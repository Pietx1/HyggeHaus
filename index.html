<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bestellungen & Bestand</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --dark:#0f172a;
      --dark2:#111827;
      --danger:#b91c1c;
      --ok:#047857;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .container{ max-width:1100px; margin:0 auto; padding:24px; }
    h1{ margin:0; font-size:38px; letter-spacing:-.02em; }
    .topbar{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      margin-bottom:18px;
    }
    .hint{ color:var(--muted); font-size:13px; }

    .navRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .navBtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:10px 14px;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
    }
    .navBtn.active{
      background:linear-gradient(180deg, #0b1220, #0f172a);
      border-color:#0f172a;
      color:#fff;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
    }
    .pad{ padding:18px; }
    .sep{ height:1px; background:var(--border); margin:14px 0; }

    .title2{ font-size:18px; font-weight:900; margin:0 0 8px; }
    label{ font-weight:900; font-size:13px; display:block; margin:0 0 6px; }

    input, textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius:14px;
      padding:11px 14px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    textarea{ min-height:90px; resize:vertical; }
    input:focus, textarea:focus{ border-color:#c7d2fe; box-shadow:0 0 0 4px rgba(99,102,241,.12); }

    .grid{ display:grid; gap:14px; }
    @media(min-width:900px){
      .grid-1{ grid-template-columns:1fr; }
      .grid-2{ grid-template-columns:repeat(2,1fr); }
      .grid-3{ grid-template-columns:repeat(3,1fr); }
      .grid-4{ grid-template-columns:repeat(4,1fr); }
    }

    .btn{
      border:0;
      cursor:pointer;
      border-radius:14px;
      padding:12px 14px;
      font-weight:1000;
      font-size:14px;
      background:var(--dark2);
      color:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .btnSmall{ padding:8px 10px; border-radius:12px; font-size:13px; }
    .btnSoft{
      background:#fff;
      border:1px solid var(--border);
      color:var(--text);
      font-weight:900;
    }
    .btnDark{ background:linear-gradient(180deg, #0b1220, #0f172a); }

    .chips{ display:flex; gap:10px; flex-wrap:wrap; }
    .chip{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      padding:11px 14px;
      border-radius:999px;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
      min-width:108px;
      text-align:center;
    }
    .chip.chipActive,
    .chip.active{
      background: linear-gradient(180deg, #0b1220, #0f172a) !important;
      color: #fff !important;
      border-color: #0f172a !important;
    }

    .prioRow{ display:flex; gap:10px; align-items:stretch; }
    .prioBtn{
      flex:1;
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      font-weight:1000;
      cursor:pointer;
      padding:10px 12px;
      text-align:center;
      user-select:none;
    }
    .prioBtn.small{ flex:.85; }
    .prioBtn.big{ flex:1.3; }
    .prioBtn.active{ background:var(--dark2); color:#fff; border-color:var(--dark2); }

    .ddWrap{ position:relative; }
    .ddInput{
      width:100%;
      height:44px;
      line-height:44px;
      padding:0 44px 0 14px;
      border:1px solid var(--border);
      border-radius:14px;
      outline:none;
      background:#fff;
    }
    .ddBtn{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      background:none;
      border:none;
      font-size:18px;
      cursor:pointer;
      z-index:3;
    }
    .ddMenu{
      position:absolute;
      top:100%;
      left:0;
      right:0;
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:12px;
      margin-top:4px;
      max-height:200px;
      overflow:auto;
      display:none;
      z-index:999;
    }
    .ddMenu.open{ display:block; }
    .ddItem{ padding:10px 12px; cursor:pointer; }
    .ddItem:hover{ background:#f1f5f9; }
    .ddEmpty{ padding:10px; color:#6b7280; }

    .status{ margin-top:10px; font-size:13px; color:var(--muted); }
    .error{ color:var(--danger); font-weight:900; }
    .ok{ color:var(--ok); font-weight:900; }
    .reqMissing{ border-color: var(--danger) !important; box-shadow:0 0 0 4px rgba(185,28,28,.10) !important; }

    .ordersHead{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
    .sortBtns{ display:flex; gap:10px; }
    .filterRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .muted{ color:var(--muted); font-size:13px; }

    .orderCard{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .orderTitle{ font-weight:1000; }
    .badge,.pill{
      font-size:12px;
      font-weight:1000;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
    }

    .iconBtn{
      border:1px solid var(--border);
      background:#fff;
      width:36px; height:36px;
      border-radius:12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .iconBtn:hover{ background:#f9fafb; }

    details.archive > summary{
      cursor:pointer;
      user-select:none;
      font-weight:1000;
      color:#1f3a8a;
    }
    .archiveWrap{ margin-top:10px; }

    .sumBox{
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px 12px;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .sumBig{
      font-weight:1100;
      font-size:20px;
      text-align:center;
      padding:14px 12px;
      cursor:pointer;
    }

    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:100;
    }
    .modalBack.open{ display:flex; }
    .modal{
      width:min(760px, 100%);
      background:#fff;
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:0 20px 60px rgba(0,0,0,.25);
    }
    .modalHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:14px 14px 10px;
      border-bottom:1px solid var(--border);
    }
    .xBtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      width:38px; height:38px;
      cursor:pointer;
      font-weight:1000;
    }
    .modalBody{ padding:14px; }
    .dangerMsg{ color:#b91c1c; font-weight:1000; display:none; margin-top:8px; }
    .okMsg{ color:#047857; font-weight:1000; display:none; margin-top:8px; }

    /* DONE */
    .itemDone{ opacity:.55; text-decoration:line-through; }
    .doneBox{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:900;
      font-size:13px;
      user-select:none;
    }
    .doneBox input{ width:18px; height:18px; }

    /* Views */
    .view{ display:none; }
    .view.active{ display:block; }

    /* Bestand cards */
    .invCard{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:#fff;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    .invLeft{ min-width:240px; }
    .invTitle{ font-weight:1100; }
    .invMeta{ color:var(--muted); font-size:13px; margin-top:3px; }
    .qtyInline{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .qtyInputSmall{
      width:120px;
      text-align:center;
      font-weight:1000;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div>
        <h1 id="pageH1">Bestellungen</h1>
        <div class="hint">GitHub Pages ‚Ä¢ Supabase</div>
      </div>

      <div class="navRow">
        <button class="navBtn active" id="navOrders">üßæ Bestellungen</button>
        <button class="navBtn" id="navStock">üì¶ Bestand</button>
      </div>
    </div>

    <!-- VIEW: Bestellungen -->
    <div class="view active" id="viewOrders">
      <!-- NEUE BESTELLUNG -->
      <div class="card">
        <div class="pad">
          <div class="row" style="justify-content:space-between;">
            <div class="chips">
              <div class="chip" id="btnBunny">üê∞ Hase</div>
              <div class="chip" id="btnLumi">‚ú®ü™≤ Lumi</div>
              <div class="chip" id="btnOther">‚ûï Weitere Produkt</div>
            </div>
          </div>

          <div style="height:10px"></div>
          <div class="title2" id="newTitle">Neue Bestellung</div>

          <div id="productArea"></div>
          <div class="sep"></div>
          <div id="colorArea"></div>

          <div class="sep"></div>

          <label>Priorit√§t</label>
          <div class="prioRow">
            <div class="prioBtn small" id="pVery">Sehr wichtig</div>
            <div class="prioBtn big" id="pNorm">Wichtig</div>
            <div class="prioBtn small" id="pLow">Nicht wichtig</div>
          </div>

          <div class="sep"></div>

          <div class="grid grid-2">
            <div>
              <label for="customer">Kundenname</label>
              <input id="customer" placeholder="z. B. Max Mustermann" />
            </div>

            <div>
              <label for="note">Beschreibung (optional)</label>
              <textarea id="note" placeholder="z. B. Sonderwunsch, Hinweis ‚Ä¶"></textarea>
            </div>
          </div>

          <div class="sep"></div>

          <label>Menge</label>
          <div class="chips" id="qtyRow" style="gap:10px;">
            <div class="chip qtyBtn" data-q="1">1</div>
            <div class="chip qtyBtn" data-q="2">2</div>
            <div class="chip qtyBtn" data-q="3">3</div>
            <div class="chip qtyBtn" data-q="4">4</div>
            <div class="chip qtyBtn" data-q="5">5</div>
            <div class="chip qtyBtn" data-q="6">6</div>
            <div class="chip qtyBtn" data-q="7">7</div>
            <div class="chip qtyBtn" data-q="8">8</div>
            <div class="chip qtyBtn" data-q="9">9</div>
          </div>

          <div class="grid grid-2" style="align-items:end; margin-top:10px;">
            <div>
              <label for="qtyOther">Andere Menge (optional)</label>
              <input id="qtyOther" inputmode="numeric" placeholder="z. B. 12" />
            </div>

            <div style="display:flex; justify-content:flex-end;">
              <button class="btn btnDark" id="addItemBtn" style="min-width:280px;">+ Position hinzuf√ºgen</button>
            </div>
          </div>

          <div class="status">
            <div class="error" id="formError" style="display:none;">Bitte erst ausf√ºllen.</div>
            <div class="muted" id="missing" style="display:none;"></div>
          </div>

          <div class="sep"></div>

          <div class="row" style="justify-content:space-between; align-items:flex-end;">
            <div class="title2" style="margin:0;">Positionen in dieser Bestellung</div>
            <div class="muted" id="cartSum">Summe: 0,00 ‚Ç¨</div>
          </div>

          <div id="cartList" class="grid" style="margin-top:10px;"></div>
          <div class="muted" id="cartHint">Noch keine Position hinzugef√ºgt.</div>

          <div class="sep"></div>

          <button id="saveOrderBtn" class="btn" disabled>‚úÖ Bestellung speichern</button>
          <div class="okMsg" id="saveStatus">Gespeichert ‚úÖ</div>
        </div>
      </div>

      <div style="height:16px"></div>

      <!-- OFFENE BESTELLUNGEN -->
      <div class="card">
        <div class="pad">
          <div class="ordersHead">
            <div>
              <div class="title2" style="margin:0;">Offene Bestellungen</div>
              <div class="muted" id="openSum">Summe offen: 0,00 ‚Ç¨</div>
            </div>

            <div class="filterRow">
              <div class="sortBtns">
                <button class="btnSmall btnDark" id="sortDate">Sort: Datum</button>
                <button class="btnSmall btnSoft" id="sortPrio">Sort: Priorit√§t</button>
              </div>

              <button class="btnSmall btnSoft" id="toggleDone">‚úÖ Fertige ausblenden</button>
            </div>
          </div>

          <div class="sep"></div>
          <div id="openOrders" class="grid"></div>

          <div class="sep"></div>

          <details class="archive">
            <summary>Archiv (alte Bestellungen anzeigen)</summary>
            <div class="archiveWrap">
              <div id="archiveOrders" class="grid" style="margin-top:10px;"></div>
            </div>
          </details>

          <div class="sep"></div>

          <div class="sumBox sumBig" id="soldSum" title="Klicken f√ºr Korrektur / Abzug">
            Verkauft gesamt: 0,00 ‚Ç¨
          </div>
          <div class="muted" style="text-align:center; margin-top:6px;">Klicken f√ºr Korrektur / Abzug</div>
        </div>
      </div>

      <!-- Modals (wie vorher) -->
      <div class="modalBack" id="modalBack">
        <div class="modal">
          <div class="modalHead">
            <div class="title2" style="margin:0;">Position bearbeiten</div>
            <button class="xBtn" id="closeModal">X</button>
          </div>
          <div class="modalBody" id="modalBody"></div>
        </div>
      </div>

      <div class="modalBack" id="adjBack">
        <div class="modal">
          <div class="modalHead">
            <div class="title2" style="margin:0;">Korrektur / Abzug</div>
            <button class="xBtn" id="closeAdj">X</button>
          </div>
          <div class="modalBody">
            <div class="muted" style="margin-bottom:10px;">
              W√§hle, was du abziehen willst (z. B. R√ºckgabe / Rabatt).
            </div>

            <div class="grid grid-2">
              <button class="btn btnSoft" id="soldBtnBunny">üê∞ Hase</button>
              <button class="btn btnSoft" id="soldBtnLumi">‚ú®ü™≤ Lumi</button>
              <button class="btn btnSoft" id="soldBtnCombo">üê∞ Hase Combo</button>
              <button class="btn btnSoft" id="soldBtnOther">‚ûï Weitere Produkt</button>
            </div>

            <div style="height:10px"></div>

            <div id="adjPickArea"></div>

            <div style="height:12px"></div>

            <label for="adjNote">Notiz (optional)</label>
            <input id="adjNote" placeholder="z. B. Rabatt / Fehler / Kunde ‚Ä¶" />

            <div style="height:10px"></div>
            <button class="btn btnDark" id="addAdjBtn">Abzug speichern</button>

            <div class="okMsg" id="adjMsg">Gespeichert ‚úÖ</div>
            <div class="dangerMsg" id="adjErr">Fehler</div>
          </div>
        </div>
      </div>
    </div><!-- /viewOrders -->

    <!-- VIEW: Bestand -->
    <div class="view" id="viewStock">
      <div class="card">
        <div class="pad">
          <div class="title2">Bestand</div>
          <div class="muted">Hier tr√§gst du fertige Hasen ein ‚Äì unabh√§ngig von Bestellungen.</div>

          <div class="sep"></div>

          <label>Gr√∂√üe</label>
          <div class="chips" id="stockSizeRow">
            <div class="chip" data-size="11">11 cm</div>
            <div class="chip" data-size="15">15 cm</div>
            <div class="chip" data-size="20">20 cm</div>
          </div>

          <div style="height:10px"></div>

          <div class="grid grid-3" id="stockColorArea"></div>

          <div style="height:10px"></div>

          <div class="grid grid-2" style="align-items:end;">
            <div>
              <label for="stockQty">Menge</label>
              <input id="stockQty" inputmode="numeric" placeholder="z. B. 3" />
            </div>
            <div style="display:flex; justify-content:flex-end;">
              <button class="btn btnDark" id="stockAddBtn" style="min-width:280px;">+ Zum Bestand hinzuf√ºgen</button>
            </div>
          </div>

          <div class="status">
            <div class="error" id="stockErr" style="display:none;"></div>
            <div class="ok" id="stockOk" style="display:none;"></div>
          </div>

          <div class="sep"></div>

          <div class="row" style="justify-content:space-between; align-items:flex-end;">
            <div class="title2" style="margin:0;">Aktueller Bestand</div>
            <div class="muted" id="stockSum">Gesamt: 0</div>
          </div>

          <div id="stockList" class="grid" style="margin-top:10px;"></div>
          <div class="muted" id="stockHint">Noch kein Bestand erfasst.</div>
        </div>
      </div>
    </div><!-- /viewStock -->

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const SUPABASE_URL = "https://htgrzmlcdolxxzvkppon.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0Z3J6bWxjZG9seHh6dmtwcG9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MzM2ODIsImV4cCI6MjA4NTAwOTY4Mn0.B0PxMAzmuvsHNd2n_mgNspjlPkaBpQlkrNzGu7p78fY";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------- shared helpers ----------
    const COLOR_SUGGESTIONS = ["wei√ü","schwarz","grau","rot","blau","gelb","gr√ºn","orange","pink","lila","braun","beige","gold","silber"];
    const PRICES = { bunny:{ "20":12.0,"15":9.0,"11":6.0, comboAllThree:22.50 }, lumi:8.50 };

    const euro = (n)=> (Number(n)||0).toFixed(2).replace(".", ",") + " ‚Ç¨";
    const esc = (s)=> String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

    function buildDropdown({ id, label, placeholder }){
      return `
        <div class="field" data-dd-wrap="${id}">
          <label for="${id}">${esc(label)}</label>
          <div class="ddWrap">
            <input id="${id}" class="ddInput" placeholder="${esc(placeholder)}" autocomplete="off" />
            <button type="button" class="ddBtn" aria-label="Dropdown √∂ffnen" data-dd-btn="${id}"><span>‚ñæ</span></button>
            <div class="ddMenu" data-dd-menu="${id}"></div>
          </div>
        </div>
      `;
    }
    function setupDropdown(inputId, onChange){
      const input = document.getElementById(inputId);
      const menu  = document.querySelector(`[data-dd-menu="${inputId}"]`);
      const btn   = document.querySelector(`[data-dd-btn="${inputId}"]`);
      const wrap  = document.querySelector(`[data-dd-wrap="${inputId}"]`);
      if(!input || !menu || !btn || !wrap) return;

      function renderMenu(filter=""){
        const f = filter.trim().toLowerCase();
        const list = COLOR_SUGGESTIONS.filter(x => x.toLowerCase().includes(f));
        menu.innerHTML = list.length
          ? list.map(x=>`<div class="ddItem" data-val="${esc(x)}">${esc(x)}</div>`).join("")
          : `<div class="ddEmpty">Keine Vorschl√§ge</div>`;

        menu.querySelectorAll(".ddItem").forEach(it=>{
          it.addEventListener("click", ()=>{
            const v = it.getAttribute("data-val") || "";
            input.value = v;
            menu.classList.remove("open");
            onChange?.(v);
          });
        });
      }

      input.addEventListener("input", ()=>{
        if(menu.classList.contains("open")) renderMenu(input.value || "");
        onChange?.(input.value || "");
      });
      btn.addEventListener("click", (e)=>{
        e.preventDefault(); e.stopPropagation();
        if(menu.classList.contains("open")) menu.classList.remove("open");
        else { menu.classList.add("open"); renderMenu(input.value || ""); input.focus(); }
      });
      document.addEventListener("click", (e)=>{ if(!wrap.contains(e.target)) menu.classList.remove("open"); });
    }

    // ---------- NAV (2 Seiten) ----------
    const pageH1 = document.getElementById("pageH1");
    const navOrders = document.getElementById("navOrders");
    const navStock  = document.getElementById("navStock");
    const viewOrders = document.getElementById("viewOrders");
    const viewStock  = document.getElementById("viewStock");

    function setActiveView(which){
      const isOrders = which === "orders";
      navOrders.classList.toggle("active", isOrders);
      navStock.classList.toggle("active", !isOrders);
      viewOrders.classList.toggle("active", isOrders);
      viewStock.classList.toggle("active", !isOrders);
      pageH1.textContent = isOrders ? "Bestellungen" : "Bestand";
    }
    navOrders.addEventListener("click", ()=> setActiveView("orders"));
    navStock.addEventListener("click", async ()=> { setActiveView("stock"); await loadStock(); });

    // ============================================================
    // =======================  BESTAND  ==========================
    // ============================================================
    const stockSizeRow = document.getElementById("stockSizeRow");
    const stockColorArea = document.getElementById("stockColorArea");
    const stockQty = document.getElementById("stockQty");
    const stockAddBtn = document.getElementById("stockAddBtn");
    const stockErr = document.getElementById("stockErr");
    const stockOk = document.getElementById("stockOk");
    const stockList = document.getElementById("stockList");
    const stockHint = document.getElementById("stockHint");
    const stockSum = document.getElementById("stockSum");

    let stockSize = null;
    let stockBody = "";
    let stockEars = "";
    let stockButt = "";

    function stockShowErr(msg){ stockOk.style.display="none"; stockErr.textContent=msg; stockErr.style.display="block"; }
    function stockShowOk(msg){ stockErr.style.display="none"; stockOk.textContent=msg; stockOk.style.display="block"; setTimeout(()=>stockOk.style.display="none", 1400); }

    // build color inputs
    stockColorArea.innerHTML = `
      ${buildDropdown({ id:"stock_body", label:"K√∂rperfarbe", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
      ${buildDropdown({ id:"stock_ears", label:"Ohrenfarbe",  placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
      ${buildDropdown({ id:"stock_butt", label:"Popofarbe",   placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
    `;
    setupDropdown("stock_body", (v)=> stockBody = v);
    setupDropdown("stock_ears", (v)=> stockEars = v);
    setupDropdown("stock_butt", (v)=> stockButt = v);

    // size chips
    stockSizeRow.querySelectorAll(".chip").forEach(ch=>{
      ch.addEventListener("click", ()=>{
        stockSize = ch.getAttribute("data-size");
        stockSizeRow.querySelectorAll(".chip").forEach(x=>x.classList.remove("chipActive","btnDark"));
        ch.classList.add("chipActive","btnDark");
      });
    });

    function stockKey(size, body, ears, butt){
      // normalize
      const norm = (s)=> String(s||"").trim().toLowerCase();
      return `bunny|${norm(size)}|${norm(body)}|${norm(ears)}|${norm(butt)}`;
    }

    async function addToStock(){
      stockErr.style.display="none";

      const size = String(stockSize||"").trim();
      const body = String(stockBody||"").trim();
      const ears = String(stockEars||"").trim();
      const butt = String(stockButt||"").trim();
      const q = Math.floor(Number(String(stockQty.value||"").replace(",", ".")));

      if(!size) return stockShowErr("Bitte Gr√∂√üe w√§hlen.");
      if(!body || !ears || !butt) return stockShowErr("Bitte alle 3 Farben ausf√ºllen.");
      if(!Number.isFinite(q) || q<=0) return stockShowErr("Bitte g√ºltige Menge eingeben.");

      const key = stockKey(size, body, ears, butt);

      // hole aktuellen qty (falls existiert), dann addieren
      const { data: existing, error: exErr } = await supabase
        .from("inventory_bunnies")
        .select("qty")
        .eq("key", key)
        .maybeSingle();

      if(exErr) return stockShowErr(exErr.message);

      const newQty = (existing?.qty ?? 0) + q;

      const { error } = await supabase
        .from("inventory_bunnies")
        .upsert({
          key,
          size, body, ears, butt,
          qty: newQty,
          updated_at: new Date().toISOString()
        });

      if(error) return stockShowErr(error.message);

      stockQty.value = "";
      stockShowOk("Gespeichert ‚úÖ");
      await loadStock();
    }

    stockAddBtn.addEventListener("click", addToStock);

    async function updateStockQty(key, qty){
      const q = Math.floor(Number(qty));
      if(!Number.isFinite(q) || q<0) throw new Error("Menge muss 0 oder gr√∂√üer sein.");

      const { error } = await supabase
        .from("inventory_bunnies")
        .update({ qty: q, updated_at: new Date().toISOString() })
        .eq("key", key);

      if(error) throw error;
    }

    async function deleteStockRow(key){
      const ok = confirm("Diesen Bestand-Eintrag l√∂schen?");
      if(!ok) return;
      await supabase.from("inventory_bunnies").delete().eq("key", key);
      await loadStock();
    }

    async function loadStock(){
      const { data, error } = await supabase
        .from("inventory_bunnies")
        .select("*")
        .order("updated_at", { ascending:false });

      if(error){
        stockShowErr(error.message);
        return;
      }

      const rows = data || [];
      stockList.innerHTML = "";
      stockHint.style.display = rows.length ? "none" : "block";

      const total = rows.reduce((s,r)=> s + Number(r.qty||0), 0);
      stockSum.textContent = `Gesamt: ${total}`;

      // nice sorting inside stock: by size 11->15->20, then updated desc
      const sizeOrder = { "11":0, "15":1, "20":2 };
      rows.sort((a,b)=>{
        const sa = sizeOrder[String(a.size)] ?? 99;
        const sb = sizeOrder[String(b.size)] ?? 99;
        if(sa!==sb) return sa-sb;
        return new Date(b.updated_at)-new Date(a.updated_at);
      });

      for(const r of rows){
        const card = document.createElement("div");
        card.className = "invCard";

        card.innerHTML = `
          <div class="invLeft">
            <div class="invTitle">üê∞ Hase ${esc(r.size)} cm</div>
            <div class="invMeta">K√∂rper: ${esc(r.body)} ‚Ä¢ Ohren: ${esc(r.ears)} ‚Ä¢ Popo: ${esc(r.butt)}</div>
          </div>

          <div class="qtyInline">
            <div class="muted">Menge:</div>
            <input class="qtyInputSmall" inputmode="numeric" value="${esc(r.qty)}" data-qty-key="${esc(r.key)}" />
            <button class="btnSmall btnSoft" data-save-key="${esc(r.key)}">Speichern</button>
            <button class="btnSmall btnSoft" data-del-key="${esc(r.key)}">L√∂schen</button>
          </div>
        `;

        stockList.appendChild(card);
      }

      // handlers
      stockList.querySelectorAll("[data-save-key]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const key = btn.getAttribute("data-save-key");
          const inp = stockList.querySelector(`input[data-qty-key="${CSS.escape(key)}"]`);
          try{
            await updateStockQty(key, inp.value);
            stockShowOk("Aktualisiert ‚úÖ");
            await loadStock();
          }catch(e){
            stockShowErr(e?.message || String(e));
          }
        });
      });
      stockList.querySelectorAll("[data-del-key]").forEach(btn=>{
        btn.addEventListener("click", ()=> deleteStockRow(btn.getAttribute("data-del-key")));
      });
    }

    // ============================================================
    // ======================  BESTELLUNGEN  ======================
    // ============================================================
    // DOM
    const btnBunny = document.getElementById("btnBunny");
    const btnLumi  = document.getElementById("btnLumi");
    const btnOther = document.getElementById("btnOther");

    const newTitle = document.getElementById("newTitle");
    const productArea = document.getElementById("productArea");
    const colorArea = document.getElementById("colorArea");

    const pVery = document.getElementById("pVery");
    const pNorm = document.getElementById("pNorm");
    const pLow  = document.getElementById("pLow");

    const customer = document.getElementById("customer");
    const noteEl   = document.getElementById("note");

    const qtyOther = document.getElementById("qtyOther");
    const addItemBtn = document.getElementById("addItemBtn");

    const cartList = document.getElementById("cartList");
    const cartHint = document.getElementById("cartHint");
    const cartSum  = document.getElementById("cartSum");

    const saveOrderBtn = document.getElementById("saveOrderBtn");
    const saveStatus   = document.getElementById("saveStatus");

    const formError = document.getElementById("formError");
    const missingEl = document.getElementById("missing");

    const openOrdersEl = document.getElementById("openOrders");
    const archiveOrdersEl = document.getElementById("archiveOrders");
    const openSumEl = document.getElementById("openSum");
    const soldSumEl = document.getElementById("soldSum");

    const sortDate = document.getElementById("sortDate");
    const sortPrio = document.getElementById("sortPrio");
    const toggleDone = document.getElementById("toggleDone");

    const modalBack = document.getElementById("modalBack");
    const modalBody = document.getElementById("modalBody");
    const closeModal = document.getElementById("closeModal");

    const adjBack = document.getElementById("adjBack");
    const closeAdj = document.getElementById("closeAdj");
    const adjPickArea = document.getElementById("adjPickArea");
    const addAdjBtn = document.getElementById("addAdjBtn");
    const adjNote = document.getElementById("adjNote");
    const adjMsg  = document.getElementById("adjMsg");
    const adjErr  = document.getElementById("adjErr");

    const soldBtnBunny = document.getElementById("soldBtnBunny");
    const soldBtnLumi  = document.getElementById("soldBtnLumi");
    const soldBtnCombo = document.getElementById("soldBtnCombo");
    const soldBtnOther = document.getElementById("soldBtnOther");

    // state
    let currentProduct = null;
    let bunnySize = null;
    let bunnyMode = null;
    let priority  = null;
    let qty = null;
    let sortMode = "date";
    let hideDoneItems = true;

    const fields = {
      bunny_body:"", bunny_ears:"", bunny_butt:"", bunny_single:"",
      lumi_body:"",  lumi_wings:"", lumi_feelers:"",
      other_size:"", other_color:"",
    };

    let cart = [];

    function setChipActive(el, on){
      if(!el) return;
      el.classList.toggle("chipActive", !!on);
      el.classList.toggle("btnDark", !!on);
    }
    function setPrioActive(el, on){
      if(!el) return;
      el.classList.toggle("active", !!on);
    }
    function showMissing(msg){
      formError.style.display = "block";
      missingEl.style.display = "block";
      missingEl.textContent = msg;
    }
    function clearErrorUI(){
      formError.style.display = "none";
      missingEl.style.display = "none";
      missingEl.textContent = "";
      document.querySelectorAll(".reqMissing").forEach(x=>x.classList.remove("reqMissing"));
    }

    function setupColorDropdowns(){
      // noop placeholder; dropdowns are created in renderColorArea()
    }

    function renderProductArea(){
      productArea.innerHTML = "";

      if(currentProduct === "bunny"){
        productArea.innerHTML = `
          <div>
            <label>Gr√∂√üe</label>
            <div class="chips">
              <div class="chip" id="size20">20 cm</div>
              <div class="chip" id="size15">15 cm</div>
              <div class="chip" id="size11">11 cm</div>
            </div>
          </div>

          <div class="sep"></div>

          <div>
            <label>Farbmodus</label>
            <div class="chips">
              <div class="chip" id="modeMulti">Mehrfarbig</div>
              <div class="chip" id="modeSingle">Einfarbig</div>
            </div>
          </div>
        `;

        const s20 = document.getElementById("size20");
        const s15 = document.getElementById("size15");
        const s11 = document.getElementById("size11");
        [s20,s15,s11].forEach(el=>{
          el.addEventListener("click", ()=>{
            bunnySize = el.id==="size20" ? "20" : el.id==="size15" ? "15" : "11";
            [s20,s15,s11].forEach(x=>setChipActive(x, x===el));
            validateForAdd();
          });
        });

        const mMulti = document.getElementById("modeMulti");
        const mSingle= document.getElementById("modeSingle");
        [mMulti,mSingle].forEach(el=>{
          el.addEventListener("click", ()=>{
            bunnyMode = (el.id==="modeSingle") ? "single" : "multi";
            [mMulti,mSingle].forEach(x=>setChipActive(x, x===el));
            fields.bunny_body=""; fields.bunny_ears=""; fields.bunny_butt=""; fields.bunny_single="";
            renderColorArea();
            validateForAdd();
          });
        });

      } else if(currentProduct === "lumi"){
        productArea.innerHTML = `<div class="muted">Lumi hat keine Gr√∂√üe ‚Äì w√§hle Farben.</div>`;
      } else if(currentProduct === "other"){
        productArea.innerHTML = `
          <div class="grid grid-2">
            <div class="field">
              <label for="other_size">Gr√∂√üe *</label>
              <input id="other_size" placeholder="z. B. gro√ü / 10 cm / XL" />
            </div>
            <div class="muted">Weitere Produkt: frei definierbar</div>
          </div>
        `;
        const os = document.getElementById("other_size");
        os.addEventListener("input", ()=>{ fields.other_size = os.value||""; validateForAdd(); });
      }
    }

    function renderColorArea(){
      colorArea.innerHTML = "";

      if(currentProduct === "bunny"){
        if(bunnyMode === "single"){
          colorArea.innerHTML = `
            <div class="grid grid-1">
              ${buildDropdown({ id:"bunny_single", label:"Einfarbig", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
            </div>
          `;
          setupDropdown("bunny_single", (v)=> fields.bunny_single=v);
        } else if(bunnyMode === "multi"){
          colorArea.innerHTML = `
            <div class="grid grid-3">
              ${buildDropdown({ id:"bunny_body", label:"K√∂rperfarbe", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
              ${buildDropdown({ id:"bunny_ears", label:"Ohrenfarbe",  placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
              ${buildDropdown({ id:"bunny_butt", label:"Popofarbe",  placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
            </div>
          `;
          setupDropdown("bunny_body", (v)=> fields.bunny_body=v);
          setupDropdown("bunny_ears", (v)=> fields.bunny_ears=v);
          setupDropdown("bunny_butt", (v)=> fields.bunny_butt=v);
        } else {
          colorArea.innerHTML = `<div class="muted">Bitte zuerst <b>Farbmodus</b> w√§hlen.</div>`;
        }
      }

      if(currentProduct === "lumi"){
        colorArea.innerHTML = `
          <div class="grid grid-3">
            ${buildDropdown({ id:"lumi_body",   label:"K√∂rperfarbe",  placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
            ${buildDropdown({ id:"lumi_wings",  label:"Fl√ºgelfarbe",  placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
            ${buildDropdown({ id:"lumi_feelers",label:"F√ºhlerfarbe",  placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
          </div>
        `;
        setupDropdown("lumi_body", (v)=> fields.lumi_body=v);
        setupDropdown("lumi_wings", (v)=> fields.lumi_wings=v);
        setupDropdown("lumi_feelers", (v)=> fields.lumi_feelers=v);
      }

      if(currentProduct === "other"){
        colorArea.innerHTML = `
          <div class="grid grid-2">
            ${buildDropdown({ id:"other_color", label:"Farbe", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
          </div>
        `;
        setupDropdown("other_color", (v)=> fields.other_color=v);
      }
    }

    function resetSelections(){
      bunnySize = null;
      bunnyMode = null;
      priority  = null;
      qty       = null;
      qtyOther.value = "";

      fields.bunny_body=""; fields.bunny_ears=""; fields.bunny_butt=""; fields.bunny_single="";
      fields.lumi_body=""; fields.lumi_wings=""; fields.lumi_feelers="";
      fields.other_size=""; fields.other_color="";
      clearErrorUI();

      [pVery,pNorm,pLow].forEach(x=>setPrioActive(x,false));
      document.querySelectorAll(".qtyBtn").forEach(b=>b.classList.remove("chipActive","btnDark"));
    }

    function setProduct(p){
      currentProduct = p;

      [btnBunny,btnLumi,btnOther].forEach(x=>setChipActive(x,false));
      setChipActive(btnBunny, p==="bunny");
      setChipActive(btnLumi,  p==="lumi");
      setChipActive(btnOther, p==="other");

      newTitle.textContent =
        p==="bunny" ? "Neue Bestellung: Hase" :
        p==="lumi"  ? "Neue Bestellung: Lumi" :
                      "Neue Bestellung: Weitere Produkt";

      resetSelections();
      renderProductArea();
      renderColorArea();
      validateForAdd();
      validateSaveEnabled();
    }

    btnBunny.addEventListener("click", ()=>setProduct("bunny"));
    btnLumi .addEventListener("click", ()=>setProduct("lumi"));
    btnOther.addEventListener("click", ()=>setProduct("other"));

    pVery.addEventListener("click", ()=>{
      priority="very";
      [pVery,pNorm,pLow].forEach(x=>setPrioActive(x,false));
      setPrioActive(pVery,true);
      validateForAdd();
    });
    pNorm.addEventListener("click", ()=>{
      priority="normal";
      [pVery,pNorm,pLow].forEach(x=>setPrioActive(x,false));
      setPrioActive(pNorm,true);
      validateForAdd();
    });
    pLow.addEventListener("click", ()=>{
      priority="low";
      [pVery,pNorm,pLow].forEach(x=>setPrioActive(x,false));
      setPrioActive(pLow,true);
      validateForAdd();
    });

    document.querySelectorAll(".qtyBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        qty = Number(btn.getAttribute("data-q"));
        document.querySelectorAll(".qtyBtn").forEach(b=>b.classList.remove("chipActive","btnDark"));
        btn.classList.add("chipActive","btnDark");
        validateForAdd();
      });
    });

    function requiredOk(){
      const missing = [];
      if(!currentProduct) missing.push("Produkt");
      if(!priority) missing.push("Priorit√§t");

      const otherQ = Number(String(qtyOther.value||"").replace(",", "."));
      const hasQty = Number.isFinite(otherQ) && otherQ>0 ? true : (typeof qty==="number" && qty>0);
      if(!hasQty) missing.push("Menge");

      if(currentProduct === "bunny"){
        if(!bunnySize) missing.push("Gr√∂√üe");
        if(!bunnyMode) missing.push("Farbmodus");

        if(bunnyMode === "single"){
          if(!(fields.bunny_single||"").trim()) missing.push("Einfarbig");
        }
        if(bunnyMode === "multi"){
          if(!(fields.bunny_body||"").trim()) missing.push("K√∂rperfarbe");
          if(!(fields.bunny_ears||"").trim()) missing.push("Ohrenfarbe");
          if(!(fields.bunny_butt||"").trim()) missing.push("Popofarbe");
        }
      }

      if(currentProduct === "lumi"){
        if(!(fields.lumi_body||"").trim())    missing.push("K√∂rperfarbe");
        if(!(fields.lumi_wings||"").trim())   missing.push("Fl√ºgelfarbe");
        if(!(fields.lumi_feelers||"").trim()) missing.push("F√ºhlerfarbe");
      }

      if(currentProduct === "other"){
        if(!(fields.other_size||"").trim())  missing.push("Gr√∂√üe");
        if(!(fields.other_color||"").trim()) missing.push("Farbe");
      }

      return missing;
    }

    function markMissingFields(missing){
      if(missing.includes("Priorit√§t")){
        document.querySelector(".prioRow")?.classList.add("reqMissing");
      }
      if(missing.includes("Menge")){
        document.getElementById("qtyRow")?.classList.add("reqMissing");
        qtyOther?.classList.add("reqMissing");
      }
    }

    function validateForAdd(){
      clearErrorUI();
      const missing = requiredOk();
      if(missing.length){
        showMissing("Bitte erst ausf√ºllen: " + missing.join(", "));
        markMissingFields(missing);
        return false;
      }
      return true;
    }

    function validateSaveEnabled(){
      saveOrderBtn.disabled = (cart.length === 0);
    }

    function itemBasePrice(item){
      if(item.product === "bunny") return PRICES.bunny[item.size] || 0;
      if(item.product === "lumi")  return PRICES.lumi;
      return 0;
    }

    function cartTotal(){
      let total = 0;

      for(const it of cart){
        if(it.product !== "bunny"){
          total += (it.price_override != null ? it.price_override : itemBasePrice(it)) * it.qty;
        }
      }

      const counts = { "20":0, "15":0, "11":0 };
      const bunnyItems = cart.filter(x=>x.product==="bunny");
      for(const it of bunnyItems){
        counts[it.size] += it.qty;
      }

      const combos = Math.min(counts["20"], counts["15"], counts["11"]);
      if(combos > 0){
        total += combos * PRICES.bunny.comboAllThree;
        counts["20"] -= combos;
        counts["15"] -= combos;
        counts["11"] -= combos;
      }

      total += counts["20"] * PRICES.bunny["20"];
      total += counts["15"] * PRICES.bunny["15"];
      total += counts["11"] * PRICES.bunny["11"];

      return total;
    }

    function prioLabel(p){
      if(p==="very") return "Sehr wichtig";
      if(p==="normal") return "Wichtig";
      return "Nicht wichtig";
    }

    function colorText(it){
      if(it.product==="bunny"){
        if(it.mode==="single") return `Einfarbig: ${it.colors.single||""}`;
        return `K√∂rper: ${it.colors.body||""}, Ohren: ${it.colors.ears||""}, Popo: ${it.colors.butt||""}`;
      }
      if(it.product==="lumi"){
        return `K√∂rper: ${it.colors.body||""}, Fl√ºgel: ${it.colors.wings||""}, F√ºhler: ${it.colors.feelers||""}`;
      }
      return `Gr√∂√üe: ${it.size||""}, Farbe: ${it.colors.color||""}`;
    }

    function updateCartUI(){
      cartList.innerHTML = "";
      cartHint.style.display = (cart.length === 0) ? "block" : "none";

      for(const it of cart){
        const card = document.createElement("div");
        card.className = "card pad";

        const pr = prioLabel(it.priority);
        const qtyTxt = `√ó ${it.qty}`;
        const title =
          it.product === "bunny" ? `Hase ${it.size} cm` :
          it.product === "lumi"  ? `Lumi` :
                                   `Weitere Produkt`;

        const colors = colorText(it);

        card.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div>
              <div style="font-weight:1000">${esc(title)} <span class="muted" style="margin-left:8px;">${esc(pr)}</span></div>
              <div class="muted" style="margin-top:2px;">
                ${esc(colors)}
                ${it.customer_name ? ` ‚Ä¢ Kunde: ${esc(it.customer_name)}` : ``}
              </div>
              ${it.note ? `<div class="muted" style="margin-top:6px;">üìù ${esc(it.note)}</div>` : ``}
            </div>
            <div class="row" style="gap:8px;">
              <div class="badge">${esc(qtyTxt)}</div>
              <button class="iconBtn" data-del="${it._cid}" title="Entfernen">‚úñ</button>
            </div>
          </div>
        `;
        cartList.appendChild(card);
      }

      cartList.querySelectorAll("[data-del]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-del");
          cart = cart.filter(x=>String(x._cid)!==String(id));
          updateCartUI();
          validateSaveEnabled();
        });
      });

      cartSum.textContent = "Summe: " + euro(cartTotal());
    }

    function getQty(){
      const otherQ = Number(String(qtyOther.value||"").replace(",", "."));
      if(Number.isFinite(otherQ) && otherQ>0) return Math.floor(otherQ);
      if(typeof qty==="number" && qty>0) return qty;
      return null;
    }

    function makeItem(){
      const q = getQty();
      const item = {
        _cid: String(Date.now()) + "-" + Math.random().toString(16).slice(2),
        product: currentProduct,
        size: null,
        mode: null,
        colors: {},
        qty: q,
        priority,
        customer_name: (customer.value||"").trim() || null,
        note: (noteEl.value||"").trim() || null,
        price_override: null
      };

      if(currentProduct==="bunny"){
        item.size = bunnySize;
        item.mode = bunnyMode;
        if(bunnyMode==="single"){
          item.colors.single = (fields.bunny_single||"").trim();
        } else {
          item.colors.body = (fields.bunny_body||"").trim();
          item.colors.ears = (fields.bunny_ears||"").trim();
          item.colors.butt = (fields.bunny_butt||"").trim();
        }
      }

      if(currentProduct==="lumi"){
        item.colors.body    = (fields.lumi_body||"").trim();
        item.colors.wings   = (fields.lumi_wings||"").trim();
        item.colors.feelers = (fields.lumi_feelers||"").trim();
      }

      if(currentProduct==="other"){
        item.size = (fields.other_size||"").trim();
        item.colors.color = (fields.other_color||"").trim();
      }

      return item;
    }

    addItemBtn.addEventListener("click", ()=>{
      const ok = validateForAdd();
      if(!ok) return;

      const item = makeItem();
      cart.push(item);

      qty = null;
      qtyOther.value = "";
      document.querySelectorAll(".qtyBtn").forEach(b=>b.classList.remove("chipActive","btnDark"));

      updateCartUI();
      validateSaveEnabled();
      clearErrorUI();
    });

    // done toggle
    async function toggleItemDone(itemId, done){
      const { error } = await supabase
        .from("order_items")
        .update({ done: !!done })
        .eq("id", itemId);
      if(error) throw error;
    }

    sortDate.addEventListener("click", ()=>{
      sortMode = "date";
      sortDate.classList.add("btnDark");
      sortDate.classList.remove("btnSoft");
      sortPrio.classList.add("btnSoft");
      sortPrio.classList.remove("btnDark");
      loadAll();
    });
    sortPrio.addEventListener("click", ()=>{
      sortMode = "prio";
      sortPrio.classList.add("btnDark");
      sortPrio.classList.remove("btnSoft");
      sortDate.classList.add("btnSoft");
      sortDate.classList.remove("btnDark");
      loadAll();
    });

    toggleDone.addEventListener("click", ()=>{
      hideDoneItems = !hideDoneItems;
      if(hideDoneItems){
        toggleDone.textContent = "‚úÖ Fertige ausblenden";
        toggleDone.classList.add("btnSoft");
        toggleDone.classList.remove("btnDark");
      }else{
        toggleDone.textContent = "‚úÖ Fertige anzeigen";
        toggleDone.classList.add("btnDark");
        toggleDone.classList.remove("btnSoft");
      }
      loadAll();
    });

    function formatDateOnly(iso){
      const d = new Date(iso);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}.${mm}.${yy}`;
    }
    function prioRank(p){
      if(p==="very") return 0;
      if(p==="normal") return 1;
      return 2;
    }

    // ‚úÖ Hasen in Bestellung: 11 -> 15 -> 20 (egal wie eingegeben)
    function sortItemsInsideOrder(items){
      const sizeOrder = { "11":0, "15":1, "20":2 };
      return [...items].sort((a,b)=>{
        if(a.product==="bunny" && b.product!=="bunny") return -1;
        if(a.product!=="bunny" && b.product==="bunny") return 1;
        if(a.product==="bunny" && b.product==="bunny"){
          const sa = sizeOrder[a.size] ?? 99;
          const sb = sizeOrder[b.size] ?? 99;
          if(sa !== sb) return sa - sb;
        }
        return 0;
      });
    }

    function priceForOrderItems(items){
      let total = 0;

      for(const it of items){
        if(it.product !== "bunny"){
          const base = (it.price_override != null ? it.price_override : itemBasePrice(it));
          total += base * it.qty;
        }
      }

      const counts = { "20":0, "15":0, "11":0 };
      const bunnyItems = items.filter(x=>x.product==="bunny");
      for(const it of bunnyItems){
        counts[it.size] += it.qty;
      }

      const combos = Math.min(counts["20"], counts["15"], counts["11"]);
      if(combos>0){
        total += combos * PRICES.bunny.comboAllThree;
        counts["20"] -= combos;
        counts["15"] -= combos;
        counts["11"] -= combos;
      }

      total += counts["20"] * PRICES.bunny["20"];
      total += counts["15"] * PRICES.bunny["15"];
      total += counts["11"] * PRICES.bunny["11"];

      return total;
    }

    async function saveOrder(){
      clearErrorUI();
      saveStatus.style.display = "none";

      if(cart.length === 0){
        showMissing("F√ºge zuerst mindestens eine Position hinzu.");
        return;
      }

      saveOrderBtn.disabled = true;
      saveOrderBtn.textContent = "Speichern‚Ä¶";

      const orderPayload = {
        customer_name: (customer.value||"").trim() || null,
        note: (noteEl.value||"").trim() || null,
        archived: false
      };

      const { data: orderData, error: orderErr } = await supabase
        .from("orders")
        .insert(orderPayload)
        .select("id")
        .single();

      if(orderErr){
        showMissing("Fehler beim Speichern: " + orderErr.message);
        saveOrderBtn.disabled = false;
        saveOrderBtn.textContent = "‚úÖ Bestellung speichern";
        return;
      }

      const orderId = orderData.id;

      const itemsPayload = cart.map(it=>({
        order_id: orderId,
        product: it.product,
        size: it.size ?? null,
        mode: it.mode ?? null,
        priority: it.priority,
        qty: it.qty,
        colors: it.colors,
        note: it.note ?? null,
        price_override: it.price_override ?? null,
        done: false
      }));

      const { error: itemsErr } = await supabase
        .from("order_items")
        .insert(itemsPayload);

      if(itemsErr){
        showMissing("Fehler beim Speichern (Positionen): " + itemsErr.message);
        await supabase.from("orders").delete().eq("id", orderId);
        saveOrderBtn.disabled = false;
        saveOrderBtn.textContent = "‚úÖ Bestellung speichern";
        return;
      }

      cart = [];
      updateCartUI();
      validateSaveEnabled();

      saveStatus.style.display = "block";
      saveStatus.textContent = "Gespeichert ‚úÖ";

      saveOrderBtn.textContent = "‚úÖ Bestellung speichern";
      saveOrderBtn.disabled = true;

      await loadAll();
    }
    saveOrderBtn.addEventListener("click", saveOrder);

    async function archiveOrder(orderId){
      await supabase.from("orders").update({ archived:true }).eq("id", orderId);
      await loadAll();
    }
    async function restoreOrder(orderId){
      await supabase.from("orders").update({ archived:false }).eq("id", orderId);
      await loadAll();
    }
    async function deleteOrder(orderId){
      const ok = confirm("Bist du sicher? Diese Bestellung wird endg√ºltig gel√∂scht.");
      if(!ok) return;

      await supabase.from("order_items").delete().eq("order_id", orderId);
      await supabase.from("orders").delete().eq("id", orderId);
      await loadAll();
    }

    // adjustments
    function adjShowOk(msg){
      adjErr.style.display="none";
      adjMsg.textContent = msg || "Gespeichert ‚úÖ";
      adjMsg.style.display="block";
    }
    function adjShowErr(msg){
      adjMsg.style.display="none";
      adjErr.textContent = msg || "Fehler";
      adjErr.style.display="block";
    }
    function adjClearMsgs(){
      adjMsg.style.display="none";
      adjErr.style.display="none";
    }

    let adjPick = { kind:null, bunnySize:null, otherAmount:null };

    function renderAdjPick(){
      adjPickArea.innerHTML = "";
      adjClearMsgs();

      if(adjPick.kind === "bunny"){
        adjPickArea.innerHTML = `
          <label>Hase: Gr√∂√üe w√§hlen</label>
          <div class="chips">
            <div class="chip" id="adjS20">20 cm</div>
            <div class="chip" id="adjS15">15 cm</div>
            <div class="chip" id="adjS11">11 cm</div>
          </div>
        `;
        ["20","15","11"].forEach(s=>{
          const el = document.getElementById("adjS"+s);
          el.addEventListener("click", ()=>{
            adjPick.bunnySize = s;
            ["20","15","11"].forEach(x=>document.getElementById("adjS"+x).classList.toggle("chipActive", x===s));
          });
        });
      }
      if(adjPick.kind === "combo"){
        adjPickArea.innerHTML = `<div class="hint">Hase-Combo (20+15+11)</div>`;
      }
      if(adjPick.kind === "lumi"){
        adjPickArea.innerHTML = `<div class="hint">Lumi</div>`;
      }
      if(adjPick.kind === "other"){
        adjPickArea.innerHTML = `
          <label>Beliebiger Betrag</label>
          <input id="adjOtherAmount" inputmode="decimal" placeholder="z. B. 5,50" />
        `;
        const inp = document.getElementById("adjOtherAmount");
        inp.addEventListener("input", ()=> adjPick.otherAmount = inp.value );
      }
    }

    soldSumEl.addEventListener("click", ()=>{
      adjPick = { kind:null, bunnySize:null, otherAmount:null };
      adjNote.value = "";
      adjPickArea.innerHTML = `<div class="hint">W√§hle unten eine Option.</div>`;
      adjClearMsgs();
      adjBack.classList.add("open");
    });
    closeAdj.addEventListener("click", ()=> adjBack.classList.remove("open"));
    adjBack.addEventListener("click", (e)=>{ if(e.target===adjBack) adjBack.classList.remove("open"); });

    soldBtnBunny.addEventListener("click", ()=>{ adjPick = { kind:"bunny", bunnySize:null, otherAmount:null }; renderAdjPick(); });
    soldBtnLumi.addEventListener("click", ()=>{ adjPick = { kind:"lumi", bunnySize:null, otherAmount:null }; renderAdjPick(); });
    soldBtnCombo.addEventListener("click", ()=>{ adjPick = { kind:"combo", bunnySize:null, otherAmount:null }; renderAdjPick(); });
    soldBtnOther.addEventListener("click", ()=>{ adjPick = { kind:"other", otherAmount:null }; renderAdjPick(); });

    addAdjBtn.addEventListener("click", async ()=>{
      try{
        adjClearMsgs();
        let amount = null;

        if(adjPick.kind === "bunny"){
          if(!adjPick.bunnySize) return adjShowErr("Bitte Gr√∂√üe w√§hlen.");
          amount = PRICES.bunny[adjPick.bunnySize];
        } else if(adjPick.kind === "lumi"){
          amount = PRICES.lumi;
        } else if(adjPick.kind === "combo"){
          amount = PRICES.bunny.comboAllThree;
        } else if(adjPick.kind === "other"){
          const raw = String(adjPick.otherAmount||"").trim().replace(",",".");
          const n = Number(raw);
          if(!Number.isFinite(n) || n<=0) return adjShowErr("Bitte g√ºltigen Betrag eingeben.");
          amount = n;
        } else {
          return adjShowErr("Bitte zuerst eine Option w√§hlen.");
        }

        const payload = { amount_eur: -Math.abs(Number(amount)||0), note: (adjNote.value||"").trim() || null };
        const { error } = await supabase.from("adjustments").insert(payload);
        if(error) return adjShowErr(error.message);

        adjShowOk("Gespeichert ‚úÖ");
        await loadAll();
      } catch(err){
        adjShowErr(String(err?.message || err));
      }
    });

    // render orders
    function renderOrders(target, orders, { archived }){
      target.innerHTML = "";

      if(orders.length === 0){
        target.innerHTML = `<div class="hint">Keine ${archived ? "Archiv" : "offenen"} Bestellungen.</div>`;
        return;
      }

      for(const o of orders){
        const allItems = o.items || [];
        const sortedAllItems = sortItemsInsideOrder(allItems);

        const items = (archived || !hideDoneItems)
          ? sortedAllItems
          : sortedAllItems.filter(x=>!x.done);

        const total = priceForOrderItems(allItems);
        const date = formatDateOnly(o.created_at);

        const minPr = Math.min(...allItems.map(x=>prioRank(x.priority)).concat([2]));
        const prText = minPr===0 ? "Sehr wichtig" : minPr===1 ? "Wichtig" : "Nicht wichtig";

        const doneCount = allItems.filter(x=>!!x.done).length;
        const totalCount = allItems.length;
        const progressText = `${doneCount}/${totalCount} fertig`;
        const allDone = totalCount > 0 && doneCount === totalCount;

        const card = document.createElement("div");
        card.className = "card pad orderCard";

        const lines = (items.length === 0)
          ? `<div class="hint">${(!archived && hideDoneItems && allItems.length > 0) ? "Alle Positionen sind fertig (ausgeblendet)." : "Keine Positionen."}</div>`
          : items.map(it=>{
              const title =
                it.product==="bunny" ? `Hase ${it.size} cm` :
                it.product==="lumi"  ? `Lumi` : `Weitere Produkt (${it.size||"?"})`;

              const colors = colorText(it);
              const qtyTxt = `√ó ${it.qty}`;
              const pr = prioLabel(it.priority);
              const isDone = !!it.done;
              const doneCls = (!archived && isDone) ? "itemDone" : "";

              return `
                <div class="line ${doneCls}">
                  <div class="row" style="justify-content:space-between; gap:10px; align-items:flex-start;">
                    <div>
                      <div style="font-weight:900">
                        ${esc(title)} <span class="muted">(${esc(pr)})</span>
                      </div>
                      <div class="muted">${esc(colors)}</div>
                    </div>

                    <div class="row" style="gap:12px; align-items:center;">
                      ${
                        archived ? `` : `
                          <label class="doneBox" title="Position fertig?">
                            <input type="checkbox" data-done-id="${esc(it.id)}" ${isDone ? "checked" : ""} />
                            fertig
                          </label>
                        `
                      }
                      <div class="muted" style="font-weight:1000">${esc(qtyTxt)}</div>
                    </div>
                  </div>

                  ${it.note ? `<div class="muted" style="margin-top:4px;">üìù ${esc(it.note)}</div>` : ``}
                </div>
              `;
            }).join(`<div class="sep"></div>`);

        card.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div>
              <div class="row" style="gap:10px; align-items:center; flex-wrap:wrap;">
                <div class="orderTitle">${archived ? "Archiv" : "Offen"} ‚Ä¢ ${esc(date)}</div>
                <div class="pill">${esc(prText)}</div>
                ${archived ? "" : `<div class="badge" title="Fortschritt">${esc(progressText)}</div>`}
              </div>

              ${o.customer_name ? `<div class="muted" style="margin-top:6px;">üë§ ${esc(o.customer_name)}</div>` : ``}
              ${o.note ? `<div class="muted" style="margin-top:6px;">üìù ${esc(o.note)}</div>` : ``}
            </div>

            <div class="row" style="gap:8px; align-items:center;">
              <div style="font-weight:1000">${euro(total)}</div>

              ${
                archived
                  ? `
                    <button class="iconBtn" data-restore="${o.id}" title="Zur√ºck holen">‚Ü©</button>
                    <button class="iconBtn" data-delete="${o.id}" title="L√∂schen">üóë</button>
                  `
                  : `
                    <button class="iconBtn"
                      data-archive="${o.id}"
                      title="${allDone ? "Ins Archiv" : "Erst alle Positionen abhaken"}"
                      ${allDone ? "" : "disabled"}
                      style="${allDone ? "" : "opacity:.45; cursor:not-allowed;"}"
                    >üì¶</button>
                  `
              }
            </div>
          </div>

          <div class="sep"></div>
          ${lines}
        `;

        target.appendChild(card);
      }

      target.querySelectorAll("[data-archive]").forEach(b=>{
        b.addEventListener("click", ()=>{
          if(b.hasAttribute("disabled")) return;
          archiveOrder(b.getAttribute("data-archive"));
        });
      });
      target.querySelectorAll("[data-restore]").forEach(b=>{
        b.addEventListener("click", ()=>restoreOrder(b.getAttribute("data-restore")));
      });
      target.querySelectorAll("[data-delete]").forEach(b=>{
        b.addEventListener("click", ()=>deleteOrder(b.getAttribute("data-delete")));
      });

      target.querySelectorAll('input[type="checkbox"][data-done-id]').forEach(cb=>{
        cb.addEventListener("change", async ()=>{
          const id = cb.getAttribute("data-done-id");
          try{
            await toggleItemDone(id, cb.checked);
            await loadAll();
          }catch(e){
            alert("Fehler: " + (e?.message || e));
            cb.checked = !cb.checked;
          }
        });
      });
    }

    function renderArchive(target, orders){
      target.innerHTML = "";
      if(orders.length===0){
        target.innerHTML = `<div class="hint">Keine archivierten Bestellungen.</div>`;
        return;
      }

      const groups = {};
      for(const o of orders){
        const d = new Date(o.created_at);
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
        if(!groups[key]) groups[key]=[];
        groups[key].push(o);
      }

      const keys = Object.keys(groups).sort().reverse();
      for(const key of keys){
        const [yy,mm] = key.split("-");
        const title = `${mm}.${yy}`;
        const wrap = document.createElement("div");
        wrap.innerHTML = `
          <div class="sep"></div>
          <div class="muted" style="font-weight:1000; margin:8px 0;">${esc(title)}</div>
          <div class="grid" data-month="${esc(key)}"></div>
        `;
        target.appendChild(wrap);

        const grid = wrap.querySelector(`[data-month="${key}"]`);
        renderOrders(grid, groups[key], { archived:true });
      }
    }

    async function loadAll(){
      const { data: orders, error: oErr } = await supabase
        .from("orders")
        .select("id,created_at,customer_name,note,archived")
        .order("created_at", { ascending:false });

      if(oErr){
        openSumEl.textContent = "Fehler: " + oErr.message;
        return;
      }

      const { data: items, error: iErr } = await supabase
        .from("order_items")
        .select("*")
        .order("created_at", { ascending:false });

      if(iErr){
        openSumEl.textContent = "Fehler: " + iErr.message;
        return;
      }

      const { data: adjs } = await supabase
        .from("adjustments")
        .select("*")
        .order("created_at", { ascending:false });

      const map = new Map();
      for(const o of (orders||[])){
        map.set(o.id, { ...o, items: [] });
      }
      for(const it of (items||[])){
        const o = map.get(it.order_id);
        if(o){
          o.items.push({ ...it, colors: it.colors || {} });
        }
      }

      const all = Array.from(map.values());
      const open = all.filter(x=>!x.archived);
      const archived = all.filter(x=>x.archived);

      if(sortMode==="prio"){
        open.sort((a,b)=>{
          const ap = Math.min(...a.items.map(x=>prioRank(x.priority)).concat([2]));
          const bp = Math.min(...b.items.map(x=>prioRank(x.priority)).concat([2]));
          if(ap!==bp) return ap-bp;
          return new Date(b.created_at)-new Date(a.created_at);
        });
      } else {
        open.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
      }

      const openTotal = open.reduce((s,o)=> s + priceForOrderItems(o.items), 0);
      openSumEl.textContent = `Summe offen: ${euro(openTotal)}`;

      const soldTotalRaw = archived.reduce((s,o)=> s + priceForOrderItems(o.items), 0);
      const adjSum = (adjs||[]).reduce((s,a)=> s + Number(a.amount_eur||0), 0);
      const soldFinal = soldTotalRaw + adjSum;

      soldSumEl.textContent = `Verkauft gesamt: ${euro(soldFinal)} (klicken f√ºr Korrektur/Abzug)`;

      renderOrders(openOrdersEl, open, { archived:false });
      renderArchive(archiveOrdersEl, archived);
    }

    // modal close
    closeModal.addEventListener("click", ()=>{ modalBack.classList.remove("open"); });
    modalBack.addEventListener("click", (e)=>{ if(e.target===modalBack) modalBack.classList.remove("open"); });

    // start
    setActiveView("orders");
    setProduct("bunny");
    cart = [];
    updateCartUI();
    validateSaveEnabled();
    await loadAll();
  </script>
</body>
</html>


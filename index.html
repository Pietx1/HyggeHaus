<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HyggeHaus ‚Ä¢ Bestellungen</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --dark:#0f172a;
      --dark2:#111827;
      --danger:#b91c1c;
      --ok:#047857;
      --warn:#b45309;
      --radius:18px;
      --soft:#f1f5f9;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .container{ max-width:1100px; margin:0 auto; padding:24px; }
    h1{ margin:0; font-size:34px; letter-spacing:-.02em; }
    .topbar{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; margin-bottom:18px; }
    .hint{ color:var(--muted); font-size:13px; }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .pad{ padding:18px; }
    .sep{ height:1px; background:var(--border); margin:14px 0; }

    .title2{ font-size:18px; font-weight:900; margin:0 0 8px; }
    label{ font-weight:900; font-size:13px; display:block; margin:0 0 6px; }

    /* iOS Zoom-Fix: inputs >=16px */
    input, textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius:14px;
      padding:11px 14px;
      font-size:16px; /* ‚úÖ wichtig gegen iPhone Zoom */
      outline:none;
      background:#fff;
    }
    textarea{ min-height:90px; resize:vertical; }
    input:focus, textarea:focus{ border-color:#c7d2fe; box-shadow:0 0 0 4px rgba(99,102,241,.12); }

    .grid{ display:grid; gap:14px; }
    @media(min-width:900px){
      .grid-2{ grid-template-columns:repeat(2,1fr); }
      .grid-3{ grid-template-columns:repeat(3,1fr); }
    }

    .btn{
      border:0;
      cursor:pointer;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      font-size:14px;
      background:var(--dark2);
      color:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .btnSmall{ padding:8px 10px; border-radius:12px; font-size:13px; }
    .btnSoft{
      background:#fff;
      border:1px solid var(--border);
      color:var(--text);
      font-weight:900;
    }
    .btnDark{ background:linear-gradient(180deg, #0b1220, #0f172a); }

    .chips{ display:flex; gap:10px; flex-wrap:wrap; }
    .chip{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      padding:11px 14px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      min-width:108px;
      text-align:center;
    }
    .chip.active{
      background:linear-gradient(180deg, #0b1220, #0f172a);
      color:#fff;
      border-color:#0f172a;
    }

    .prioRow{ display:flex; gap:10px; align-items:stretch; }
    .prioBtn{
      flex:1;
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      padding:10px 12px;
      text-align:center;
      user-select:none;
    }
    .prioBtn.small{ flex:.85; }
    .prioBtn.big{ flex:1.3; }
    .prioBtn.active{ background:var(--dark2); color:#fff; border-color:var(--dark2); }

    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .muted{ color:var(--muted); font-size:13px; }

    .status{ margin-top:10px; font-size:13px; color:var(--muted); }
    .error{ color:var(--danger); font-weight:900; }
    .ok{ color:var(--ok); font-weight:900; }

    /* Dropdown */
    .ddWrap{ position:relative; }
    .ddBtn{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      background:none;
      border:none;
      font-size:18px;
      cursor:pointer;
      z-index:3;
    }
    .ddInput{ padding-right:36px; }
    .ddMenu{
      position:absolute;
      top:100%;
      left:0; right:0;
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      margin-top:4px;
      max-height:200px;
      overflow:auto;
      display:none;
      z-index:999;
    }
    .ddMenu.open{ display:block; }
    .ddItem{ padding:10px 12px; cursor:pointer; }
    .ddItem:hover{ background:var(--soft); }
    .ddEmpty{ padding:10px; color:var(--muted); }

    /* Orders cards */
    .orderCard{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .orderTitle{ font-weight:1000; }

    .badge{
      font-size:12px;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      white-space:nowrap;
    }
    .badge.ok{ border-color:#bbf7d0; background:#f0fdf4; color:#166534; }
    .badge.warn{ border-color:#fed7aa; background:#fff7ed; color:#9a3412; }
    .badge.bad{ border-color:#fecaca; background:#fff1f2; color:#991b1b; }
    .badge.neutral{ border-color:#e5e7eb; background:#f9fafb; color:#111827; }

    .iconBtn{
      border:1px solid var(--border);
      background:#fff;
      width:36px; height:36px;
      border-radius:12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
    }
    .iconBtn:hover{ background:#f9fafb; }
    .iconBtn.danger{ border-color:#fecaca; color:#991b1b; }

    details.archive > summary{
      cursor:pointer;
      user-select:none;
      font-weight:900;
      color:#1f3a8a;
    }

    /* Farben untereinander */
    .colorsStack{ display:grid; gap:2px; margin-top:4px; }
    .colorsStack div{ line-height:1.25; }

    /* Produziert checkbox look */
    .prodBox{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      font-weight:900;
    }
    .prodMark{
      width:22px; height:22px;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:2px solid #ef4444;
      color:#ef4444;
      background:#fff;
      line-height:1;
      font-size:14px;
    }
    .prodBox.done .prodMark{
      border-color:#16a34a;
      background:#16a34a;
      color:#fff;
    }

    /* Price field (opens NumPad) */
    .pricePick{
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      padding:11px 14px;
      font-size:16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
      user-select:none;
    }
    .pricePick .muted{ font-size:13px; }

    /* NumPad Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:99999;
      padding:14px;
    }
    .modalBack.open{ display:flex; }
    .modal{
      width:min(520px, 100%);
      background:#fff;
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--border);
      background:#fff;
    }
    .modalTitle{ font-weight:1000; }
    .modalBody{ padding:14px; }
    .numDisplay{
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      font-size:22px;
      font-weight:1000;
      text-align:right;
      background:#fff;
    }
    .numGrid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
      margin-top:12px;
    }
    .numBtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      padding:14px 0;
      font-size:18px;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
      text-align:center;
    }
    .numBtn:active{ transform:scale(.98); }
    .numBtn.dark{ background:var(--dark2); color:#fff; border-color:var(--dark2); }
    .numBtn.soft{ background:var(--soft); }
    .numActions{
      display:flex;
      gap:10px;
      margin-top:12px;
    }
    .numActions .numBtn{ flex:1; }

  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <h1>Bestellungen</h1>
      <div class="hint">GitHub Pages ‚Ä¢ Supabase</div>
    </div>

    <!-- NEUE BESTELLUNG -->
    <div class="card">
      <div class="pad">
        <div class="chips">
          <div class="chip" id="btnBunny">üê∞ Hase</div>
          <div class="chip" id="btnLumi">‚ú®ü™≤ Lumi</div>
          <div class="chip" id="btnText">üñäÔ∏è Schriftzug</div>
          <div class="chip" id="btnOther">‚ûï Weitere Produkt</div>
        </div>

        <div style="height:10px"></div>
        <div class="title2" id="newTitle">Neue Bestellung</div>

        <div id="productArea"></div>
        <div class="sep"></div>

        <div id="colorArea"></div>
        <div class="sep"></div>

        <div id="priceArea"></div>
        <div class="sep"></div>

        <label>Priorit√§t</label>
        <div class="prioRow">
          <div class="prioBtn small" id="pVery">Sehr wichtig</div>
          <div class="prioBtn big" id="pNorm">Wichtig</div>
          <div class="prioBtn small" id="pLow">Nicht wichtig</div>
        </div>

        <div class="sep"></div>

        <div class="grid grid-2">
          <div>
            <label for="customer">Kundenname <span class="muted">(bei Schriftzug Pflicht)</span></label>
            <input id="customer" placeholder="z. B. Max Mustermann" />
          </div>

          <div>
            <label for="note">Beschreibung (optional)</label>
            <textarea id="note" placeholder="z. B. Sonderwunsch, Hinweis ‚Ä¶"></textarea>
          </div>
        </div>

        <div class="sep"></div>

        <label>Menge</label>
        <div class="chips" id="qtyRow" style="gap:10px;">
          <div class="chip qtyBtn" data-q="1">1</div>
          <div class="chip qtyBtn" data-q="2">2</div>
          <div class="chip qtyBtn" data-q="3">3</div>
          <div class="chip qtyBtn" data-q="4">4</div>
          <div class="chip qtyBtn" data-q="5">5</div>
          <div class="chip qtyBtn" data-q="6">6</div>
          <div class="chip qtyBtn" data-q="7">7</div>
          <div class="chip qtyBtn" data-q="8">8</div>
          <div class="chip qtyBtn" data-q="9">9</div>
        </div>

        <div class="grid grid-2" style="align-items:end; margin-top:10px;">
          <div>
            <label for="qtyOther">Andere Menge (optional)</label>
            <input id="qtyOther" inputmode="numeric" placeholder="z. B. 12" />
          </div>

          <div style="display:flex; justify-content:flex-end;">
            <button class="btn btnDark" id="addItemBtn" style="min-width:280px;">+ Position hinzuf√ºgen</button>
          </div>
        </div>

        <div class="status">
          <div class="error" id="formError" style="display:none;">Bitte erst ausf√ºllen.</div>
          <div class="muted" id="missing" style="display:none;"></div>
        </div>

        <div class="sep"></div>

        <div class="row" style="justify-content:space-between; align-items:flex-end;">
          <div class="title2" style="margin:0;">Positionen in dieser Bestellung</div>
          <div class="muted" id="cartSum">Summe: 0,00 ‚Ç¨</div>
        </div>

        <div id="cartList" class="grid" style="margin-top:10px;"></div>
        <div class="muted" id="cartHint">Noch keine Position hinzugef√ºgt.</div>

        <div class="sep"></div>

        <button id="saveOrderBtn" class="btn" disabled>‚úÖ Bestellung speichern</button>
        <div class="ok" id="saveStatus" style="display:none; margin-top:10px;">Gespeichert ‚úÖ</div>
      </div>
    </div>

    <div style="height:16px"></div>

    <!-- OFFENE BESTELLUNGEN -->
    <div class="card">
      <div class="pad">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div class="title2" style="margin:0;">Offene Bestellungen</div>
            <div class="muted" id="openSum">Summe offen: 0,00 ‚Ç¨</div>
          </div>

          <div class="row" style="gap:10px;">
            <button class="btnSmall btnDark" id="sortDate">Sort: Datum</button>
            <button class="btnSmall btnSoft" id="sortPrio">Sort: Priorit√§t</button>
          </div>
        </div>

        <div class="sep"></div>
        <div id="openOrders" class="grid"></div>

        <div class="sep"></div>

        <details class="archive">
          <summary>Archiv (alte Bestellungen anzeigen)</summary>
          <div style="margin-top:10px;">
            <div class="muted" id="archivedTotal">Archiv gesamt: 0,00 ‚Ç¨</div>
            <div style="height:8px"></div>
            <div id="archiveOrders" class="grid"></div>
          </div>
        </details>
      </div>
    </div>

  </div>

  <!-- NumPad Modal -->
  <div class="modalBack" id="numPadBack">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="modalTitle" id="numPadTitle">Preis eingeben</div>
        <button class="iconBtn" id="numPadClose" title="Schlie√üen">‚úñ</button>
      </div>
      <div class="modalBody">
        <div class="numDisplay" id="numPadDisplay">0</div>

        <div class="numGrid">
          <div class="numBtn" data-k="1">1</div>
          <div class="numBtn" data-k="2">2</div>
          <div class="numBtn" data-k="3">3</div>
          <div class="numBtn" data-k="4">4</div>
          <div class="numBtn" data-k="5">5</div>
          <div class="numBtn" data-k="6">6</div>
          <div class="numBtn" data-k="7">7</div>
          <div class="numBtn" data-k="8">8</div>
          <div class="numBtn" data-k="9">9</div>
          <div class="numBtn soft" data-k="del">‚å´</div>
          <div class="numBtn" data-k="0">0</div>
          <div class="numBtn soft" data-k=".">,</div>
        </div>

        <div class="numActions">
          <div class="numBtn soft" id="numPadClear">Clear</div>
          <div class="numBtn dark" id="numPadOk">OK</div>
        </div>
      </div>
    </div>
  </div>

  <!-- TEIL 2/3 kommt danach -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ‚úÖ Supabase
    const SUPABASE_URL = "https://htgrzmlcdolxxzvkppon.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0Z3J6bWxjZG9seHh6dmtwcG9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MzM2ODIsImV4cCI6MjA4NTAwOTY4Mn0.B0PxMAzmuvsHNd2n_mgNspjlPkaBpQlkrNzGu7p78fY";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------------- constants ----------------
    const COLOR_SUGGESTIONS = [
      "wei√ü","schwarz","grau","dunkelgrau","hellgrau",
      "beige","creme","braun","oak",
      "rot","orange","gelb","gr√ºn","blau","lila",
      "pink","rosa","gold","silber"
    ];

    const PRICES = {
      bunny: { "20": 12.0, "15": 9.0, "11": 6.0, comboAllThree: 22.50 },
      lumi: 8.50
    };

    // ---------------- helpers ----------------
    const euro = (n)=> (Number(n)||0).toFixed(2).replace(".", ",") + " ‚Ç¨";
    const esc = (s)=> String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    const norm = (s)=> String(s||"").trim().toLowerCase();
    const num = (s)=> {
      const t = String(s??"").trim().replace(",", ".");
      const n = Number(t);
      return Number.isFinite(n) ? n : NaN;
    };

    function setChip(el, on){ el?.classList.toggle("active", !!on); }
    function show(el){ el.style.display="block"; }
    function hide(el){ el.style.display="none"; el.textContent=""; }
    function showErr(el,msg){ el.style.display="block"; el.textContent=msg; }

    // ---------------- dropdown ----------------
    function buildDropdown({ id, label, placeholder }){
      return `
        <div class="field" data-dd-wrap="${id}">
          <label for="${id}">${esc(label)}</label>
          <div class="ddWrap">
            <input id="${id}" class="ddInput" placeholder="${esc(placeholder)}" autocomplete="off" />
            <button type="button" class="ddBtn" aria-label="Dropdown √∂ffnen" data-dd-btn="${id}">‚ñæ</button>
            <div class="ddMenu" data-dd-menu="${id}"></div>
          </div>
        </div>
      `;
    }

    function setupDropdown(inputId, onChange){
      const input = document.getElementById(inputId);
      const menu  = document.querySelector(`[data-dd-menu="${inputId}"]`);
      const btn   = document.querySelector(`[data-dd-btn="${inputId}"]`);
      const wrap  = document.querySelector(`[data-dd-wrap="${inputId}"]`);
      if(!input || !menu || !btn || !wrap) return;

      function renderMenu(filter=""){
        const f = filter.trim().toLowerCase();
        const list = COLOR_SUGGESTIONS.filter(x => x.toLowerCase().includes(f));
        menu.innerHTML = list.length
          ? list.map(x=>`<div class="ddItem" data-val="${esc(x)}">${esc(x)}</div>`).join("")
          : `<div class="ddEmpty">Keine Vorschl√§ge</div>`;

        menu.querySelectorAll(".ddItem").forEach(it=>{
          it.addEventListener("click", ()=>{
            const v = it.getAttribute("data-val") || "";
            input.value = v;
            menu.classList.remove("open");
            onChange?.(v);
          });
        });
      }

      input.addEventListener("input", ()=>{
        if(menu.classList.contains("open")) renderMenu(input.value||"");
        onChange?.(input.value||"");
      });

      btn.addEventListener("click", (e)=>{
        e.preventDefault(); e.stopPropagation();
        menu.classList.toggle("open");
        if(menu.classList.contains("open")) renderMenu(input.value||"");
        input.focus();
      });

      document.addEventListener("click", (e)=>{
        if(!wrap.contains(e.target)) menu.classList.remove("open");
      });
    }

    // ---------------- NumPad Modal ----------------
    const numPadBack = document.getElementById("numPadBack");
    const numPadTitle = document.getElementById("numPadTitle");
    const numPadDisplay = document.getElementById("numPadDisplay");
    const numPadClose = document.getElementById("numPadClose");
    const numPadOk = document.getElementById("numPadOk");
    const numPadClear = document.getElementById("numPadClear");

    let numPadValue = "0";
    let numPadResolve = null;

    function openNumPad({ title, startValue }){
      numPadTitle.textContent = title || "Eingabe";
      numPadValue = String(startValue ?? "0").trim();
      if(numPadValue === "") numPadValue = "0";
      numPadDisplay.textContent = numPadValue.replace(".", ",");

      numPadBack.classList.add("open");

      return new Promise((resolve)=>{
        numPadResolve = resolve;
      });
    }

    function closeNumPad(result){
      numPadBack.classList.remove("open");
      const r = numPadResolve;
      numPadResolve = null;
      if(r) r(result);
    }

    function setDisplay(){
      numPadDisplay.textContent = numPadValue.replace(".", ",");
    }

    numPadBack.querySelectorAll("[data-k]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const k = b.getAttribute("data-k");
        if(k === "del"){
          numPadValue = numPadValue.length <= 1 ? "0" : numPadValue.slice(0, -1);
          if(numPadValue === "-" || numPadValue === "") numPadValue = "0";
          setDisplay();
          return;
        }
        if(k === "."){
          if(!numPadValue.includes(".")) numPadValue += ".";
          setDisplay();
          return;
        }
        // digits
        if(numPadValue === "0") numPadValue = k;
        else numPadValue += k;
        setDisplay();
      });
    });

    numPadClear.addEventListener("click", ()=>{
      numPadValue = "0";
      setDisplay();
    });

    numPadClose.addEventListener("click", ()=> closeNumPad(null));
    numPadBack.addEventListener("click", (e)=>{
      if(e.target === numPadBack) closeNumPad(null);
    });

    numPadOk.addEventListener("click", ()=>{
      const v = num(numPadValue);
      if(!Number.isFinite(v)) return alert("Ung√ºltige Zahl.");
      closeNumPad(v);
    });

    // ---------------- DOM ----------------
    const btnBunny = document.getElementById("btnBunny");
    const btnLumi  = document.getElementById("btnLumi");
    const btnText  = document.getElementById("btnText");
    const btnOther = document.getElementById("btnOther");

    const newTitle = document.getElementById("newTitle");
    const productArea = document.getElementById("productArea");
    const colorArea = document.getElementById("colorArea");
    const priceArea = document.getElementById("priceArea");

    const pVery = document.getElementById("pVery");
    const pNorm = document.getElementById("pNorm");
    const pLow  = document.getElementById("pLow");

    const customer = document.getElementById("customer");
    const noteEl   = document.getElementById("note");

    const qtyOther = document.getElementById("qtyOther");
    const addItemBtn = document.getElementById("addItemBtn");

    const cartList = document.getElementById("cartList");
    const cartHint = document.getElementById("cartHint");
    const cartSum  = document.getElementById("cartSum");

    const saveOrderBtn = document.getElementById("saveOrderBtn");
    const saveStatus   = document.getElementById("saveStatus");

    const formError = document.getElementById("formError");
    const missingEl = document.getElementById("missing");

    const openOrdersEl = document.getElementById("openOrders");
    const archiveOrdersEl = document.getElementById("archiveOrders");
    const openSumEl = document.getElementById("openSum");
    const archivedTotalEl = document.getElementById("archivedTotal");

    const sortDate = document.getElementById("sortDate");
    const sortPrio = document.getElementById("sortPrio");

    // ---------------- state ----------------
    let currentProduct = null; // bunny | lumi | text | other
    let priority = null;       // very|normal|low
    let qty = null;
    let sortMode = "date";

    // bunny specifics
    let bunnySize = null; // 20|15|11
    let bunnyMode = null; // single|multi

    // price for ‚Äútext‚Äù and ‚Äúother‚Äù (required)
    let customUnitPrice = null;

    const fields = {
      bunny_single:"",
      bunny_ears:"", bunny_body:"", bunny_butt:"",
      lumi_body:"", lumi_wings:"", lumi_feelers:"",
      text_name:"", text_size:"", text_main:"", text_second:"",
      other_name:"", other_size:"", other_main:"", other_second:"",
    };

    let cart = [];

    function setChipActive(el,on){ el?.classList.toggle("active", !!on); }
    function setPrioActive(el,on){ el?.classList.toggle("active", !!on); }

    function showMissing(msg){
      formError.style.display="block";
      missingEl.style.display="block";
      missingEl.textContent = msg;
    }
    function clearErrorUI(){
      formError.style.display="none";
      missingEl.style.display="none";
      missingEl.textContent="";
    }

    function prioLabel(p){
      if(p==="very") return "Sehr wichtig";
      if(p==="normal") return "Wichtig";
      return "Nicht wichtig";
    }
    function prioRank(p){
      if(p==="very") return 0;
      if(p==="normal") return 1;
      return 2;
    }

    function formatDateOnly(iso){
      const d = new Date(iso);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}.${mm}.${yy}`;
    }

    function buildPricePick({ id, label, valueText, hint }){
      return `
        <div class="field">
          <label>${esc(label)}</label>
          <div class="pricePick" id="${esc(id)}">
            <div style="font-weight:1000">${esc(valueText || "Preis w√§hlen‚Ä¶")}</div>
            <div class="muted">${esc(hint || "NumPad")}</div>
          </div>
        </div>
      `;
    }

    function colorTextStack(it){
      const c = it.colors || {};
      if(it.product==="bunny"){
        if(it.mode==="single"){
          return `<div class="colorsStack muted"><div><b>Einfarbig:</b> ${esc(c.single||"")}</div></div>`;
        }
        return `
          <div class="colorsStack muted">
            <div><b>Ohren:</b> ${esc(c.ears||"")}</div>
            <div><b>K√∂rper:</b> ${esc(c.body||"")}</div>
            <div><b>Popo:</b> ${esc(c.butt||"")}</div>
          </div>
        `;
      }
      if(it.product==="lumi"){
        return `
          <div class="colorsStack muted">
            <div><b>K√∂rper:</b> ${esc(c.body||"")}</div>
            <div><b>Fl√ºgel:</b> ${esc(c.wings||"")}</div>
            <div><b>F√ºhler:</b> ${esc(c.feelers||"")}</div>
          </div>
        `;
      }
      // text/other
      return `
        <div class="colorsStack muted">
          ${it.size ? `<div><b>Gr√∂√üe:</b> ${esc(it.size)}</div>` : ``}
          ${c.main ? `<div><b>Hauptfarbe:</b> ${esc(c.main)}</div>` : ``}
          ${c.second ? `<div><b>2. Farbe:</b> ${esc(c.second)}</div>` : ``}
        </div>
      `;
    }

    function buildItemTitle(it){
      if(it.product==="bunny") return `Hase ${it.size} cm`;
      if(it.product==="lumi") return `Lumi`;
      if(it.product==="text") return `Schriftzug: ${it.name || ""}`.trim();
      return `Weitere Produkt: ${it.name || ""}`.trim();
    }

    // ---------------- UI render: product area ----------------
    function renderProductArea(){
      productArea.innerHTML = "";
      colorArea.innerHTML = "";
      priceArea.innerHTML = "";
      customUnitPrice = null;

      if(currentProduct==="bunny"){
        newTitle.textContent = "Neue Bestellung: Hase";
        productArea.innerHTML = `
          <div>
            <label>Gr√∂√üe</label>
            <div class="chips">
              <div class="chip" id="size20">20 cm</div>
              <div class="chip" id="size15">15 cm</div>
              <div class="chip" id="size11">11 cm</div>
            </div>
          </div>
          <div class="sep"></div>
          <div>
            <label>Farbmodus</label>
            <div class="chips">
              <div class="chip" id="modeMulti">Mehrfarbig</div>
              <div class="chip" id="modeSingle">Einfarbig</div>
            </div>
          </div>
        `;

        const s20 = document.getElementById("size20");
        const s15 = document.getElementById("size15");
        const s11 = document.getElementById("size11");
        [s20,s15,s11].forEach(el=>{
          el.addEventListener("click", ()=>{
            bunnySize = el.id==="size20" ? "20" : el.id==="size15" ? "15" : "11";
            [s20,s15,s11].forEach(x=>setChipActive(x, x===el));
            validateForAdd();
          });
        });

        const mMulti = document.getElementById("modeMulti");
        const mSingle= document.getElementById("modeSingle");
        [mMulti,mSingle].forEach(el=>{
          el.addEventListener("click", ()=>{
            bunnyMode = (el.id==="modeSingle") ? "single" : "multi";
            [mMulti,mSingle].forEach(x=>setChipActive(x, x===el));
            fields.bunny_single=""; fields.bunny_ears=""; fields.bunny_body=""; fields.bunny_butt="";
            renderColorArea();
            validateForAdd();
          });
        });

        renderColorArea();
        renderPriceArea();
        return;
      }

      if(currentProduct==="lumi"){
        newTitle.textContent = "Neue Bestellung: Lumi";
        productArea.innerHTML = `<div class="muted">Lumi hat keine Gr√∂√üe ‚Äì w√§hle Farben.</div>`;
        renderColorArea();
        renderPriceArea();
        return;
      }

      if(currentProduct==="text"){
        newTitle.textContent = "Neue Bestellung: Schriftzug";
        productArea.innerHTML = `
          <div class="grid grid-2">
            <div>
              <label for="text_name">Name *</label>
              <input id="text_name" placeholder="z. B. Sophia" />
            </div>
            <div>
              <label for="text_size">Gr√∂√üe *</label>
              <input id="text_size" placeholder="z. B. 10 cm / klein / XL" />
            </div>
          </div>
        `;
        const tn = document.getElementById("text_name");
        const ts = document.getElementById("text_size");
        tn.addEventListener("input", ()=>{ fields.text_name = tn.value||""; validateForAdd(); });
        ts.addEventListener("input", ()=>{ fields.text_size = ts.value||""; validateForAdd(); });

        renderColorArea();
        renderPriceArea();
        return;
      }

      if(currentProduct==="other"){
        newTitle.textContent = "Neue Bestellung: Weitere Produkt";
        productArea.innerHTML = `
          <div class="grid grid-2">
            <div>
              <label for="other_name">Name *</label>
              <input id="other_name" placeholder="z. B. Schl√ºsselanh√§nger" />
            </div>
            <div>
              <label for="other_size">Gr√∂√üe *</label>
              <input id="other_size" placeholder="z. B. 10 cm / gro√ü / XL" />
            </div>
          </div>
        `;
        const on = document.getElementById("other_name");
        const os = document.getElementById("other_size");
        on.addEventListener("input", ()=>{ fields.other_name = on.value||""; validateForAdd(); });
        os.addEventListener("input", ()=>{ fields.other_size = os.value||""; validateForAdd(); });

        renderColorArea();
        renderPriceArea();
        return;
      }
    }

    function renderColorArea(){
      colorArea.innerHTML = "";

      if(currentProduct==="bunny"){
        if(bunnyMode==="single"){
          colorArea.innerHTML = `
            <div class="grid">
              ${buildDropdown({ id:"bunny_single", label:"Einfarbig", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
            </div>
          `;
          setupDropdown("bunny_single", v=>{ fields.bunny_single=v; validateForAdd(); });
          return;
        }
        if(bunnyMode==="multi"){
          colorArea.innerHTML = `
            <div class="grid grid-3">
              ${buildDropdown({ id:"bunny_ears", label:"Ohren", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
              ${buildDropdown({ id:"bunny_body", label:"K√∂rper", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
              ${buildDropdown({ id:"bunny_butt", label:"Popo",  placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
            </div>
          `;
          setupDropdown("bunny_ears", v=>{ fields.bunny_ears=v; validateForAdd(); });
          setupDropdown("bunny_body", v=>{ fields.bunny_body=v; validateForAdd(); });
          setupDropdown("bunny_butt", v=>{ fields.bunny_butt=v; validateForAdd(); });
          return;
        }
        colorArea.innerHTML = `<div class="muted">Bitte zuerst <b>Farbmodus</b> w√§hlen.</div>`;
        return;
      }

      if(currentProduct==="lumi"){
        colorArea.innerHTML = `
          <div class="grid grid-3">
            ${buildDropdown({ id:"lumi_body",   label:"K√∂rper", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
            ${buildDropdown({ id:"lumi_wings",  label:"Fl√ºgel", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
            ${buildDropdown({ id:"lumi_feelers",label:"F√ºhler", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
          </div>
        `;
        setupDropdown("lumi_body",   v=>{ fields.lumi_body=v; validateForAdd(); });
        setupDropdown("lumi_wings",  v=>{ fields.lumi_wings=v; validateForAdd(); });
        setupDropdown("lumi_feelers",v=>{ fields.lumi_feelers=v; validateForAdd(); });
        return;
      }

      if(currentProduct==="text"){
        colorArea.innerHTML = `
          <div class="grid grid-2">
            ${buildDropdown({ id:"text_main", label:"Hauptfarbe *", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
            ${buildDropdown({ id:"text_second", label:"2. Farbe *", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
          </div>
        `;
        setupDropdown("text_main", v=>{ fields.text_main=v; validateForAdd(); });
        setupDropdown("text_second", v=>{ fields.text_second=v; validateForAdd(); });
        return;
      }

      if(currentProduct==="other"){
        colorArea.innerHTML = `
          <div class="grid grid-2">
            ${buildDropdown({ id:"other_main", label:"Hauptfarbe *", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
            ${buildDropdown({ id:"other_second", label:"2. Farbe *", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
          </div>
        `;
        setupDropdown("other_main", v=>{ fields.other_main=v; validateForAdd(); });
        setupDropdown("other_second", v=>{ fields.other_second=v; validateForAdd(); });
        return;
      }
    }

    function renderPriceArea(){
      priceArea.innerHTML = "";

      if(currentProduct==="text" || currentProduct==="other"){
        const label = "Preis pro St√ºck *";
        const valueText = (customUnitPrice==null) ? "Preis w√§hlen‚Ä¶" : euro(customUnitPrice);
        priceArea.innerHTML = buildPricePick({
          id:"pickPrice",
          label,
          valueText,
          hint:"NumPad"
        });

        document.getElementById("pickPrice").addEventListener("click", async ()=>{
          const v = await openNumPad({
            title: "Preis pro St√ºck (‚Ç¨)",
            startValue: customUnitPrice==null ? "0" : String(customUnitPrice)
          });
          if(v==null) return;
          customUnitPrice = v;
          renderPriceArea();
          validateForAdd();
        });
        return;
      }

      // bunny/lumi: kein Pflichtpreis-Feld (Standardpreise)
      priceArea.innerHTML = `<div class="muted">Preis: Standard (sp√§ter per ‚úè pro Position √§nderbar)</div>`;
    }
    // ---------------- selection + priority + qty ----------------
    function resetSelections(){
      priority=null; qty=null;
      qtyOther.value="";
      customer.value="";
      noteEl.value="";

      bunnySize=null; bunnyMode=null;
      customUnitPrice=null;

      // clear fields
      for(const k of Object.keys(fields)) fields[k]="";

      clearErrorUI();
      [pVery,pNorm,pLow].forEach(x=>setPrioActive(x,false));
      document.querySelectorAll(".qtyBtn").forEach(b=>b.classList.remove("active"));
    }

    function setProduct(p){
      currentProduct=p;
      [btnBunny,btnLumi,btnText,btnOther].forEach(x=>setChipActive(x,false));
      setChipActive(btnBunny, p==="bunny");
      setChipActive(btnLumi,  p==="lumi");
      setChipActive(btnText,  p==="text");
      setChipActive(btnOther, p==="other");

      resetSelections();
      renderProductArea();
      validateForAdd();
      validateSaveEnabled();
    }

    btnBunny.addEventListener("click", ()=>setProduct("bunny"));
    btnLumi .addEventListener("click", ()=>setProduct("lumi"));
    btnText .addEventListener("click", ()=>setProduct("text"));
    btnOther.addEventListener("click", ()=>setProduct("other"));

    pVery.addEventListener("click", ()=>{
      priority="very";
      [pVery,pNorm,pLow].forEach(x=>setPrioActive(x,false));
      setPrioActive(pVery,true);
      validateForAdd();
    });
    pNorm.addEventListener("click", ()=>{
      priority="normal";
      [pVery,pNorm,pLow].forEach(x=>setPrioActive(x,false));
      setPrioActive(pNorm,true);
      validateForAdd();
    });
    pLow.addEventListener("click", ()=>{
      priority="low";
      [pVery,pNorm,pLow].forEach(x=>setPrioActive(x,false));
      setPrioActive(pLow,true);
      validateForAdd();
    });

    document.querySelectorAll(".qtyBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        qty = Number(btn.getAttribute("data-q"));
        document.querySelectorAll(".qtyBtn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        validateForAdd();
      });
    });
    qtyOther.addEventListener("input", ()=> validateForAdd());

    function getQty(){
      const otherQ = Number(String(qtyOther.value||"").replace(",", "."));
      if(Number.isFinite(otherQ) && otherQ>0) return Math.floor(otherQ);
      if(typeof qty==="number" && qty>0) return qty;
      return null;
    }

    // ---------------- validation ----------------
    function requiredOk(){
      const missing = [];
      const q = getQty();

      if(!currentProduct) missing.push("Produkt");
      if(!priority) missing.push("Priorit√§t");
      if(!q) missing.push("Menge");

      const cust = (customer.value||"").trim();
      // Schriftzug: Kunde Pflicht
      if(currentProduct==="text" && !cust) missing.push("Kundenname");

      if(currentProduct==="bunny"){
        if(!bunnySize) missing.push("Gr√∂√üe");
        if(!bunnyMode) missing.push("Farbmodus");
        if(bunnyMode==="single" && !norm(fields.bunny_single)) missing.push("Einfarbig");
        if(bunnyMode==="multi"){
          if(!norm(fields.bunny_ears)) missing.push("Ohren");
          if(!norm(fields.bunny_body)) missing.push("K√∂rper");
          if(!norm(fields.bunny_butt)) missing.push("Popo");
        }
      }

      if(currentProduct==="lumi"){
        if(!norm(fields.lumi_body)) missing.push("K√∂rper");
        if(!norm(fields.lumi_wings)) missing.push("Fl√ºgel");
        if(!norm(fields.lumi_feelers)) missing.push("F√ºhler");
      }

      if(currentProduct==="text"){
        if(!norm(fields.text_name)) missing.push("Name");
        if(!norm(fields.text_size)) missing.push("Gr√∂√üe");
        if(!norm(fields.text_main)) missing.push("Hauptfarbe");
        if(!norm(fields.text_second)) missing.push("2. Farbe");
        if(!(Number.isFinite(customUnitPrice) && customUnitPrice>=0)) missing.push("Preis pro St√ºck");
      }

      if(currentProduct==="other"){
        if(!norm(fields.other_name)) missing.push("Name");
        if(!norm(fields.other_size)) missing.push("Gr√∂√üe");
        if(!norm(fields.other_main)) missing.push("Hauptfarbe");
        if(!norm(fields.other_second)) missing.push("2. Farbe");
        if(!(Number.isFinite(customUnitPrice) && customUnitPrice>=0)) missing.push("Preis pro St√ºck");
      }

      return missing;
    }

    function validateForAdd(){
      clearErrorUI();
      const missing = requiredOk();
      if(missing.length){
        showMissing("Bitte erst ausf√ºllen: " + missing.join(", "));
        return false;
      }
      return true;
    }

    function validateSaveEnabled(){
      saveOrderBtn.disabled = (cart.length===0);
    }

    // ---------------- pricing rules ----------------
    function itemBasePrice(it){
      if(it.product==="bunny") return PRICES.bunny[String(it.size)] || 0;
      if(it.product==="lumi") return PRICES.lumi;
      // text/other: must have price_override
      return Number(it.price_override || 0);
    }

    function priceForItems(items){
      // bunny combo nur wenn KEIN bunny override existiert
      let total = 0;

      // text/other + lumi (inkl. overrides)
      for(const it of items){
        if(it.product!=="bunny"){
          const unit = (it.price_override!=null ? Number(it.price_override) : itemBasePrice(it));
          total += unit * Number(it.qty||0);
        }
      }

      const bunny = items.filter(x=>x.product==="bunny");
      const anyOverride = bunny.some(x=>x.price_override!=null);

      if(anyOverride){
        for(const it of bunny){
          const unit = (it.price_override!=null ? Number(it.price_override) : itemBasePrice(it));
          total += unit * Number(it.qty||0);
        }
        return total;
      }

      const counts = { "20":0, "15":0, "11":0 };
      for(const it of bunny) counts[String(it.size)] += Number(it.qty||0);

      const combos = Math.min(counts["20"], counts["15"], counts["11"]);
      if(combos>0){
        total += combos * PRICES.bunny.comboAllThree;
        counts["20"] -= combos; counts["15"] -= combos; counts["11"] -= combos;
      }
      total += counts["20"] * PRICES.bunny["20"];
      total += counts["15"] * PRICES.bunny["15"];
      total += counts["11"] * PRICES.bunny["11"];
      return total;
    }

    function cartTotal(){ return priceForItems(cart); }

    // ---------------- make item ----------------
    function makeItem(){
      const q = getQty();
      const item = {
        _cid: String(Date.now()) + "-" + Math.random().toString(16).slice(2),
        product: currentProduct,
        name: null,
        size: null,
        mode: null,
        colors: {},
        qty: q,
        priority,
        customer_name: (customer.value||"").trim() || null,
        note: (noteEl.value||"").trim() || null,
        price_override: null,
        produced: false
      };

      if(currentProduct==="bunny"){
        item.size = bunnySize;
        item.mode = bunnyMode;
        if(bunnyMode==="single") item.colors = { single: norm(fields.bunny_single) };
        else item.colors = { ears:norm(fields.bunny_ears), body:norm(fields.bunny_body), butt:norm(fields.bunny_butt) };
      }

      if(currentProduct==="lumi"){
        item.colors = { body:norm(fields.lumi_body), wings:norm(fields.lumi_wings), feelers:norm(fields.lumi_feelers) };
      }

      if(currentProduct==="text"){
        item.product = "text";
        item.name = (fields.text_name||"").trim();
        item.size = (fields.text_size||"").trim();
        item.colors = { main:norm(fields.text_main), second:norm(fields.text_second) };
        item.price_override = Number(customUnitPrice);
      }

      if(currentProduct==="other"){
        item.product = "other";
        item.name = (fields.other_name||"").trim();
        item.size = (fields.other_size||"").trim();
        item.colors = { main:norm(fields.other_main), second:norm(fields.other_second) };
        item.price_override = Number(customUnitPrice);
      }

      return item;
    }

    // ---------------- cart UI ----------------
    function updateCartUI(){
      cartList.innerHTML="";
      cartHint.style.display = cart.length===0 ? "block" : "none";

      for(const it of cart){
        const card = document.createElement("div");
        card.className = "card pad";

        const unit = (it.price_override!=null ? Number(it.price_override) : (it.product==="bunny"||it.product==="lumi") ? null : 0);
        const priceLine =
          (unit!=null && (it.product==="text" || it.product==="other"))
            ? `<div class="muted" style="margin-top:4px;">üí∂ Preis/Stk: ${euro(unit)}</div>`
            : ``;

        card.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div style="min-width:220px;">
              <div style="font-weight:1000">${esc(buildItemTitle(it))} <span class="muted">(${esc(prioLabel(it.priority))})</span></div>
              ${colorTextStack(it)}
              ${it.customer_name ? `<div class="muted" style="margin-top:6px;">üë§ ${esc(it.customer_name)}</div>` : ``}
              ${it.note ? `<div class="muted" style="margin-top:6px;">üìù ${esc(it.note)}</div>` : ``}
              ${priceLine}
            </div>
            <div class="row" style="gap:8px;">
              <span class="badge">√ó ${esc(it.qty)}</span>
              <button class="iconBtn danger" data-del="${esc(it._cid)}" title="Entfernen">‚úñ</button>
            </div>
          </div>
        `;
        cartList.appendChild(card);
      }

      cartList.querySelectorAll("[data-del]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-del");
          cart = cart.filter(x=>String(x._cid)!==String(id));
          updateCartUI();
          validateSaveEnabled();
        });
      });

      cartSum.textContent = "Summe: " + euro(cartTotal());
    }

    addItemBtn.addEventListener("click", ()=>{
      if(!validateForAdd()) return;
      cart.push(makeItem());

      qty=null;
      qtyOther.value="";
      document.querySelectorAll(".qtyBtn").forEach(b=>b.classList.remove("active"));

      updateCartUI();
      validateSaveEnabled();
      clearErrorUI();
    });

    // ---------------- sorting buttons ----------------
    sortDate.addEventListener("click", ()=>{
      sortMode="date";
      sortDate.classList.add("btnDark"); sortDate.classList.remove("btnSoft");
      sortPrio.classList.add("btnSoft"); sortPrio.classList.remove("btnDark");
      loadAll();
    });
    sortPrio.addEventListener("click", ()=>{
      sortMode="prio";
      sortPrio.classList.add("btnDark"); sortPrio.classList.remove("btnSoft");
      sortDate.classList.add("btnSoft"); sortDate.classList.remove("btnDark");
      loadAll();
    });

    // ---------------- save order ----------------
    async function saveOrder(){
      clearErrorUI();
      saveStatus.style.display="none";

      if(cart.length===0){
        showMissing("F√ºge zuerst mindestens eine Position hinzu.");
        return;
      }

      saveOrderBtn.disabled = true;
      saveOrderBtn.textContent = "Speichern‚Ä¶";

      const { data: orderData, error: oErr } = await supabase
        .from("orders")
        .insert({ archived:false, total_override: null })
        .select("id")
        .single();

      if(oErr){
        showMissing("Fehler beim Speichern: " + oErr.message);
        saveOrderBtn.disabled = false;
        saveOrderBtn.textContent = "‚úÖ Bestellung speichern";
        return;
      }

      const orderId = orderData.id;

      const itemsPayload = cart.map(it=>({
        order_id: orderId,
        product: it.product,
        name: it.name ?? null,
        size: it.size ?? null,
        mode: it.mode ?? null,
        colors: it.colors ?? {},
        qty: it.qty,
        priority: it.priority,
        customer_name: it.customer_name ?? null,
        note: it.note ?? null,
        price_override: it.price_override ?? null,
        produced: it.produced ?? false
      }));

      const { error: iErr } = await supabase.from("order_items").insert(itemsPayload);

      if(iErr){
        showMissing("Fehler beim Speichern (Positionen): " + iErr.message);
        await supabase.from("orders").delete().eq("id", orderId);
        saveOrderBtn.disabled = false;
        saveOrderBtn.textContent = "‚úÖ Bestellung speichern";
        return;
      }

      cart=[];
      updateCartUI();
      validateSaveEnabled();

      saveStatus.style.display="block";
      saveStatus.textContent="Gespeichert ‚úÖ";
      saveOrderBtn.textContent="‚úÖ Bestellung speichern";
      saveOrderBtn.disabled=true;

      await loadAll();
    }

    saveOrderBtn.addEventListener("click", saveOrder);

    // ---------------- order actions ----------------
    async function deleteOrder(orderId){
      const ok = confirm("Bist du sicher? Diese Bestellung wird endg√ºltig gel√∂scht.");
      if(!ok) return;
      await supabase.from("orders").delete().eq("id", orderId); // cascade l√∂scht items
      await loadAll();
    }

    async function archiveOrder(orderId){
      await supabase.from("orders").update({ archived:true }).eq("id", orderId);
      await loadAll();
    }

    async function restoreOrder(orderId){
      await supabase.from("orders").update({ archived:false }).eq("id", orderId);
      await loadAll();
    }

    async function toggleProduced(itemId, newVal){
      const { error } = await supabase.from("order_items").update({ produced: !!newVal }).eq("id", itemId);
      if(error) alert(error.message);
      await loadAll();
    }

    async function editItemPrice(itemId, cur){
      const v = await openNumPad({
        title: "Preis pro St√ºck (‚Ç¨)",
        startValue: (cur==null || cur==="") ? "0" : String(cur)
      });
      if(v==null) return;
      const { error } = await supabase.from("order_items").update({ price_override: v }).eq("id", itemId);
      if(error) alert(error.message);
      await loadAll();
    }

    async function editOrderTotal(orderId, cur){
      const start = (cur==null || cur==="") ? "0" : String(cur);
      const v = await openNumPad({
        title: "Neuer Gesamtpreis (‚Ç¨)",
        startValue: start
      });
      if(v==null) return;
      const { error } = await supabase.from("orders").update({ total_override: v }).eq("id", orderId);
      if(error) alert(error.message);
      await loadAll();
    }

    async function clearOrderTotalOverride(orderId){
      const ok = confirm("Gesamtpreis-Override l√∂schen? Danach wird wieder normal berechnet.");
      if(!ok) return;
      const { error } = await supabase.from("orders").update({ total_override: null }).eq("id", orderId);
      if(error) alert(error.message);
      await loadAll();
    }

    // ---------------- render orders ----------------
    function itemSortKey(it){
      // bunny 11->15->20, dann lumi, dann text, dann other
      if(it.product==="bunny"){
        const r = (String(it.size)==="11") ? 0 : (String(it.size)==="15") ? 1 : 2;
        return "0-"+r;
      }
      if(it.product==="lumi") return "1";
      if(it.product==="text") return "2";
      return "3";
    }

    function renderOrders(target, orders, { archived }){
      target.innerHTML = "";

      if(orders.length===0){
        target.innerHTML = `<div class="muted">Keine ${archived ? "archivierten" : "offenen"} Bestellungen.</div>`;
        return;
      }

      for(const o of orders){
        const items = (o.items||[]).slice().sort((a,b)=>{
          const ka=itemSortKey(a), kb=itemSortKey(b);
          return ka<kb?-1:ka>kb?1:0;
        });

        const computed = priceForItems(items);
        const total = (o.total_override!=null ? Number(o.total_override) : computed);

        // FERTIG?
        const allDone = items.length>0 && items.every(x=>!!x.produced);

        const minPr = Math.min(...items.map(x=>prioRank(x.priority)).concat([2]));
        const prText = minPr===0 ? "Sehr wichtig" : minPr===1 ? "Wichtig" : "Nicht wichtig";

        const date = formatDateOnly(o.created_at);

        const lines = items.map(it=>{
          const prodClass = it.produced ? "prodBox done" : "prodBox";
          const prodIcon = it.produced ? "‚úì" : "‚úñ";

          const unit = (it.price_override!=null) ? Number(it.price_override) : null;
          const priceTxt = (unit!=null)
            ? `<div class="muted" style="margin-top:4px;">üí∂ Preis/Stk: ${euro(unit)}</div>`
            : ``;

          return `
            <div style="padding:10px 0; border-top:1px dashed #eef2f7;">
              <div class="row" style="justify-content:space-between; gap:10px; align-items:flex-start;">
                <div style="min-width:240px;">
                  <div style="font-weight:900">${esc(buildItemTitle(it))} <span class="muted">(${esc(prioLabel(it.priority))})</span></div>
                  ${colorTextStack(it)}
                  ${it.customer_name ? `<div class="muted" style="margin-top:6px;">üë§ ${esc(it.customer_name)}</div>` : ``}
                  ${it.note ? `<div class="muted" style="margin-top:6px;">üìù ${esc(it.note)}</div>` : ``}
                  ${priceTxt}
                </div>

                <div class="row" style="gap:10px;">
                  <div class="${prodClass}" data-prod="${esc(it.id)}" data-prodval="${it.produced ? "1":"0"}">
                    <div class="prodMark">${prodIcon}</div>
                    Produziert
                  </div>

                  <span class="badge">√ó ${esc(it.qty)}</span>

                  <button class="iconBtn" title="Preis pro St√ºck √§ndern" data-edit-item="${esc(it.id)}" data-cur-price="${it.price_override ?? ""}">‚úè</button>
                </div>
              </div>
            </div>
          `;
        }).join("");

        const card = document.createElement("div");
        card.className = "card pad orderCard";

        const overrideBadge = (o.total_override!=null)
          ? `<span class="badge warn" title="Override aktiv">Gesamt √ºberschrieben</span>`
          : ``;

        const fertigBadge = allDone
          ? `<span class="badge ok">FERTIG ‚úì</span>`
          : `<span class="badge neutral">Offen</span>`;

        card.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div>
              <div class="row" style="gap:10px; align-items:center;">
                <div class="orderTitle">${archived ? "Archiv" : "Offen"} ‚Ä¢ ${esc(date)}</div>
                <span class="badge">${esc(prText)}</span>
                ${fertigBadge}
                ${overrideBadge}
              </div>
            </div>

            <div class="row" style="gap:8px; align-items:center;">
              <div style="font-weight:1000">${euro(total)}</div>

              <button class="iconBtn" title="Gesamtpreis neu setzen" data-edit-order="${esc(o.id)}" data-cur-total="${o.total_override ?? ""}">‚úè</button>
              <button class="iconBtn" title="Gesamtpreis-Override l√∂schen" data-clear-order="${esc(o.id)}">‚Ü∫</button>

              ${
                archived
                  ? `
                    <button class="iconBtn" data-restore="${esc(o.id)}" title="Zur√ºck holen">‚Ü©</button>
                    <button class="iconBtn danger" data-delete="${esc(o.id)}" title="L√∂schen">üóë</button>
                  `
                  : `
                    <button class="iconBtn" data-archive="${esc(o.id)}" title="Ins Archiv">üì¶</button>
                    <button class="iconBtn danger" data-delete="${esc(o.id)}" title="L√∂schen">üóë</button>
                  `
              }
            </div>
          </div>

          <div class="sep"></div>
          ${lines}
        `;

        target.appendChild(card);
      }

      // Handlers
      target.querySelectorAll("[data-archive]").forEach(b=>{
        b.addEventListener("click", ()=>archiveOrder(b.getAttribute("data-archive")));
      });
      target.querySelectorAll("[data-restore]").forEach(b=>{
        b.addEventListener("click", ()=>restoreOrder(b.getAttribute("data-restore")));
      });
      target.querySelectorAll("[data-delete]").forEach(b=>{
        b.addEventListener("click", ()=>deleteOrder(b.getAttribute("data-delete")));
      });

      target.querySelectorAll("[data-prod]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-prod");
          const cur = b.getAttribute("data-prodval")==="1";
          toggleProduced(id, !cur);
        });
      });

      target.querySelectorAll("[data-edit-item]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-edit-item");
          const cur = b.getAttribute("data-cur-price");
          editItemPrice(id, cur==="" ? null : cur);
        });
      });

      target.querySelectorAll("[data-edit-order]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-edit-order");
          const cur = b.getAttribute("data-cur-total");
          editOrderTotal(id, cur==="" ? null : cur);
        });
      });

      target.querySelectorAll("[data-clear-order]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-clear-order");
          clearOrderTotalOverride(id);
        });
      });
    }

    // ---------------- load all ----------------
    async function loadAll(){
      const { data: orders, error: oErr } = await supabase
        .from("orders")
        .select("id,created_at,archived,total_override")
        .order("created_at", { ascending:false });

      if(oErr){
        openSumEl.textContent = "Fehler: " + oErr.message;
        return;
      }

      const { data: items, error: iErr } = await supabase
        .from("order_items")
        .select("*")
        .order("created_at", { ascending:false });

      if(iErr){
        openSumEl.textContent = "Fehler: " + iErr.message;
        return;
      }

      const map = new Map();
      for(const o of (orders||[])) map.set(o.id, { ...o, items: [] });
      for(const it of (items||[])){
        const o = map.get(it.order_id);
        if(o){
          o.items.push({ ...it, colors: it.colors || {} });
        }
      }

      const all = Array.from(map.values());
      const open = all.filter(x=>!x.archived);
      const archived = all.filter(x=>x.archived);

      if(sortMode==="prio"){
        open.sort((a,b)=>{
          const ap = Math.min(...a.items.map(x=>prioRank(x.priority)).concat([2]));
          const bp = Math.min(...b.items.map(x=>prioRank(x.priority)).concat([2]));
          if(ap!==bp) return ap-bp;
          return new Date(b.created_at)-new Date(a.created_at);
        });
      } else {
        open.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
      }

      const openTotal = open.reduce((s,o)=>{
        const computed = priceForItems(o.items);
        const total = (o.total_override!=null ? Number(o.total_override) : computed);
        return s + total;
      }, 0);

      const archivedTotal = archived.reduce((s,o)=>{
        const computed = priceForItems(o.items);
        const total = (o.total_override!=null ? Number(o.total_override) : computed);
        return s + total;
      }, 0);

      openSumEl.textContent = `Summe offen: ${euro(openTotal)}`;
      archivedTotalEl.textContent = `Archiv gesamt: ${euro(archivedTotal)}`;

      renderOrders(openOrdersEl, open, { archived:false });
      renderOrders(archiveOrdersEl, archived, { archived:true });
    }

    // ---------------- start ----------------
    setProduct("bunny");
    updateCartUI();
    validateSaveEnabled();
    await loadAll();

  </script>
</body>
</html>

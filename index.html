<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bestellungen</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b; --border:#e2e8f0;
      --accent:#0b1220; --danger:#b91c1c; --ok:#047857; --chip:#eef2ff;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text);}
    .container{max-width:1100px; margin:0 auto; padding:18px;}
    h1{margin:8px 0 6px; font-size:34px; letter-spacing:-.5px}
    .hint{color:var(--muted); font-size:13px}
    .row{display:flex; gap:12px; align-items:center; justify-content:space-between}
    .card{background:var(--card); border:1px solid var(--border); border-radius:18px; box-shadow:0 10px 25px rgba(2,6,23,.06);}
    .pad{padding:16px}
    .sep{height:14px}
    .grid{display:grid; gap:12px}
    @media(min-width:900px){ .grid-2{grid-template-columns:1fr 1fr} }
    @media(min-width:900px){ .grid-3{grid-template-columns:repeat(3,1fr)} }

    .btn{
      border:0; cursor:pointer; border-radius:14px; padding:10px 14px; font-weight:800;
      background:var(--accent); color:#fff; display:inline-flex; align-items:center; justify-content:center; gap:8px;
    }
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .btn-soft{
      background:#fff; color:var(--accent); border:1px solid var(--border);
    }
    .btn-danger{background:var(--danger)}
    .btn-small{padding:8px 10px; border-radius:12px; font-weight:800}
    .btn-ghost{background:transparent; border:1px solid var(--border); color:var(--accent)}
    .toggleRow{display:flex; gap:10px}
    .toggle{
      flex:1; border-radius:16px; padding:12px 14px; font-weight:900; border:1px solid var(--border);
      background:#fff; color:var(--accent); cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px;
    }
    .toggle.active{background:var(--accent); color:#fff; border-color:transparent}
    .title2{font-size:22px; margin:0 0 10px; font-weight:900}
    .label{font-size:13px; font-weight:900; color:var(--text); margin:2px 0 6px}
    .muted{color:var(--muted)}
    .err{color:var(--danger); font-weight:800; font-size:13px; margin-top:8px; display:flex; align-items:center; gap:8px}
    .ok{color:var(--ok); font-weight:800; font-size:13px; margin-top:8px}
    .field{border:1px solid var(--border); border-radius:14px; padding:10px 12px; width:100%; font-size:15px; outline:none; background:#fff}
    textarea.field{min-height:86px; resize:vertical}
    .field.error{border-color:var(--danger); box-shadow:0 0 0 3px rgba(185,28,28,.12)}
    .chipRow{display:flex; gap:10px; flex-wrap:wrap}
    .chip{
      border:1px solid var(--border); background:#fff; padding:10px 14px; border-radius:16px; font-weight:900; cursor:pointer;
      min-width:84px; text-align:center;
    }
    .chip.active{background:var(--accent); color:#fff; border-color:transparent}
    .prioRow{display:grid; grid-template-columns:1fr 1.2fr 1fr; gap:10px}
    .prioBtn{border:1px solid var(--border); background:#fff; border-radius:16px; padding:12px 10px; font-weight:950; cursor:pointer}
    .prioBtn.active{background:var(--accent); color:#fff; border-color:transparent}
    .prioBtn.small{transform:scale(.92)}
    .qtyRow{display:flex; gap:8px; flex-wrap:wrap}
    .qtyBtn{width:44px; height:40px; border-radius:14px; border:1px solid var(--border); background:#fff; font-weight:950; cursor:pointer}
    .qtyBtn.active{background:var(--accent); color:#fff; border-color:transparent}
    .inline{display:flex; gap:10px; align-items:center}
    .grow{flex:1}

    /* ---- Custom dropdown (mobile friendly) ---- */
    .ddWrap{position:relative; display:flex; gap:10px; align-items:center}
    .ddInput{flex:1}
    .ddArrow{
      width:44px; height:42px; border-radius:14px; border:1px solid var(--border); background:#fff;
      display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none;
    }
    .ddMenu{
      position:absolute; left:0; right:0; top:50px;
      background:#fff; border:1px solid var(--border); border-radius:14px; box-shadow:0 16px 30px rgba(2,6,23,.10);
      overflow:hidden; z-index:50; max-height:240px; overflow-y:auto;
    }
    .ddItem{padding:10px 12px; cursor:pointer; font-weight:800}
    .ddItem:hover{background:#f1f5f9}

    /* Orders list */
    .ordersHead{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .sortBtns{display:flex; gap:10px}
    .orderCard{border:1px solid var(--border); border-radius:16px; padding:12px; background:#fff}
    .orderTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .orderMeta{display:flex; flex-direction:column; gap:4px}
    .orderDate{font-weight:950}
    .orderCustomer{color:var(--muted); font-weight:800}
    .orderTotal{font-weight:950}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); font-weight:900; background:#fff}
    .pill.prio{background:var(--chip)}
    .items{margin-top:10px; display:grid; gap:8px}
    .itemLine{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; padding:10px; border:1px solid var(--border); border-radius:14px; background:#fff}
    .itemL{display:flex; flex-direction:column; gap:4px}
    .itemT{font-weight:950}
    .itemS{color:var(--muted); font-weight:800; font-size:13px}
    .iconBtn{width:40px; height:40px; border-radius:14px; border:1px solid var(--border); background:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center}
    .iconBtn:hover{background:#f8fafc}

    details.archive{margin-top:10px}
    summary{cursor:pointer; color:var(--muted); font-weight:900}
    .archiveWrap{margin-top:10px; display:grid; gap:10px}
    .monthTitle{font-weight:950; color:var(--muted); margin-top:8px}

    /* Modal */
    .modalBack{position:fixed; inset:0; background:rgba(2,6,23,.45); display:none; align-items:center; justify-content:center; padding:16px; z-index:100}
    .modal{max-width:680px; width:100%; background:#fff; border-radius:18px; border:1px solid var(--border); box-shadow:0 30px 60px rgba(2,6,23,.25)}
    .modalHead{display:flex; justify-content:space-between; align-items:center; padding:14px 14px 0}
    .modalBody{padding:14px}
    .xBtn{border:1px solid var(--border); background:#fff; border-radius:14px; width:40px; height:40px; cursor:pointer; font-weight:950}

    @media (max-width:520px){
      h1{font-size:30px}
      .toggle{padding:10px 10px}
      .prioBtn{padding:10px 8px}
      .ddMenu{top:48px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="row">
      <div>
        <h1>Bestellungen</h1>
      </div>
      <div class="hint">GitHub Pages ‚Ä¢ Supabase</div>
    </div>

    <div class="sep"></div>

    <!-- Neue Bestellung -->
    <div class="card">
      <div class="pad">
        <div class="toggleRow" style="margin-bottom:12px">
          <button id="btnBunny" class="toggle">üê∞ Hase</button>
          <button id="btnLumi" class="toggle">‚ú®ü™≤ Lumi</button>
          <button id="btnOther" class="toggle">‚ûï Weitere</button>
        </div>

        <div class="title2" id="formTitle">Neue Bestellung</div>

        <!-- Gr√∂√üe (nur Hase) -->
        <div id="bunnySizeBlock" style="display:none; margin-bottom:10px">
          <div class="label">Gr√∂√üe</div>
          <div class="chipRow">
            <button class="chip" data-size="20">20 cm</button>
            <button class="chip" data-size="15">15 cm</button>
            <button class="chip" data-size="11">11 cm</button>
          </div>
        </div>

        <!-- Farben -->
        <div id="colorsBlock" style="margin-top:6px">
          <div class="label">Farben</div>

          <!-- Hase: Einfarbig -->
          <div id="bunnyModeRow" style="display:none; margin:6px 0 10px">
            <div class="chipRow">
              <button id="btnMulti" class="chip">Mehrfarbig</button>
              <button id="btnSingle" class="chip">Einfarbig</button>
            </div>
          </div>

          <!-- Hase Multi -->
          <div id="bunnyMulti" class="grid grid-3" style="display:none">
            <div>
              <div class="label">K√∂rperfarbe</div>
              <div class="ddWrap" data-dd="b_body">
                <input class="field ddInput" id="b_body" placeholder="Tippen oder ausw√§hlen..." autocomplete="off">
                <div class="ddArrow" data-dd-btn="b_body">‚ñº</div>
                <div class="ddMenu" data-dd-menu="b_body" style="display:none"></div>
              </div>
            </div>
            <div>
              <div class="label">Ohrenfarbe</div>
              <div class="ddWrap" data-dd="b_ear">
                <input class="field ddInput" id="b_ear" placeholder="Tippen oder ausw√§hlen..." autocomplete="off">
                <div class="ddArrow" data-dd-btn="b_ear">‚ñº</div>
                <div class="ddMenu" data-dd-menu="b_ear" style="display:none"></div>
              </div>
            </div>
            <div>
              <div class="label">Popofarbe</div>
              <div class="ddWrap" data-dd="b_butt">
                <input class="field ddInput" id="b_butt" placeholder="Tippen oder ausw√§hlen..." autocomplete="off">
                <div class="ddArrow" data-dd-btn="b_butt">‚ñº</div>
                <div class="ddMenu" data-dd-menu="b_butt" style="display:none"></div>
              </div>
            </div>
          </div>

          <!-- Hase Single -->
          <div id="bunnySingle" style="display:none">
            <div class="label">Einfarbig</div>
            <div class="ddWrap" data-dd="b_single">
              <input class="field ddInput" id="b_single" placeholder="Tippen oder ausw√§hlen..." autocomplete="off">
              <div class="ddArrow" data-dd-btn="b_single">‚ñº</div>
              <div class="ddMenu" data-dd-menu="b_single" style="display:none"></div>
            </div>
            <div class="hint" style="margin-top:6px">Setzt K√∂rper, Ohren und Popo automatisch auf dieselbe Farbe.</div>
          </div>

          <!-- Lumi -->
          <div id="lumiColors" class="grid grid-3" style="display:none">
            <div>
              <div class="label">K√∂rperfarbe</div>
              <div class="ddWrap" data-dd="l_body">
                <input class="field ddInput" id="l_body" placeholder="Tippen oder ausw√§hlen..." autocomplete="off">
                <div class="ddArrow" data-dd-btn="l_body">‚ñº</div>
                <div class="ddMenu" data-dd-menu="l_body" style="display:none"></div>
              </div>
            </div>
            <div>
              <div class="label">Fl√ºgelfarbe</div>
              <div class="ddWrap" data-dd="l_wing">
                <input class="field ddInput" id="l_wing" placeholder="Tippen oder ausw√§hlen..." autocomplete="off">
                <div class="ddArrow" data-dd-btn="l_wing">‚ñº</div>
                <div class="ddMenu" data-dd-menu="l_wing" style="display:none"></div>
              </div>
            </div>
            <div>
              <div class="label">F√ºhlerfarbe</div>
              <div class="ddWrap" data-dd="l_feel">
                <input class="field ddInput" id="l_feel" placeholder="Tippen oder ausw√§hlen..." autocomplete="off">
                <div class="ddArrow" data-dd-btn="l_feel">‚ñº</div>
                <div class="ddMenu" data-dd-menu="l_feel" style="display:none"></div>
              </div>
            </div>
          </div>

          <!-- Other -->
          <div id="otherColors" class="grid grid-2" style="display:none">
            <div>
              <div class="label">Gr√∂√üe</div>
              <input class="field" id="o_size" placeholder="z.B. 10cm / XL / ..." />
            </div>
            <div>
              <div class="label">Farbe</div>
              <div class="ddWrap" data-dd="o_color">
                <input class="field ddInput" id="o_color" placeholder="Tippen oder ausw√§hlen..." autocomplete="off">
                <div class="ddArrow" data-dd-btn="o_color">‚ñº</div>
                <div class="ddMenu" data-dd-menu="o_color" style="display:none"></div>
              </div>
            </div>
            <div style="grid-column:1/-1">
              <div class="label">Beschreibung (f√ºr ‚ÄûWeitere‚Äú)</div>
              <input class="field" id="o_desc" placeholder="z.B. Sonderform, eigenes Produkt..." />
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <!-- Kunde (neu) -->
        <div class="grid grid-2">
          <div>
            <div class="label">Kundenname</div>
            <input class="field" id="customer" placeholder="z.B. Max Mustermann" />
          </div>

          <div>
            <div class="label">Priorit√§t</div>
            <div class="prioRow">
              <button id="pVery" class="prioBtn small">Sehr wichtig</button>
              <button id="pNorm" class="prioBtn">Wichtig</button>
              <button id="pLow" class="prioBtn small">Nicht wichtig</button>
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <!-- Beschreibung -->
        <div>
          <div class="label">Beschreibung (optional)</div>
          <textarea class="field" id="note" placeholder="z.B. Sonderwunsch, Kunde, Hinweis ..."></textarea>
        </div>

        <div class="sep"></div>

        <!-- Menge Buttons -->
        <div class="label">Menge</div>
        <div class="qtyRow">
          <button class="qtyBtn" data-q="1">1</button>
          <button class="qtyBtn" data-q="2">2</button>
          <button class="qtyBtn" data-q="3">3</button>
          <button class="qtyBtn" data-q="4">4</button>
          <button class="qtyBtn" data-q="5">5</button>
          <button class="qtyBtn" data-q="6">6</button>
          <button class="qtyBtn" data-q="7">7</button>
          <button class="qtyBtn" data-q="8">8</button>
          <button class="qtyBtn" data-q="9">9</button>
        </div>

        <div class="sep"></div>

        <div class="grid grid-2">
          <div>
            <div class="label">Andere Menge (optional)</div>
            <input class="field" id="qtyOther" placeholder="z.B. 12" inputmode="numeric" />
          </div>
          <div class="inline" style="align-items:flex-end">
            <button id="addItemBtn" class="btn grow">+ Zur Bestellung hinzuf√ºgen</button>
          </div>
        </div>

        <div id="formError" class="err" style="display:none">‚ö†Ô∏è Bitte erst ausf√ºllen: <span id="missing"></span></div>

        <div class="sep"></div>

        <!-- Warenkorb / Positionen -->
        <div class="title2" style="margin-top:4px">Positionen in dieser Bestellung</div>
        <div id="cartList" class="grid" style="margin-top:10px"></div>
        <div class="hint" id="cartHint">Noch keine Positionen hinzugef√ºgt.</div>

        <div class="sep"></div>

        <button id="saveOrderBtn" class="btn" disabled>‚úÖ Bestellung speichern</button>
        <div id="saveStatus" class="ok" style="display:none"></div>
      </div>
    </div>

    <div class="sep"></div>

    <!-- Offene Bestellungen -->
    <div class="card">
      <div class="pad">
        <div class="ordersHead">
          <div>
            <div class="title2" style="margin:0">Offene Bestellungen</div>
            <div class="hint" id="openSum">Summe offen: ‚Äì</div>
          </div>
          <div class="sortBtns">
            <button id="sortDate" class="btn-small btn">Sort: Datum</button>
            <button id="sortPrio" class="btn-small btn-soft">Sort: Priorit√§t</button>
          </div>
        </div>

        <div class="sep"></div>

        <div id="openOrders" class="grid"></div>

        <details class="archive">
          <summary>Archiv (alte Bestellungen anzeigen)</summary>
          <div class="archiveWrap">
            <div class="row" style="align-items:flex-end">
              <div class="hint" id="soldSum" style="cursor:pointer; text-decoration:underline">Verkauft gesamt: ‚Äì (klicken f√ºr Korrektur)</div>
            </div>
            <div id="archiveOrders" class="grid"></div>
          </div>
        </details>
      </div>
    </div>
  </div>

  <!-- Modal: Edit Item -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <div class="title2" style="margin:0; font-size:18px">Position bearbeiten</div>
        <button class="xBtn" id="closeModal">‚úï</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <!-- Modal: Sold adjustments -->
  <div class="modalBack" id="adjBack">
    <div class="modal">
      <div class="modalHead">
        <div class="title2" style="margin:0; font-size:18px">Korrektur (verkauft gesamt)</div>
        <button class="xBtn" id="closeAdj">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="hint">Hier kannst du Betr√§ge abziehen (negativ) oder hinzuf√ºgen (positiv).</div>
        <div class="sep"></div>
        <div class="grid grid-2">
          <div>
            <div class="label">Betrag in ‚Ç¨</div>
            <input class="field" id="adjAmount" placeholder="-2.00" />
          </div>
          <div>
            <div class="label">Notiz</div>
            <input class="field" id="adjNote" placeholder="z.B. Reklamation / Rabatt" />
          </div>
        </div>
        <div class="sep"></div>
        <button class="btn" id="addAdjBtn">+ Korrektur speichern</button>
        <div id="adjMsg" class="ok" style="display:none"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ‚úÖ HIER EINTRAGEN:
    const SUPABASE_URL = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0Z3J6bWxjZG9seHh6dmtwcG9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MzM2ODIsImV4cCI6MjA4NTAwOTY4Mn0.B0PxMAzmuvsHNd2n_mgNspjlPkaBpQlkrNzGu7p78fY";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------- UI refs ----------
    const btnBunny = document.getElementById("btnBunny");
    const btnLumi = document.getElementById("btnLumi");
    const btnOther = document.getElementById("btnOther");
    const formTitle = document.getElementById("formTitle");

    const bunnySizeBlock = document.getElementById("bunnySizeBlock");
    const colorsBlock = document.getElementById("colorsBlock");

    const bunnyModeRow = document.getElementById("bunnyModeRow");
    const btnMulti = document.getElementById("btnMulti");
    const btnSingle = document.getElementById("btnSingle");
    const bunnyMulti = document.getElementById("bunnyMulti");
    const bunnySingle = document.getElementById("bunnySingle");

    const lumiColors = document.getElementById("lumiColors");
    const otherColors = document.getElementById("otherColors");

    const customerEl = document.getElementById("customer");
    const noteEl = document.getElementById("note");

    const pVery = document.getElementById("pVery");
    const pNorm = document.getElementById("pNorm");
    const pLow  = document.getElementById("pLow");

    const qtyBtns = [...document.querySelectorAll(".qtyBtn")];
    const qtyOther = document.getElementById("qtyOther");

    const addItemBtn = document.getElementById("addItemBtn");
    const cartList = document.getElementById("cartList");
    const cartHint = document.getElementById("cartHint");
    const saveOrderBtn = document.getElementById("saveOrderBtn");
    const saveStatus = document.getElementById("saveStatus");

    const formError = document.getElementById("formError");
    const missingEl = document.getElementById("missing");

    const openOrdersEl = document.getElementById("openOrders");
    const archiveOrdersEl = document.getElementById("archiveOrders");
    const openSumEl = document.getElementById("openSum");
    const soldSumEl = document.getElementById("soldSum");

    const sortDate = document.getElementById("sortDate");
    const sortPrio = document.getElementById("sortPrio");

    const modalBack = document.getElementById("modalBack");
    const modalBody = document.getElementById("modalBody");
    const closeModal = document.getElementById("closeModal");

    const adjBack = document.getElementById("adjBack");
    const closeAdj = document.getElementById("closeAdj");
    const addAdjBtn = document.getElementById("addAdjBtn");
    const adjAmount = document.getElementById("adjAmount");
    const adjNote = document.getElementById("adjNote");
    const adjMsg = document.getElementById("adjMsg");

    // ---------- constants ----------
    const COLOR_SUGGESTIONS = ["wei√ü","schwarz","grau","rot","blau","gelb","gr√ºn","orange","pink","lila","braun","beige","gold","silber"];

    // ---------- state ----------
    let currentProduct = null; // 'bunny' | 'lumi' | 'other'
    let bunnySize = null;      // '20'|'15'|'11'
    let bunnyMode = null;      // 'multi'|'single'
    let priority = null;       // 'very'|'normal'|'low'
    let qty = null;            // number
    let cart = [];             // items before saving order
    let sortMode = "date";     // 'date'|'prio'

    // dropdown helpers
    function setupDropdown(inputId){
      const input = document.getElementById(inputId);
      const menu = document.querySelector(`[data-dd-menu="${inputId}"]`);
      const btn  = document.querySelector(`[data-dd-btn="${inputId}"]`);

      function renderMenu(filter=""){
        const f = filter.trim().toLowerCase();
        const list = COLOR_SUGGESTIONS
          .filter(c => !f || c.toLowerCase().includes(f))
          .slice(0, 30);

        menu.innerHTML = list.map(c => `<div class="ddItem" data-val="${c}">${c}</div>`).join("") || `<div class="ddItem" data-val="${filter}">"${filter}" √ºbernehmen</div>`;
        menu.querySelectorAll(".ddItem").forEach(it=>{
          it.addEventListener("click", ()=>{
            input.value = it.getAttribute("data-val") || "";
            closeMenu();
          });
        });
      }
      function openMenu(){
        renderMenu(input.value);
        menu.style.display = "block";
      }
      function closeMenu(){
        menu.style.display = "none";
      }
      function toggle(){
        if(menu.style.display === "block") closeMenu(); else openMenu();
      }

      // ‚úÖ wichtig: Arrow ist der einzige "Dropdown-Opener" (mobile friendly)
      btn.addEventListener("click", (e)=>{ e.stopPropagation(); toggle(); });

      // Tippen/Schreiben filtert Liste (optional)
      input.addEventListener("input", ()=>{ if(menu.style.display==="block") renderMenu(input.value); });

      // Klick au√üerhalb schlie√üt
      document.addEventListener("click", ()=> closeMenu());

      return { openMenu, closeMenu };
    }

    const dd = {
      b_body: setupDropdown("b_body"),
      b_ear: setupDropdown("b_ear"),
      b_butt: setupDropdown("b_butt"),
      b_single: setupDropdown("b_single"),
      l_body: setupDropdown("l_body"),
      l_wing: setupDropdown("l_wing"),
      l_feel: setupDropdown("l_feel"),
      o_color: setupDropdown("o_color"),
    };

    // ---------- UI select product ----------
    function setActiveProduct(p){
      currentProduct = p;
      [btnBunny, btnLumi, btnOther].forEach(b=>b.classList.remove("active"));
      if(p==="bunny") btnBunny.classList.add("active");
      if(p==="lumi") btnLumi.classList.add("active");
      if(p==="other") btnOther.classList.add("active");

      // blocks
      bunnySizeBlock.style.display = (p==="bunny") ? "block" : "none";
      bunnyModeRow.style.display   = (p==="bunny") ? "block" : "none";
      bunnyMulti.style.display     = "none";
      bunnySingle.style.display    = "none";
      lumiColors.style.display     = (p==="lumi") ? "grid" : "none";
      otherColors.style.display    = (p==="other") ? "grid" : "none";

      // reset product-specific selections
      bunnySize = null;
      bunnyMode = null;
      // unselect size chips
      document.querySelectorAll('[data-size]').forEach(x=>x.classList.remove("active"));
      btnMulti.classList.remove("active");
      btnSingle.classList.remove("active");

      formTitle.textContent = p==="bunny" ? "Neue Bestellung: Hase" : p==="lumi" ? "Neue Bestellung: Lumi" : "Neue Bestellung: Weitere";
      hideError();
      refreshSaveEnabled();
    }

    btnBunny.addEventListener("click", ()=>setActiveProduct("bunny"));
    btnLumi.addEventListener("click", ()=>setActiveProduct("lumi"));
    btnOther.addEventListener("click", ()=>setActiveProduct("other"));

    // size select
    document.querySelectorAll('[data-size]').forEach(chip=>{
      chip.addEventListener("click", ()=>{
        bunnySize = chip.getAttribute("data-size");
        document.querySelectorAll('[data-size]').forEach(x=>x.classList.remove("active"));
        chip.classList.add("active");
        // if size chosen, default show mode buttons but NOT auto select
        showBunnyModeUI();
        hideError();
        refreshSaveEnabled();
      });
    });

    function showBunnyModeUI(){
      // show mode buttons; no auto selection
      if(currentProduct!=="bunny") return;
      // show nothing yet; user must pick Multi/Single
      bunnyMulti.style.display = "none";
      bunnySingle.style.display = "none";
    }

    btnMulti.addEventListener("click", ()=>{
      bunnyMode = "multi";
      btnMulti.classList.add("active"); btnSingle.classList.remove("active");
      bunnyMulti.style.display = "grid";
      bunnySingle.style.display = "none";
      hideError();
      refreshSaveEnabled();
    });
    btnSingle.addEventListener("click", ()=>{
      bunnyMode = "single";
      btnSingle.classList.add("active"); btnMulti.classList.remove("active");
      bunnySingle.style.display = "block";
      bunnyMulti.style.display = "none";
      hideError();
      refreshSaveEnabled();
    });

    // priority buttons (no auto select)
    function setPriority(p){
      priority = p;
      [pVery,pNorm,pLow].forEach(x=>x.classList.remove("active"));
      if(p==="very") pVery.classList.add("active");
      if(p==="normal") pNorm.classList.add("active");
      if(p==="low") pLow.classList.add("active");
      hideError();
      refreshSaveEnabled();
    }
    pVery.addEventListener("click", ()=>setPriority("very"));
    pNorm.addEventListener("click", ()=>setPriority("normal"));
    pLow.addEventListener("click",  ()=>setPriority("low"));

    // quantity buttons (no auto select)
    function setQty(n){
      qty = n;
      qtyBtns.forEach(b=>b.classList.remove("active"));
      const btn = qtyBtns.find(b=>Number(b.getAttribute("data-q"))===n);
      if(btn) btn.classList.add("active");
      hideError();
      refreshSaveEnabled();
    }
    qtyBtns.forEach(b=>{
      b.addEventListener("click", ()=> setQty(Number(b.getAttribute("data-q"))));
    });
    qtyOther.addEventListener("input", ()=>{
      // if user types custom qty, we unset buttons visually
      qtyBtns.forEach(b=>b.classList.remove("active"));
      qty = null;
      hideError();
      refreshSaveEnabled();
    });

    // ---------- validation helpers ----------
    function showError(msg){
      missingEl.textContent = msg;
      formError.style.display = "flex";
    }
    function hideError(){
      formError.style.display = "none";
      // remove red borders
      document.querySelectorAll(".field").forEach(el=>el.classList.remove("error"));
    }

    function getFinalQty(){
      const other = Number(String(qtyOther.value||"").trim());
      if(Number.isFinite(other) && other>0) return other;
      if(Number.isFinite(qty) && qty>0) return qty;
      return null;
    }

    function requiredColorField(el){
      const v = (el.value||"").trim();
      return v.length>0;
    }

    function markError(el){
      el.classList.add("error");
    }

    // ---------- cart ----------
    function refreshCart(){
      cartList.innerHTML = "";
      if(cart.length===0){
        cartHint.style.display="block";
      } else {
        cartHint.style.display="none";
      }

      cart.forEach((it, idx)=>{
        const div = document.createElement("div");
        div.className = "orderCard";
        div.innerHTML = `
          <div class="orderTop">
            <div class="orderMeta">
              <div class="orderDate">${renderItemTitle(it)}</div>
              <div class="orderCustomer">${renderItemSubtitle(it)}</div>
            </div>
            <div class="inline">
              <button class="iconBtn" data-edit="${idx}" title="Bearbeiten">‚úé</button>
              <button class="iconBtn" data-del="${idx}" title="Entfernen">üóëÔ∏è</button>
            </div>
          </div>
        `;
        cartList.appendChild(div);
      });

      cartList.querySelectorAll("[data-del]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const i = Number(b.getAttribute("data-del"));
          cart.splice(i,1);
          refreshCart();
          refreshSaveEnabled();
        });
      });

      cartList.querySelectorAll("[data-edit]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const i = Number(b.getAttribute("data-edit"));
          openEditModal(i);
        });
      });

      refreshSaveEnabled();
    }

    function renderItemTitle(it){
      const pr = it.priority === "very" ? "Sehr wichtig" : it.priority==="normal" ? "Wichtig" : "Nicht wichtig";
      let name = "";
      if(it.product_type==="bunny"){
        name = `üê∞ Hase ${it.bunny_size}cm`;
      } else if(it.product_type==="lumi"){
        name = `‚ú®ü™≤ Lumi`;
      } else {
        name = `‚ûï Weitere`;
      }
      return `${name} ‚Ä¢ x${it.quantity} ‚Ä¢ ${pr}`;
    }

    function renderItemSubtitle(it){
      if(it.product_type==="bunny"){
        if(it.bunny_mode==="single"){
          return `Einfarbig: ${it.bunny_single_color}`;
        }
        return `K√∂rper: ${it.bunny_body_color} ‚Ä¢ Ohren: ${it.bunny_ear_color} ‚Ä¢ Popo: ${it.bunny_butt_color}`;
      }
      if(it.product_type==="lumi"){
        return `K√∂rper: ${it.lumi_body_color} ‚Ä¢ Fl√ºgel: ${it.lumi_wing_color} ‚Ä¢ F√ºhler: ${it.lumi_feeler_color}`;
      }
      return `Gr√∂√üe: ${it.other_size || "-"} ‚Ä¢ Farbe: ${it.other_color || "-"} ‚Ä¢ ${it.other_description || ""}`;
    }

    addItemBtn.addEventListener("click", ()=>{
      hideError();

      // Required fields (ALL au√üer Beschreibung in noteEl sind Pflicht f√ºr "Position hinzuf√ºgen")
      const customer = (customerEl.value||"").trim();
      if(!currentProduct){ showError("Produkt"); return; }
      if(!customer){ markError(customerEl); showError("Kundenname"); return; }
      if(!priority){ showError("Priorit√§t"); return; }
      const q = getFinalQty();
      if(!q){ showError("Menge"); return; }

      // product-specific required
      if(currentProduct==="bunny"){
        if(!bunnySize){ showError("Gr√∂√üe"); return; }
        if(!bunnyMode){ showError("Mehrfarbig/Einfarbig"); return; }
        if(bunnyMode==="single"){
          const b_single = document.getElementById("b_single");
          if(!requiredColorField(b_single)){ markError(b_single); showError("Einfarbig (Farbe)"); return; }
        } else {
          const b_body = document.getElementById("b_body");
          const b_ear  = document.getElementById("b_ear");
          const b_butt = document.getElementById("b_butt");
          if(!requiredColorField(b_body)){ markError(b_body); showError("K√∂rperfarbe"); return; }
          if(!requiredColorField(b_ear)){ markError(b_ear); showError("Ohrenfarbe"); return; }
          if(!requiredColorField(b_butt)){ markError(b_butt); showError("Popofarbe"); return; }
        }
      }

      if(currentProduct==="lumi"){
        const l_body = document.getElementById("l_body");
        const l_wing = document.getElementById("l_wing");
        const l_feel = document.getElementById("l_feel");
        if(!requiredColorField(l_body)){ markError(l_body); showError("K√∂rperfarbe"); return; }
        if(!requiredColorField(l_wing)){ markError(l_wing); showError("Fl√ºgelfarbe"); return; }
        if(!requiredColorField(l_feel)){ markError(l_feel); showError("F√ºhlerfarbe"); return; }
      }

      if(currentProduct==="other"){
        const o_size = document.getElementById("o_size");
        const o_color = document.getElementById("o_color");
        const o_desc = document.getElementById("o_desc");
        if(!(o_size.value||"").trim()){ markError(o_size); showError("Gr√∂√üe"); return; }
        if(!(o_color.value||"").trim()){ markError(o_color); showError("Farbe"); return; }
        if(!(o_desc.value||"").trim()){ markError(o_desc); showError("Beschreibung (Weitere)"); return; }
      }

      // build item
      const item = {
        product_type: currentProduct,
        priority,
        quantity: q,
      };

      if(currentProduct==="bunny"){
        item.bunny_size = bunnySize;
        item.bunny_mode = bunnyMode;
        if(bunnyMode==="single"){
          const c = document.getElementById("b_single").value.trim();
          item.bunny_single_color = c;
          // convenience: also store in multi fields for display consistency
          item.bunny_body_color = c;
          item.bunny_ear_color = c;
          item.bunny_butt_color = c;
        } else {
          item.bunny_body_color = document.getElementById("b_body").value.trim();
          item.bunny_ear_color  = document.getElementById("b_ear").value.trim();
          item.bunny_butt_color = document.getElementById("b_butt").value.trim();
        }
      } else if(currentProduct==="lumi"){
        item.lumi_body_color   = document.getElementById("l_body").value.trim();
        item.lumi_wing_color   = document.getElementById("l_wing").value.trim();
        item.lumi_feeler_color = document.getElementById("l_feel").value.trim();
      } else {
        item.other_size = document.getElementById("o_size").value.trim();
        item.other_color = document.getElementById("o_color").value.trim();
        item.other_description = document.getElementById("o_desc").value.trim();
      }

      cart.push(item);
      refreshCart();

      // keep customer/note as order-level; don't reset them
      // reset qty fields only
      qty = null;
      qtyBtns.forEach(b=>b.classList.remove("active"));
      qtyOther.value = "";

      // reset product fields to reduce mistakes
      if(currentProduct==="bunny"){
        // keep product selection but clear colors
        ["b_body","b_ear","b_butt","b_single"].forEach(id=>document.getElementById(id).value="");
      }
      if(currentProduct==="lumi"){
        ["l_body","l_wing","l_feel"].forEach(id=>document.getElementById(id).value="");
      }
      if(currentProduct==="other"){
        ["o_size","o_color","o_desc"].forEach(id=>document.getElementById(id).value="");
      }
    });

    function refreshSaveEnabled(){
      const customer = (customerEl.value||"").trim();
      saveOrderBtn.disabled = !(cart.length>0 && customer.length>0);
    }
    customerEl.addEventListener("input", refreshSaveEnabled);

    // ---------- edit modal for cart items ----------
    let editingIndex = null;

    function openEditModal(idx){
      editingIndex = idx;
      const it = cart[idx];

      // simple editor: quantity + priority + colors
      const pr = it.priority;
      const q = it.quantity;

      modalBody.innerHTML = `
        <div class="grid">
          <div class="hint">${renderItemTitle(it)}</div>

          <div class="label">Priorit√§t</div>
          <div class="prioRow">
            <button class="prioBtn small" data-pr="very">Sehr wichtig</button>
            <button class="prioBtn" data-pr="normal">Wichtig</button>
            <button class="prioBtn small" data-pr="low">Nicht wichtig</button>
          </div>

          <div class="label">Menge</div>
          <input class="field" id="editQty" value="${q}" inputmode="numeric" />

          <div id="editFields"></div>

          <button class="btn" id="saveEdit">Speichern</button>
        </div>
      `;

      // set active prio
      modalBody.querySelectorAll("[data-pr]").forEach(b=>{
        if(b.getAttribute("data-pr")===pr) b.classList.add("active");
        b.addEventListener("click", ()=>{
          modalBody.querySelectorAll("[data-pr]").forEach(x=>x.classList.remove("active"));
          b.classList.add("active");
        });
      });

      const editFields = modalBody.querySelector("#editFields");
      if(it.product_type==="bunny"){
        if(it.bunny_mode==="single"){
          editFields.innerHTML = `
            <div class="label">Einfarbig</div>
            <input class="field" id="editC1" value="${it.bunny_single_color || ""}" />
          `;
        } else {
          editFields.innerHTML = `
            <div class="grid grid-3">
              <div><div class="label">K√∂rper</div><input class="field" id="editC1" value="${it.bunny_body_color || ""}"></div>
              <div><div class="label">Ohren</div><input class="field" id="editC2" value="${it.bunny_ear_color || ""}"></div>
              <div><div class="label">Popo</div><input class="field" id="editC3" value="${it.bunny_butt_color || ""}"></div>
            </div>
          `;
        }
      } else if(it.product_type==="lumi"){
        editFields.innerHTML = `
          <div class="grid grid-3">
            <div><div class="label">K√∂rper</div><input class="field" id="editC1" value="${it.lumi_body_color || ""}"></div>
            <div><div class="label">Fl√ºgel</div><input class="field" id="editC2" value="${it.lumi_wing_color || ""}"></div>
            <div><div class="label">F√ºhler</div><input class="field" id="editC3" value="${it.lumi_feeler_color || ""}"></div>
          </div>
        `;
      } else {
        editFields.innerHTML = `
          <div class="grid grid-2">
            <div><div class="label">Gr√∂√üe</div><input class="field" id="editC1" value="${it.other_size || ""}"></div>
            <div><div class="label">Farbe</div><input class="field" id="editC2" value="${it.other_color || ""}"></div>
            <div style="grid-column:1/-1"><div class="label">Beschreibung</div><input class="field" id="editC3" value="${it.other_description || ""}"></div>
          </div>
        `;
      }

      modalBody.querySelector("#saveEdit").addEventListener("click", ()=>{
        const newPr = modalBody.querySelector("[data-pr].active")?.getAttribute("data-pr") || it.priority;
        const newQ = Number(modalBody.querySelector("#editQty").value);
        if(!Number.isFinite(newQ) || newQ<=0) return;

        it.priority = newPr;
        it.quantity = newQ;

        if(it.product_type==="bunny"){
          if(it.bunny_mode==="single"){
            const c = modalBody.querySelector("#editC1").value.trim();
            it.bunny_single_color = c;
            it.bunny_body_color = c; it.bunny_ear_color = c; it.bunny_butt_color = c;
          } else {
            it.bunny_body_color = modalBody.querySelector("#editC1").value.trim();
            it.bunny_ear_color  = modalBody.querySelector("#editC2").value.trim();
            it.bunny_butt_color = modalBody.querySelector("#editC3").value.trim();
          }
        } else if(it.product_type==="lumi"){
          it.lumi_body_color = modalBody.querySelector("#editC1").value.trim();
          it.lumi_wing_color = modalBody.querySelector("#editC2").value.trim();
          it.lumi_feeler_color = modalBody.querySelector("#editC3").value.trim();
        } else {
          it.other_size = modalBody.querySelector("#editC1").value.trim();
          it.other_color = modalBody.querySelector("#editC2").value.trim();
          it.other_description = modalBody.querySelector("#editC3").value.trim();
        }

        cart[editingIndex] = it;
        closeEditModal();
        refreshCart();
      });

      modalBack.style.display = "flex";
    }

    function closeEditModal(){
      modalBack.style.display = "none";
      editingIndex = null;
      modalBody.innerHTML = "";
    }
    closeModal.addEventListener("click", closeEditModal);
    modalBack.addEventListener("click", (e)=>{ if(e.target===modalBack) closeEditModal(); });

    // ---------- pricing ----------
    function priceForOrderItems(items){
      let total = 0;

      // bunny bundle
      const b20 = items.filter(i=>i.product_type==="bunny" && i.bunny_size==="20").reduce((s,i)=>s+i.quantity,0);
      const b15 = items.filter(i=>i.product_type==="bunny" && i.bunny_size==="15").reduce((s,i)=>s+i.quantity,0);
      const b11 = items.filter(i=>i.product_type==="bunny" && i.bunny_size==="11").reduce((s,i)=>s+i.quantity,0);

      const bundle = Math.min(b20,b15,b11);
      total += bundle * 22.0;
      total += (b20 - bundle) * 12.0;
      total += (b15 - bundle) * 9.0;
      total += (b11 - bundle) * 6.0;

      // lumis
      const lumis = items.filter(i=>i.product_type==="lumi").reduce((s,i)=>s+i.quantity,0);
      total += lumis * 8.0;

      // other: 0 (du kannst sp√§ter Preise erg√§nzen)
      return Number(total.toFixed(2));
    }

    function prioRank(p){
      if(p==="very") return 1;
      if(p==="normal") return 2;
      return 3;
    }

    // ---------- save order ----------
    saveOrderBtn.addEventListener("click", async ()=>{
      const customer = (customerEl.value||"").trim();
      if(!customer || cart.length===0) return;

      saveOrderBtn.disabled = true;
      saveStatus.style.display = "none";

      const note = (noteEl.value||"").trim();

      const { data: order, error: oErr } = await supabase
        .from("orders")
        .insert({ customer_name: customer, note })
        .select("id")
        .single();

      if(oErr){
        alert("Order Fehler: " + oErr.message);
        refreshSaveEnabled();
        return;
      }

      const rows = cart.map(it => ({ ...it, order_id: order.id }));
      const { error: iErr } = await supabase.from("order_items").insert(rows);
      if(iErr){
        alert("Items Fehler: " + iErr.message);
        refreshSaveEnabled();
        return;
      }

      // reset cart only (customer & note keep? -> wir resetten beides f√ºr neue Bestellung)
      cart = [];
      customerEl.value = "";
      noteEl.value = "";
      priority = null;
      [pVery,pNorm,pLow].forEach(x=>x.classList.remove("active"));

      saveStatus.textContent = "Gespeichert ‚úÖ";
      saveStatus.style.display = "block";

      refreshCart();
      await loadAll();
    });

    // ---------- archive / delete / restore ----------
    async function archiveOrder(orderId){
      await supabase.from("orders").update({ archived: true }).eq("id", orderId);
      await loadAll();
    }
    async function restoreOrder(orderId){
      await supabase.from("orders").update({ archived: false }).eq("id", orderId);
      await loadAll();
    }
    async function deleteOrder(orderId){
      const ok = confirm("Bist du sicher? Diese Bestellung wird endg√ºltig gel√∂scht.");
      if(!ok) return;
      await supabase.from("orders").delete().eq("id", orderId);
      await loadAll();
    }

    // ---------- sold adjustments ----------
    soldSumEl.addEventListener("click", ()=>{
      adjMsg.style.display="none";
      adjAmount.value = "";
      adjNote.value = "";
      adjBack.style.display="flex";
    });
    closeAdj.addEventListener("click", ()=> adjBack.style.display="none");
    adjBack.addEventListener("click", (e)=>{ if(e.target===adjBack) adjBack.style.display="none"; });

    addAdjBtn.addEventListener("click", async ()=>{
      const a = Number(String(adjAmount.value).replace(",", "."));
      if(!Number.isFinite(a)) return;
      const n = (adjNote.value||"").trim();
      const { error } = await supabase.from("adjustments").insert({ amount_eur: a, note: n });
      if(error){ alert(error.message); return; }
      adjMsg.textContent = "Gespeichert ‚úÖ";
      adjMsg.style.display="block";
      await loadAll();
    });

    // ---------- load + render ----------
    function formatDateOnly(iso){
      const d = new Date(iso);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}.${mm}.${yy}`;
    }

    async function loadAll(){
      // fetch orders + items
      const { data: orders, error: oErr } = await supabase
        .from("orders")
        .select("id,created_at,customer_name,note,archived")
        .order("created_at", { ascending:false });

      if(oErr){
        openSumEl.textContent = "Fehler: " + oErr.message;
        return;
      }

      const { data: items, error: iErr } = await supabase
        .from("order_items")
        .select("*")
        .order("created_at", { ascending:false });

      if(iErr){
        openSumEl.textContent = "Fehler: " + iErr.message;
        return;
      }

      const { data: adjs } = await supabase.from("adjustments").select("*");
      const adjSum = (adjs||[]).reduce((s,a)=> s + Number(a.amount_eur||0), 0);

      // group items by order
      const byOrder = new Map();
      (items||[]).forEach(it=>{
        const arr = byOrder.get(it.order_id) || [];
        arr.push(it);
        byOrder.set(it.order_id, arr);
      });

      const open = (orders||[]).filter(o=>!o.archived).map(o=>({ ...o, items: byOrder.get(o.id)||[] }));
      const archived = (orders||[]).filter(o=>o.archived).map(o=>({ ...o, items: byOrder.get(o.id)||[] }));

      // sorting open
      if(sortMode==="prio"){
        open.sort((a,b)=>{
          const ap = Math.min(...a.items.map(x=>prioRank(x.priority)).concat([9]));
          const bp = Math.min(...b.items.map(x=>prioRank(x.priority)).concat([9]));
          if(ap!==bp) return ap-bp;
          return new Date(b.created_at)-new Date(a.created_at);
        });
      } else {
        open.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
      }

      // sums
      const openTotal = open.reduce((s,o)=> s + priceForOrderItems(o.items), 0);
      openSumEl.textContent = `Summe offen: ${openTotal.toFixed(2)}‚Ç¨`;

      const soldTotalRaw = archived.reduce((s,o)=> s + priceForOrderItems(o.items), 0);
      const soldFinal = (soldTotalRaw + adjSum);
      soldSumEl.textContent = `Verkauft gesamt: ${soldFinal.toFixed(2)}‚Ç¨ (klicken f√ºr Korrektur)`;

      renderOrders(openOrdersEl, open, { archived:false });
      renderArchive(archiveOrdersEl, archived);
    }

    function prioLabel(p){
      if(p==="very") return "Sehr wichtig";
      if(p==="normal") return "Wichtig";
      return "Nicht wichtig";
    }

    function renderOrders(target, orders, { archived }){
      target.innerHTML = "";
      if(orders.length===0){
        target.innerHTML = `<div class="hint">Keine ${archived?"Archiv":"offenen"} Bestellungen.</div>`;
        return;
      }

      for(const o of orders){
        const total = priceForOrderItems(o.items);
        const bestPrio = Math.min(...o.items.map(x=>prioRank(x.priority)).concat([9]));
        const prText = bestPrio===1 ? "Sehr wichtig" : bestPrio===2 ? "Wichtig" : "Nicht wichtig";

        const wrap = document.createElement("div");
        wrap.className = "orderCard";
        wrap.innerHTML = `
          <div class="orderTop">
            <div class="orderMeta">
              <div class="orderDate">${formatDateOnly(o.created_at)} ‚Ä¢ <span class="pill prio">${prText}</span></div>
              <div class="orderCustomer">${escapeHtml(o.customer_name)}</div>
            </div>
            <div class="inline">
              <div class="orderTotal">${total.toFixed(2)}‚Ç¨</div>
              ${archived
                ? `<button class="btn-small btn-ghost" data-restore="${o.id}">Zur√ºckholen</button>
                   <button class="btn-small btn-danger" data-del="${o.id}">L√∂schen</button>`
                : `<button class="btn-small btn-soft" data-archive="${o.id}">Archivieren</button>`
              }
            </div>
          </div>
          ${o.note ? `<div class="hint" style="margin-top:6px">Hinweis: ${escapeHtml(o.note)}</div>` : ``}
          <div class="items">
            ${o.items.map(it=>renderItemRow(it, !archived)).join("")}
          </div>
        `;
        target.appendChild(wrap);
      }

      // handlers
      target.querySelectorAll("[data-archive]").forEach(b=>{
        b.addEventListener("click", ()=> archiveOrder(b.getAttribute("data-archive")));
      });
      target.querySelectorAll("[data-restore]").forEach(b=>{
        b.addEventListener("click", ()=> restoreOrder(b.getAttribute("data-restore")));
      });
      target.querySelectorAll("[data-del]").forEach(b=>{
        b.addEventListener("click", ()=> deleteOrder(b.getAttribute("data-del")));
      });

      // edit open order items (pencil)
      target.querySelectorAll("[data-edit-item]").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const itemId = b.getAttribute("data-edit-item");
          await openEditOpenItem(itemId);
        });
      });
    }

    function renderItemRow(it, allowEdit){
      const pr = prioLabel(it.priority); // ‚úÖ ohne "Priorit√§t:"
      let title = "";
      let sub = "";
      if(it.product_type==="bunny"){
        title = `üê∞ Hase ${it.bunny_size}cm ‚Ä¢ x${it.quantity}`;
        if(it.bunny_mode==="single"){
          sub = `Einfarbig: ${it.bunny_single_color || it.bunny_body_color || ""}`;
        } else {
          sub = `K√∂rper: ${it.bunny_body_color} ‚Ä¢ Ohren: ${it.bunny_ear_color} ‚Ä¢ Popo: ${it.bunny_butt_color}`;
        }
      } else if(it.product_type==="lumi"){
        title = `‚ú®ü™≤ Lumi ‚Ä¢ x${it.quantity}`;
        sub = `K√∂rper: ${it.lumi_body_color} ‚Ä¢ Fl√ºgel: ${it.lumi_wing_color} ‚Ä¢ F√ºhler: ${it.lumi_feeler_color}`;
      } else {
        title = `‚ûï Weitere ‚Ä¢ x${it.quantity}`;
        sub = `Gr√∂√üe: ${it.other_size} ‚Ä¢ Farbe: ${it.other_color} ‚Ä¢ ${it.other_description || ""}`;
      }

      return `
        <div class="itemLine">
          <div class="itemL">
            <div class="itemT">${escapeHtml(title)} <span class="pill" style="margin-left:6px">${escapeHtml(pr)}</span></div>
            <div class="itemS">${escapeHtml(sub)}</div>
          </div>
          ${allowEdit ? `<button class="iconBtn" data-edit-item="${it.id}" title="Bearbeiten">‚úé</button>` : ``}
        </div>
      `;
    }

    async function openEditOpenItem(itemId){
      // load item
      const { data: it, error } = await supabase.from("order_items").select("*").eq("id", itemId).single();
      if(error){ alert(error.message); return; }

      modalBody.innerHTML = `
        <div class="grid">
          <div class="hint">Bearbeiten: ${escapeHtml(it.product_type)} ‚Ä¢ x${it.quantity}</div>
          <div class="label">Menge</div>
          <input class="field" id="eoQty" value="${it.quantity}" inputmode="numeric" />
          <div class="label">Priorit√§t</div>
          <div class="prioRow">
            <button class="prioBtn small" data-pr="very">Sehr wichtig</button>
            <button class="prioBtn" data-pr="normal">Wichtig</button>
            <button class="prioBtn small" data-pr="low">Nicht wichtig</button>
          </div>
          <div id="eoFields"></div>
          <button class="btn" id="eoSave">Speichern</button>
        </div>
      `;

      modalBody.querySelectorAll("[data-pr]").forEach(b=>{
        if(b.getAttribute("data-pr")===it.priority) b.classList.add("active");
        b.addEventListener("click", ()=>{
          modalBody.querySelectorAll("[data-pr]").forEach(x=>x.classList.remove("active"));
          b.classList.add("active");
        });
      });

      const f = modalBody.querySelector("#eoFields");
      if(it.product_type==="bunny"){
        if(it.bunny_mode==="single"){
          f.innerHTML = `
            <div class="label">Einfarbig</div>
            <input class="field" id="eoC1" value="${it.bunny_single_color || it.bunny_body_color || ""}" />
          `;
        } else {
          f.innerHTML = `
            <div class="grid grid-3">
              <div><div class="label">K√∂rper</div><input class="field" id="eoC1" value="${it.bunny_body_color || ""}"></div>
              <div><div class="label">Ohren</div><input class="field" id="eoC2" value="${it.bunny_ear_color || ""}"></div>
              <div><div class="label">Popo</div><input class="field" id="eoC3" value="${it.bunny_butt_color || ""}"></div>
            </div>
          `;
        }
      } else if(it.product_type==="lumi"){
        f.innerHTML = `
          <div class="grid grid-3">
            <div><div class="label">K√∂rper</div><input class="field" id="eoC1" value="${it.lumi_body_color || ""}"></div>
            <div><div class="label">Fl√ºgel</div><input class="field" id="eoC2" value="${it.lumi_wing_color || ""}"></div>
            <div><div class="label">F√ºhler</div><input class="field" id="eoC3" value="${it.lumi_feeler_color || ""}"></div>
          </div>
        `;
      } else {
        f.innerHTML = `
          <div class="grid grid-2">
            <div><div class="label">Gr√∂√üe</div><input class="field" id="eoC1" value="${it.other_size || ""}"></div>
            <div><div class="label">Farbe</div><input class="field" id="eoC2" value="${it.other_color || ""}"></div>
            <div style="grid-column:1/-1"><div class="label">Beschreibung</div><input class="field" id="eoC3" value="${it.other_description || ""}"></div>
          </div>
        `;
      }

      modalBody.querySelector("#eoSave").addEventListener("click", async ()=>{
        const newQty = Number(modalBody.querySelector("#eoQty").value);
        if(!Number.isFinite(newQty) || newQty<=0) return;
        const newPr = modalBody.querySelector("[data-pr].active")?.getAttribute("data-pr") || it.priority;

        const patch = { quantity: newQty, priority: newPr };

        if(it.product_type==="bunny"){
          if(it.bunny_mode==="single"){
            const c = modalBody.querySelector("#eoC1").value.trim();
            patch.bunny_single_color = c;
            patch.bunny_body_color = c;
            patch.bunny_ear_color = c;
            patch.bunny_butt_color = c;
          } else {
            patch.bunny_body_color = modalBody.querySelector("#eoC1").value.trim();
            patch.bunny_ear_color  = modalBody.querySelector("#eoC2").value.trim();
            patch.bunny_butt_color = modalBody.querySelector("#eoC3").value.trim();
          }
        } else if(it.product_type==="lumi"){
          patch.lumi_body_color = modalBody.querySelector("#eoC1").value.trim();
          patch.lumi_wing_color = modalBody.querySelector("#eoC2").value.trim();
          patch.lumi_feeler_color = modalBody.querySelector("#eoC3").value.trim();
        } else {
          patch.other_size = modalBody.querySelector("#eoC1").value.trim();
          patch.other_color = modalBody.querySelector("#eoC2").value.trim();
          patch.other_description = modalBody.querySelector("#eoC3").value.trim();
        }

        const { error: uErr } = await supabase.from("order_items").update(patch).eq("id", itemId);
        if(uErr){ alert(uErr.message); return; }
        closeEditModal();
        await loadAll();
      });

      modalBack.style.display = "flex";
    }

    function renderArchive(target, archived){
      // group by month-year
      const groups = new Map();
      for(const o of archived){
        const d = new Date(o.created_at);
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
        const name = d.toLocaleString("de-DE", { month:"long", year:"numeric" });
        const arr = groups.get(key) || { name, orders: [] };
        arr.orders.push(o);
        groups.set(key, arr);
      }

      // newest month first
      const keys = [...groups.keys()].sort((a,b)=> b.localeCompare(a));
      target.innerHTML = "";

      if(keys.length===0){
        target.innerHTML = `<div class="hint">Archiv ist leer.</div>`;
        return;
      }

      for(const k of keys){
        const g = groups.get(k);
        const title = document.createElement("div");
        title.className = "monthTitle";
        title.textContent = g.name;
        target.appendChild(title);

        renderOrders(target, g.orders, { archived:true });
      }
    }

    function escapeHtml(str){
      return String(str ?? "").replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[s]));
    }

    // sorting toggle
    sortDate.addEventListener("click", ()=>{
      sortMode = "date";
      sortDate.className = "btn-small btn";
      sortPrio.className = "btn-small btn-soft";
      loadAll();
    });
    sortPrio.addEventListener("click", ()=>{
      sortMode = "prio";
      sortPrio.className = "btn-small btn";
      sortDate.className = "btn-small btn-soft";
      loadAll();
    });

    // init defaults (NO auto selections)
    setActiveProduct("bunny");
    refreshCart();
    refreshSaveEnabled();
    await loadAll();
  </script>
</body>
</html>

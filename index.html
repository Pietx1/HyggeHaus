<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bestellungen</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --soft:#f1f5f9;
      --dark:#0b1220;
      --dark2:#121a2b;
      --danger:#b91c1c;
      --ok:#047857;
      --shadow:0 10px 26px rgba(0,0,0,.08);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .container{max-width:1100px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;margin-bottom:14px}
    .title{font-size:42px;letter-spacing:-.02em;margin:0}
    .hint{color:var(--muted);font-size:14px;white-space:nowrap}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--r);
      box-shadow:var(--shadow);
    }
    .pad{padding:16px}
    .sep{height:14px}
    .grid{display:grid;gap:12px}
    @media(min-width:900px){ .grid-2{grid-template-columns:1fr 1fr} }
    @media(min-width:900px){ .grid-3{grid-template-columns:repeat(3,1fr)} }

    .sectionTitle{font-size:20px;margin:0 0 10px}
    .subTitle{font-size:14px;color:var(--muted);margin:0 0 10px}
    label{display:block;font-weight:700;font-size:13px;margin-bottom:6px}
    input, textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    textarea{min-height:90px;resize:vertical}

    /* buttons */
    .rowBtns{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:16px;
      padding:12px 14px;
      font-weight:800;
      cursor:pointer;
      min-width:120px;
      box-shadow:0 6px 14px rgba(0,0,0,.04);
    }
    .btn:active{transform:translateY(1px)}
    .btnDark{
      background:linear-gradient(180deg,var(--dark2),var(--dark));
      color:#fff;
      border-color:transparent;
    }
    .btnSoft{
      background:var(--soft);
      border-color:transparent;
      color:var(--text);
    }
    .btnSmall{padding:9px 12px;border-radius:14px;font-weight:800;min-width:auto}
    .btnDanger{background:#fff;color:var(--danger);border-color:#fecaca}
    .btnDanger:hover{background:#fff5f5}
    .btnOk{background:#fff;border-color:#bbf7d0;color:var(--ok)}
    .btnWide{width:100%;justify-content:center;text-align:center}
    .btnDisabled{opacity:.45;cursor:not-allowed}

    /* Priority buttons */
    .prioWrap{display:flex;gap:10px;align-items:stretch}
    .prioSmall{flex:1}
    .prioBig{flex:1.35}
    .prioBtn{
      width:100%;
      border:1px solid var(--border);
      background:#fff;
      border-radius:16px;
      padding:12px 10px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.04);
    }
    .prioBtn.active{
      background:linear-gradient(180deg,var(--dark2),var(--dark));
      color:#fff;border-color:transparent;
    }

    /* quantity */
    .qtyRow{display:flex;gap:10px;flex-wrap:wrap}
    .qtyBtn{
      width:62px;
      height:42px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:900;
      cursor:pointer;
    }
    .qtyBtn.active{background:linear-gradient(180deg,var(--dark2),var(--dark));color:#fff;border-color:transparent}
    .qtyOtherWrap{display:flex;gap:10px;align-items:center}
    .qtyOtherWrap input{max-width:180px}

    /* form error */
    .formError{
      margin-top:10px;
      font-weight:900;
      color:var(--danger);
      display:none;
      align-items:center;
      gap:8px;
    }
    .errorOutline{border-color:var(--danger) !important; box-shadow:0 0 0 3px rgba(185,28,28,.15)}
    .errorLabel{color:var(--danger)}

    /* dropdown (custom) */
    .ddWrap{position:relative}
    .ddInputWrap{
      display:flex;align-items:center;gap:10px;
    }
    .ddInputWrap input{
      padding-right:44px;
    }
    .ddArrowBtn{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      width:34px;height:34px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
    }
    .ddArrowBtn:active{transform:translateY(-50%) translateY(1px)}
    .ddArrowBtn svg{width:18px;height:18px;opacity:.8}
    .ddMenu{
      position:absolute;
      left:0; right:0;
      top:calc(100% + 8px);
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:var(--shadow);
      padding:8px;
      display:none;
      z-index:50;
      max-height:260px;
      overflow:auto;
    }
    .ddMenu.open{display:block}
    .ddItem{
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      color:var(--text);
    }
    .ddItem:hover{background:var(--soft)}
    .ddNote{
      padding:8px 10px;
      color:var(--muted);
      font-size:12px;
    }

    /* layout helpers */
    .twoCols{display:grid;gap:12px}
    @media(min-width:900px){ .twoCols{grid-template-columns:1fr 1fr} }

    .chips{display:flex;gap:10px;flex-wrap:wrap}
    .chip{
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      min-width:110px;
      text-align:center;
    }
    .chip.active{
      background:linear-gradient(180deg,var(--dark2),var(--dark));
      color:#fff;
      border-color:transparent;
    }

    .cartCard{
      border:1px dashed #cbd5e1;
      background:#fff;
      border-radius:16px;
      padding:12px;
    }
    .cartHead{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .cartTitle{font-weight:1000}
    .cartList{display:grid;gap:8px;margin-top:10px}
    .cartItem{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      background:#fff;
    }
    .cartMeta{color:var(--muted);font-size:13px;margin-top:3px;line-height:1.25}
    .iconBtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:12px;
      width:38px;height:38px;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
    }
    .iconBtn:hover{background:var(--soft)}
    .iconBtn svg{width:18px;height:18px}

    /* orders */
    .ordersHead{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .ordersHead .left .title2{font-weight:1000;font-size:18px}
    .ordersHead .left .sum{color:var(--muted);font-weight:900;margin-top:4px}
    .sortBtns{display:flex;gap:10px;align-items:center}
    .orderBox{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:#fff;
      box-shadow:0 6px 14px rgba(0,0,0,.04);
    }
    .orderTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .orderDate{color:var(--muted);font-size:13px;font-weight:900}
    .orderCustomer{font-weight:1000}
    .orderBadge{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      background:var(--soft);font-weight:1000;font-size:13px
    }
    .badgeVery{background:#ffe4e6;color:#9f1239}
    .badgeNorm{background:#ffedd5;color:#9a3412}
    .badgeLow{background:#e0f2fe;color:#075985}

    .orderItems{margin-top:10px;display:grid;gap:8px}
    .orderLine{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .lineLeft{min-width:0}
    .lineName{font-weight:1000}
    .lineMeta{color:var(--muted);font-size:13px;margin-top:4px;line-height:1.25}
    .lineRight{display:flex;gap:8px;align-items:center}
    .lineQty{
      font-weight:1000;
      font-size:14px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      white-space:nowrap;
    }

    details.archive{margin-top:10px}
    details.archive summary{cursor:pointer;font-weight:1000;color:var(--muted)}
    .archiveWrap{margin-top:10px}

    .soldBigBtn{
      width:100%;
      border-radius:18px;
      padding:14px;
      margin-top:12px;
      background:#fff;
      border:1px solid var(--border);
      cursor:pointer;
      font-weight:1000;
      text-align:center;
    }
    .soldBigBtn strong{font-size:16px}
    .soldBigBtn .small{display:block;color:var(--muted);font-weight:900;font-size:12px;margin-top:4px}

    /* modal */
    .modalBack{
      position:fixed;inset:0;
      background:rgba(15,23,42,.55);
      display:none;
      align-items:center;justify-content:center;
      padding:18px;
      z-index:200;
    }
    .modal{
      width:min(720px,100%);
      background:#fff;
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 14px;
      border-bottom:1px solid var(--border);
      background:var(--soft);
      gap:10px;
    }
    .modalTitle{font-weight:1000;font-size:18px;margin:0}
    .modalBody{padding:14px}
    .modalFoot{padding:14px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}
    .okMsg{color:var(--ok);font-weight:1000;display:none;margin-top:8px}
    .dangerMsg{color:var(--danger);font-weight:1000;display:none;margin-top:8px}

    /* icons */
    .ico{display:inline-flex;align-items:center;gap:8px}
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <h1 class="title">Bestellungen</h1>
      <div class="hint">GitHub Pages ‚Ä¢ Supabase</div>
    </div>

    <!-- ============ NEUE BESTELLUNG ============ -->
    <div class="card">
      <div class="pad">
        <div class="rowBtns">
          <button id="btnBunny" class="btn">üê∞ Hase</button>
          <button id="btnLumi" class="btn">‚ú®ü™≤ Lumi</button>
          <button id="btnOther" class="btn">‚ûï Weitere Produkt</button>
        </div>

        <div class="sep"></div>

        <div id="newTitle" class="sectionTitle">Neue Bestellung</div>

        <!-- Produkt-spezifische Auswahl -->
        <div id="productArea" class="grid"></div>

        <div class="sep"></div>

        <!-- Priorit√§t -->
        <label>Priorit√§t</label>
        <div class="prioWrap">
          <div class="prioSmall"><button id="pVery" class="prioBtn">Sehr wichtig</button></div>
          <div class="prioBig"><button id="pNorm" class="prioBtn">Wichtig</button></div>
          <div class="prioSmall"><button id="pLow"  class="prioBtn">Nicht wichtig</button></div>
        </div>

        <div class="sep"></div>

        <!-- Farben + Kunde -->
        <div id="colorArea" class="grid"></div>

        <div class="sep"></div>

        <div class="twoCols">
          <div>
            <label for="customer">Kundenname</label>
            <input id="customer" placeholder="z. B. Max Mustermann" />
          </div>
          <div>
            <label for="note">Beschreibung (optional)</label>
            <textarea id="note" placeholder="z. B. Sonderwunsch, Hinweis ‚Ä¶"></textarea>
          </div>
        </div>

        <div class="sep"></div>

        <!-- Menge -->
        <label>Menge</label>
        <div class="qtyRow" id="qtyBtns">
          <button class="qtyBtn" data-qty="1">1</button>
          <button class="qtyBtn" data-qty="2">2</button>
          <button class="qtyBtn" data-qty="3">3</button>
          <button class="qtyBtn" data-qty="4">4</button>
          <button class="qtyBtn" data-qty="5">5</button>
          <button class="qtyBtn" data-qty="6">6</button>
          <button class="qtyBtn" data-qty="7">7</button>
          <button class="qtyBtn" data-qty="8">8</button>
          <button class="qtyBtn" data-qty="9">9</button>
        </div>

        <div class="sep"></div>

        <div class="qtyOtherWrap">
          <div style="flex:1">
            <label for="qtyOther">Andere Menge (optional)</label>
            <input id="qtyOther" placeholder="z. B. 12" inputmode="numeric" />
          </div>
          <div style="flex:1; display:flex; align-items:flex-end;">
            <button id="addItemBtn" class="btn btnDark btnWide">+ Position hinzuf√ºgen</button>
          </div>
        </div>

        <div id="formError" class="formError">‚ùó Bitte erst alles ausf√ºllen.</div>

        <div class="sep"></div>

        <!-- Warenkorb / Positionen -->
        <div class="cartCard">
          <div class="cartHead">
            <div class="cartTitle">Positionen in dieser Bestellung</div>
            <div class="subTitle" id="cartSum">Summe: 0,00 ‚Ç¨</div>
          </div>
          <div id="cartList" class="cartList"></div>
          <div class="subTitle" id="cartHint">Noch keine Position hinzugef√ºgt.</div>

          <div class="sep"></div>

          <button id="saveOrderBtn" class="btn btnDark btnWide btnDisabled" disabled>‚úÖ Bestellung speichern</button>
          <div id="saveStatus" class="okMsg">Gespeichert ‚úÖ</div>
        </div>
      </div>
    </div>

    <div class="sep"></div>

    <!-- ============ OFFENE BESTELLUNGEN ============ -->
    <div class="card">
      <div class="pad">
        <div class="ordersHead">
          <div class="left">
            <div class="title2">Offene Bestellungen</div>
            <div class="sum" id="openSum">Summe offen: 0,00 ‚Ç¨</div>
          </div>
          <div class="sortBtns">
            <button id="sortDate" class="btnSmall btn btnDark">Sort: Datum</button>
            <button id="sortPrio" class="btnSmall btn btnSoft">Sort: Priorit√§t</button>
          </div>
        </div>

        <div class="sep"></div>

        <div id="openOrders" class="grid"></div>

        <details class="archive">
          <summary>Archiv (alte Bestellungen anzeigen)</summary>
          <div class="archiveWrap">
            <div id="archiveOrders" class="grid"></div>
          </div>
        </details>

        <!-- gro√üer Button: verkauft gesamt (Korrektur per Klick) -->
        <button id="soldBtn" class="soldBigBtn" type="button">
          <strong id="soldSum">Verkauft gesamt: 0,00 ‚Ç¨</strong>
          <span class="small">Klicken f√ºr Korrektur / Abzug</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ================= MODAL: Position bearbeiten ================= -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <h3 class="modalTitle">Position bearbeiten</h3>
        <button class="iconBtn" id="closeModal" title="Schlie√üen">‚úï</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFoot">
        <button class="btn btnSoft" id="cancelEditBtn">Abbrechen</button>
        <button class="btn btnDark" id="saveEditBtn">Speichern</button>
      </div>
    </div>
  </div>

  <!-- ================= MODAL: verkauft gesamt ‚Äì Abz√ºge ================= -->
  <div class="modalBack" id="adjBack">
    <div class="modal">
      <div class="modalHead">
        <h3 class="modalTitle">Korrektur (verkauft gesamt)</h3>
        <button class="iconBtn" id="closeAdj" title="Schlie√üen">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="subTitle">W√§hle, was du abziehen willst (wird als negativer Betrag gespeichert).</div>

        <div class="grid">
          <div class="rowBtns">
            <button class="btn btnSoft" id="adjChooseBunny">üê∞ Hase</button>
            <button class="btn btnSoft" id="adjChooseLumi">‚ú®ü™≤ Lumi</button>
            <button class="btn btnSoft" id="adjChooseCombo">üê∞üê∞üê∞ Hase Combo</button>
            <button class="btn btnSoft" id="adjChooseOther">‚ûï Weiteres Produkt</button>
          </div>

          <div id="adjStep2" style="display:none">
            <div class="sep"></div>
            <div id="adjPickArea"></div>
          </div>

          <div class="sep"></div>
          <label for="adjNote">Notiz (optional)</label>
          <input id="adjNote" placeholder="z. B. Rabatt / Fehler / Kunde ‚Ä¶" />

          <div class="sep"></div>
          <button class="btn btnDark btnWide" id="addAdjBtn">Abzug speichern</button>
          <div class="okMsg" id="adjMsg">Gespeichert ‚úÖ</div>
          <div class="dangerMsg" id="adjErr">Fehler</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Script kommt in Teil 2/4 -->

  <!-- Supabase + App Script -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ‚úÖ HIER EINTRAGEN (Supabase ‚Üí Project Settings ‚Üí Data API ‚Üí URL / anon public key)
    const SUPABASE_URL = "https://htgrzmlcdolxxzvkppon.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0Z3J6bWxjZG9seHh6dmtwcG9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MzM2ODIsImV4cCI6MjA4NTAwOTY4Mn0.B0PxMAzmuvsHNd2n_mgNspjlPkaBpQlkrNzGu7p78fY";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------- DOM ----------
    const btnBunny = document.getElementById("btnBunny");
    const btnLumi  = document.getElementById("btnLumi");
    const btnOther = document.getElementById("btnOther");
    const newTitle = document.getElementById("newTitle");
    const productArea = document.getElementById("productArea");
    const colorArea = document.getElementById("colorArea");

    const pVery = document.getElementById("pVery");
    const pNorm = document.getElementById("pNorm");
    const pLow  = document.getElementById("pLow");

    const customer = document.getElementById("customer");
    const noteEl = document.getElementById("note");

    const qtyBtns = [...document.querySelectorAll("#qtyBtns .qtyBtn")];
    const qtyOther = document.getElementById("qtyOther");

    const addItemBtn = document.getElementById("addItemBtn");
    const saveOrderBtn = document.getElementById("saveOrderBtn");
    const saveStatus = document.getElementById("saveStatus");

    const formError = document.getElementById("formError");

    const cartList = document.getElementById("cartList");
    const cartHint = document.getElementById("cartHint");
    const cartSum  = document.getElementById("cartSum");

    const openOrdersEl = document.getElementById("openOrders");
    const archiveOrdersEl = document.getElementById("archiveOrders");
    const openSumEl = document.getElementById("openSum");
    const soldSumEl = document.getElementById("soldSum");

    const sortDate = document.getElementById("sortDate");
    const sortPrio = document.getElementById("sortPrio");

    // Edit modal
    const modalBack = document.getElementById("modalBack");
    const modalBody = document.getElementById("modalBody");
    const closeModal = document.getElementById("closeModal");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const saveEditBtn = document.getElementById("saveEditBtn");

    // sold adjustments modal
    const soldBtn = document.getElementById("soldBtn");
    const adjBack = document.getElementById("adjBack");
    const closeAdj = document.getElementById("closeAdj");
    const addAdjBtn = document.getElementById("addAdjBtn");
    const adjNote = document.getElementById("adjNote");
    const adjMsg = document.getElementById("adjMsg");
    const adjErr = document.getElementById("adjErr");
    const adjChooseBunny = document.getElementById("adjChooseBunny");
    const adjChooseLumi = document.getElementById("adjChooseLumi");
    const adjChooseCombo = document.getElementById("adjChooseCombo");
    const adjChooseOther = document.getElementById("adjChooseOther");
    const adjStep2 = document.getElementById("adjStep2");
    const adjPickArea = document.getElementById("adjPickArea");

    // ---------- Consts ----------
    const COLOR_SUGGESTIONS = ["wei√ü","schwarz","grau","rot","blau","gelb","gr√ºn","orange","pink","lila","braun","beige","gold","silber"];

    // Preise (DU kannst sp√§ter die Werte √§ndern)
    const PRICES = {
      bunny: { "20": 12.0, "15": 9.0, "11": 6.0, combo: 22.0 }, // <- combo Preis
      lumi: 8.0, // <- lumi Preis
    };

    const PRIORITY = {
      very: "Sehr wichtig",
      normal: "Wichtig",
      low: "Nicht wichtig"
    };
    const priorRank = (p) => p==="very" ? 0 : p==="normal" ? 1 : 2;

    // ---------- State ----------
    let currentProduct = null; // 'bunny' | 'lumi' | 'other'
    let bunnySize = null;      // '20'|'15'|'11'
    let bunnyMode = null;      // 'single'|'multi' (Einfarbig)
    let priority = null;       // 'very'|'normal'|'low'
    let qty = null;            // number (from 1-9 buttons)
    let cart = [];             // items before saving order

    let sortMode = "date";     // 'date' | 'prio'

    // dropdown state (inputs)
    let fields = {
      // bunny
      bunny_body: "",
      bunny_ears: "",
      bunny_butt: "",
      bunny_single: "",

      // lumi
      lumi_body: "",
      lumi_wings: "",
      lumi_feelers: "",

      // other
      other_size: "",
      other_color: ""
    };

    // editing
    let editing = null; // { orderId, itemId, itemData }

    // ---------- Helpers ----------
    function euro(n){ return (Number(n)||0).toFixed(2).replace(".", ",") + " ‚Ç¨"; }

    function setBtnActive(btn, on){
      btn.classList.toggle("btnDark", on);
      btn.classList.toggle("btnSoft", !on);
    }
    function setChipActive(el, on){ el.classList.toggle("active", on); }
    function clearErrorUI(){
      formError.style.display = "none";
      document.querySelectorAll(".errorOutline").forEach(x=>x.classList.remove("errorOutline"));
      document.querySelectorAll(".errorLabel").forEach(x=>x.classList.remove("errorLabel"));
    }
    function showError(missingIds = [], msg="‚ùó Bitte erst alles ausf√ºllen."){
      formError.textContent = msg;
      formError.style.display = "flex";
      // mark fields red
      missingIds.forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.classList.add("errorOutline");
        const lab = document.querySelector(`label[for="${id}"]`);
        if(lab) lab.classList.add("errorLabel");
      });
      // auto scroll a bit to make it visible
      formError.scrollIntoView({ behavior:"smooth", block:"nearest" });
    }

    function formatDateOnly(iso){
      const d = new Date(iso);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}.${mm}.${yy}`;
    }

    function iconChevronDown(){
      return `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M6 9l6 6 6-6"></path>
        </svg>`;
    }
    function iconPencil(){
      return `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
             stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M12 20h9"></path>
          <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
        </svg>`;
    }

    // ---------- Custom Dropdown (Fix: Arrow always clickable, mobile OK) ----------
    function buildDropdown({ id, label, placeholder }){
      return `
        <div class="ddWrap">
          <label for="${id}">${label}</label>
          <div class="ddInputWrap">
            <input id="${id}" placeholder="${placeholder}" autocomplete="off" />
            <button type="button" class="ddArrowBtn" data-dd-btn="${id}" aria-label="Dropdown √∂ffnen">
              ${iconChevronDown()}
            </button>
          </div>
          <div class="ddMenu" data-dd-menu="${id}">
            <div class="ddNote">Tippen oder ausw√§hlen</div>
            ${COLOR_SUGGESTIONS.map(c=>`<div class="ddItem" data-dd-item="${id}" data-value="${c}">${c}</div>`).join("")}
          </div>
        </div>
      `;
    }

    function setupDropdown(inputId){
      const input = document.getElementById(inputId);
      const btn = document.querySelector(`[data-dd-btn="${inputId}"]`);
      const menu = document.querySelector(`[data-dd-menu="${inputId}"]`);

      function open(){
        menu.classList.add("open");
      }
      function close(){
        menu.classList.remove("open");
      }
      function toggle(){
        menu.classList.toggle("open");
      }

      // IMPORTANT: clicking arrow opens (works on mobile)
      btn.addEventListener("click", (e)=>{ e.preventDefault(); toggle(); input.focus(); });

      // click on input also opens
      input.addEventListener("focus", ()=>open());
      input.addEventListener("click", ()=>open());

      // select item
      menu.querySelectorAll(`[data-dd-item="${inputId}"]`).forEach(it=>{
        it.addEventListener("click", ()=>{
          const v = it.getAttribute("data-value") || "";
          input.value = v;
          fields[inputId] = v;
          close();
          validateForAdd();
        });
      });

      // typing custom
      input.addEventListener("input", ()=>{
        fields[inputId] = input.value.trim();
        validateForAdd();
      });

      // close on outside click
      document.addEventListener("click", (e)=>{
        const inside = menu.contains(e.target) || input.contains(e.target) || btn.contains(e.target);
        if(!inside) close();
      });
    }

    // ---------- Product UI Builders ----------
    function renderProductArea(){
      // buttons should NOT auto-select. user must click.
      productArea.innerHTML = "";

      if(currentProduct === "bunny"){
        productArea.innerHTML = `
          <div>
            <label>Gr√∂√üe</label>
            <div class="chips">
              <div class="chip" id="size20">20 cm</div>
              <div class="chip" id="size15">15 cm</div>
              <div class="chip" id="size11">11 cm</div>
            </div>
          </div>

          <div class="sep"></div>

          <div>
            <label>Farbmodus</label>
            <div class="chips">
              <div class="chip" id="modeMulti">Mehrfarbig</div>
              <div class="chip" id="modeSingle">Einfarbig</div>
            </div>
          </div>
        `;

        // size buttons
        const s20 = document.getElementById("size20");
        const s15 = document.getElementById("size15");
        const s11 = document.getElementById("size11");
        [s20,s15,s11].forEach(el=>{
          el.addEventListener("click", ()=>{
            bunnySize = el.id==="size20" ? "20" : el.id==="size15" ? "15" : "11";
            [s20,s15,s11].forEach(x=>setChipActive(x, x===el));
            validateForAdd();
          });
        });

        // mode buttons
        const mMulti = document.getElementById("modeMulti");
        const mSingle = document.getElementById("modeSingle");
        [mMulti,mSingle].forEach(el=>{
          el.addEventListener("click", ()=>{
            bunnyMode = (el.id==="modeSingle") ? "single" : "multi";
            [mMulti,mSingle].forEach(x=>setChipActive(x, x===el));
            // reset fields for bunny colors when switching
            fields.bunny_body=""; fields.bunny_ears=""; fields.bunny_butt=""; fields.bunny_single="";
            renderColorArea();
            validateForAdd();
          });
        });

      } else if(currentProduct === "lumi"){
        productArea.innerHTML = `
          <div class="subTitle">Lumi hat keine Gr√∂√üe ‚Äì w√§hle Farben.</div>
        `;
      } else if(currentProduct === "other"){
        productArea.innerHTML = `
          <div class="twoCols">
            <div>
              <label for="other_size">Gr√∂√üe</label>
              <input id="other_size" placeholder="z. B. 30 cm / S / XL ‚Ä¶" />
            </div>
            <div></div>
          </div>
        `;
        const os = document.getElementById("other_size");
        os.addEventListener("input", ()=>{ fields.other_size = os.value.trim(); validateForAdd(); });
      }
    }

    function renderColorArea(){
      colorArea.innerHTML = "";

      if(currentProduct === "bunny"){
        if(bunnyMode === "single"){
          colorArea.innerHTML = `
            <div class="grid">
              ${buildDropdown({ id:"bunny_single", label:"Einfarbig", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
            </div>
          `;
          setupDropdown("bunny_single");
        } else if(bunnyMode === "multi"){
          colorArea.innerHTML = `
            <div class="grid grid-3">
              ${buildDropdown({ id:"bunny_body", label:"K√∂rperfarbe", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
              ${buildDropdown({ id:"bunny_ears", label:"Ohrenfarbe", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
              ${buildDropdown({ id:"bunny_butt", label:"Popofarbe", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
            </div>
          `;
          setupDropdown("bunny_body");
          setupDropdown("bunny_ears");
          setupDropdown("bunny_butt");
        } else {
          colorArea.innerHTML = `<div class="subTitle">Bitte zuerst <b>Farbmodus</b> w√§hlen.</div>`;
        }
      }

      if(currentProduct === "lumi"){
        colorArea.innerHTML = `
          <div class="grid grid-3">
            ${buildDropdown({ id:"lumi_body", label:"K√∂rperfarbe", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
            ${buildDropdown({ id:"lumi_wings", label:"Fl√ºgelfarbe", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
            ${buildDropdown({ id:"lumi_feelers", label:"F√ºhlerfarbe", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
          </div>
        `;
        setupDropdown("lumi_body");
        setupDropdown("lumi_wings");
        setupDropdown("lumi_feelers");
      }

      if(currentProduct === "other"){
        colorArea.innerHTML = `
          <div class="grid grid-2">
            ${buildDropdown({ id:"other_color", label:"Farbe", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
          </div>
        `;
        setupDropdown("other_color");
      }
    }

    // ---------- Selection handlers ----------
    function setProduct(p){
      currentProduct = p;
      bunnySize = null;
      bunnyMode = null;
      priority = null;
      qty = null;
      qtyOther.value = "";
      // clear color fields
      fields.bunny_body=""; fields.bunny_ears=""; fields.bunny_butt=""; fields.bunny_single="";
      fields.lumi_body=""; fields.lumi_wings=""; fields.lumi_feelers="";
      fields.other_size=""; fields.other_color="";

      // UI
      [btnBunny,btnLumi,btnOther].forEach(b=>b.classList.remove("btnDark"));
      btnBunny.classList.add(currentProduct==="bunny" ? "btnDark" : "");
      btnLumi.classList.add(currentProduct==="lumi" ? "btnDark" : "");
      btnOther.classList.add(currentProduct==="other" ? "btnDark" : "");

      // priority buttons reset (no auto active)
      [pVery,pNorm,pLow].forEach(x=>x.classList.remove("active"));

      // qty reset
      qtyBtns.forEach(b=>b.classList.remove("active"));

      newTitle.textContent =
        currentProduct==="bunny" ? "Neue Bestellung: Hase"
        : currentProduct==="lumi" ? "Neue Bestellung: Lumi"
        : "Neue Bestellung: Weitere Produkt";

      renderProductArea();
      renderColorArea();
      clearErrorUI();
      validateForAdd();
      validateSaveEnabled();
    }

    btnBunny.addEventListener("click", ()=>setProduct("bunny"));
    btnLumi.addEventListener("click", ()=>setProduct("lumi"));
    btnOther.addEventListener("click", ()=>setProduct("other"));

    // Priority (no auto select)
    function setPriority(p){
      priority = p;
      [pVery,pNorm,pLow].forEach(x=>x.classList.remove("active"));
      (p==="very" ? pVery : p==="normal" ? pNorm : pLow).classList.add("active");
      validateForAdd();
    }
    pVery.addEventListener("click", ()=>setPriority("very"));
    pNorm.addEventListener("click", ()=>setPriority("normal"));
    pLow.addEventListener("click", ()=>setPriority("low"));

    // qty
    qtyBtns.forEach(b=>{
      b.addEventListener("click", ()=>{
        qtyBtns.forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        qty = Number(b.getAttribute("data-qty"));
        validateForAdd();
      });
    });
    qtyOther.addEventListener("input", ()=>validateForAdd());

    // ---------- Validation for adding an item ----------
    function getQty(){
      const other = Number(String(qtyOther.value||"").replace(",", "."));
      if(Number.isFinite(other) && other>0) return Math.floor(other);
      return qty;
    }

    function validateForAdd(){
      clearErrorUI();
      const missing = [];

      if(!currentProduct) missing.push("btnBunny"); // dummy
      if(!priority) missing.push("pNorm");         // dummy
      if(!getQty()) missing.push("qtyOther");      // highlight other field if none selected

      if(currentProduct==="bunny"){
        if(!bunnySize) missing.push("size20");
        if(!bunnyMode) missing.push("modeMulti");
        if(bunnyMode==="single"){
          if(!fields.bunny_single) missing.push("bunny_single");
        }else if(bunnyMode==="multi"){
          if(!fields.bunny_body) missing.push("bunny_body");
          if(!fields.bunny_ears) missing.push("bunny_ears");
          if(!fields.bunny_butt) missing.push("bunny_butt");
        }
      }

      if(currentProduct==="lumi"){
        if(!fields.lumi_body) missing.push("lumi_body");
        if(!fields.lumi_wings) missing.push("lumi_wings");
        if(!fields.lumi_feelers) missing.push("lumi_feelers");
      }

      if(currentProduct==="other"){
        if(!fields.other_size) missing.push("other_size");
        if(!fields.other_color) missing.push("other_color");
      }

      // customer optional? you wanted it free; not required, so not in missing.
      // description optional too.

      return missing.length===0;
    }

    // ---------- Cart pricing ----------
    function priceForItem(it){
      // it: { product, bunny_size, bunny_mode, qty, ... , price_override? }
      const q = Number(it.qty||1);

      if(it.price_override != null && Number.isFinite(Number(it.price_override))){
        return Number(it.price_override) * q;
      }

      if(it.product === "bunny"){
        const p = PRICES.bunny[it.bunny_size] ?? 0;
        return p * q;
      }
      if(it.product === "lumi"){
        return PRICES.lumi * q;
      }
      if(it.product === "other"){
        // other price not defined -> 0 (you can override later in edit)
        return 0;
      }
      return 0;
    }

    function cartTotal(){
      return cart.reduce((s,it)=>s + priceForItem(it), 0);
    }

    function validateSaveEnabled(){
      const ok = cart.length > 0;
      saveOrderBtn.disabled = !ok;
      saveOrderBtn.classList.toggle("btnDisabled", !ok);
    }

    // ---------- Cart render ----------
    function renderCart(){
      cartList.innerHTML = "";
      cartHint.style.display = cart.length ? "none" : "block";
      cartSum.textContent = "Summe: " + euro(cartTotal());

      cart.forEach((it, idx)=>{
        const name =
          it.product==="bunny" ? `Hase ${it.bunny_size} cm`
          : it.product==="lumi" ? `Lumi`
          : `Weitere Produkt`;

        const pr = PRIORITY[it.priority] || "";
        const qtyTxt = `Menge: ${it.qty}`;

        const colors = (() => {
          if(it.product==="bunny"){
            if(it.bunny_mode==="single"){
              return `Farbe: ${it.colors.single}`;
            }
            return `K√∂rper: ${it.colors.body} ‚Ä¢ Ohren: ${it.colors.ears} ‚Ä¢ Popo: ${it.colors.butt}`;
          }
          if(it.product==="lumi"){
            return `K√∂rper: ${it.colors.body} ‚Ä¢ Fl√ºgel: ${it.colors.wings} ‚Ä¢ F√ºhler: ${it.colors.feelers}`;
          }
          return `Gr√∂√üe: ${it.other_size} ‚Ä¢ Farbe: ${it.other_color}`;
        })();

        const customerTxt = it.customer_name ? `Kunde: ${it.customer_name}` : "";

        const meta = [pr, colors, qtyTxt, customerTxt].filter(Boolean).join("<br>");

        const row = document.createElement("div");
        row.className = "cartItem";
        row.innerHTML = `
          <div class="lineLeft">
            <div class="lineName">${escapeHtml(name)}</div>
            <div class="cartMeta">${meta}</div>
            ${it.note ? `<div class="cartMeta">Hinweis: ${escapeHtml(it.note)}</div>` : ``}
            <div class="cartMeta"><b>Preis:</b> ${euro(priceForItem(it))}${it.price_override!=null ? " (angepasst)" : ""}</div>
          </div>
          <div class="lineRight">
            <button class="iconBtn" title="Bearbeiten" data-edit="${idx}">${iconPencil()}</button>
            <button class="iconBtn" title="Entfernen" data-del="${idx}">üóë</button>
          </div>
        `;
        cartList.appendChild(row);
      });

      cartList.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const idx = Number(btn.getAttribute("data-del"));
          cart.splice(idx,1);
          renderCart();
          validateSaveEnabled();
        });
      });
      cartList.querySelectorAll("[data-edit]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const idx = Number(btn.getAttribute("data-edit"));
          openEditCartItem(idx);
        });
      });
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[s]));
    }

    // ---------- Add item ----------
    addItemBtn.addEventListener("click", ()=>{
      clearErrorUI();
      const missingOk = validateForAdd();
      if(!missingOk){
        // show message + red outlines on missing required fields
        // we can't know exact ids from validateForAdd without returning them,
        // so we compute them again quickly:
        const missing = [];
        if(!currentProduct) missing.push("btnBunny");
        if(!priority) missing.push("pNorm");
        if(!getQty()) missing.push("qtyOther");

        if(currentProduct==="bunny"){
          if(!bunnySize) missing.push("size20");
          if(!bunnyMode) missing.push("modeMulti");
          if(bunnyMode==="single"){
            if(!fields.bunny_single) missing.push("bunny_single");
          }else if(bunnyMode==="multi"){
            if(!fields.bunny_body) missing.push("bunny_body");
            if(!fields.bunny_ears) missing.push("bunny_ears");
            if(!fields.bunny_butt) missing.push("bunny_butt");
          }
        }
        if(currentProduct==="lumi"){
          if(!fields.lumi_body) missing.push("lumi_body");
          if(!fields.lumi_wings) missing.push("lumi_wings");
          if(!fields.lumi_feelers) missing.push("lumi_feelers");
        }
        if(currentProduct==="other"){
          if(!fields.other_size) missing.push("other_size");
          if(!fields.other_color) missing.push("other_color");
        }

        showError(missing, "‚ùó Bitte erst ausf√ºllen: " + missingLabel(missing));
        return;
      }

      const q = getQty();
      const it = {
        product: currentProduct,
        priority,
        qty: q,
        note: (noteEl.value||"").trim() || null,
        customer_name: (customer.value||"").trim() || null,
        price_override: null
      };

      if(currentProduct==="bunny"){
        it.bunny_size = bunnySize;
        it.bunny_mode = bunnyMode;
        it.colors = bunnyMode==="single"
          ? { single: fields.bunny_single }
          : { body: fields.bunny_body, ears: fields.bunny_ears, butt: fields.bunny_butt };
      }
      if(currentProduct==="lumi"){
        it.colors = { body: fields.lumi_body, wings: fields.lumi_wings, feelers: fields.lumi_feelers };
      }
      if(currentProduct==="other"){
        it.other_size = fields.other_size;
        it.other_color = fields.other_color;
      }

      cart.push(it);
      renderCart();
      validateSaveEnabled();

      // do NOT auto-reset selections (you didn't ask), keep user selections
      saveStatus.style.display = "none";
    });

    function missingLabel(ids){
      // nicer red-text output
      const map = {
        size20: "Gr√∂√üe",
        modeMulti: "Farbmodus",
        bunny_single: "Einfarbig",
        bunny_body: "K√∂rperfarbe",
        bunny_ears: "Ohrenfarbe",
        bunny_butt: "Popofarbe",
        lumi_body: "K√∂rperfarbe",
        lumi_wings: "Fl√ºgelfarbe",
        lumi_feelers: "F√ºhlerfarbe",
        other_size: "Gr√∂√üe",
        other_color: "Farbe",
        qtyOther: "Menge",
        pNorm: "Priorit√§t",
      };
      const uniq = [...new Set(ids.map(x=>map[x]).filter(Boolean))];
      return uniq.join(", ") || "Pflichtfelder";
    }

    // ---------- Cart item edit modal ----------
    function openEditCartItem(idx){
      editing = { type:"cart", idx };
      const it = cart[idx];

      modalBody.innerHTML = buildEditForm(it, { allowPrice:true });
      modalBack.style.display = "flex";
    }

    closeModal.addEventListener("click", ()=>modalBack.style.display="none");
    cancelEditBtn.addEventListener("click", ()=>modalBack.style.display="none");
    modalBack.addEventListener("click", (e)=>{ if(e.target===modalBack) modalBack.style.display="none"; });

    saveEditBtn.addEventListener("click", ()=>{
      if(!editing) return;

      if(editing.type==="cart"){
        const idx = editing.idx;
        const it = cart[idx];
        applyEditFormToItem(it);
        cart[idx] = it;
        renderCart();
        validateSaveEnabled();
        modalBack.style.display="none";
        return;
      }

      if(editing.type==="open"){
        // handled in part 3 (saving to DB)
      }
    });

    function buildEditForm(it, { allowPrice }){
      // NOTE: We keep it simple: customer/note/qty/priority/colors; plus price override field
      const prioOptions = ["very","normal","low"].map(p=>{
        const t = PRIORITY[p];
        return `<button type="button" class="prioBtn ${it.priority===p?"active":""}" data-eprio="${p}">${t}</button>`;
      }).join("");

      const priceVal = it.price_override!=null ? String(it.price_override) : "";

      const base = `
        <div class="grid">
          <div>
            <label>Kundenname</label>
            <input id="e_customer" value="${escapeHtml(it.customer_name||"")}" placeholder="Kunde" />
          </div>

          <div>
            <label>Beschreibung (optional)</label>
            <textarea id="e_note" placeholder="Hinweis‚Ä¶">${escapeHtml(it.note||"")}</textarea>
          </div>

          <div>
            <label>Priorit√§t</label>
            <div class="prioWrap" id="e_prioWrap">${prioOptions}</div>
          </div>

          <div>
            <label>Menge</label>
            <input id="e_qty" inputmode="numeric" value="${escapeHtml(String(it.qty||1))}" />
          </div>

          ${allowPrice ? `
          <div>
            <label>Preis pro St√ºck (optional √ºberschreiben)</label>
            <input id="e_price" inputmode="decimal" placeholder="z. B. 8" value="${escapeHtml(priceVal)}" />
            <div class="subTitle">Leer lassen = Standardpreis</div>
          </div>` : ``}
        </div>
      `;

      const colors = (() => {
        if(it.product==="bunny"){
          if(it.bunny_mode==="single"){
            return `
              <div class="sep"></div>
              <div class="grid">
                ${buildDropdown({ id:"e_bunny_single", label:"Einfarbig", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
              </div>
            `;
          }
          return `
            <div class="sep"></div>
            <div class="grid grid-3">
              ${buildDropdown({ id:"e_bunny_body", label:"K√∂rperfarbe", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
              ${buildDropdown({ id:"e_bunny_ears", label:"Ohrenfarbe", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
              ${buildDropdown({ id:"e_bunny_butt", label:"Popofarbe", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
            </div>
          `;
        }
        if(it.product==="lumi"){
          return `
            <div class="sep"></div>
            <div class="grid grid-3">
              ${buildDropdown({ id:"e_lumi_body", label:"K√∂rperfarbe", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
              ${buildDropdown({ id:"e_lumi_wings", label:"Fl√ºgelfarbe", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
              ${buildDropdown({ id:"e_lumi_feelers", label:"F√ºhlerfarbe", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
            </div>
          `;
        }
        return `
          <div class="sep"></div>
          <div class="grid grid-2">
            <div>
              <label>Gr√∂√üe</label>
              <input id="e_other_size" value="${escapeHtml(it.other_size||"")}" />
            </div>
            ${buildDropdown({ id:"e_other_color", label:"Farbe", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
          </div>
        `;
      })();

      // attach after open
      setTimeout(()=> {
        // priority buttons
        const wrap = document.getElementById("e_prioWrap");
        wrap.querySelectorAll("[data-eprio]").forEach(b=>{
          b.addEventListener("click", ()=>{
            wrap.querySelectorAll("[data-eprio]").forEach(x=>x.classList.remove("active"));
            b.classList.add("active");
          });
        });

        // dropdowns init + set values
        if(it.product==="bunny" && it.bunny_mode==="single"){
          setupDropdown("e_bunny_single");
          document.getElementById("e_bunny_single").value = it.colors.single || "";
          fields["e_bunny_single"] = it.colors.single || "";
        } else if(it.product==="bunny"){
          setupDropdown("e_bunny_body");
          setupDropdown("e_bunny_ears");
          setupDropdown("e_bunny_butt");
          document.getElementById("e_bunny_body").value = it.colors.body || "";
          document.getElementById("e_bunny_ears").value = it.colors.ears || "";
          document.getElementById("e_bunny_butt").value = it.colors.butt || "";
          fields["e_bunny_body"]=it.colors.body||"";
          fields["e_bunny_ears"]=it.colors.ears||"";
          fields["e_bunny_butt"]=it.colors.butt||"";
        }
        if(it.product==="lumi"){
          setupDropdown("e_lumi_body");
          setupDropdown("e_lumi_wings");
          setupDropdown("e_lumi_feelers");
          document.getElementById("e_lumi_body").value = it.colors.body || "";
          document.getElementById("e_lumi_wings").value = it.colors.wings || "";
          document.getElementById("e_lumi_feelers").value = it.colors.feelers || "";
          fields["e_lumi_body"]=it.colors.body||"";
          fields["e_lumi_wings"]=it.colors.wings||"";
          fields["e_lumi_feelers"]=it.colors.feelers||"";
        }
        if(it.product==="other"){
          setupDropdown("e_other_color");
          document.getElementById("e_other_color").value = it.other_color || "";
          fields["e_other_color"]=it.other_color||"";
        }
      }, 0);

      return base + colors;
    }

    function applyEditFormToItem(it){
      const e_customer = document.getElementById("e_customer");
      const e_note = document.getElementById("e_note");
      const e_qty = document.getElementById("e_qty");
      const e_price = document.getElementById("e_price");

      it.customer_name = (e_customer?.value||"").trim() || null;
      it.note = (e_note?.value||"").trim() || null;

      const q = Math.max(1, Math.floor(Number(String(e_qty?.value||"1").replace(",", "."))));
      it.qty = q;

      // priority
      const pr = document.querySelector("#e_prioWrap .active")?.getAttribute("data-eprio");
      if(pr) it.priority = pr;

      // price override per piece
      if(e_price){
        const v = String(e_price.value||"").trim();
        if(!v){
          it.price_override = null;
        } else {
          const num = Number(v.replace(",", "."));
          it.price_override = Number.isFinite(num) ? num : null;
        }
      }

      // colors
      if(it.product==="bunny"){
        if(it.bunny_mode==="single"){
          it.colors.single = (document.getElementById("e_bunny_single")?.value||"").trim();
        }else{
          it.colors.body = (document.getElementById("e_bunny_body")?.value||"").trim();
          it.colors.ears = (document.getElementById("e_bunny_ears")?.value||"").trim();
          it.colors.butt = (document.getElementById("e_bunny_butt")?.value||"").trim();
        }
      }
      if(it.product==="lumi"){
        it.colors.body = (document.getElementById("e_lumi_body")?.value||"").trim();
        it.colors.wings = (document.getElementById("e_lumi_wings")?.value||"").trim();
        it.colors.feelers = (document.getElementById("e_lumi_feelers")?.value||"").trim();
      }
      if(it.product==="other"){
        it.other_size = (document.getElementById("e_other_size")?.value||"").trim();
        it.other_color = (document.getElementById("e_other_color")?.value||"").trim();
      }
    }

    // ---------- init UI: start with nothing selected ----------
    function init(){
      // product buttons initial style
      btnBunny.classList.remove("btnDark");
      btnLumi.classList.remove("btnDark");
      btnOther.classList.remove("btnDark");

      renderProductArea();
      renderColorArea();
      renderCart();
      validateSaveEnabled();
    }

    init();

    // Part 3/4 will add: DB save order + fetch/render open/archive + edit open orders + archive/restore/delete + sold adjustments + sorting
  
	    // ---------- DB helpers ----------
    async function dbCreateOrderWithItems(items){
      // create order
      const { data: o, error: oErr } = await supabase
        .from("orders")
        .insert({
          archived: false,
          customer_name: (customer.value||"").trim() || null,
          note: (noteEl.value||"").trim() || null
        })
        .select("id,created_at")
        .single();

      if(oErr) throw oErr;

      const orderId = o.id;

      // map cart items -> order_items rows
      const rows = items.map(it=>{
        const base = {
          order_id: orderId,
          product: it.product,
          size: it.product==="bunny" ? it.bunny_size : it.product==="other" ? (it.other_size||null) : null,
          colors: it.product==="bunny"
            ? (it.bunny_mode==="single"
                ? { mode:"single", single: it.colors.single }
                : { mode:"multi", body: it.colors.body, ears: it.colors.ears, butt: it.colors.butt })
            : it.product==="lumi"
              ? { body: it.colors.body, wings: it.colors.wings, feelers: it.colors.feelers }
              : { color: it.other_color || "" },
          priority: it.priority,
          qty: it.qty,
          price_override: it.price_override
        };
        return base;
      });

      const { error: iErr } = await supabase.from("order_items").insert(rows);
      if(iErr) throw iErr;

      return orderId;
    }

    async function dbFetchAll(){
      // orders + items
      const { data: orders, error: oErr } = await supabase
        .from("orders")
        .select("id,created_at,archived,customer_name,note");
      if(oErr) throw oErr;

      const { data: items, error: iErr } = await supabase
        .from("order_items")
        .select("id,order_id,created_at,product,size,colors,priority,qty,price_override");
      if(iErr) throw iErr;

      const { data: adjs, error: aErr } = await supabase
        .from("adjustments")
        .select("id,created_at,amount_eur,note");
      if(aErr) throw aErr;

      // join
      const byOrder = new Map();
      for(const o of (orders||[])){
        byOrder.set(o.id, { ...o, items: [] });
      }
      for(const it of (items||[])){
        const o = byOrder.get(it.order_id);
        if(o) o.items.push(it);
      }

      return {
        orders: [...byOrder.values()],
        adjustments: adjs || []
      };
    }

    function humanProduct(it){
      if(it.product==="bunny"){
        return `Hase ${it.size || ""} cm`.trim();
      }
      if(it.product==="lumi") return "Lumi";
      return "Weitere Produkt";
    }

    function humanPriority(p){
      return PRIORITY[p] || "Wichtig";
    }

    function badgeClass(p){
      return p==="very" ? "badgeVery" : p==="normal" ? "badgeNorm" : "badgeLow";
    }

    function lineMeta(it){
      const q = Number(it.qty||1);
      const pr = humanPriority(it.priority);

      let colors = "";
      if(it.product==="bunny"){
        const mode = it.colors?.mode;
        if(mode==="single"){
          colors = `Farbe: ${it.colors.single || ""}`;
        } else {
          colors = `K√∂rper: ${it.colors.body || ""} ‚Ä¢ Ohren: ${it.colors.ears || ""} ‚Ä¢ Popo: ${it.colors.butt || ""}`;
        }
      } else if(it.product==="lumi"){
        colors = `K√∂rper: ${it.colors?.body || ""} ‚Ä¢ Fl√ºgel: ${it.colors?.wings || ""} ‚Ä¢ F√ºhler: ${it.colors?.feelers || ""}`;
      } else {
        colors = `Gr√∂√üe: ${it.size || ""} ‚Ä¢ Farbe: ${it.colors?.color || ""}`;
      }

      // requested: not "Priorit√§t: sehr wichtig" but just "Sehr wichtig"
      return `${pr}<br>${escapeHtml(colors)}<br>Menge: ${q}`;
    }

    // pricing: works per item, and bundles are calculated per ORDER (only for standard bunny items without overrides)
    function priceForOrderItems(orderItems){
      const items = orderItems || [];

      // overrides: count separately at unit override * qty
      const overridden = items.filter(i => i.price_override != null && Number.isFinite(Number(i.price_override)));
      const normal = items.filter(i => i.price_override == null || !Number.isFinite(Number(i.price_override)));

      let total = 0;

      for(const it of overridden){
        total += Number(it.price_override) * Number(it.qty||0);
      }

      // now normal pricing with bunny combo logic
      // count bunnies by size
      const b20 = normal.filter(i=>i.product==="bunny" && i.size==="20").reduce((s,i)=>s+Number(i.qty||0),0);
      const b15 = normal.filter(i=>i.product==="bunny" && i.size==="15").reduce((s,i)=>s+Number(i.qty||0),0);
      const b11 = normal.filter(i=>i.product==="bunny" && i.size==="11").reduce((s,i)=>s+Number(i.qty||0),0);

      const lumis = normal.filter(i=>i.product==="lumi").reduce((s,i)=>s+Number(i.qty||0),0);

      // other defaults to 0 unless override exists (so stays 0 here)
      // Bunny combo: one set requires at least one of each size
      let sets = Math.min(b20,b15,b11);
      total += sets * PRICES.bunny.combo;

      // remaining bunnies
      total += (b20 - sets) * PRICES.bunny["20"];
      total += (b15 - sets) * PRICES.bunny["15"];
      total += (b11 - sets) * PRICES.bunny["11"];

      total += lumis * PRICES.lumi;

      return total;
    }

    function sortOrders(orders){
      const arr = [...orders];
      if(sortMode === "prio"){
        arr.sort((a,b)=>{
          // higher priority first (very->low), then date
          const ap = Math.min(...(a.items||[]).map(x=>priorRank(x.priority)));
          const bp = Math.min(...(b.items||[]).map(x=>priorRank(x.priority)));
          if(ap !== bp) return ap - bp;
          return new Date(b.created_at) - new Date(a.created_at);
        });
        return arr;
      }
      // date
      arr.sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
      return arr;
    }

    // ---------- Render orders ----------
    function renderOpen(orders){
      openOrdersEl.innerHTML = "";

      const open = sortOrders(orders.filter(o=>!o.archived));

      for(const o of open){
        const box = document.createElement("div");
        box.className = "orderBox";

        const dateOnly = formatDateOnly(o.created_at);
        const cust = (o.customer_name||"").trim();
        const orderTotal = priceForOrderItems(o.items);

        box.innerHTML = `
          <div class="orderTop">
            <div>
              <div class="orderCustomer">${cust ? escapeHtml(cust) : "Ohne Kundenname"}</div>
              <div class="orderDate">${dateOnly}</div>
              ${o.note ? `<div class="subTitle" style="margin-top:8px">${escapeHtml(o.note)}</div>` : ``}
            </div>
            <div class="right" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <div class="orderBadge">Summe: ${euro(orderTotal)}</div>
              <button class="iconBtn" title="Archivieren" data-arch="${o.id}">üìÅ</button>
            </div>
          </div>

          <div class="orderItems">
            ${(o.items||[]).map(it=>{
              return `
                <div class="orderLine">
                  <div class="lineLeft">
                    <div class="lineName">${escapeHtml(humanProduct(it))}</div>
                    <div class="lineMeta">${lineMeta(it)}</div>
                  </div>
                  <div class="lineRight">
                    <div class="lineQty">x${Number(it.qty||1)}</div>
                    <button class="iconBtn" title="Bearbeiten" data-edit-open="${o.id}" data-item="${it.id}">
                      ${iconPencil()}
                    </button>
                  </div>
                </div>
              `;
            }).join("")}
          </div>
        `;

        openOrdersEl.appendChild(box);
      }

      // archive button for order
      openOrdersEl.querySelectorAll("[data-arch]").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const id = b.getAttribute("data-arch");
          await supabase.from("orders").update({ archived:true }).eq("id", id);
          await loadAll();
        });
      });

      // edit open item
      openOrdersEl.querySelectorAll("[data-edit-open]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const orderId = b.getAttribute("data-edit-open");
          const itemId = b.getAttribute("data-item");
          openEditOpenItem(orderId, itemId);
        });
      });
    }

    function monthKey(dateIso){
      const d = new Date(dateIso);
      const m = String(d.getMonth()+1).padStart(2,"0");
      return `${d.getFullYear()}-${m}`;
    }
    function monthLabel(key){
      const [y,m] = key.split("-");
      const names = ["Januar","Februar","M√§rz","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"];
      return `${names[Number(m)-1]} ${y}`;
    }

    function renderArchive(orders){
      archiveOrdersEl.innerHTML = "";

      const archived = sortOrders(orders.filter(o=>o.archived));
      if(archived.length === 0){
        archiveOrdersEl.innerHTML = `<div class="subTitle">Noch nichts im Archiv.</div>`;
        return;
      }

      // group by month
      const groups = new Map();
      for(const o of archived){
        const k = monthKey(o.created_at);
        if(!groups.has(k)) groups.set(k, []);
        groups.get(k).push(o);
      }
      const keys = [...groups.keys()].sort((a,b)=> b.localeCompare(a));

      for(const k of keys){
        const title = document.createElement("div");
        title.className = "orderBox";
        title.style.background = "transparent";
        title.style.border = "none";
        title.style.boxShadow = "none";
        title.innerHTML = `<div class="monthTitle">${monthLabel(k)}</div>`;
        archiveOrdersEl.appendChild(title);

        for(const o of groups.get(k)){
          const box = document.createElement("div");
          box.className = "orderBox";

          const dateOnly = formatDateOnly(o.created_at);
          const cust = (o.customer_name||"").trim();
          const orderTotal = priceForOrderItems(o.items);

          box.innerHTML = `
            <div class="orderTop">
              <div>
                <div class="orderCustomer">${cust ? escapeHtml(cust) : "Ohne Kundenname"}</div>
                <div class="orderDate">${dateOnly}</div>
                ${o.note ? `<div class="subTitle" style="margin-top:8px">${escapeHtml(o.note)}</div>` : ``}
              </div>
              <div class="right" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                <div class="orderBadge">Summe: ${euro(orderTotal)}</div>
                <button class="btnSmall btn btnOk" data-restore="${o.id}">Zur√ºckholen</button>
                <button class="btnSmall btn btnDanger" data-del-order="${o.id}">L√∂schen</button>
              </div>
            </div>

            <div class="orderItems">
              ${(o.items||[]).map(it=>{
                return `
                  <div class="orderLine">
                    <div class="lineLeft">
                      <div class="lineName">${escapeHtml(humanProduct(it))}</div>
                      <div class="lineMeta">${lineMeta(it)}</div>
                    </div>
                    <div class="lineRight">
                      <div class="lineQty">x${Number(it.qty||1)}</div>
                    </div>
                  </div>
                `;
              }).join("")}
            </div>
          `;
          archiveOrdersEl.appendChild(box);
        }
      }

      archiveOrdersEl.querySelectorAll("[data-restore]").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const id = b.getAttribute("data-restore");
          await supabase.from("orders").update({ archived:false }).eq("id", id);
          await loadAll();
        });
      });

      archiveOrdersEl.querySelectorAll("[data-del-order]").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const id = b.getAttribute("data-del-order");
          const ok = confirm("Bist du sicher, dass du diese Archiv-Bestellung l√∂schen willst?");
          if(!ok) return;
          await supabase.from("orders").delete().eq("id", id);
          await loadAll();
        });
      });
    }

    // ---------- Open item edit (DB) ----------
    async function openEditOpenItem(orderId, itemId){
      // fetch item (we have it in memory via loadAll, but simplest fetch)
      const { data, error } = await supabase
        .from("order_items")
        .select("id,order_id,product,size,colors,priority,qty,price_override")
        .eq("id", itemId)
        .single();
      if(error){ alert(error.message); return; }

      editing = { type:"open", orderId, itemId, item:data };

      // Build form for open item (allowPrice true)
      modalBody.innerHTML = buildEditForm(fromDbItemToCartLike(data), { allowPrice:true });
      modalBack.style.display = "flex";

      // Override the save handler for open items
      saveEditBtn.onclick = async ()=>{
        const it = fromDbItemToCartLike(data);
        applyEditFormToItem(it);

        // validate minimal: qty >= 1, priority exists
        if(!it.priority || !it.qty || it.qty<1){
          alert("Bitte Menge & Priorit√§t pr√ºfen.");
          return;
        }

        const patch = {
          priority: it.priority,
          qty: it.qty,
          price_override: it.price_override
        };

        // colors + size depending product
        if(it.product==="bunny"){
          patch.size = it.bunny_size;
          patch.colors = it.bunny_mode==="single"
            ? { mode:"single", single: it.colors.single }
            : { mode:"multi", body: it.colors.body, ears: it.colors.ears, butt: it.colors.butt };
        } else if(it.product==="lumi"){
          patch.size = null;
          patch.colors = { body: it.colors.body, wings: it.colors.wings, feelers: it.colors.feelers };
        } else {
          patch.size = it.other_size || null;
          patch.colors = { color: it.other_color || "" };
        }

        const { error: uErr } = await supabase.from("order_items").update(patch).eq("id", itemId);
        if(uErr){ alert(uErr.message); return; }

        // update order-level customer/note too (in same modal)
        const custVal = (document.getElementById("e_customer")?.value||"").trim() || null;
        const noteVal = (document.getElementById("e_note")?.value||"").trim() || null;
        await supabase.from("orders").update({ customer_name: custVal, note: noteVal }).eq("id", orderId);

        modalBack.style.display="none";
        await loadAll();
      };
    }

    function fromDbItemToCartLike(db){
      const it = {
        product: db.product,
        priority: db.priority,
        qty: Number(db.qty||1),
        note: null,
        customer_name: null,
        price_override: db.price_override
      };
      if(db.product==="bunny"){
        it.bunny_size = db.size;
        it.bunny_mode = db.colors?.mode || "multi";
        it.colors = it.bunny_mode==="single"
          ? { single: db.colors?.single || "" }
          : { body: db.colors?.body || "", ears: db.colors?.ears || "", butt: db.colors?.butt || "" };
      } else if(db.product==="lumi"){
        it.colors = { body: db.colors?.body || "", wings: db.colors?.wings || "", feelers: db.colors?.feelers || "" };
      } else {
        it.other_size = db.size || "";
        it.other_color = db.colors?.color || "";
      }
      return it;
    }

    // ---------- Save order ----------
    saveOrderBtn.addEventListener("click", async ()=>{
      if(cart.length===0) return;

      try{
        saveStatus.style.display = "none";
        saveOrderBtn.disabled = true;

        const orderId = await dbCreateOrderWithItems(cart);

        // reset cart + (optional) clear form inputs
        cart = [];
        renderCart();
        validateSaveEnabled();
        saveOrderBtn.disabled = false;

        saveStatus.style.display = "block";
        setTimeout(()=>saveStatus.style.display="none", 1500);

        await loadAll();
      } catch(e){
        alert(e.message || String(e));
        saveOrderBtn.disabled = false;
      }
    });

    // ---------- Sorting buttons ----------
    sortDate.addEventListener("click", ()=>{
      sortMode = "date";
      sortDate.classList.add("btnDark"); sortDate.classList.remove("btnSoft");
      sortPrio.classList.add("btnSoft"); sortPrio.classList.remove("btnDark");
      loadAll();
    });
    sortPrio.addEventListener("click", ()=>{
      sortMode = "prio";
      sortPrio.classList.add("btnDark"); sortPrio.classList.remove("btnSoft");
      sortDate.classList.add("btnSoft"); sortDate.classList.remove("btnDark");
      loadAll();
    });

    // ---------- Sold sum button opens modal ----------
    soldBtn.addEventListener("click", ()=>{
      adjMsg.style.display="none";
      adjErr.style.display="none";
      adjNote.value = "";
      adjStep2.style.display="none";
      adjPickArea.innerHTML = "";
      adjBack.style.display="flex";
    });

    closeAdj.addEventListener("click", ()=>adjBack.style.display="none");
    adjBack.addEventListener("click", (e)=>{ if(e.target===adjBack) adjBack.style.display="none"; });

    // ---------- Load & KPIs ----------
    async function loadAll(){
      const { orders, adjustments } = await dbFetchAll();

      renderOpen(orders);
      renderArchive(orders);

      // sums
      const openOrders = orders.filter(o=>!o.archived);
      const openTotal = openOrders.reduce((s,o)=>s + priceForOrderItems(o.items), 0);
      openSumEl.textContent = `Summe offen: ${euro(openTotal)}`;

      const archivedOrders = orders.filter(o=>o.archived);
      const soldRaw = archivedOrders.reduce((s,o)=>s + priceForOrderItems(o.items), 0);
      const adjSum = (adjustments||[]).reduce((s,a)=>s + Number(a.amount_eur||0), 0);

      const soldFinal = soldRaw + adjSum;
      soldSumEl.textContent = `Verkauft gesamt: ${euro(soldFinal)}`;
    }

    await loadAll();

    // Part 4/4 will add: adjustments UI (choose product/size/qty) + subtract logic + archive delete confirmations are already, but we add better step-2 UI and "other amount" + finalize script end tags.


</script>


</body>
</html>


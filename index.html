<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mein 3D-Druck Business</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    .container{ max-width:1100px; margin:0 auto; padding:24px; }
    h1{ font-size:28px; margin:0 0 16px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,.06); }
    .card-pad{ padding:16px; }
    .grid{ display:grid; gap:16px; }
    @media(min-width:900px){ .grid-3{ grid-template-columns:repeat(3,1fr); } }
    label{ font-weight:700; font-size:13px; }
    input, textarea, select{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    textarea{ min-height:90px; resize:vertical; }
    .row{ display:grid; gap:12px; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px; border:0; cursor:pointer; border-radius:12px;
      padding:10px 14px; font-weight:800; font-size:14px;
      background:#111827; color:#fff;
    }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .btn-danger{ background:#b91c1c; }
    .drop{
      border:2px dashed #cbd5e1; border-radius:16px; padding:18px;
      text-align:center; background:#fafafa; color:var(--muted);
    }
    .drop strong{ color:var(--text); }
    .topbar{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .hint{ color:var(--muted); font-size:13px; }
    .product img{ width:100%; height:180px; object-fit:cover; border-radius:12px; border:1px solid var(--border); background:#fff; }
    .product h3{ margin:10px 0 4px; font-size:16px; }
    .product p{ margin:0; color:var(--muted); font-size:13px; line-height:1.35; }
    .status{ margin-top:10px; font-size:13px; color:var(--muted); }
    .error{ color:#b91c1c; }
    .ok{ color:#047857; }
    .section-title{ font-weight:900; margin:10px 0 6px; }
    .order-line{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      border:1px solid var(--border); border-radius:12px; padding:8px 10px;
      background:#fff;
    }
    .order-badges{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .badge{
      border:1px solid var(--border);
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
      background:#f9fafb;
    }
    .order-form{ display:grid; gap:10px; }
    .order-grid{ display:grid; grid-template-columns:1fr 1fr 1fr 110px; gap:10px; }
    @media(max-width:900px){ .order-grid{ grid-template-columns:1fr 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h1>Mein 3D-Druck Business</h1>
      <div class="hint">GitHub Pages ‚Ä¢ Supabase</div>
    </div>

    <!-- Produkt anlegen -->
    <div class="card">
      <div class="card-pad">
        <h2 style="margin:0 0 12px;font-size:18px;">Produkt anlegen</h2>

        <div class="row">
          <div>
            <label for="name">Produktname</label>
            <input id="name" placeholder="z. B. Bunny 20cm" />
          </div>

          <div>
            <label for="desc">Beschreibung</label>
            <textarea id="desc" placeholder="Kurzbeschreibung‚Ä¶"></textarea>
          </div>

          <div id="drop" class="drop">
            <div><strong>Bild</strong> hier ablegen oder klicken üì∏</div>
            <div id="fileName" style="margin-top:6px;"></div>
            <input id="file" type="file" accept="image/*" style="display:none" />
          </div>

          <button id="saveBtn" class="btn" disabled>+ Produkt speichern</button>

          <div id="status" class="status"></div>
        </div>
      </div>
    </div>

    <div style="height:18px"></div>

    <!-- Produkte -->
    <div id="list" class="grid grid-3"></div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ‚úÖ Deine Daten:
    const SUPABASE_URL = "https://htgrzmlcdolxxzvkppon.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0Z3J6bWxjZG9seHh6dmtwcG9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MzM2ODIsImV4cCI6MjA4NTAwOTY4Mn0.B0PxMAzmuvsHNd2n_mgNspjlPkaBpQlkrNzGu7p78fY";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Farben f√ºr Dropdown (kannst du beliebig anpassen)
    const COLORS = [
      "schwarz","wei√ü","grau","blau","rot","gelb","gr√ºn","orange","pink","lila","braun"
    ];

    const elName = document.getElementById("name");
    const elDesc = document.getElementById("desc");
    const elFile = document.getElementById("file");
    const elDrop = document.getElementById("drop");
    const elFileName = document.getElementById("fileName");
    const elSave = document.getElementById("saveBtn");
    const elStatus = document.getElementById("status");
    const elList = document.getElementById("list");

    let imageFile = null;

    function setStatus(msg, type="") {
      elStatus.className = "status " + type;
      elStatus.textContent = msg || "";
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[s]));
    }

    function updateSaveEnabled() {
      elSave.disabled = !(elName.value.trim() && imageFile);
    }

    elName.addEventListener("input", updateSaveEnabled);

    elDrop.addEventListener("click", () => elFile.click());
    elDrop.addEventListener("dragover", (e) => { e.preventDefault(); });
    elDrop.addEventListener("drop", (e) => {
      e.preventDefault();
      const f = e.dataTransfer.files?.[0];
      if (f) setFile(f);
    });

    elFile.addEventListener("change", () => {
      const f = elFile.files?.[0];
      if (f) setFile(f);
    });

    function setFile(f) {
      imageFile = f;
      elFileName.textContent = f.name;
      updateSaveEnabled();
    }

    function colorOptionsHtml(selected) {
      return COLORS.map(c => `<option value="${escapeHtml(c)}" ${c===selected ? "selected":""}>${escapeHtml(c)}</option>`).join("");
    }

    async function loadProducts() {
      setStatus("Lade Produkte‚Ä¶");

      const { data: products, error: pErr } = await supabase
        .from("products")
        .select("id,name,desc,image,created_at")
        .order("created_at", { ascending: false });

      if (pErr) {
        setStatus("Fehler beim Laden: " + pErr.message, "error");
        return;
      }

      const ids = (products || []).map(p => p.id);

      let orders = [];
      if (ids.length) {
        const { data: oData, error: oErr } = await supabase
          .from("orders")
          .select("id,product_id,body_color,ears_color,butt_color,qty,created_at")
          .in("product_id", ids)
          .order("created_at", { ascending: true });

        if (oErr) {
          setStatus("Fehler beim Laden (Bestellungen): " + oErr.message, "error");
          return;
        }
        orders = oData || [];
      }

      const byProduct = new Map();
      for (const o of orders) {
        if (!byProduct.has(o.product_id)) byProduct.set(o.product_id, []);
        byProduct.get(o.product_id).push(o);
      }

      renderProducts(products || [], byProduct);
      setStatus("");
    }

    async function addProduct() {
      const name = elName.value.trim();
      const desc = elDesc.value.trim();
      if (!name || !imageFile) return;

      setStatus("Upload l√§uft‚Ä¶");

      const fileName = `${Date.now()}-${imageFile.name}`;

      const { error: upErr } = await supabase
        .storage
        .from("product-images")
        .upload(fileName, imageFile, { upsert: false });

      if (upErr) {
        setStatus("Upload-Fehler: " + upErr.message, "error");
        return;
      }

      const { data: pub } = supabase
        .storage
        .from("product-images")
        .getPublicUrl(fileName);

      const imageUrl = pub?.publicUrl;

      const { error: insErr } = await supabase
        .from("products")
        .insert({ name, desc, image: imageUrl });

      if (insErr) {
        setStatus("DB-Fehler: " + insErr.message, "error");
        return;
      }

      elName.value = "";
      elDesc.value = "";
      imageFile = null;
      elFile.value = "";
      elFileName.textContent = "";
      updateSaveEnabled();

      setStatus("Gespeichert ‚úÖ", "ok");
      await loadProducts();
    }

    async function deleteProduct(id) {
      setStatus("L√∂sche Produkt‚Ä¶");
      const { error } = await supabase.from("products").delete().eq("id", id);
      if (error) {
        setStatus("L√∂schen fehlgeschlagen: " + error.message, "error");
        return;
      }
      setStatus("Gel√∂scht ‚úÖ", "ok");
      await loadProducts();
    }

    async function addOrder(productId, bodyColor, earsColor, buttColor, qty) {
      if (!productId) return;
      if (!bodyColor || !earsColor || !buttColor) {
        setStatus("Bitte alle Farben ausw√§hlen.", "error");
        return;
      }
      const q = parseInt(qty, 10);
      if (!Number.isFinite(q) || q < 1) {
        setStatus("Menge muss >= 1 sein.", "error");
        return;
      }

      setStatus("Speichere Bestell-Position‚Ä¶");

      const { error } = await supabase
        .from("orders")
        .insert({
          product_id: productId,
          body_color: bodyColor,
          ears_color: earsColor,
          butt_color: buttColor,
          qty: q
        });

      if (error) {
        setStatus("Fehler (Order): " + error.message, "error");
        return;
      }

      setStatus("Gespeichert ‚úÖ", "ok");
      await loadProducts();
    }

    async function deleteOrder(orderId) {
      setStatus("Entferne Position‚Ä¶");
      const { error } = await supabase.from("orders").delete().eq("id", orderId);
      if (error) {
        setStatus("Fehler beim Entfernen: " + error.message, "error");
        return;
      }
      setStatus("Entfernt ‚úÖ", "ok");
      await loadProducts();
    }

    function renderProducts(products, ordersByProduct) {
      elList.innerHTML = "";

      for (const p of products) {
        const card = document.createElement("div");
        card.className = "card card-pad product";

        // Bild-Link robust
        const bucket = "product-images";
        const imageSrc = (p.image && p.image.startsWith("http"))
          ? p.image
          : (p.image ? `${SUPABASE_URL}/storage/v1/object/public/${bucket}/${encodeURIComponent(p.image)}` : "");

        const orders = ordersByProduct.get(p.id) || [];
        const totalQty = orders.reduce((sum, o) => sum + (o.qty || 0), 0);

        const ordersHtml = orders.length
          ? orders.map(o => `
              <div class="order-line">
                <div class="order-badges">
                  <span class="badge"><b>K√∂rper:</b> ${escapeHtml(o.body_color)}</span>
                  <span class="badge"><b>Ohren:</b> ${escapeHtml(o.ears_color)}</span>
                  <span class="badge"><b>Popo:</b> ${escapeHtml(o.butt_color)}</span>
                  <span class="badge"><b>Menge:</b> ${o.qty}</span>
                </div>
                <button class="btn btn-danger" data-order-id="${o.id}" style="padding:8px 10px;font-size:12px;">Entfernen</button>
              </div>
            `).join("")
          : `<div class="hint">Noch keine Bestellungen.</div>`;

        card.innerHTML = `
          <img src="${imageSrc}" alt="${escapeHtml(p.name || "")}">
          <h3>${escapeHtml(p.name || "")}</h3>
          <p>${escapeHtml(p.desc || "")}</p>

          <div class="section-title">Bestellungen (K√∂rper/Ohren/Popo + Menge)</div>

          <div class="order-form">
            <div class="order-grid">
              <div>
                <label>K√∂rper</label>
                <select data-body-for="${p.id}">
                  ${colorOptionsHtml("schwarz")}
                </select>
              </div>
              <div>
                <label>Ohren</label>
                <select data-ears-for="${p.id}">
                  ${colorOptionsHtml("schwarz")}
                </select>
              </div>
              <div>
                <label>Popo</label>
                <select data-butt-for="${p.id}">
                  ${colorOptionsHtml("schwarz")}
                </select>
              </div>
              <div>
                <label>Menge</label>
                <input type="number" min="1" value="1" data-qty-for="${p.id}">
              </div>
            </div>

            <button class="btn" data-add-order-for="${p.id}">+ Position hinzuf√ºgen</button>

            <div class="hint">Gesamtmenge f√ºr dieses Produkt: <b>${totalQty}</b></div>

            <div style="display:grid;gap:8px;">
              ${ordersHtml}
            </div>

            <div style="display:flex;justify-content:flex-end;">
              <button class="btn btn-danger" data-delete-product="${p.id}">Produkt l√∂schen</button>
            </div>
          </div>
        `;

        elList.appendChild(card);
      }

      // Produkt l√∂schen
      elList.querySelectorAll("button[data-delete-product]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-delete-product");
          if (!id) return;
          await deleteProduct(id);
        });
      });

      // Order hinzuf√ºgen
      elList.querySelectorAll("button[data-add-order-for]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const productId = btn.getAttribute("data-add-order-for");
          const bodyEl = elList.querySelector(`select[data-body-for="${productId}"]`);
          const earsEl = elList.querySelector(`select[data-ears-for="${productId}"]`);
          const buttEl = elList.querySelector(`select[data-butt-for="${productId}"]`);
          const qtyEl  = elList.querySelector(`input[data-qty-for="${productId}"]`);

          await addOrder(
            productId,
            bodyEl?.value || "",
            earsEl?.value || "",
            buttEl?.value || "",
            qtyEl?.value || "1"
          );

          if (qtyEl) qtyEl.value = "1";
        });
      });

      // Order entfernen
      elList.querySelectorAll("button[data-order-id]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const orderId = btn.getAttribute("data-order-id");
          if (!orderId) return;
          await deleteOrder(orderId);
        });
      });
    }

    elSave.addEventListener("click", addProduct);

    // Start
    await loadProducts();
  </script>
</body>
</html>

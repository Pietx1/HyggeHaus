<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mein 3D-Druck Business</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    .container{ max-width:1100px; margin:0 auto; padding:24px; }
    h1{ font-size:28px; margin:0 0 16px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,.06); }
    .card-pad{ padding:16px; }
    .grid{ display:grid; gap:16px; }
    @media(min-width:900px){ .grid-3{ grid-template-columns:repeat(3,1fr); } }
    label{ font-weight:600; font-size:14px; }
    input, textarea{ width:100%; border:1px solid var(--border); border-radius:12px; padding:10px 12px; font-size:14px; outline:none; }
    textarea{ min-height:90px; resize:vertical; }
    .row{ display:grid; gap:12px; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px; border:0; cursor:pointer; border-radius:12px;
      padding:10px 14px; font-weight:700; font-size:14px;
      background:#111827; color:#fff;
    }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .drop{
      border:2px dashed #cbd5e1; border-radius:16px; padding:18px;
      text-align:center; background:#fafafa; color:var(--muted);
    }
    .drop strong{ color:var(--text); }
    .topbar{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .hint{ color:var(--muted); font-size:13px; }
    .product img{ width:100%; height:180px; object-fit:cover; border-radius:12px; border:1px solid var(--border); background:#fff; }
    .product h3{ margin:10px 0 4px; font-size:16px; }
    .product p{ margin:0; color:var(--muted); font-size:13px; line-height:1.35; }
    .prod-actions{ display:flex; justify-content:flex-end; margin-top:10px; }
    .btn-danger{ background:#b91c1c; }
    .status{ margin-top:10px; font-size:13px; color:var(--muted); }
    .error{ color:#b91c1c; }
    .ok{ color:#047857; }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h1>Mein 3D-Druck Business</h1>
      <div class="hint">GitHub Pages â€¢ Supabase</div>
    </div>

    <div class="card">
      <div class="card-pad">
        <h2 style="margin:0 0 12px;font-size:18px;">Produkt anlegen</h2>

        <div class="row">
          <div>
            <label for="name">Produktname</label>
            <input id="name" placeholder="z. B. Handyhalter" />
          </div>

          <div>
            <label for="desc">Beschreibung</label>
            <textarea id="desc" placeholder="Kurzbeschreibungâ€¦"></textarea>
          </div>

          <div id="drop" class="drop">
            <div><strong>Bild</strong> hier ablegen oder klicken ðŸ“¸</div>
            <div id="fileName" style="margin-top:6px;"></div>
            <input id="file" type="file" accept="image/*" style="display:none" />
          </div>

          <button id="saveBtn" class="btn" disabled>+ Produkt speichern</button>

          <div id="status" class="status"></div>
        </div>
      </div>
    </div>

    <div style="height:18px"></div>

    <div id="list" class="grid grid-3"></div>
  </div>

  <!-- Supabase JS (Browser) -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // âœ… HIER EINTRAGEN:
    const SUPABASE_URL = "https://htgrzmlcdolxxzvkppon.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0Z3J6bWxjZG9seHh6dmtwcG9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MzM2ODIsImV4cCI6MjA4NTAwOTY4Mn0.B0PxMAzmuvsHNd2n_mgNspjlPkaBpQlkrNzGu7p78fY";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const elName = document.getElementById("name");
    const elDesc = document.getElementById("desc");
    const elFile = document.getElementById("file");
    const elDrop = document.getElementById("drop");
    const elFileName = document.getElementById("fileName");
    const elSave = document.getElementById("saveBtn");
    const elStatus = document.getElementById("status");
    const elList = document.getElementById("list");

    let imageFile = null;

    function setStatus(msg, type="") {
      elStatus.className = "status " + type;
      elStatus.textContent = msg || "";
    }

    function updateSaveEnabled() {
      elSave.disabled = !(elName.value.trim() && imageFile);
    }

    elName.addEventListener("input", updateSaveEnabled);

    elDrop.addEventListener("click", () => elFile.click());
    elDrop.addEventListener("dragover", (e) => { e.preventDefault(); });
    elDrop.addEventListener("drop", (e) => {
      e.preventDefault();
      const f = e.dataTransfer.files?.[0];
      if (f) setFile(f);
    });

    elFile.addEventListener("change", () => {
      const f = elFile.files?.[0];
      if (f) setFile(f);
    });

    function setFile(f) {
      imageFile = f;
      elFileName.textContent = f.name;
      updateSaveEnabled();
    }

    async function loadProducts() {
      setStatus("Lade Produkteâ€¦");
      const { data, error } = await supabase
        .from("products")
        .select("id,name,desc,image,created_at")
        .order("created_at", { ascending: false });

      if (error) {
        setStatus("Fehler beim Laden: " + error.message, "error");
        return;
      }
      renderProducts(data || []);
      setStatus("");
    }

    function renderProducts(products) {
      elList.innerHTML = "";
      for (const p of products) {
        const card = document.createElement("div");
        card.className = "card card-pad product";

        card.innerHTML = `
          <img src="${p.image || ""}" alt="${escapeHtml(p.name || "")}">
          <h3>${escapeHtml(p.name || "")}</h3>
          <p>${escapeHtml(p.desc || "")}</p>
          <div class="prod-actions">
            <button class="btn btn-danger" data-id="${p.id}">LÃ¶schen</button>
          </div>
        `;
        elList.appendChild(card);
      }

      elList.querySelectorAll("button[data-id]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          if (!id) return;
          await deleteProduct(id);
        });
      });
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[s]));
    }

    async function addProduct() {
      const name = elName.value.trim();
      const desc = elDesc.value.trim();
      if (!name || !imageFile) return;

      setStatus("Upload lÃ¤uftâ€¦");

      // 1) Upload in Storage
      const fileName = `${Date.now()}-${imageFile.name}`;
      const { error: upErr } = await supabase
        .storage
        .from("product-images")
        .upload(fileName, imageFile, { upsert: false });

      if (upErr) {
        setStatus("Upload-Fehler: " + upErr.message, "error");
        return;
      }

      // 2) Public URL holen
      const { data: pub } = supabase
        .storage
        .from("product-images")
        .getPublicUrl(fileName);

      const imageUrl = pub?.publicUrl;

      // 3) In Tabelle speichern
      const { error: insErr } = await supabase
        .from("products")
        .insert({ name, desc, image: imageUrl });

      if (insErr) {
        setStatus("DB-Fehler: " + insErr.message, "error");
        return;
      }

      // Reset
      elName.value = "";
      elDesc.value = "";
      imageFile = null;
      elFile.value = "";
      elFileName.textContent = "";
      updateSaveEnabled();

      setStatus("Gespeichert âœ…", "ok");
      await loadProducts();
    }

    async function deleteProduct(id) {
      setStatus("LÃ¶scheâ€¦");
      const { error } = await supabase.from("products").delete().eq("id", id);
      if (error) {
        setStatus("LÃ¶schen fehlgeschlagen: " + error.message, "error");
        return;
      }
      setStatus("GelÃ¶scht âœ…", "ok");
      await loadProducts();
    }

    elSave.addEventListener("click", addProduct);

    // Start
    await loadProducts();
  </script>
</body>
</html>

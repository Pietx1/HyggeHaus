<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HyggeHaus ‚Ä¢ Bestellungen</title>

<style>
:root{
  --bg:#f7f8fa;
  --card:#ffffff;
  --border:#e6e8ee;
  --text:#111827;
  --muted:#6b7280;
  --dark:#111827;
  --danger:#b91c1c;
  --ok:#047857;
  --radius:16px;
}

*{box-sizing:border-box;}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}

.container{
  max-width:1100px;
  margin:auto;
  padding:24px;
}

h1{
  margin:0 0 20px;
  font-size:28px;
  font-weight:800;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:20px;
  margin-bottom:20px;
}

.sep{
  height:1px;
  background:var(--border);
  margin:18px 0;
}

label{
  display:block;
  font-size:13px;
  font-weight:700;
  margin-bottom:6px;
}

input, textarea{
  width:100%;
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:10px;
  font-size:16px;
  background:#fff;
}

textarea{resize:vertical;}

.grid{
  display:grid;
  gap:16px;
}

.grid-2{
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
}

.chips{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

.chip{
  border:1px solid var(--border);
  padding:8px 14px;
  border-radius:999px;
  font-weight:600;
  cursor:pointer;
  background:#fff;
  font-size:14px;
}

.chip.active{
  background:var(--dark);
  color:#fff;
  border-color:var(--dark);
}

.btn{
  border:none;
  padding:10px 16px;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
  background:var(--dark);
  color:#fff;
  font-size:14px;
}

.btnSoft{
  background:#fff;
  border:1px solid var(--border);
  color:var(--text);
}

.iconBtn{
  width:32px;
  height:32px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#fff;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
}

.iconBtn.danger{
  border-color:#f5c2c2;
  color:var(--danger);
}

.badge{
  font-size:12px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid var(--border);
}

.badge.ok{
  background:#f0fdf4;
  border-color:#bbf7d0;
  color:#166534;
}

.qtyGrid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
}

.colorRow{
  display:flex;
  gap:8px;
  align-items:center;
  margin-bottom:10px;
}

.colorRow input{
  flex:1;
}

.colorRow button{
  width:36px;
}

.orderCard{
  border:1px solid var(--border);
  border-radius:12px;
  padding:14px;
  margin-bottom:14px;
}

.orderHeader{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}

.orderItems{
  border-top:1px solid var(--border);
  padding-top:10px;
}

.orderItem{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
}

.checkboxBtn{
  width:26px;
  height:26px;
  border:1px solid var(--border);
  border-radius:6px;
  background:#fff;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
}

.checkboxBtn.done{
  background:#e6f9f1;
  border-color:#bbf7d0;
  color:var(--ok);
}

.sectionTitle{
  font-weight:800;
  margin-bottom:12px;
}
</style>
</head>

<body>
<div class="container">

<h1>Bestellungen</h1>

<!-- Neue Bestellung -->
<div class="card">

  <div class="chips">
    <div class="chip active" id="btnBunny">üê∞ Hase</div>
    <div class="chip" id="btnLumi">‚ú® Lumi</div>
    <div class="chip" id="btnText">‚úçÔ∏è Schriftzug</div>
    <div class="chip" id="btnOther">‚ûï Weitere</div>
  </div>

  <div class="sep"></div>

  <div class="grid grid-2">
    <div>
      <label>Kundenname</label>
      <input id="customer">
    </div>
    <div>
      <label>Beschreibung</label>
      <textarea id="note"></textarea>
    </div>
  </div>

  <div class="sep"></div>

  <div id="productArea"></div>

  <div class="sep"></div>

  <label>Priorit√§t</label>
  <div class="chips">
    <div class="chip" data-prio="very">Sehr wichtig</div>
    <div class="chip active" data-prio="normal">Wichtig</div>
    <div class="chip" data-prio="low">Nicht wichtig</div>
  </div>

  <div class="sep"></div>

  <label>Menge</label>
  <div class="qtyGrid" id="qtyGrid"></div>

  <div class="sep"></div>

  <button class="btn" id="addItemBtn">+ Position hinzuf√ºgen</button>

  <div class="sep"></div>

  <div id="cartList"></div>

  <div class="sep"></div>

  <button class="btn" id="saveOrderBtn">Bestellung speichern</button>

</div>

<!-- Offene Bestellungen -->
<div class="card">
  <div class="sectionTitle">Offene Bestellungen</div>
  <div id="openOrders"></div>
</div>

<!-- Archiv -->
<div class="card">
  <div class="sectionTitle">Archiv</div>
  <div id="archiveOrders"></div>
</div>

<!-- Farb Modal -->
<div class="modal" id="colorModal" style="display:none;">
  <div class="card" style="max-width:600px;margin:auto;">
    <div class="sectionTitle">Farbe w√§hlen</div>
    <div class="colorGrid" id="colorGrid"></div>
  </div>
</div>
<script type="module">

/* =============================
   BASIS DATEN
============================= */

const COLORS = [
  "wei√ü","schwarz","grau","beige","braun",
  "rot","orange","gelb","gr√ºn","blau",
  "lila","pink","rosa","gold","silber"
];

let currentProduct = "bunny";
let priority = "normal";
let qty = 1;
let cart = [];

/* =============================
   STATE PRO PRODUKT
============================= */

function createColorArray(){
  return [
    { label:"Hauptfarbe", value:"" },
    { label:"2. Farbe", value:"" }
  ];
}

let fields = {
  bunny:{ size:null, mode:null, single:"", ears:"", body:"", butt:"" },
  lumi:{ body:"", wings:"", feelers:"" },
  schriftzug:{ name:"", price:"", colors:createColorArray() },
  other:{ name:"", size:"", price:"", colors:createColorArray() }
};

/* =============================
   HELPER
============================= */

const esc = s => String(s ?? "").replace(/[&<>"']/g,m=>(
  {"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]
));

/* =============================
   PRODUKT SWITCH
============================= */

const btnBunny = document.getElementById("btnBunny");
const btnLumi  = document.getElementById("btnLumi");
const btnText  = document.getElementById("btnText");
const btnOther = document.getElementById("btnOther");

function setProduct(p){
  currentProduct = p;

  [btnBunny,btnLumi,btnText,btnOther].forEach(b=>b.classList.remove("active"));
  if(p==="bunny") btnBunny.classList.add("active");
  if(p==="lumi") btnLumi.classList.add("active");
  if(p==="schriftzug") btnText.classList.add("active");
  if(p==="other") btnOther.classList.add("active");

  renderProductArea();
}

btnBunny.addEventListener("click",()=>setProduct("bunny"));
btnLumi.addEventListener("click",()=>setProduct("lumi"));
btnText.addEventListener("click",()=>setProduct("schriftzug"));
btnOther.addEventListener("click",()=>setProduct("other"));

/* =============================
   PRIORITY
============================= */

document.querySelectorAll("[data-prio]").forEach(ch=>{
  ch.addEventListener("click",()=>{
    priority = ch.dataset.prio;
    document.querySelectorAll("[data-prio]").forEach(x=>x.classList.remove("active"));
    ch.classList.add("active");
  });
});

/* =============================
   MENGE
============================= */

const qtyGrid = document.getElementById("qtyGrid");

for(let i=1;i<=9;i++){
  const div = document.createElement("div");
  div.className="chip"+(i===1?" active":"");
  div.textContent=i;
  div.addEventListener("click",()=>{
    qty=i;
    [...qtyGrid.children].forEach(x=>x.classList.remove("active"));
    div.classList.add("active");
  });
  qtyGrid.appendChild(div);
}

/* =============================
   FARBMENU
============================= */

const colorModal = document.getElementById("colorModal");
const colorGrid  = document.getElementById("colorGrid");

let colorCallback = null;

function openColorModal(callback){
  colorCallback = callback;
  colorGrid.innerHTML = COLORS.map(c=>`
    <div class="chip">${c}</div>
  `).join("");

  colorModal.classList.add("open");

  [...colorGrid.children].forEach((el,i)=>{
    el.addEventListener("click",()=>{
      const val = COLORS[i];
      colorModal.classList.remove("open");
      if(colorCallback) colorCallback(val);
    });
  });
}

colorModal.addEventListener("click",e=>{
  if(e.target===colorModal){
    colorModal.classList.remove("open");
  }
});

/* =============================
   PRODUKT RENDER
============================= */

const productArea = document.getElementById("productArea");

function renderProductArea(){

  /* ---------- SCHRIFTZUG ---------- */
  if(currentProduct==="schriftzug"){
    const p = fields.schriftzug;

    productArea.innerHTML = `
      <label>Text</label>
      <input id="textName" value="${esc(p.name)}" placeholder="z.B. Happy Birthday">

      <div class="sep"></div>

      <label>Preis (‚Ç¨)</label>
      <button class="btnSoft" id="openPriceUI">Preis eingeben</button>
      <div id="priceDisplay">${esc(p.price||"")}</div>

      <div class="sep"></div>

      <label>Farben</label>
      <div id="colorContainer"></div>
      ${p.colors.length<4?'<button class="btnSoft" id="addColorBtn">+ Farbe</button>':''}
    `;

    document.getElementById("textName")
      .addEventListener("input",e=>p.name=e.target.value);

    document.getElementById("openPriceUI")
      .addEventListener("click",()=>openPricePad(p));

    renderColorFields(p);
  }

  /* ---------- OTHER ---------- */
  if(currentProduct==="other"){
    const p = fields.other;

    productArea.innerHTML = `
      <label>Name</label>
      <input id="otherName" value="${esc(p.name)}">

      <label>Gr√∂√üe</label>
      <input id="otherSize" value="${esc(p.size)}">

      <div class="sep"></div>

      <label>Preis (‚Ç¨)</label>
      <button class="btnSoft" id="openPriceUI">Preis eingeben</button>
      <div id="priceDisplay">${esc(p.price||"")}</div>

      <div class="sep"></div>

      <label>Farben</label>
      <div id="colorContainer"></div>
      ${p.colors.length<4?'<button class="btnSoft" id="addColorBtn">+ Farbe</button>':''}
    `;

    document.getElementById("otherName")
      .addEventListener("input",e=>p.name=e.target.value);

    document.getElementById("otherSize")
      .addEventListener("input",e=>p.size=e.target.value);

    document.getElementById("openPriceUI")
      .addEventListener("click",()=>openPricePad(p));

    renderColorFields(p);
  }

  /* ---------- HASE ---------- */
  if(currentProduct==="bunny"){
    const p = fields.bunny;

    productArea.innerHTML = `
      <label>Gr√∂√üe</label>
      <div class="chips">
        <div class="chip ${p.size==="11"?"active":""}" data-size="11">11 cm</div>
        <div class="chip ${p.size==="15"?"active":""}" data-size="15">15 cm</div>
        <div class="chip ${p.size==="20"?"active":""}" data-size="20">20 cm</div>
      </div>

      <div class="sep"></div>

      <label>Modus</label>
      <div class="chips">
        <div class="chip ${p.mode==="single"?"active":""}" data-mode="single">Einfarbig</div>
        <div class="chip ${p.mode==="multi"?"active":""}" data-mode="multi">Mehrfarbig</div>
      </div>

      <div id="bunnyColors"></div>
    `;

    productArea.querySelectorAll("[data-size]").forEach(el=>{
      el.addEventListener("click",()=>{
        p.size = el.dataset.size;
        renderProductArea();
      });
    });

    productArea.querySelectorAll("[data-mode]").forEach(el=>{
      el.addEventListener("click",()=>{
        p.mode = el.dataset.mode;
        renderProductArea();
      });
    });

    renderBunnyColors();
  }

  /* ---------- LUMI ---------- */
  if(currentProduct==="lumi"){
    const p = fields.lumi;

    productArea.innerHTML = `
      <label>K√∂rper</label>
      <button class="btnSoft" id="bodyBtn">${p.body||"Farbe w√§hlen"}</button>

      <label>Fl√ºgel</label>
      <button class="btnSoft" id="wingBtn">${p.wings||"Farbe w√§hlen"}</button>

      <label>F√ºhler</label>
      <button class="btnSoft" id="feelBtn">${p.feelers||"Farbe w√§hlen"}</button>
    `;

    document.getElementById("bodyBtn")
      .addEventListener("click",()=>openColorModal(v=>{
        p.body=v;
        renderProductArea();
      }));

    document.getElementById("wingBtn")
      .addEventListener("click",()=>openColorModal(v=>{
        p.wings=v;
        renderProductArea();
      }));

    document.getElementById("feelBtn")
      .addEventListener("click",()=>openColorModal(v=>{
        p.feelers=v;
        renderProductArea();
      }));
  }
}

/* =============================
   BUNNY COLORS
============================= */

function renderBunnyColors(){
  const p = fields.bunny;
  const host = document.getElementById("bunnyColors");
  if(!host) return;

  if(p.mode==="single"){
    host.innerHTML = `
      <div class="sep"></div>
      <label>Farbe</label>
      <button class="btnSoft" id="singleBtn">${p.single||"Farbe w√§hlen"}</button>
    `;

    document.getElementById("singleBtn")
      .addEventListener("click",()=>openColorModal(v=>{
        p.single=v;
        renderProductArea();
      }));
  }

  if(p.mode==="multi"){
    host.innerHTML = `
      <div class="sep"></div>
      <label>Ohren</label>
      <button class="btnSoft" id="earsBtn">${p.ears||"Farbe w√§hlen"}</button>

      <label>K√∂rper</label>
      <button class="btnSoft" id="bodyBtn">${p.body||"Farbe w√§hlen"}</button>

      <label>Popo</label>
      <button class="btnSoft" id="buttBtn">${p.butt||"Farbe w√§hlen"}</button>
    `;

    document.getElementById("earsBtn")
      .addEventListener("click",()=>openColorModal(v=>{
        p.ears=v;
        renderProductArea();
      }));

    document.getElementById("bodyBtn")
      .addEventListener("click",()=>openColorModal(v=>{
        p.body=v;
        renderProductArea();
      }));

    document.getElementById("buttBtn")
      .addEventListener("click",()=>openColorModal(v=>{
        p.butt=v;
        renderProductArea();
      }));
  }
}

/* =============================
   DYNAMISCHE FARBEN
============================= */

function renderColorFields(obj){
  const container = document.getElementById("colorContainer");
  container.innerHTML="";

  obj.colors.forEach((c,i)=>{
    const row = document.createElement("div");
    row.className="colorRow";

    row.innerHTML = `
      <input value="${esc(c.label)}">
      <button class="btnSoft">${c.value||"Farbe w√§hlen"}</button>
      ${obj.colors.length>2?'<button class="iconBtn">‚úñ</button>':''}
    `;

    const labelInput = row.children[0];
    const pickBtn    = row.children[1];
    const delBtn     = row.children[2];

    labelInput.addEventListener("input",e=>{
      obj.colors[i].label = e.target.value;
    });

    pickBtn.addEventListener("click",()=>{
      openColorModal(v=>{
        obj.colors[i].value=v;
        renderProductArea();
      });
    });

    if(delBtn){
      delBtn.addEventListener("click",()=>{
        obj.colors.splice(i,1);
        renderProductArea();
      });
    }

    container.appendChild(row);
  });

  const addBtn = document.getElementById("addColorBtn");
  if(addBtn){
    addBtn.addEventListener("click",()=>{
      if(obj.colors.length>=4) return;
      obj.colors.push({label:"Weitere Farbe",value:""});
      renderProductArea();
    });
  }
}

/* =============================
   PREIS PAD
============================= */

function openPricePad(obj){

  let value = obj.price || "";

  const pad = document.createElement("div");
  pad.className="modal open";
  pad.innerHTML=`
    <div class="modalBox">
      <div class="sectionTitle">Preis eingeben</div>
      <div style="font-size:22px;margin-bottom:12px;">${value||"0"}</div>
      <div class="colorGrid">
        ${[1,2,3,4,5,6,7,8,9,0,",","‚Üê"].map(v=>`
          <div class="chip">${v}</div>
        `).join("")}
      </div>
    </div>
  `;

  document.body.appendChild(pad);

  const display = pad.querySelector("div[style]");
  pad.querySelectorAll(".chip").forEach(el=>{
    el.addEventListener("click",()=>{
      const val = el.textContent;
      if(val==="‚Üê"){
        value=value.slice(0,-1);
      }else{
        value+=val;
      }
      display.textContent=value||"0";
    });
  });

  pad.addEventListener("click",e=>{
    if(e.target===pad){
      obj.price=value;
      pad.remove();
      renderProductArea();
    }
  });
}

/* =============================
   INIT
============================= */

renderProductArea();

/* =============================
   SUPABASE
============================= */

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const SUPABASE_URL = "https://htgrzmlcdolxxzvkppon.supabase.co";
const SUPABASE_ANON_KEY = "DEeyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0Z3J6bWxjZG9seHh6dmtwcG9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MzM2ODIsImV4cCI6MjA4NTAwOTY4Mn0.B0PxMAzmuvsHNd2n_mgNspjlPkaBpQlkrNzGu7p78fYIN_ANON_KEY_HIER_EINF√úGEN";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =============================
   PREISE
============================= */

const PRICES = {
  bunny: { "11":6, "15":9, "20":12, comboAllThree:22.5 },
  lumi: 8.5
};

function euro(n){
  return (Number(n)||0).toFixed(2).replace(".",",")+" ‚Ç¨";
}

function parsePrice(val){
  if(!val) return null;
  const n = Number(val.replace(",","."));
  if(isNaN(n)) return null;
  return Math.round(n*100);
}

/* =============================
   ITEM ERSTELLEN
============================= */

function buildItem(){

  const customerName = document.getElementById("customer").value.trim();
  if(!customerName) return null;

  if(currentProduct==="schriftzug"){
    const p = fields.schriftzug;
    if(!p.name || !p.price) return null;
    if(p.colors.some(c=>!c.value)) return null;

    return {
      product_type:"schriftzug",
      title:p.name,
      size:null,
      colors:p.colors,
      priority,
      qty,
      price_cents:parsePrice(p.price),
      produced:false
    };
  }

  if(currentProduct==="other"){
    const p = fields.other;
    if(!p.name || !p.size || !p.price) return null;
    if(p.colors.some(c=>!c.value)) return null;

    return {
      product_type:"other",
      title:p.name,
      size:p.size,
      colors:p.colors,
      priority,
      qty,
      price_cents:parsePrice(p.price),
      produced:false
    };
  }

  if(currentProduct==="bunny"){
    const p = fields.bunny;
    if(!p.size || !p.mode) return null;
    if(p.mode==="single" && !p.single) return null;
    if(p.mode==="multi" && (!p.ears||!p.body||!p.butt)) return null;

    return {
      product_type:"bunny",
      title:"Hase",
      size:p.size,
      colors:p.mode==="single"
        ? [{label:"Farbe",value:p.single}]
        : [
            {label:"Ohren",value:p.ears},
            {label:"K√∂rper",value:p.body},
            {label:"Popo",value:p.butt}
          ],
      priority,
      qty,
      price_cents:null,
      produced:false
    };
  }

  if(currentProduct==="lumi"){
    const p = fields.lumi;
    if(!p.body||!p.wings||!p.feelers) return null;

    return {
      product_type:"lumi",
      title:"Lumi",
      size:null,
      colors:[
        {label:"K√∂rper",value:p.body},
        {label:"Fl√ºgel",value:p.wings},
        {label:"F√ºhler",value:p.feelers}
      ],
      priority,
      qty,
      price_cents:null,
      produced:false
    };
  }

  return null;
}

/* =============================
   CART
============================= */

const cartList = document.getElementById("cartList");
const addItemBtn = document.getElementById("addItemBtn");

addItemBtn.addEventListener("click",()=>{
  const item = buildItem();
  if(!item){
    alert("Bitte alles korrekt ausf√ºllen.");
    return;
  }
  cart.push(item);
  renderCart();
});

function itemPrice(item){
  if(item.price_cents!=null) return item.price_cents/100;
  if(item.product_type==="lumi") return PRICES.lumi;
  if(item.product_type==="bunny") return PRICES.bunny[item.size]||0;
  return 0;
}

function cartTotal(){
  let total=0;

  const bunnies = cart.filter(x=>x.product_type==="bunny");
  const others  = cart.filter(x=>x.product_type!=="bunny");

  others.forEach(i=>{
    total += itemPrice(i)*i.qty;
  });

  if(bunnies.length){
    let counts={"11":0,"15":0,"20":0};
    bunnies.forEach(b=>counts[b.size]+=b.qty);

    const combos=Math.min(counts["11"],counts["15"],counts["20"]);
    if(combos>0){
      total+=combos*PRICES.bunny.comboAllThree;
      counts["11"]-=combos;
      counts["15"]-=combos;
      counts["20"]-=combos;
    }

    Object.keys(counts).forEach(s=>{
      total+=counts[s]*(PRICES.bunny[s]||0);
    });
  }

  return total;
}

function renderCart(){
  cartList.innerHTML="";

  cart.forEach((item,i)=>{
    const div=document.createElement("div");
    div.className="orderCard";

    div.innerHTML=`
      <div><strong>${esc(item.title)}</strong></div>
      <div>${item.colors.map(c=>`${esc(c.label)}: ${esc(c.value)}`).join("<br>")}</div>
      <div>Menge: ${item.qty}</div>
      <div>Preis: ${euro(itemPrice(item)*item.qty)}</div>
      <button class="iconBtn danger">‚úñ</button>
    `;

    div.querySelector("button").addEventListener("click",()=>{
      cart.splice(i,1);
      renderCart();
    });

    cartList.appendChild(div);
  });

  if(cart.length){
    const totalDiv=document.createElement("div");
    totalDiv.style.marginTop="10px";
    totalDiv.innerHTML="<strong>Gesamt: "+euro(cartTotal())+"</strong>";
    cartList.appendChild(totalDiv);
  }
}

/* =============================
   SAVE ORDER
============================= */

document.getElementById("saveOrderBtn")
  .addEventListener("click", async ()=>{

    if(cart.length===0){
      alert("Keine Positionen im Warenkorb.");
      return;
    }

    const customerName = document.getElementById("customer").value.trim();
    const note = document.getElementById("note").value.trim() || null;

    if(!customerName){
      alert("Kundenname fehlt.");
      return;
    }

    const { data:orderData, error:orderError } = await supabase
      .from("orders")
      .insert({
        customer_name:customerName,
        note,
        archived:false,
        total_override_cents:null
      })
      .select()
      .single();

    if(orderError){
      alert(orderError.message);
      return;
    }

    const orderId = orderData.id;

    const itemsPayload = cart.map(item=>({
      order_id:orderId,
      product_type:item.product_type,
      title:item.title,
      size:item.size,
      colors:item.colors,
      priority:item.priority,
      qty:item.qty,
      price_cents:item.price_cents,
      produced:false
    }));

    const { error:itemError } = await supabase
      .from("order_items")
      .insert(itemsPayload);

    if(itemError){
      alert(itemError.message);
      return;
    }

    cart=[];
    renderCart();
    document.getElementById("customer").value="";
    document.getElementById("note").value="";
    alert("Bestellung gespeichert.");

    await loadOrders();
});
/* =============================
   LOAD ORDERS
============================= */

const openOrdersEl = document.getElementById("openOrders");
const archiveOrdersEl = document.getElementById("archiveOrders");

async function loadOrders(){

  const { data:orders, error:oErr } = await supabase
    .from("orders")
    .select("*")
    .order("created_at",{ascending:false});

  if(oErr){
    console.error(oErr);
    return;
  }

  const { data:items, error:iErr } = await supabase
    .from("order_items")
    .select("*");

  if(iErr){
    console.error(iErr);
    return;
  }

  const map = new Map();

  orders.forEach(o=>{
    map.set(o.id,{...o,items:[]});
  });

  items.forEach(i=>{
    const order = map.get(i.order_id);
    if(order) order.items.push(i);
  });

  const allOrders = Array.from(map.values());

  const open = allOrders.filter(o=>!o.archived);
  const archived = allOrders.filter(o=>o.archived);

  renderOrders(openOrdersEl, open, false);
  renderOrders(archiveOrdersEl, archived, true);
}

/* =============================
   ORDER TOTAL
============================= */

function orderTotal(order){

  if(order.total_override_cents!=null){
    return order.total_override_cents/100;
  }

  let total=0;

  const bunnies = order.items.filter(x=>x.product_type==="bunny");
  const others  = order.items.filter(x=>x.product_type!=="bunny");

  others.forEach(i=>{
    const price = i.price_cents!=null
      ? i.price_cents/100
      : (i.product_type==="lumi"?PRICES.lumi:0);
    total += price*i.qty;
  });

  if(bunnies.length){
    let counts={"11":0,"15":0,"20":0};
    bunnies.forEach(b=>counts[b.size]+=b.qty);

    const combos=Math.min(counts["11"],counts["15"],counts["20"]);
    if(combos>0){
      total+=combos*PRICES.bunny.comboAllThree;
      counts["11"]-=combos;
      counts["15"]-=combos;
      counts["20"]-=combos;
    }

    Object.keys(counts).forEach(s=>{
      total+=counts[s]*(PRICES.bunny[s]||0);
    });
  }

  return total;
}

/* =============================
   RENDER ORDERS
============================= */

function renderOrders(container, list, archived){

  container.innerHTML="";

  if(list.length===0){
    container.innerHTML="<div>Keine Eintr√§ge.</div>";
    return;
  }

  list.forEach(order=>{

    const fertig = order.items.length>0 &&
      order.items.every(i=>i.produced);

    const total = orderTotal(order);

    const card=document.createElement("div");
    card.className="orderCard";

    card.innerHTML=`
      <div class="orderHeader">
        <div>
          <strong>${esc(order.customer_name)}</strong>
          ${fertig?'<span class="badge ok">FERTIG</span>':''}
        </div>
        <div>
          ${euro(total)}
          <button class="iconBtn" data-edit="${order.id}">‚úè</button>
          ${archived
            ?'<button class="iconBtn" data-restore="'+order.id+'">‚Ü©</button>'
            :'<button class="iconBtn" data-archive="'+order.id+'">üì¶</button>'}
          <button class="iconBtn danger" data-delete="${order.id}">üóë</button>
        </div>
      </div>

      <div class="orderItems">
        ${order.items.map(i=>`
          <div class="orderItem">
            <div>
              ${esc(i.title)} √ó ${i.qty}
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
              <div class="checkboxBtn ${i.produced?'done':''}" 
                   data-prod="${i.id}">
                ${i.produced?'‚úì':''}
              </div>
            </div>
          </div>
        `).join("")}
      </div>
    `;

    /* PRODUCED */
    card.querySelectorAll("[data-prod]").forEach(btn=>{
      btn.addEventListener("click",async()=>{
        const id = btn.dataset.prod;
        const current = order.items.find(x=>x.id===id).produced;

        await supabase.from("order_items")
          .update({produced:!current})
          .eq("id",id);

        await loadOrders();
      });
    });

    /* ARCHIVE */
    const archBtn = card.querySelector("[data-archive]");
    if(archBtn){
      archBtn.addEventListener("click",async()=>{
        await supabase.from("orders")
          .update({archived:true})
          .eq("id",order.id);
        await loadOrders();
      });
    }

    /* RESTORE */
    const resBtn = card.querySelector("[data-restore]");
    if(resBtn){
      resBtn.addEventListener("click",async()=>{
        await supabase.from("orders")
          .update({archived:false})
          .eq("id",order.id);
        await loadOrders();
      });
    }

    /* DELETE */
    card.querySelector("[data-delete]")
      .addEventListener("click",async()=>{
        if(!confirm("Wirklich l√∂schen?")) return;
        await supabase.from("orders").delete().eq("id",order.id);
        await loadOrders();
      });

    /* OVERRIDE */
    card.querySelector("[data-edit]")
      .addEventListener("click",async()=>{

        const current = order.total_override_cents
          ? String(order.total_override_cents/100).replace(".",",")
          : "";

        const v = prompt("Neuer Gesamtpreis (‚Ç¨):",current);
        if(v===null) return;

        const cents = v.trim()===""
          ? null
          : Math.round(Number(v.replace(",","."))*100);

        await supabase.from("orders")
          .update({total_override_cents:cents})
          .eq("id",order.id);

        await loadOrders();
      });

    container.appendChild(card);
  });
}

/* =============================
   INIT LOAD
============================= */

loadOrders();

</script>
</body>
</html>
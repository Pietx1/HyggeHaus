<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HyggeHaus ‚Ä¢ Bestellungen</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --dark:#0f172a;
      --dark2:#111827;
      --danger:#b91c1c;
      --ok:#047857;
      --warn:#b45309;
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .container{ max-width:1100px; margin:0 auto; padding:24px; }
    h1{ margin:0; font-size:38px; letter-spacing:-.02em; }
    .topbar{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; margin-bottom:18px; }
    .hint{ color:var(--muted); font-size:13px; }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .pad{ padding:18px; }
    .sep{ height:1px; background:var(--border); margin:14px 0; }

    .title2{ font-size:18px; font-weight:900; margin:0 0 8px; }
    label{ font-weight:900; font-size:13px; display:block; margin:0 0 6px; }

    input, textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius:14px;
      padding:11px 14px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    textarea{ min-height:90px; resize:vertical; }
    input:focus, textarea:focus{ border-color:#c7d2fe; box-shadow:0 0 0 4px rgba(99,102,241,.12); }

    .grid{ display:grid; gap:14px; }
    @media(min-width:900px){
      .grid-2{ grid-template-columns:repeat(2,1fr); }
      .grid-3{ grid-template-columns:repeat(3,1fr); }
    }

    .btn{
      border:0;
      cursor:pointer;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      font-size:14px;
      background:var(--dark2);
      color:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .btnSmall{ padding:8px 10px; border-radius:12px; font-size:13px; }
    .btnSoft{
      background:#fff;
      border:1px solid var(--border);
      color:var(--text);
      font-weight:900;
    }
    .btnDark{ background:linear-gradient(180deg, #0b1220, #0f172a); }

    .chips{ display:flex; gap:10px; flex-wrap:wrap; }
    .chip{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      padding:11px 14px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      min-width:108px;
      text-align:center;
    }
    .chip.active{
      background:linear-gradient(180deg, #0b1220, #0f172a);
      color:#fff;
      border-color:#0f172a;
    }

    .prioRow{ display:flex; gap:10px; align-items:stretch; }
    .prioBtn{
      flex:1;
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      padding:10px 12px;
      text-align:center;
      user-select:none;
    }
    .prioBtn.small{ flex:.85; }
    .prioBtn.big{ flex:1.3; }
    .prioBtn.active{ background:var(--dark2); color:#fff; border-color:var(--dark2); }

    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .muted{ color:var(--muted); font-size:13px; }

    .status{ margin-top:10px; font-size:13px; color:var(--muted); }
    .error{ color:var(--danger); font-weight:900; }
    .ok{ color:var(--ok); font-weight:900; }

    /* Dropdown */
    .ddWrap{ position:relative; }
    .ddBtn{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      background:none;
      border:none;
      font-size:18px;
      cursor:pointer;
      z-index:3;
    }
    .ddInput{ padding-right:36px; }
    .ddMenu{
      position:absolute;
      top:100%;
      left:0; right:0;
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      margin-top:4px;
      max-height:200px;
      overflow:auto;
      display:none;
      z-index:999;
    }
    .ddMenu.open{ display:block; }
    .ddItem{ padding:10px 12px; cursor:pointer; }
    .ddItem:hover{ background:#f1f5f9; }
    .ddEmpty{ padding:10px; color:var(--muted); }

    /* Tabs oben */
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px; }
    .tabBtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:10px 14px;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
    }
    .tabBtn.active{
      background:linear-gradient(180deg, #0b1220, #0f172a);
      color:#fff;
      border-color:#0f172a;
    }
    .view{ display:none; }
    .view.active{ display:block; }

    .orderCard{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .orderTitle{ font-weight:1000; }

    .badge{
      font-size:12px;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      white-space:nowrap;
    }
    .badge.ok{ border-color:#bbf7d0; background:#f0fdf4; color:#166534; }
    .badge.warn{ border-color:#fed7aa; background:#fff7ed; color:#9a3412; }
    .badge.bad{ border-color:#fecaca; background:#fff1f2; color:#991b1b; }
    .badge.neutral{ border-color:#e5e7eb; background:#f9fafb; color:#111827; }
    .badge.clickable{ cursor:pointer; user-select:none; }

    .iconBtn{
      border:1px solid var(--border);
      background:#fff;
      width:36px; height:36px;
      border-radius:12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
    }
    .iconBtn:hover{ background:#f9fafb; }
    .iconBtn.danger{ border-color:#fecaca; color:#991b1b; }

    details.archive > summary{
      cursor:pointer;
      user-select:none;
      font-weight:900;
      color:#1f3a8a;
    }

    /* Farben untereinander */
    .colorsStack{ display:grid; gap:2px; margin-top:4px; }
    .colorsStack div{ line-height:1.25; }

    /* Bestand: nicht zu breit */
    .invRow{
      display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;
      padding:12px; border:1px solid var(--border); border-radius:16px; background:#fff;
      max-width:100%; overflow:hidden;
    }
    .invLeft{ flex:1; min-width:220px; max-width:100%; overflow:hidden; }
    .invKey{ font-weight:1000; overflow-wrap:anywhere; word-break:break-word; }
    .invControls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .invQty{ width:110px; }

    /* Bestand Filter Buttons */
    .filtersRow{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top:10px;
    }
    .filterBtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:10px 14px;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <h1 id="pageTitle">Bestellungen</h1>
      <div class="hint">GitHub Pages ‚Ä¢ Supabase</div>
    </div>

    <div class="tabs">
      <button class="tabBtn active" id="tabOrders">üßæ Bestellungen</button>
      <button class="tabBtn" id="tabInv">üì¶ Bestand</button>
    </div>

    <!-- ================== VIEW: BESTELLUNGEN ================== -->
    <div class="view active" id="viewOrders">

      <!-- NEUE BESTELLUNG -->
      <div class="card">
        <div class="pad">
          <div class="row" style="justify-content:space-between;">
            <div class="chips">
              <div class="chip" id="btnBunny">üê∞ Hase</div>
              <div class="chip" id="btnLumi">‚ú®ü™≤ Lumi</div>
              <div class="chip" id="btnOther">‚ûï Weitere Produkt</div>
            </div>
          </div>

          <div style="height:10px"></div>
          <div class="title2" id="newTitle">Neue Bestellung</div>

          <div id="productArea"></div>
          <div class="sep"></div>

          <div id="colorArea"></div>
          <div class="sep"></div>

          <label>Priorit√§t</label>
          <div class="prioRow">
            <div class="prioBtn small" id="pVery">Sehr wichtig</div>
            <div class="prioBtn big" id="pNorm">Wichtig</div>
            <div class="prioBtn small" id="pLow">Nicht wichtig</div>
          </div>

          <div class="sep"></div>

          <div class="grid grid-2">
            <div>
              <label for="customer">Kundenname</label>
              <input id="customer" placeholder="z. B. Max Mustermann" />
            </div>
            <div>
              <label for="note">Beschreibung (optional)</label>
              <textarea id="note" placeholder="z. B. Sonderwunsch, Hinweis ‚Ä¶"></textarea>
            </div>
          </div>

          <div class="sep"></div>

          <label>Menge</label>
          <div class="chips" id="qtyRow" style="gap:10px;">
            <div class="chip qtyBtn" data-q="1">1</div>
            <div class="chip qtyBtn" data-q="2">2</div>
            <div class="chip qtyBtn" data-q="3">3</div>
            <div class="chip qtyBtn" data-q="4">4</div>
            <div class="chip qtyBtn" data-q="5">5</div>
            <div class="chip qtyBtn" data-q="6">6</div>
            <div class="chip qtyBtn" data-q="7">7</div>
            <div class="chip qtyBtn" data-q="8">8</div>
            <div class="chip qtyBtn" data-q="9">9</div>
          </div>

          <div class="grid grid-2" style="align-items:end; margin-top:10px;">
            <div>
              <label for="qtyOther">Andere Menge (optional)</label>
              <input id="qtyOther" inputmode="numeric" placeholder="z. B. 12" />
            </div>
            <div style="display:flex; justify-content:flex-end;">
              <button class="btn btnDark" id="addItemBtn" style="min-width:280px;">+ Position hinzuf√ºgen</button>
            </div>
          </div>

          <div class="status">
            <div class="error" id="formError" style="display:none;">Bitte erst ausf√ºllen.</div>
            <div class="muted" id="missing" style="display:none;"></div>
          </div>

          <div class="sep"></div>

          <div class="row" style="justify-content:space-between; align-items:flex-end;">
            <div class="title2" style="margin:0;">Positionen in dieser Bestellung</div>
            <div class="muted" id="cartSum">Summe: 0,00 ‚Ç¨</div>
          </div>

          <div id="cartList" class="grid" style="margin-top:10px;"></div>
          <div class="muted" id="cartHint">Noch keine Position hinzugef√ºgt.</div>

          <div class="sep"></div>

          <button id="saveOrderBtn" class="btn" disabled>‚úÖ Bestellung speichern</button>
          <div class="ok" id="saveStatus" style="display:none; margin-top:10px;">Gespeichert ‚úÖ</div>
        </div>
      </div>

      <div style="height:16px"></div>

      <!-- OFFENE BESTELLUNGEN -->
      <div class="card">
        <div class="pad">
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div>
              <div class="title2" style="margin:0;">Offene Bestellungen</div>
              <div class="muted" id="openSum">Summe offen: 0,00 ‚Ç¨</div>
            </div>

            <div class="row" style="gap:10px;">
              <button class="btnSmall btnDark" id="sortDate">Sort: Datum</button>
              <button class="btnSmall btnSoft" id="sortPrio">Sort: Priorit√§t</button>
            </div>
          </div>

          <div class="sep"></div>
          <div id="openOrders" class="grid"></div>

          <div class="sep"></div>

          <details class="archive">
            <summary>Archiv (alte Bestellungen anzeigen)</summary>
            <div style="margin-top:10px;">
              <div class="muted" id="archivedTotal">Archiv gesamt: 0,00 ‚Ç¨</div>
              <div style="height:8px"></div>
              <div id="archiveOrders" class="grid"></div>
            </div>
          </details>
        </div>
      </div>

    </div>

    <!-- ================== VIEW: BESTAND ================== -->
    <div class="view" id="viewInv">
      <div class="card">
        <div class="pad">
          <div class="row" style="justify-content:space-between; align-items:flex-end;">
            <div>
              <div class="title2">Bestand</div>
              <div class="muted">Hasen unabh√§ngig von Bestellungen pflegen. Beim Archivieren wird automatisch abgezogen (au√üer ‚Äúmanuell als da markiert‚Äù).</div>
            </div>
            <button class="btnSmall btnSoft" id="invReload">‚Üª Neu laden</button>
          </div>

          <div class="filtersRow">
            <button class="filterBtn" id="filterModeBtn">Modus: Alle</button>
            <button class="filterBtn" id="filterSizeBtn">Gr√∂√üe: Alle</button>
          </div>

          <div class="sep"></div>

          <label>Hase: Gr√∂√üe</label>
          <div class="chips" id="invSizeRow">
            <div class="chip invSize" data-s="11">11 cm</div>
            <div class="chip invSize" data-s="15">15 cm</div>
            <div class="chip invSize" data-s="20">20 cm</div>
          </div>

          <div class="sep"></div>

          <label>Farbmodus</label>
          <div class="chips" id="invModeRow">
            <div class="chip invMode" data-m="single">Einfarbig</div>
            <div class="chip invMode" data-m="multi">Mehrfarbig</div>
          </div>

          <div class="sep"></div>

          <div id="invColorsArea"></div>

          <div class="sep"></div>

          <div class="grid grid-2" style="align-items:end;">
            <div>
              <label for="invQty">Menge</label>
              <input id="invQty" inputmode="numeric" placeholder="z. B. 5" />
            </div>
            <div style="display:flex; justify-content:flex-end;">
              <button class="btn btnDark" id="invSaveBtn" style="min-width:280px;">üíæ In Bestand speichern</button>
            </div>
          </div>

          <div class="status">
            <div class="error" id="invErr" style="display:none;"></div>
            <div class="ok" id="invOk" style="display:none;"></div>
          </div>

          <div class="sep"></div>

          <div class="title2" style="margin:0;">Aktueller Bestand</div>
          <div id="invList" class="grid" style="margin-top:10px;"></div>
          <div class="muted" id="invHint">Noch kein Bestand eingetragen.</div>
        </div>
      </div>
    </div>

  </div>

  <!-- Teil 2/3 kommt jetzt -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ‚úÖ Supabase
    const SUPABASE_URL = "https://htgrzmlcdolxxzvkppon.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0Z3J6bWxjZG9seHh6dmtwcG9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MzM2ODIsImV4cCI6MjA4NTAwOTY4Mn0.B0PxMAzmuvsHNd2n_mgNspjlPkaBpQlkrNzGu7p78fY";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------------- constants ----------------
    const COLOR_SUGGESTIONS = [
      "wei√ü","schwarz","grau","dunkelgrau","hellgrau",
      "beige","creme","braun","oak",
      "rot","orange","gelb","gr√ºn","blau","lila",
      "pink","rosa","gold","silber"
    ];

    const PRICES = {
      bunny: { "20": 12.0, "15": 9.0, "11": 6.0, comboAllThree: 22.50 },
      lumi: 8.50
    };

    // ---------------- helpers ----------------
    const euro = (n)=> (Number(n)||0).toFixed(2).replace(".", ",") + " ‚Ç¨";
    const esc = (s)=> String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    const norm = (s)=> String(s||"").trim().toLowerCase();
    const num = (s)=> Number(String(s??"").replace(",", "."));

    function setChip(el, on){ el?.classList.toggle("active", !!on); }
    function showErr(el,msg){ el.style.display="block"; el.textContent=msg; }
    function hideErr(el){ el.style.display="none"; el.textContent=""; }

    // ---------------- dropdown ----------------
    function buildDropdown({ id, label, placeholder }){
      return `
        <div class="field" data-dd-wrap="${id}">
          <label for="${id}">${esc(label)}</label>
          <div class="ddWrap">
            <input id="${id}" class="ddInput" placeholder="${esc(placeholder)}" autocomplete="off" />
            <button type="button" class="ddBtn" aria-label="Dropdown √∂ffnen" data-dd-btn="${id}">‚ñæ</button>
            <div class="ddMenu" data-dd-menu="${id}"></div>
          </div>
        </div>
      `;
    }

    function setupDropdown(inputId, onChange){
      const input = document.getElementById(inputId);
      const menu  = document.querySelector(`[data-dd-menu="${inputId}"]`);
      const btn   = document.querySelector(`[data-dd-btn="${inputId}"]`);
      const wrap  = document.querySelector(`[data-dd-wrap="${inputId}"]`);
      if(!input || !menu || !btn || !wrap) return;

      function renderMenu(filter=""){
        const f = filter.trim().toLowerCase();
        const list = COLOR_SUGGESTIONS.filter(x => x.toLowerCase().includes(f));
        menu.innerHTML = list.length
          ? list.map(x=>`<div class="ddItem" data-val="${esc(x)}">${esc(x)}</div>`).join("")
          : `<div class="ddEmpty">Keine Vorschl√§ge</div>`;

        menu.querySelectorAll(".ddItem").forEach(it=>{
          it.addEventListener("click", ()=>{
            const v = it.getAttribute("data-val") || "";
            input.value = v;
            menu.classList.remove("open");
            onChange?.(v);
          });
        });
      }

      input.addEventListener("input", ()=>{
        if(menu.classList.contains("open")) renderMenu(input.value||"");
        onChange?.(input.value||"");
      });

      btn.addEventListener("click", (e)=>{
        e.preventDefault(); e.stopPropagation();
        menu.classList.toggle("open");
        if(menu.classList.contains("open")) renderMenu(input.value||"");
        input.focus();
      });

      document.addEventListener("click", (e)=>{
        if(!wrap.contains(e.target)) menu.classList.remove("open");
      });
    }

    // ---------------- Tabs ----------------
    const tabOrders = document.getElementById("tabOrders");
    const tabInv    = document.getElementById("tabInv");
    const viewOrders= document.getElementById("viewOrders");
    const viewInv   = document.getElementById("viewInv");
    const pageTitle = document.getElementById("pageTitle");

    async function setActiveTab(which){
      const onOrders = which === "orders";
      tabOrders.classList.toggle("active", onOrders);
      tabInv.classList.toggle("active", !onOrders);
      viewOrders.classList.toggle("active", onOrders);
      viewInv.classList.toggle("active", !onOrders);
      pageTitle.textContent = onOrders ? "Bestellungen" : "Bestand";

      // ‚úÖ IMMER neu laden beim Wechsel
      if(onOrders) await loadAll();
      else await loadInventory();
    }

    tabOrders.addEventListener("click", ()=>setActiveTab("orders"));
    tabInv.addEventListener("click", ()=>setActiveTab("inv"));

    // ---------------- Inventory (Bestand) ----------------
    const invSizeRow = document.getElementById("invSizeRow");
    const invModeRow = document.getElementById("invModeRow");
    const invColorsArea = document.getElementById("invColorsArea");
    const invQty = document.getElementById("invQty");
    const invSaveBtn = document.getElementById("invSaveBtn");
    const invErr = document.getElementById("invErr");
    const invOk  = document.getElementById("invOk");
    const invList = document.getElementById("invList");
    const invHint = document.getElementById("invHint");
    const invReload = document.getElementById("invReload");

    // Filter Buttons
    const filterModeBtn = document.getElementById("filterModeBtn");
    const filterSizeBtn = document.getElementById("filterSizeBtn");
    const modeCycle = ["all","single","multi"];
    const sizeCycle = ["all","11","15","20"];
    let modeFilter = "all";
    let sizeFilter = "all";

    function refreshFilterLabels(){
      filterModeBtn.textContent =
        modeFilter==="all" ? "Modus: Alle" : (modeFilter==="single" ? "Modus: Einfarbig" : "Modus: Mehrfarbig");
      filterSizeBtn.textContent =
        sizeFilter==="all" ? "Gr√∂√üe: Alle" : `Gr√∂√üe: ${sizeFilter} cm`;
    }

    filterModeBtn.addEventListener("click", async ()=>{
      modeFilter = modeCycle[(modeCycle.indexOf(modeFilter)+1)%modeCycle.length];
      refreshFilterLabels();
      await loadInventory();
    });
    filterSizeBtn.addEventListener("click", async ()=>{
      sizeFilter = sizeCycle[(sizeCycle.indexOf(sizeFilter)+1)%sizeCycle.length];
      refreshFilterLabels();
      await loadInventory();
    });

    refreshFilterLabels();
    invReload.addEventListener("click", loadInventory);

    let invSize = null;           // "11"|"15"|"20"
    let invMode = null;           // "single"|"multi"
    let invColors = { single:"", ears:"", body:"", butt:"" };

    function inventoryKeyFromParts({ size, mode, colors }){
      if(mode==="single") return `bunny|${size}|single|${norm(colors.single)}`;
      // OHREN ‚Üí K√ñRPER ‚Üí POPO
      return `bunny|${size}|multi|${norm(colors.ears)}|${norm(colors.body)}|${norm(colors.butt)}`;
    }

    function invShowOk(msg){
      hideErr(invErr);
      invOk.style.display="block";
      invOk.textContent = msg || "Gespeichert ‚úÖ";
      setTimeout(()=>{ invOk.style.display="none"; }, 1600);
    }

    function renderInvColors(){
      invColorsArea.innerHTML = "";
      if(!invMode){
        invColorsArea.innerHTML = `<div class="muted">Bitte zuerst Farbmodus w√§hlen.</div>`;
        return;
      }

      if(invMode==="single"){
        invColorsArea.innerHTML = `
          <div class="grid">
            ${buildDropdown({ id:"inv_single", label:"Einfarbig", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
          </div>
        `;
        setupDropdown("inv_single", (v)=>{ invColors.single = v; });
        return;
      }

      invColorsArea.innerHTML = `
        <div class="grid grid-3">
          ${buildDropdown({ id:"inv_ears", label:"Ohren", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
          ${buildDropdown({ id:"inv_body", label:"K√∂rper", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
          ${buildDropdown({ id:"inv_butt", label:"Popo",  placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
        </div>
      `;
      setupDropdown("inv_ears", (v)=>{ invColors.ears = v; });
      setupDropdown("inv_body", (v)=>{ invColors.body = v; });
      setupDropdown("inv_butt", (v)=>{ invColors.butt = v; });
    }

    invSizeRow.querySelectorAll(".invSize").forEach(b=>{
      b.addEventListener("click", ()=>{
        invSize = b.getAttribute("data-s");
        invSizeRow.querySelectorAll(".invSize").forEach(x=>setChip(x, x===b));
      });
    });

    invModeRow.querySelectorAll(".invMode").forEach(b=>{
      b.addEventListener("click", ()=>{
        invMode = b.getAttribute("data-m");
        invModeRow.querySelectorAll(".invMode").forEach(x=>setChip(x, x===b));
        invColors = { single:"", ears:"", body:"", butt:"" };
        renderInvColors();
      });
    });

    async function saveInventory(){
      hideErr(invErr);
      invOk.style.display="none";

      const q = num(invQty.value);
      if(!invSize) return showErr(invErr, "Bitte Gr√∂√üe w√§hlen.");
      if(!invMode) return showErr(invErr, "Bitte Farbmodus w√§hlen.");
      if(!Number.isFinite(q) || q<0) return showErr(invErr, "Bitte g√ºltige Menge eingeben (0 oder mehr).");

      if(invMode==="single"){
        if(!norm(invColors.single)) return showErr(invErr, "Bitte Einfarbig-Farbe w√§hlen.");
      } else {
        if(!norm(invColors.ears) || !norm(invColors.body) || !norm(invColors.butt)){
          return showErr(invErr, "Bitte Ohren / K√∂rper / Popo ausw√§hlen.");
        }
      }

      const key = inventoryKeyFromParts({ size: invSize, mode: invMode, colors: invColors });
      const colors = invMode==="single"
        ? { single: norm(invColors.single) }
        : { ears: norm(invColors.ears), body: norm(invColors.body), butt: norm(invColors.butt) };

      // ‚úÖ zusammenpacken (addieren)
      const { data: existing, error: exErr } = await supabase
        .from("inventory")
        .select("qty")
        .eq("key", key)
        .maybeSingle();
      if(exErr) return showErr(invErr, exErr.message);

      const oldQty = Number(existing?.qty ?? 0);
      const addQty = Math.floor(q);
      const newQty = oldQty + addQty;

      const { error } = await supabase
        .from("inventory")
        .upsert({
          key,
          product: "bunny",
          size: invSize,
          mode: invMode,
          colors,
          qty: newQty
        }, { onConflict: "key" });

      if(error) return showErr(invErr, error.message);

      invShowOk("Bestand gespeichert ‚úÖ");
      await loadInventory();
    }

    invSaveBtn.addEventListener("click", saveInventory);

    async function loadInventory(){
      invList.innerHTML = "";
      invHint.style.display = "none";
      hideErr(invErr);

      const { data, error } = await supabase
        .from("inventory")
        .select("*")
        .order("updated_at", { ascending:false });

      if(error){
        invHint.style.display="block";
        invHint.textContent = "Fehler: " + error.message;
        return;
      }

      let rows = (data || []);

      // ‚úÖ Filter anwenden
      if(modeFilter!=="all") rows = rows.filter(r => String(r.mode) === modeFilter);
      if(sizeFilter!=="all") rows = rows.filter(r => String(r.size) === sizeFilter);

      if(rows.length===0){
        invHint.style.display="block";
        invHint.textContent = "Kein Bestand f√ºr diese Filter.";
        return;
      }

      for(const r of rows){
        const isSingle = r.mode==="single";
        const c = r.colors || {};

        const title = isSingle
          ? `üê∞ ${r.size} cm ‚Ä¢ Einfarbig`
          : `üê∞ ${r.size} cm ‚Ä¢ Mehrfarbig`;

        const colorsHtml = isSingle
          ? `<div class="colorsStack muted"><div><b>Einfarbig:</b> ${esc(c.single||"")}</div></div>`
          : `
            <div class="colorsStack muted">
              <div><b>Ohren:</b> ${esc(c.ears||"")}</div>
              <div><b>K√∂rper:</b> ${esc(c.body||"")}</div>
              <div><b>Popo:</b> ${esc(c.butt||"")}</div>
            </div>
          `;

        const wrap = document.createElement("div");
        wrap.className = "invRow";
        wrap.innerHTML = `
          <div class="invLeft">
            <div class="invKey">${esc(title)}</div>
            ${colorsHtml}
          </div>
          <div class="invControls">
            <label class="muted" style="margin:0;">Menge</label>
            <input class="invQty" inputmode="numeric" value="${esc(String(r.qty ?? 0))}" data-qty="${esc(r.key)}" />
            <button class="btnSmall btnDark" data-save="${esc(r.key)}">Speichern</button>
            <button class="btnSmall btnSoft" data-del="${esc(r.key)}">L√∂schen</button>
          </div>
        `;
        invList.appendChild(wrap);
      }

      invList.querySelectorAll("[data-save]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const key = btn.getAttribute("data-save");
          const inp = invList.querySelector(`input[data-qty="${CSS.escape(key)}"]`);
          const q = num(inp?.value);
          if(!Number.isFinite(q) || q<0) return alert("Bitte g√ºltige Menge (0 oder mehr).");

          const { error } = await supabase.from("inventory").update({ qty: Math.floor(q) }).eq("key", key);
          if(error) return alert(error.message);
          invShowOk("Aktualisiert ‚úÖ");
        });
      });

      invList.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const key = btn.getAttribute("data-del");
          const ok = confirm("Wirklich l√∂schen?");
          if(!ok) return;
          const { error } = await supabase.from("inventory").delete().eq("key", key);
          if(error) return alert(error.message);
          invShowOk("Gel√∂scht ‚úÖ");
          await loadInventory();
        });
      });
    }

    // Teil 3/3 kommt jetzt‚Ä¶
    // ---------------- Orders DOM ----------------
    const btnBunny = document.getElementById("btnBunny");
    const btnLumi  = document.getElementById("btnLumi");
    const btnOther = document.getElementById("btnOther");

    const newTitle = document.getElementById("newTitle");
    const productArea = document.getElementById("productArea");
    const colorArea = document.getElementById("colorArea");

    const pVery = document.getElementById("pVery");
    const pNorm = document.getElementById("pNorm");
    const pLow  = document.getElementById("pLow");

    const customer = document.getElementById("customer");
    const noteEl   = document.getElementById("note");

    const qtyOther = document.getElementById("qtyOther");
    const addItemBtn = document.getElementById("addItemBtn");

    const cartList = document.getElementById("cartList");
    const cartHint = document.getElementById("cartHint");
    const cartSum  = document.getElementById("cartSum");

    const saveOrderBtn = document.getElementById("saveOrderBtn");
    const saveStatus   = document.getElementById("saveStatus");

    const formError = document.getElementById("formError");
    const missingEl = document.getElementById("missing");

    const openOrdersEl = document.getElementById("openOrders");
    const archiveOrdersEl = document.getElementById("archiveOrders");
    const openSumEl = document.getElementById("openSum");
    const archivedTotalEl = document.getElementById("archivedTotal");

    const sortDate = document.getElementById("sortDate");
    const sortPrio = document.getElementById("sortPrio");

    // ---------------- Orders state ----------------
    let currentProduct = null;  // 'bunny' | 'lumi' | 'other'
    let bunnySize = null;       // '20'|'15'|'11'
    let bunnyMode = null;       // 'multi'|'single'
    let priority  = null;       // 'very'|'normal'|'low'
    let qty = null;
    let sortMode = "date";

    const fields = {
      bunny_ears:"", bunny_body:"", bunny_butt:"", bunny_single:"",
      lumi_body:"",  lumi_wings:"", lumi_feelers:"",
      other_size:"", other_color:"", other_name:"",
    };

    let cart = [];

    function setChipActive(el, on){ el?.classList.toggle("active", !!on); }
    function setPrioActive(el, on){ el?.classList.toggle("active", !!on); }

    function showMissing(msg){
      formError.style.display = "block";
      missingEl.style.display = "block";
      missingEl.textContent = msg;
    }
    function clearErrorUI(){
      formError.style.display = "none";
      missingEl.style.display = "none";
      missingEl.textContent = "";
    }

    function buildOrderItemTitle(it){
      if(it.product==="bunny") return `Hase ${it.size} cm`;
      if(it.product==="lumi") return `Lumi`;
      return `Weitere Produkt (${it.size||"?"})`;
    }

    function prioLabel(p){
      if(p==="very") return "Sehr wichtig";
      if(p==="normal") return "Wichtig";
      return "Nicht wichtig";
    }
    function prioRank(p){
      if(p==="very") return 0;
      if(p==="normal") return 1;
      return 2;
    }

    function sizeRank(size){
      if(String(size)==="11") return 0;
      if(String(size)==="15") return 1;
      return 2;
    }
    function itemSortKey(it){
      if(it.product==="bunny") return "0-"+sizeRank(it.size)+"-"+(it.mode||"");
      if(it.product==="lumi") return "1";
      return "2";
    }

    function formatDateOnly(iso){
      const d = new Date(iso);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}.${mm}.${yy}`;
    }

    function itemBasePrice(item){
      if(item.product === "bunny") return PRICES.bunny[item.size] || 0;
      if(item.product === "lumi") return PRICES.lumi;
      return 0;
    }

    function priceForOrderItems(items){
      // nutzt price_override pro item (falls gesetzt), sonst Standard + Hase-Combo
      let total = 0;

      // non-bunny:
      for(const it of items){
        if(it.product !== "bunny"){
          const base = (it.price_override != null ? Number(it.price_override) : itemBasePrice(it));
          total += base * Number(it.qty||0);
        }
      }

      // bunnies: wenn irgendein bunny-item price_override hat -> dann kein combo, sondern overrides/standard einzeln
      const bunny = items.filter(x=>x.product==="bunny");
      const anyOverride = bunny.some(x => x.price_override != null);

      if(anyOverride){
        for(const it of bunny){
          const base = (it.price_override != null ? Number(it.price_override) : itemBasePrice(it));
          total += base * Number(it.qty||0);
        }
        return total;
      }

      // combo rule
      const counts = { "20":0, "15":0, "11":0 };
      for(const it of bunny) counts[it.size] += Number(it.qty||0);

      const combos = Math.min(counts["20"], counts["15"], counts["11"]);
      if(combos>0){
        total += combos * PRICES.bunny.comboAllThree;
        counts["20"] -= combos; counts["15"] -= combos; counts["11"] -= combos;
      }
      total += counts["20"] * PRICES.bunny["20"];
      total += counts["15"] * PRICES.bunny["15"];
      total += counts["11"] * PRICES.bunny["11"];
      return total;
    }

    function colorTextStack(it){
      const c = it.colors || {};
      if(it.product==="bunny"){
        if(it.mode==="single"){
          return `<div class="colorsStack muted"><div><b>Einfarbig:</b> ${esc(c.single||"")}</div></div>`;
        }
        return `
          <div class="colorsStack muted">
            <div><b>Ohren:</b> ${esc(c.ears||"")}</div>
            <div><b>K√∂rper:</b> ${esc(c.body||"")}</div>
            <div><b>Popo:</b> ${esc(c.butt||"")}</div>
          </div>
        `;
      }
      if(it.product==="lumi"){
        return `
          <div class="colorsStack muted">
            <div><b>K√∂rper:</b> ${esc(c.body||"")}</div>
            <div><b>Fl√ºgel:</b> ${esc(c.wings||"")}</div>
            <div><b>F√ºhler:</b> ${esc(c.feelers||"")}</div>
          </div>
        `;
      }
      return `<div class="colorsStack muted"><div><b>Gr√∂√üe:</b> ${esc(it.size||"")}</div><div><b>Farbe:</b> ${esc(c.color||"")}</div></div>`;
    }

    // ---------------- product selection UI ----------------
    function renderProductArea(){
      productArea.innerHTML = "";

      if(currentProduct === "bunny"){
        productArea.innerHTML = `
          <div>
            <label>Gr√∂√üe</label>
            <div class="chips">
              <div class="chip" id="size20">20 cm</div>
              <div class="chip" id="size15">15 cm</div>
              <div class="chip" id="size11">11 cm</div>
            </div>
          </div>

          <div class="sep"></div>

          <div>
            <label>Farbmodus</label>
            <div class="chips">
              <div class="chip" id="modeMulti">Mehrfarbig</div>
              <div class="chip" id="modeSingle">Einfarbig</div>
            </div>
          </div>
        `;

        const s20 = document.getElementById("size20");
        const s15 = document.getElementById("size15");
        const s11 = document.getElementById("size11");
        [s20,s15,s11].forEach(el=>{
          el.addEventListener("click", ()=>{
            bunnySize = el.id==="size20" ? "20" : el.id==="size15" ? "15" : "11";
            [s20,s15,s11].forEach(x=>setChipActive(x, x===el));
            validateForAdd();
          });
        });

        const mMulti = document.getElementById("modeMulti");
        const mSingle= document.getElementById("modeSingle");
        [mMulti,mSingle].forEach(el=>{
          el.addEventListener("click", ()=>{
            bunnyMode = (el.id==="modeSingle") ? "single" : "multi";
            [mMulti,mSingle].forEach(x=>setChipActive(x, x===el));
            fields.bunny_ears=""; fields.bunny_body=""; fields.bunny_butt=""; fields.bunny_single="";
            renderColorArea();
            validateForAdd();
          });
        });

      } else if(currentProduct === "lumi"){
        productArea.innerHTML = `<div class="muted">Lumi hat keine Gr√∂√üe ‚Äì w√§hle Farben.</div>`;
      } else if(currentProduct === "other"){
        productArea.innerHTML = `
          <div class="grid grid-2">
            <div class="field">
              <label for="other_name">Produktname *</label>
              <input id="other_name" placeholder="z. B. Schl√ºsselanh√§nger" />
            </div>
            <div class="field">
              <label for="other_size">Gr√∂√üe *</label>
              <input id="other_size" placeholder="z. B. gro√ü / 10 cm / XL" />
            </div>
          </div>
        `;
        const on = document.getElementById("other_name");
        const os = document.getElementById("other_size");
        on.addEventListener("input", ()=>{ fields.other_name = on.value||""; validateForAdd(); });
        os.addEventListener("input", ()=>{ fields.other_size = os.value||""; validateForAdd(); });
      }
    }

    function renderColorArea(){
      colorArea.innerHTML = "";

      if(currentProduct === "bunny"){
        if(bunnyMode === "single"){
          colorArea.innerHTML = `
            <div class="grid">
              ${buildDropdown({ id:"bunny_single", label:"Einfarbig", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
            </div>
          `;
          setupDropdown("bunny_single", v=>{ fields.bunny_single=v; validateForAdd(); });
        } else if(bunnyMode === "multi"){
          colorArea.innerHTML = `
            <div class="grid grid-3">
              ${buildDropdown({ id:"bunny_ears", label:"Ohren", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
              ${buildDropdown({ id:"bunny_body", label:"K√∂rper", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
              ${buildDropdown({ id:"bunny_butt", label:"Popo",  placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
            </div>
          `;
          setupDropdown("bunny_ears", v=>{ fields.bunny_ears=v; validateForAdd(); });
          setupDropdown("bunny_body", v=>{ fields.bunny_body=v; validateForAdd(); });
          setupDropdown("bunny_butt", v=>{ fields.bunny_butt=v; validateForAdd(); });
        } else {
          colorArea.innerHTML = `<div class="muted">Bitte zuerst <b>Farbmodus</b> w√§hlen.</div>`;
        }
      }

      if(currentProduct === "lumi"){
        colorArea.innerHTML = `
          <div class="grid grid-3">
            ${buildDropdown({ id:"lumi_body",   label:"K√∂rper", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
            ${buildDropdown({ id:"lumi_wings",  label:"Fl√ºgel", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
            ${buildDropdown({ id:"lumi_feelers",label:"F√ºhler", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
          </div>
        `;
        setupDropdown("lumi_body",   v=>{ fields.lumi_body=v; validateForAdd(); });
        setupDropdown("lumi_wings",  v=>{ fields.lumi_wings=v; validateForAdd(); });
        setupDropdown("lumi_feelers",v=>{ fields.lumi_feelers=v; validateForAdd(); });
      }

      if(currentProduct === "other"){
        colorArea.innerHTML = `
          <div class="grid grid-2">
            ${buildDropdown({ id:"other_color", label:"Farbe", placeholder:"Tippen oder ausw√§hlen‚Ä¶" })}
          </div>
        `;
        setupDropdown("other_color", v=>{ fields.other_color=v; validateForAdd(); });
      }
    }

    function resetSelections(){
      bunnySize = null;
      bunnyMode = null;
      priority  = null;
      qty       = null;
      qtyOther.value = "";
      fields.bunny_ears=""; fields.bunny_body=""; fields.bunny_butt=""; fields.bunny_single="";
      fields.lumi_body=""; fields.lumi_wings=""; fields.lumi_feelers="";
      fields.other_size=""; fields.other_color=""; fields.other_name="";
      clearErrorUI();
      [pVery,pNorm,pLow].forEach(x=>setPrioActive(x,false));
      document.querySelectorAll(".qtyBtn").forEach(b=>b.classList.remove("active"));
    }

    function setProduct(p){
      currentProduct = p;
      [btnBunny,btnLumi,btnOther].forEach(x=>setChipActive(x,false));
      setChipActive(btnBunny, p==="bunny");
      setChipActive(btnLumi,  p==="lumi");
      setChipActive(btnOther, p==="other");

      newTitle.textContent =
        p==="bunny" ? "Neue Bestellung: Hase" :
        p==="lumi"  ? "Neue Bestellung: Lumi" :
                      "Neue Bestellung: Weitere Produkt";

      resetSelections();
      renderProductArea();
      renderColorArea();
      validateForAdd();
      validateSaveEnabled();
    }

    btnBunny.addEventListener("click", ()=>setProduct("bunny"));
    btnLumi .addEventListener("click", ()=>setProduct("lumi"));
    btnOther.addEventListener("click", ()=>setProduct("other"));

    pVery.addEventListener("click", ()=>{
      priority="very";
      [pVery,pNorm,pLow].forEach(x=>setPrioActive(x,false));
      setPrioActive(pVery,true);
      validateForAdd();
    });
    pNorm.addEventListener("click", ()=>{
      priority="normal";
      [pVery,pNorm,pLow].forEach(x=>setPrioActive(x,false));
      setPrioActive(pNorm,true);
      validateForAdd();
    });
    pLow.addEventListener("click", ()=>{
      priority="low";
      [pVery,pNorm,pLow].forEach(x=>setPrioActive(x,false));
      setPrioActive(pLow,true);
      validateForAdd();
    });

    document.querySelectorAll(".qtyBtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        qty = Number(btn.getAttribute("data-q"));
        document.querySelectorAll(".qtyBtn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        validateForAdd();
      });
    });

    qtyOther.addEventListener("input", ()=> validateForAdd());

    function requiredOk(){
      const missing = [];
      if(!currentProduct) missing.push("Produkt");
      if(!priority) missing.push("Priorit√§t");

      const otherQ = num(qtyOther.value);
      const hasQty = Number.isFinite(otherQ) && otherQ>0 ? true : (typeof qty==="number" && qty>0);
      if(!hasQty) missing.push("Menge");

      if(currentProduct === "bunny"){
        if(!bunnySize) missing.push("Gr√∂√üe");
        if(!bunnyMode) missing.push("Farbmodus");
        if(bunnyMode === "single"){
          if(!norm(fields.bunny_single)) missing.push("Einfarbig");
        }
        if(bunnyMode === "multi"){
          if(!norm(fields.bunny_ears)) missing.push("Ohren");
          if(!norm(fields.bunny_body)) missing.push("K√∂rper");
          if(!norm(fields.bunny_butt)) missing.push("Popo");
        }
      }

      if(currentProduct === "lumi"){
        if(!norm(fields.lumi_body))    missing.push("K√∂rper");
        if(!norm(fields.lumi_wings))   missing.push("Fl√ºgel");
        if(!norm(fields.lumi_feelers)) missing.push("F√ºhler");
      }

      if(currentProduct === "other"){
        if(!norm(fields.other_name)) missing.push("Produktname");
        if(!norm(fields.other_size)) missing.push("Gr√∂√üe");
        if(!norm(fields.other_color)) missing.push("Farbe");
      }

      return missing;
    }

    function validateForAdd(){
      clearErrorUI();
      const missing = requiredOk();
      if(missing.length){
        showMissing("Bitte erst ausf√ºllen: " + missing.join(", "));
        return false;
      }
      return true;
    }

    function validateSaveEnabled(){
      saveOrderBtn.disabled = (cart.length === 0);
    }

    function getQty(){
      const otherQ = num(qtyOther.value);
      if(Number.isFinite(otherQ) && otherQ>0) return Math.floor(otherQ);
      if(typeof qty==="number" && qty>0) return qty;
      return null;
    }

    function inventoryKeyFromOrderItem(it){
      if(it.product !== "bunny") return null;
      const size = String(it.size||"");
      const mode = String(it.mode||"");
      const c = it.colors || {};
      if(mode==="single"){
        return inventoryKeyFromParts({ size, mode:"single", colors:{ single: c.single||"" } });
      }
      return inventoryKeyFromParts({ size, mode:"multi", colors:{ ears:c.ears||"", body:c.body||"", butt:c.butt||"" } });
    }

    function makeItem(){
      const q = getQty();
      const item = {
        _cid: String(Date.now()) + "-" + Math.random().toString(16).slice(2),
        product: currentProduct,
        size: null,
        mode: null,
        colors: {},
        qty: q,
        priority,
        customer_name: (customer.value||"").trim() || null,
        note: (noteEl.value||"").trim() || null,
        price_override: null,
        ignore_inventory: false
      };

      if(currentProduct==="bunny"){
        item.size = bunnySize;
        item.mode = bunnyMode;
        if(bunnyMode==="single") item.colors.single = norm(fields.bunny_single);
        else {
          item.colors.ears = norm(fields.bunny_ears);
          item.colors.body = norm(fields.bunny_body);
          item.colors.butt = norm(fields.bunny_butt);
        }
      }

      if(currentProduct==="lumi"){
        item.colors.body    = norm(fields.lumi_body);
        item.colors.wings   = norm(fields.lumi_wings);
        item.colors.feelers = norm(fields.lumi_feelers);
      }

      if(currentProduct==="other"){
        item.size = norm(fields.other_size);
        item.colors.color = norm(fields.other_color);
        item.other_name = (fields.other_name||"").trim();
      }

      return item;
    }

    function cartTotal(){
      // wie priceForOrderItems aber f√ºr cart (noch nicht gespeichert)
      return priceForOrderItems(cart);
    }

    function updateCartUI(){
      cartList.innerHTML = "";
      cartHint.style.display = cart.length===0 ? "block" : "none";

      for(const it of cart){
        const card = document.createElement("div");
        card.className = "card pad";

        card.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div style="min-width:220px;">
              <div style="font-weight:1000">${esc(buildOrderItemTitle(it))} <span class="muted">(${esc(prioLabel(it.priority))})</span></div>
              ${colorTextStack(it)}
            </div>
            <div class="row" style="gap:8px;">
              <span class="badge">√ó ${esc(it.qty)}</span>
              <button class="iconBtn danger" data-del="${esc(it._cid)}" title="Entfernen">‚úñ</button>
            </div>
          </div>
        `;
        cartList.appendChild(card);
      }

      cartList.querySelectorAll("[data-del]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-del");
          cart = cart.filter(x=>String(x._cid)!==String(id));
          updateCartUI();
          validateSaveEnabled();
        });
      });

      cartSum.textContent = "Summe: " + euro(cartTotal());
    }

    addItemBtn.addEventListener("click", ()=>{
      if(!validateForAdd()) return;
      cart.push(makeItem());
      qty = null;
      qtyOther.value = "";
      document.querySelectorAll(".qtyBtn").forEach(b=>b.classList.remove("active"));
      updateCartUI();
      validateSaveEnabled();
      clearErrorUI();
    });

    sortDate.addEventListener("click", ()=>{
      sortMode = "date";
      sortDate.classList.add("btnDark"); sortDate.classList.remove("btnSoft");
      sortPrio.classList.add("btnSoft"); sortPrio.classList.remove("btnDark");
      loadAll();
    });
    sortPrio.addEventListener("click", ()=>{
      sortMode = "prio";
      sortPrio.classList.add("btnDark"); sortPrio.classList.remove("btnSoft");
      sortDate.classList.add("btnSoft"); sortDate.classList.remove("btnDark");
      loadAll();
    });

    setProduct("bunny");
    updateCartUI();
    validateSaveEnabled();

    // ---------------- Save order ----------------
    async function saveOrder(){
      clearErrorUI();
      saveStatus.style.display = "none";

      if(cart.length === 0){
        showMissing("F√ºge zuerst mindestens eine Position hinzu.");
        return;
      }

      saveOrderBtn.disabled = true;
      saveOrderBtn.textContent = "Speichern‚Ä¶";

      const orderPayload = {
        customer_name: (customer.value||"").trim() || null,
        note: (noteEl.value||"").trim() || null,
        archived: false,
        amount_adjust: 0
      };

      const { data: orderData, error: orderErr } = await supabase
        .from("orders")
        .insert(orderPayload)
        .select("id")
        .single();

      if(orderErr){
        showMissing("Fehler beim Speichern: " + orderErr.message);
        saveOrderBtn.disabled = false;
        saveOrderBtn.textContent = "‚úÖ Bestellung speichern";
        return;
      }

      const orderId = orderData.id;

      const itemsPayload = cart.map(it=>({
        order_id: orderId,
        product: it.product,
        size: it.size ?? null,
        mode: it.mode ?? null,
        priority: it.priority,
        qty: it.qty,
        colors: it.colors,
        note: it.note ?? null,
        price_override: it.price_override ?? null,
        ignore_inventory: it.ignore_inventory ?? false,
        inventory_key: inventoryKeyFromOrderItem(it)
      }));

      const { error: itemsErr } = await supabase.from("order_items").insert(itemsPayload);

      if(itemsErr){
        showMissing("Fehler beim Speichern (Positionen): " + itemsErr.message);
        await supabase.from("orders").delete().eq("id", orderId);
        saveOrderBtn.disabled = false;
        saveOrderBtn.textContent = "‚úÖ Bestellung speichern";
        return;
      }

      cart = [];
      updateCartUI();
      validateSaveEnabled();

      saveStatus.style.display = "block";
      saveStatus.textContent = "Gespeichert ‚úÖ";
      saveOrderBtn.textContent = "‚úÖ Bestellung speichern";
      saveOrderBtn.disabled = true;

      await loadAll();
    }
    saveOrderBtn.addEventListener("click", saveOrder);

    // ---------------- inventory map ----------------
    function buildInventoryMap(rows){
      const map = new Map();
      for(const r of (rows||[])) map.set(String(r.key), Number(r.qty||0));
      return map;
    }

    // ‚úÖ Stock badge: klickbar bei ‚ÄúNicht im Bestand‚Äù
    function stockBadgeForItem(it, invMap){
      if(it.product !== "bunny") return `<span class="badge neutral">‚Äî</span>`;

      // wenn manuell als ‚Äúda‚Äù markiert:
      if(it.ignore_inventory){
        return `<span class="badge ok">‚úÖ Manuell als da</span>`;
      }

      const key = it.inventory_key || inventoryKeyFromOrderItem(it);
      const have = Number(invMap.get(key) || 0);
      const need = Number(it.qty || 0);

      if(have >= need) return `<span class="badge ok">‚úÖ Im Bestand (${have})</span>`;
      if(have > 0) return `<span class="badge warn">‚ö†Ô∏è Nur ${have} da</span>`;

      // ‚ùå klickbar
      return `<span class="badge bad clickable" data-mark-stock="${esc(it.id)}">‚ùå Nicht im Bestand</span>`;
    }

    async function markItemAsManualStock(itemId){
      const ok = confirm("Als 'im Bestand' markieren (manuell)?\n\nDann wird der Bestand NICHT beeinflusst (auch nicht beim Archivieren).");
      if(!ok) return;

      const { error } = await supabase
        .from("order_items")
        .update({ ignore_inventory: true })
        .eq("id", itemId);

      if(error) return alert(error.message);
      await loadAll();
    }

    // ---------------- order actions ----------------
    async function deleteOrder(orderId){
      const ok = confirm("Bist du sicher? Diese Bestellung wird endg√ºltig gel√∂scht.");
      if(!ok) return;
      await supabase.from("order_items").delete().eq("order_id", orderId);
      await supabase.from("orders").delete().eq("id", orderId);
      await loadAll();
    }

    async function restoreOrder(orderId){
      await supabase.from("orders").update({ archived:false }).eq("id", orderId);
      await loadAll();
    }

    async function editOrderAdjust(orderId, currentAdjust){
      const v = prompt("Korrektur / Preis-Anpassung f√ºr diese Bestellung in ‚Ç¨ (z.B. -2 oder 3.50):", String(currentAdjust ?? 0));
      if(v===null) return;
      const n = num(v);
      if(!Number.isFinite(n)) return alert("Bitte eine Zahl eingeben (z.B. 2 oder -1.50).");

      const { error } = await supabase.from("orders").update({ amount_adjust: n }).eq("id", orderId);
      if(error) return alert(error.message);
      await loadAll();
    }

    async function editItemPrice(itemId, currentPrice){
      const v = prompt("Preis pro St√ºck in ‚Ç¨ (leer = Standardpreis):", currentPrice==null ? "" : String(currentPrice));
      if(v===null) return;

      const trimmed = String(v).trim();
      let newVal = null;
      if(trimmed !== ""){
        const n = num(trimmed);
        if(!Number.isFinite(n) || n<0) return alert("Bitte eine g√ºltige Zahl >= 0 eingeben.");
        newVal = n;
      }

      const { error } = await supabase.from("order_items").update({ price_override: newVal }).eq("id", itemId);
      if(error) return alert(error.message);
      await loadAll();
    }

    // ‚úÖ Archivieren: zieht nur ab, wenn item.ignore_inventory = false
    async function archiveOrderWithStock(orderId){
      const { data: items, error: iErr } = await supabase
        .from("order_items")
        .select("*")
        .eq("order_id", orderId);

      if(iErr) return alert(iErr.message);

      const { data: inv, error: invErr2 } = await supabase
        .from("inventory")
        .select("*");

      if(invErr2) return alert(invErr2.message);

      const invMap = buildInventoryMap(inv);

      const needMap = new Map();
      for(const it of (items||[])){
        if(it.product !== "bunny") continue;
        if(it.ignore_inventory) continue; // ‚úÖ manuell markiert -> kein Abzug
        const key = it.inventory_key || inventoryKeyFromOrderItem(it);
        const q = Number(it.qty||0);
        needMap.set(key, (needMap.get(key)||0) + q);
      }

      // pr√ºfen
      const shortages = [];
      for(const [key, need] of needMap.entries()){
        const have = Number(invMap.get(key)||0);
        if(have < need) shortages.push({ key, have, need });
      }

      if(shortages.length){
        const msg =
          "‚ö†Ô∏è Bestand reicht nicht f√ºr alle Positionen.\n\n" +
          shortages.slice(0,6).map(s=>`‚Ä¢ ${s.key} (da: ${s.have}, n√∂tig: ${s.need})`).join("\n") +
          (shortages.length>6 ? "\n‚Ä¶" : "") +
          "\n\nTrotzdem archivieren?\n" +
          "OK = Archivieren OHNE Bestands-Abzug\n" +
          "Abbrechen = zur√ºck";
        const ok = confirm(msg);
        if(!ok) return;

        await supabase.from("orders").update({ archived:true }).eq("id", orderId);
        await loadAll();
        return;
      }

      // abziehen
      for(const [key, need] of needMap.entries()){
        const have = Number(invMap.get(key)||0);
        const newQty = Math.max(0, have - need);
        const { error: uErr } = await supabase.from("inventory").update({ qty: newQty }).eq("key", key);
        if(uErr) return alert("Fehler beim Abziehen im Bestand: " + uErr.message);
      }

      await supabase.from("orders").update({ archived:true }).eq("id", orderId);
      await loadAll();
    }

    // ---------------- render orders ----------------
    function renderOrders(target, orders, invMap, { archived }){
      target.innerHTML = "";

      if(orders.length === 0){
        target.innerHTML = `<div class="muted">Keine ${archived ? "archivierten" : "offenen"} Bestellungen.</div>`;
        return;
      }

      for(const o of orders){
        let items = (o.items || []).slice().sort((a,b)=>{
          const ka = itemSortKey(a), kb = itemSortKey(b);
          return ka < kb ? -1 : ka > kb ? 1 : 0;
        });

        const baseTotal = priceForOrderItems(items);
        const adjust = Number(o.amount_adjust || 0);
        const total = baseTotal + adjust;

        const date = formatDateOnly(o.created_at);
        const minPr = Math.min(...items.map(x=>prioRank(x.priority)).concat([2]));
        const prText = minPr===0 ? "Sehr wichtig" : minPr===1 ? "Wichtig" : "Nicht wichtig";

        const lines = items.map(it=>{
          const stock = archived ? `<span class="badge neutral">‚Äî</span>` : stockBadgeForItem(it, invMap);
          const priceTxt = (it.price_override!=null)
            ? `<div class="muted" style="margin-top:4px;">üí∂ Preis/Stk: ${euro(it.price_override)}</div>`
            : ``;

          return `
            <div style="padding:10px 0; border-top:1px dashed #eef2f7;">
              <div class="row" style="justify-content:space-between; gap:10px; align-items:flex-start;">
                <div style="min-width:240px;">
                  <div style="font-weight:900">${esc(buildOrderItemTitle(it))} <span class="muted">(${esc(prioLabel(it.priority))})</span></div>
                  ${colorTextStack(it)}
                  ${priceTxt}
                </div>

                <div class="row" style="gap:10px;">
                  ${stock}
                  <span class="badge">√ó ${esc(it.qty)}</span>

                  <!-- Stift pro Position -->
                  <button class="iconBtn" title="Preis pro St√ºck √§ndern" data-edit-item="${it.id}" data-cur-price="${it.price_override ?? ""}">‚úè</button>
                </div>
              </div>
            </div>
          `;
        }).join("");

        const card = document.createElement("div");
        card.className = "card pad orderCard";

        const adjustTxt = adjust !== 0 ? `<div class="muted" style="margin-top:6px;">Korrektur: ${euro(adjust)}</div>` : "";

        card.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div>
              <div class="row" style="gap:10px; align-items:center;">
                <div class="orderTitle">${archived ? "Archiv" : "Offen"} ‚Ä¢ ${esc(date)}</div>
                <span class="badge">${esc(prText)}</span>
              </div>
              ${o.customer_name ? `<div class="muted" style="margin-top:6px;">üë§ ${esc(o.customer_name)}</div>` : ``}
              ${o.note ? `<div class="muted" style="margin-top:6px;">üìù ${esc(o.note)}</div>` : ``}
              ${adjustTxt}
            </div>

            <div class="row" style="gap:8px; align-items:center;">
              <div style="font-weight:1000">${euro(total)}</div>

              <!-- Stift: Korrektur pro Bestellung -->
              <button class="iconBtn" title="Bestellung-Korrektur √§ndern" data-edit-order="${o.id}" data-cur-adjust="${o.amount_adjust ?? 0}">‚úè</button>

              ${
                archived
                  ? `
                    <button class="iconBtn" data-restore="${o.id}" title="Zur√ºck holen">‚Ü©</button>
                    <button class="iconBtn danger" data-delete="${o.id}" title="L√∂schen">üóë</button>
                  `
                  : `
                    <button class="iconBtn" data-archive="${o.id}" title="Ins Archiv (zieht Bestand ab)">üì¶</button>
                    <button class="iconBtn danger" data-delete="${o.id}" title="L√∂schen">üóë</button>
                  `
              }
            </div>
          </div>

          <div class="sep"></div>
          ${lines}
        `;

        target.appendChild(card);
      }

      // Handlers
      target.querySelectorAll("[data-archive]").forEach(b=>{
        b.addEventListener("click", ()=>archiveOrderWithStock(b.getAttribute("data-archive")));
      });
      target.querySelectorAll("[data-restore]").forEach(b=>{
        b.addEventListener("click", ()=>restoreOrder(b.getAttribute("data-restore")));
      });
      target.querySelectorAll("[data-delete]").forEach(b=>{
        b.addEventListener("click", ()=>deleteOrder(b.getAttribute("data-delete")));
      });

      // ‚ÄúNicht im Bestand‚Äù anklickbar
      target.querySelectorAll("[data-mark-stock]").forEach(b=>{
        b.addEventListener("click", ()=>markItemAsManualStock(b.getAttribute("data-mark-stock")));
      });

      // Stift pro Bestellung (Korrektur)
      target.querySelectorAll("[data-edit-order]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-edit-order");
          const cur = b.getAttribute("data-cur-adjust");
          editOrderAdjust(id, cur);
        });
      });

      // Stift pro Item (Preis/Stk)
      target.querySelectorAll("[data-edit-item]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-edit-item");
          const cur = b.getAttribute("data-cur-price");
          editItemPrice(id, cur==="" ? null : cur);
        });
      });
    }

    function renderArchive(target, orders, invMap){
      target.innerHTML = "";
      if(orders.length===0){
        target.innerHTML = `<div class="muted">Keine archivierten Bestellungen.</div>`;
        return;
      }
      renderOrders(target, orders, invMap, { archived:true });
    }

    // ---------------- load all ----------------
    async function loadAll(){
      const { data: orders, error: oErr } = await supabase
        .from("orders")
        .select("id,created_at,customer_name,note,archived,amount_adjust")
        .order("created_at", { ascending:false });

      if(oErr){
        openSumEl.textContent = "Fehler: " + oErr.message;
        return;
      }

      const { data: items, error: iErr } = await supabase
        .from("order_items")
        .select("*")
        .order("created_at", { ascending:false });

      if(iErr){
        openSumEl.textContent = "Fehler: " + iErr.message;
        return;
      }

      const { data: inv, error: invErr3 } = await supabase
        .from("inventory")
        .select("*");

      const invMap = invErr3 ? new Map() : buildInventoryMap(inv);

      // merge items into orders
      const map = new Map();
      for(const o of (orders||[])) map.set(o.id, { ...o, items: [] });
      for(const it of (items||[])){
        const o = map.get(it.order_id);
        if(o){
          o.items.push({ ...it, colors: it.colors || {} });
        }
      }

      const all = Array.from(map.values());
      const open = all.filter(x=>!x.archived);
      const archived = all.filter(x=>x.archived);

      if(sortMode==="prio"){
        open.sort((a,b)=>{
          const ap = Math.min(...a.items.map(x=>prioRank(x.priority)).concat([2]));
          const bp = Math.min(...b.items.map(x=>prioRank(x.priority)).concat([2]));
          if(ap!==bp) return ap-bp;
          return new Date(b.created_at)-new Date(a.created_at);
        });
      } else {
        open.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
      }

      // sums
      const openTotal = open.reduce((s,o)=> s + (priceForOrderItems(o.items) + Number(o.amount_adjust||0)), 0);
      openSumEl.textContent = `Summe offen: ${euro(openTotal)}`;

      const archivedTotal = archived.reduce((s,o)=> s + (priceForOrderItems(o.items) + Number(o.amount_adjust||0)), 0);
      archivedTotalEl.textContent = `Archiv gesamt: ${euro(archivedTotal)}`;

      renderOrders(openOrdersEl, open, invMap, { archived:false });
      renderArchive(archiveOrdersEl, archived, invMap);
    }

    // ---------------- Start ----------------
    await setActiveTab("orders");
  </script>
</body>
</html>

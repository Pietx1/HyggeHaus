<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HyggeHaus ‚Ä¢ Bestellungen</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --dark:#0f172a;
      --dark2:#111827;
      --danger:#b91c1c;
      --ok:#047857;
      --warn:#b45309;
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .container{ max-width:1100px; margin:0 auto; padding:24px; }
    h1{ margin:0; font-size:38px; letter-spacing:-.02em; }
    .topbar{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; margin-bottom:18px; }
    .hint{ color:var(--muted); font-size:13px; }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .pad{ padding:18px; }
    .sep{ height:1px; background:var(--border); margin:14px 0; }

    .title2{ font-size:18px; font-weight:900; margin:0 0 8px; }
    label{ font-weight:900; font-size:13px; display:block; margin:0 0 6px; }

    /* iOS Zoom Bug vermeiden: input font-size >= 16px */
    input, textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius:14px;
      padding:11px 14px;
      font-size:16px;
      outline:none;
      background:#fff;
    }
    textarea{ min-height:90px; resize:vertical; }
    input:focus, textarea:focus{ border-color:#c7d2fe; box-shadow:0 0 0 4px rgba(99,102,241,.12); }

    .grid{ display:grid; gap:14px; }
    @media(min-width:900px){
      .grid-2{ grid-template-columns:repeat(2,1fr); }
      .grid-3{ grid-template-columns:repeat(3,1fr); }
    }

    .btn{
      border:0;
      cursor:pointer;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      font-size:14px;
      background:var(--dark2);
      color:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .btnSmall{ padding:8px 10px; border-radius:12px; font-size:13px; }
    .btnSoft{
      background:#fff;
      border:1px solid var(--border);
      color:var(--text);
      font-weight:900;
    }
    .btnDark{ background:linear-gradient(180deg, #0b1220, #0f172a); }
    .btnDanger{ background:var(--danger); }

    .chips{ display:flex; gap:10px; flex-wrap:wrap; }
    .chip{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      padding:11px 14px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      min-width:108px;
      text-align:center;
    }
    .chip.active{
      background:linear-gradient(180deg, #0b1220, #0f172a);
      color:#fff;
      border-color:#0f172a;
    }

    .prioRow{ display:flex; gap:10px; align-items:stretch; }
    .prioBtn{
      flex:1;
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      padding:10px 12px;
      text-align:center;
      user-select:none;
    }
    .prioBtn.small{ flex:.85; }
    .prioBtn.big{ flex:1.3; }
    .prioBtn.active{ background:var(--dark2); color:#fff; border-color:var(--dark2); }

    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .muted{ color:var(--muted); font-size:13px; }
    .status{ margin-top:10px; font-size:13px; color:var(--muted); }
    .error{ color:var(--danger); font-weight:900; }
    .ok{ color:var(--ok); font-weight:900; }

    .orderCard{ border:1px solid var(--border); border-radius:16px; padding:12px; background:#fff; }
    .orderTitle{ font-weight:1000; }

    .badge{
      font-size:12px;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      white-space:nowrap;
    }
    .badge.ok{ border-color:#bbf7d0; background:#f0fdf4; color:#166534; }
    .badge.warn{ border-color:#fed7aa; background:#fff7ed; color:#9a3412; }
    .badge.bad{ border-color:#fecaca; background:#fff1f2; color:#991b1b; }

    .iconBtn{
      border:1px solid var(--border);
      background:#fff;
      width:36px; height:36px;
      border-radius:12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
    }
    .iconBtn:hover{ background:#f9fafb; }
    .iconBtn.danger{ border-color:#fecaca; color:#991b1b; }

    details.archive > summary{
      cursor:pointer;
      user-select:none;
      font-weight:900;
      color:#1f3a8a;
    }

    /* Farben untereinander */
    .colorsStack{ display:grid; gap:2px; margin-top:4px; }
    .colorsStack div{ line-height:1.25; }

    /* Menge 3x3 am Handy */
    .qtyGrid{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
    }
    .qtyGrid .chip{ min-width:0; }

    /* Color field mit Pfeil (√∂ffnet Modal) */
    .colorField{ position:relative; }
    .colorField input{ padding-right:42px; }
    .colorArrow{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      border:1px solid var(--border);
      background:#fff;
      width:30px;
      height:30px;
      border-radius:10px;
      cursor:pointer;
      font-weight:1000;
    }

    /* Produced toggle (nur Icon) */
    .prodToggle{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:46px;
      background:#fff;
    }
    .prodToggle.done{
      border-color:#bbf7d0;
      background:#f0fdf4;
      color:#166534;
    }
    .prodToggle.notdone{
      border-color:#fecaca;
      background:#fff1f2;
      color:#991b1b;
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(15,23,42,.45);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modalBack.open{ display:flex; }
    .modal{
      width:min(560px, 100%);
      background:#fff;
      border-radius:22px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--border);
    }
    .modalTitle{ font-weight:1000; }
    .modalBody{ padding:14px 16px; }
    .modalFoot{
      padding:14px 16px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      border-top:1px solid var(--border);
    }

    /* Color buttons */
    .colorGrid{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
    }
    @media(min-width:900px){
      .colorGrid{ grid-template-columns:repeat(4, 1fr); }
    }
    .colorBtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      padding:10px 10px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      text-align:center;
    }
    .colorBtn:hover{ background:#f9fafb; }

    /* Preis-Keypad */
    .moneyDisplay{
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px 14px;
      font-weight:1000;
      font-size:22px;
      text-align:center;
      background:#fff;
    }
    .keypad{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
      margin-top:12px;
    }
    .key{
      border:1px solid var(--border);
      background:#fff;
      border-radius:16px;
      padding:14px 0;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
      text-align:center;
      font-size:18px;
    }
    .key:hover{ background:#f9fafb; }
    .key.secondary{ color:var(--muted); }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <h1>Bestellungen</h1>
      <div class="hint">GitHub Pages ‚Ä¢ Supabase</div>
    </div>

    <!-- NEUE BESTELLUNG -->
    <div class="card">
      <div class="pad">
        <div class="chips">
          <div class="chip" id="btnBunny">üê∞ Hase</div>
          <div class="chip" id="btnLumi">‚ú®ü™≤ Lumi</div>
          <div class="chip" id="btnScript">‚úçÔ∏è Schriftzug</div>
          <div class="chip" id="btnOther">‚ûï Weitere Produkt</div>
        </div>

        <div style="height:10px"></div>
        <div class="title2" id="newTitle">Neue Bestellung</div>

        <div id="productArea"></div>
        <div class="sep"></div>

        <!-- Kundenname immer √ºber Priorit√§t -->
        <div class="grid grid-2">
          <div>
            <label for="customer">Kundenname</label>
            <input id="customer" placeholder="z. B. Max Mustermann" />
          </div>
          <div>
            <label for="note">Beschreibung (optional)</label>
            <textarea id="note" placeholder="z. B. Sonderwunsch, Hinweis ‚Ä¶"></textarea>
          </div>
        </div>

        <div class="sep"></div>

        <label>Priorit√§t</label>
        <div class="prioRow">
          <div class="prioBtn small" id="pVery">Sehr wichtig</div>
          <div class="prioBtn big" id="pNorm">Wichtig</div>
          <div class="prioBtn small" id="pLow">Nicht wichtig</div>
        </div>

        <div class="sep"></div>

        <label>Menge</label>
        <div class="qtyGrid" id="qtyGrid">
          <div class="chip qtyBtn" data-q="1">1</div>
          <div class="chip qtyBtn" data-q="2">2</div>
          <div class="chip qtyBtn" data-q="3">3</div>
          <div class="chip qtyBtn" data-q="4">4</div>
          <div class="chip qtyBtn" data-q="5">5</div>
          <div class="chip qtyBtn" data-q="6">6</div>
          <div class="chip qtyBtn" data-q="7">7</div>
          <div class="chip qtyBtn" data-q="8">8</div>
          <div class="chip qtyBtn" data-q="9">9</div>
        </div>

        <div class="grid grid-2" style="align-items:end; margin-top:10px;">
          <div>
            <label for="qtyOther">Andere Menge (optional)</label>
            <input id="qtyOther" inputmode="numeric" placeholder="z. B. 12" />
          </div>
          <div style="display:flex; justify-content:flex-end;">
            <button class="btn btnDark" id="addItemBtn" style="min-width:280px;">+ Position hinzuf√ºgen</button>
          </div>
        </div>

        <div class="status">
          <div class="error" id="formError" style="display:none;"></div>
        </div>

        <div class="sep"></div>

        <div class="row" style="justify-content:space-between; align-items:flex-end;">
          <div class="title2" style="margin:0;">Positionen in dieser Bestellung</div>
          <div class="muted" id="cartSum">Summe: 0,00 ‚Ç¨</div>
        </div>

        <div id="cartList" class="grid" style="margin-top:10px;"></div>
        <div class="muted" id="cartHint">Noch keine Position hinzugef√ºgt.</div>

        <div class="sep"></div>

        <button id="saveOrderBtn" class="btn" disabled>‚úÖ Bestellung speichern</button>
        <div class="ok" id="saveStatus" style="display:none; margin-top:10px;">Gespeichert ‚úÖ</div>
      </div>
    </div>

    <div style="height:16px"></div>

    <!-- OFFENE BESTELLUNGEN -->
    <div class="card">
      <div class="pad">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div class="title2" style="margin:0;">Offene Bestellungen</div>
            <div class="muted" id="openSum">Summe offen: 0,00 ‚Ç¨</div>
          </div>

          <div class="row" style="gap:10px;">
            <button class="btnSmall btnDark" id="sortDate">Sort: Datum</button>
            <button class="btnSmall btnSoft" id="sortPrio">Sort: Priorit√§t</button>
          </div>
        </div>

        <div class="sep"></div>
        <div id="openOrders" class="grid"></div>

        <div class="sep"></div>

        <details class="archive">
          <summary>Archiv (alte Bestellungen anzeigen)</summary>
          <div style="margin-top:10px;">
            <div class="muted" id="archivedTotal">Archiv gesamt: 0,00 ‚Ç¨</div>
            <div style="height:8px"></div>
            <div id="archiveOrders" class="grid"></div>
          </div>
        </details>
      </div>
    </div>
  </div>

  <!-- MODALS -->
  <div class="modalBack" id="colorModalBack">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle" id="colorModalTitle">Farbe w√§hlen</div>
        <button class="iconBtn" id="colorModalClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="muted" style="margin-bottom:10px;">Tippe eine Farbe an ‚Äî oder tippe selbst ins Feld.</div>
        <div class="grid grid-1">
          <input id="colorModalInput" placeholder="Farbe eintippen‚Ä¶" />
        </div>
        <div style="height:10px"></div>
        <div class="colorGrid" id="colorGrid"></div>
      </div>
      <div class="modalFoot">
        <button class="btnSmall btnSoft" id="colorCancel">Abbrechen</button>
        <button class="btnSmall btnDark" id="colorApply">√úbernehmen</button>
      </div>
    </div>
  </div>

  <div class="modalBack" id="moneyModalBack">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle" id="moneyModalTitle">Preis</div>
        <button class="iconBtn" id="moneyModalClose">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="moneyDisplay" id="moneyDisplay">0,00 ‚Ç¨</div>
        <div class="keypad" id="keypad"></div>
        <div class="muted" style="margin-top:10px;">
          Eingabe funktioniert wie Kassensystem: jede Zahl schiebt das Komma.
        </div>
      </div>
      <div class="modalFoot">
        <button class="btnSmall btnSoft" id="moneyClear">L√∂schen</button>
        <button class="btnSmall btnDark" id="moneyApply">√úbernehmen</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ‚úÖ Supabase
    const SUPABASE_URL = "https://htgrzmlcdolxxzvkppon.supabase.co";
    const SUPABASE_ANON_KEY = "REPLACE_WITH_YOUR_KEY";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Farben (Buttons in Modal)
    const COLOR_SUGGESTIONS = [
      "wei√ü","schwarz","grau","dunkelgrau","hellgrau",
      "beige","creme","braun","oak",
      "rot","orange","gelb","gr√ºn","blau","lila",
      "pink","rosa","gold","silber"
    ];

    // Standardpreise in CENT
    const PRICES_CENTS = {
      bunny: { "11 cm": 600, "15 cm": 900, "20 cm": 1200 },
      lumi: 850
    };

    // Helpers
    const esc = (s)=> String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    const norm = (s)=> String(s||"").trim();
    const euroFromCents = (c)=> {
      const n = Number(c||0);
      const euros = Math.floor(n/100);
      const cents = String(Math.abs(n%100)).padStart(2,"0");
      return `${euros},${cents} ‚Ç¨`.replace("-0,", "-0,");
    };
    const parseQty = (v)=> {
      const n = Number(String(v??"").replace(",", "."));
      if(!Number.isFinite(n) || n<=0) return null;
      return Math.floor(n);
    };

    function setChip(el, on){ el?.classList.toggle("active", !!on); }
    function showErr(msg){
      const el = document.getElementById("formError");
      el.style.display="block";
      el.textContent = msg;
    }
    function clearErr(){
      const el = document.getElementById("formError");
      el.style.display="none";
      el.textContent = "";
    }

    // ---------------- Color Modal ----------------
    const colorModalBack = document.getElementById("colorModalBack");
    const colorModalTitle= document.getElementById("colorModalTitle");
    const colorModalInput= document.getElementById("colorModalInput");
    const colorGrid      = document.getElementById("colorGrid");
    const colorApply     = document.getElementById("colorApply");
    const colorCancel    = document.getElementById("colorCancel");
    const colorModalClose= document.getElementById("colorModalClose");

    let colorTargetInput = null;

    function openColorModal({ title, targetInput }){
      colorTargetInput = targetInput;
      colorModalTitle.textContent = title || "Farbe w√§hlen";
      colorModalInput.value = targetInput?.value || "";
      colorGrid.innerHTML = COLOR_SUGGESTIONS.map(c=>`<button class="colorBtn" type="button" data-color="${esc(c)}">${esc(c)}</button>`).join("");
      colorGrid.querySelectorAll("[data-color]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const v = b.getAttribute("data-color") || "";
          colorModalInput.value = v;
          applyColorModal();
        });
      });
      colorModalBack.classList.add("open");
      setTimeout(()=>colorModalInput.focus(), 50);
    }
    function closeColorModal(){
      colorModalBack.classList.remove("open");
      colorTargetInput = null;
    }
    function applyColorModal(){
      if(!colorTargetInput) return closeColorModal();
      colorTargetInput.value = colorModalInput.value || "";
      colorTargetInput.dispatchEvent(new Event("input", { bubbles:true }));
      closeColorModal();
    }
    colorApply.addEventListener("click", applyColorModal);
    colorCancel.addEventListener("click", closeColorModal);
    colorModalClose.addEventListener("click", closeColorModal);
    colorModalBack.addEventListener("click", (e)=>{ if(e.target === colorModalBack) closeColorModal(); });

    // ---------------- Money Modal (Komma schieben) ----------------
    const moneyModalBack = document.getElementById("moneyModalBack");
    const moneyModalTitle= document.getElementById("moneyModalTitle");
    const moneyDisplay   = document.getElementById("moneyDisplay");
    const keypad         = document.getElementById("keypad");
    const moneyApply     = document.getElementById("moneyApply");
    const moneyClear     = document.getElementById("moneyClear");
    const moneyModalClose= document.getElementById("moneyModalClose");

    let moneyCents = 0;
    let moneyOnApply = null;

    function renderMoney(){
      moneyDisplay.textContent = euroFromCents(moneyCents);
    }
    function openMoneyModal({ title, initialCents, onApply }){
      moneyModalTitle.textContent = title || "Preis";
      moneyCents = Number(initialCents ?? 0) || 0;
      moneyOnApply = onApply || null;
      renderMoney();

      keypad.innerHTML = [
        "1","2","3","4","5","6","7","8","9","‚å´","0","OK"
      ].map(k=>`<button type="button" class="key ${k==='‚å´'?'secondary':''} ${k==='OK'?'':'']}" data-key="${esc(k)}">${esc(k)}</button>`).join("");

      keypad.querySelectorAll("[data-key]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const k = b.getAttribute("data-key");
          if(k === "OK"){ applyMoneyModal(); return; }
          if(k === "‚å´"){
            moneyCents = Math.floor(moneyCents / 10);
            renderMoney();
            return;
          }
          // Zahl: Komma schiebt -> cents = cents*10 + digit
          const d = Number(k);
          if(Number.isFinite(d)){
            moneyCents = moneyCents * 10 + d;
            renderMoney();
          }
        });
      });

      moneyModalBack.classList.add("open");
    }
    function closeMoneyModal(){
      moneyModalBack.classList.remove("open");
      moneyOnApply = null;
    }
    function applyMoneyModal(){
      moneyOnApply?.(moneyCents);
      closeMoneyModal();
    }
    moneyApply.addEventListener("click", applyMoneyModal);
    moneyClear.addEventListener("click", ()=>{ moneyCents = 0; renderMoney(); });
    moneyModalClose.addEventListener("click", closeMoneyModal);
    moneyModalBack.addEventListener("click", (e)=>{ if(e.target === moneyModalBack) closeMoneyModal(); });

    // ---------------- UI State (New order) ----------------
    const btnBunny  = document.getElementById("btnBunny");
    const btnLumi   = document.getElementById("btnLumi");
    const btnScript = document.getElementById("btnScript");
    const btnOther  = document.getElementById("btnOther");

    const newTitle  = document.getElementById("newTitle");
    const productArea = document.getElementById("productArea");

    const customer = document.getElementById("customer");
    const noteEl   = document.getElementById("note");

    const pVery = document.getElementById("pVery");
    const pNorm = document.getElementById("pNorm");
    const pLow  = document.getElementById("pLow");

    const qtyOther = document.getElementById("qtyOther");
    const addItemBtn = document.getElementById("addItemBtn");

    const cartList = document.getElementById("cartList");
    const cartHint = document.getElementById("cartHint");
    const cartSum  = document.getElementById("cartSum");

    const saveOrderBtn = document.getElementById("saveOrderBtn");
    const saveStatus   = document.getElementById("saveStatus");

    const openOrdersEl = document.getElementById("openOrders");
    const archiveOrdersEl = document.getElementById("archiveOrders");
    const openSumEl = document.getElementById("openSum");
    const archivedTotalEl = document.getElementById("archivedTotal");

    const sortDate = document.getElementById("sortDate");
    const sortPrio = document.getElementById("sortPrio");

    let sortMode = "date";
    let currentProduct = "bunny";
    let priority = null;
    let qty = null;

    // product form state
    const f = {
      bunny_size: "",
      bunny_ears: "", bunny_body:"", bunny_butt:"",
      lumi_color1:"", lumi_color2:"",

      script_text:"",
      script_size:"",
      script_color1:"",
      script_color2:"",
      script_price_cents: 0,

      other_name:"",
      other_size:"",
      other_color1:"",
      other_color2:"",
      other_price_cents: 0
    };

    let cart = []; // items for new order

    function prioLabel(p){
      if(p==="very") return "Sehr wichtig";
      if(p==="normal") return "Wichtig";
      return "Nicht wichtig";
    }
    function prioRank(p){
      if(p==="very") return 0;
      if(p==="normal") return 1;
      return 2;
    }

    function setProduct(p){
      currentProduct = p;
      [btnBunny,btnLumi,btnScript,btnOther].forEach(x=>setChip(x,false));
      setChip(btnBunny, p==="bunny");
      setChip(btnLumi,  p==="lumi");
      setChip(btnScript,p==="schriftzug");
      setChip(btnOther, p==="other");

      newTitle.textContent =
        p==="bunny" ? "Neue Bestellung: Hase" :
        p==="lumi" ? "Neue Bestellung: Lumi" :
        p==="schriftzug" ? "Neue Bestellung: Schriftzug" :
        "Neue Bestellung: Weitere Produkt";

      renderProductArea();
      clearErr();
    }
    btnBunny.addEventListener("click", ()=>setProduct("bunny"));
    btnLumi.addEventListener("click", ()=>setProduct("lumi"));
    btnScript.addEventListener("click", ()=>setProduct("schriftzug"));
    btnOther.addEventListener("click", ()=>setProduct("other"));

    // Priority buttons
    function setPrio(p){
      priority = p;
      [pVery,pNorm,pLow].forEach(x=>x.classList.remove("active"));
      if(p==="very") pVery.classList.add("active");
      if(p==="normal") pNorm.classList.add("active");
      if(p==="low") pLow.classList.add("active");
    }
    pVery.addEventListener("click", ()=>setPrio("very"));
    pNorm.addEventListener("click", ()=>setPrio("normal"));
    pLow.addEventListener("click", ()=>setPrio("low"));

    // qty buttons
    document.querySelectorAll(".qtyBtn").forEach(b=>{
      b.addEventListener("click", ()=>{
        qty = Number(b.getAttribute("data-q"));
        document.querySelectorAll(".qtyBtn").forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
      });
    });

    function makeColorField(id, label, placeholder){
      return `
        <div class="colorField">
          <label for="${esc(id)}">${esc(label)}</label>
          <input id="${esc(id)}" placeholder="${esc(placeholder)}" autocomplete="off" />
          <button class="colorArrow" type="button" data-color-arrow="${esc(id)}">‚ñæ</button>
        </div>
      `;
    }

    function wireColorField(id, modalTitle, onInput){
      const input = document.getElementById(id);
      const arrow = document.querySelector(`[data-color-arrow="${CSS.escape(id)}"]`);
      if(!input || !arrow) return;
      input.addEventListener("input", ()=>onInput(input.value||""));
      arrow.addEventListener("click", ()=>{
        openColorModal({ title: modalTitle, targetInput: input });
      });
    }

    function renderProductArea(){
      productArea.innerHTML = "";

      if(currentProduct === "bunny"){
        productArea.innerHTML = `
          <div class="grid grid-2">
            <div>
              <label>Gr√∂√üe</label>
              <div class="chips">
                <div class="chip" data-bsize="11 cm">11 cm</div>
                <div class="chip" data-bsize="15 cm">15 cm</div>
                <div class="chip" data-bsize="20 cm">20 cm</div>
              </div>
            </div>
            <div></div>
          </div>

          <div class="sep"></div>

          <div class="grid grid-3">
            ${makeColorField("bunny_ears","Ohren","Tippen‚Ä¶")}
            ${makeColorField("bunny_body","K√∂rper","Tippen‚Ä¶")}
            ${makeColorField("bunny_butt","Popo","Tippen‚Ä¶")}
          </div>
        `;

        productArea.querySelectorAll("[data-bsize]").forEach(b=>{
          b.addEventListener("click", ()=>{
            f.bunny_size = b.getAttribute("data-bsize") || "";
            productArea.querySelectorAll("[data-bsize]").forEach(x=>x.classList.remove("active"));
            b.classList.add("active");
          });
        });

        wireColorField("bunny_ears","Ohren", v=>f.bunny_ears=v);
        wireColorField("bunny_body","K√∂rper", v=>f.bunny_body=v);
        wireColorField("bunny_butt","Popo", v=>f.bunny_butt=v);
      }

      if(currentProduct === "lumi"){
        productArea.innerHTML = `
          <div class="grid grid-2">
            ${makeColorField("lumi_c1","Hauptfarbe","Tippen‚Ä¶")}
            ${makeColorField("lumi_c2","2. Farbe","Tippen‚Ä¶")}
          </div>
        `;
        wireColorField("lumi_c1","Hauptfarbe", v=>f.lumi_color1=v);
        wireColorField("lumi_c2","2. Farbe", v=>f.lumi_color2=v);
      }

      if(currentProduct === "schriftzug"){
        productArea.innerHTML = `
          <div class="grid grid-2">
            <div>
              <label for="script_text">Name</label>
              <input id="script_text" placeholder="Happy Birthday" />
            </div>
            <div>
              <label for="script_size">Gr√∂√üe</label>
              <input id="script_size" placeholder="z. B. 20 cm / gro√ü / 10x5" />
            </div>
          </div>

          <div class="sep"></div>

          <div class="grid grid-2">
            ${makeColorField("script_c1","Hauptfarbe","Tippen‚Ä¶")}
            ${makeColorField("script_c2","2. Farbe","Tippen‚Ä¶")}
          </div>

          <div class="sep"></div>

          <div>
            <label>Preis</label>
            <button class="btnSoft btn" type="button" id="script_price_btn" style="width:100%; justify-content:space-between;">
              <span>Preis eingeben</span>
              <span id="script_price_txt">${euroFromCents(f.script_price_cents)}</span>
            </button>
          </div>
        `;

        const st = document.getElementById("script_text");
        const ss = document.getElementById("script_size");
        st.addEventListener("input", ()=>f.script_text = st.value||"");
        ss.addEventListener("input", ()=>f.script_size = ss.value||"");

        wireColorField("script_c1","Hauptfarbe", v=>f.script_color1=v);
        wireColorField("script_c2","2. Farbe", v=>f.script_color2=v);

        const priceBtn = document.getElementById("script_price_btn");
        const priceTxt = document.getElementById("script_price_txt");
        priceBtn.addEventListener("click", ()=>{
          openMoneyModal({
            title: "Preis Schriftzug",
            initialCents: f.script_price_cents || 0,
            onApply: (cents)=>{
              f.script_price_cents = cents;
              priceTxt.textContent = euroFromCents(cents);
            }
          });
        });
      }

      if(currentProduct === "other"){
        productArea.innerHTML = `
          <div class="grid grid-2">
            <div>
              <label for="other_name">Produktname</label>
              <input id="other_name" placeholder="z. B. Schl√ºsselanh√§nger" />
            </div>
            <div>
              <label for="other_size">Gr√∂√üe</label>
              <input id="other_size" placeholder="z. B. gro√ü / 10 cm / XL" />
            </div>
          </div>

          <div class="sep"></div>

          <div class="grid grid-2">
            ${makeColorField("other_c1","Hauptfarbe","Tippen‚Ä¶")}
            ${makeColorField("other_c2","2. Farbe","Tippen‚Ä¶")}
          </div>

          <div class="sep"></div>

          <div>
            <label>Preis</label>
            <button class="btnSoft btn" type="button" id="other_price_btn" style="width:100%; justify-content:space-between;">
              <span>Preis eingeben</span>
              <span id="other_price_txt">${euroFromCents(f.other_price_cents)}</span>
            </button>
          </div>
        `;

        const on = document.getElementById("other_name");
        const os = document.getElementById("other_size");
        on.addEventListener("input", ()=>f.other_name = on.value||"");
        os.addEventListener("input", ()=>f.other_size = os.value||"");

        wireColorField("other_c1","Hauptfarbe", v=>f.other_color1=v);
        wireColorField("other_c2","2. Farbe", v=>f.other_color2=v);

        const priceBtn = document.getElementById("other_price_btn");
        const priceTxt = document.getElementById("other_price_txt");
        priceBtn.addEventListener("click", ()=>{
          openMoneyModal({
            title: "Preis weiteres Produkt",
            initialCents: f.other_price_cents || 0,
            onApply: (cents)=>{
              f.other_price_cents = cents;
              priceTxt.textContent = euroFromCents(cents);
            }
          });
        });
      }
    }

    function getQty(){
      const other = parseQty(qtyOther.value);
      if(other) return other;
      if(typeof qty==="number" && qty>0) return qty;
      return null;
    }

    function validateForAdd(){
      clearErr();

      if(!norm(customer.value)) return showErr("Bitte Kundenname ausf√ºllen.");
      if(!priority) return showErr("Bitte Priorit√§t ausw√§hlen.");

      const q = getQty();
      if(!q) return showErr("Bitte Menge ausw√§hlen.");

      if(currentProduct==="bunny"){
        if(!norm(f.bunny_size)) return showErr("Bitte Gr√∂√üe w√§hlen.");
        if(!norm(f.bunny_ears) || !norm(f.bunny_body) || !norm(f.bunny_butt)) return showErr("Bitte Ohren / K√∂rper / Popo ausf√ºllen.");
      }
      if(currentProduct==="lumi"){
        if(!norm(f.lumi_color1) || !norm(f.lumi_color2)) return showErr("Bitte Hauptfarbe und 2. Farbe ausf√ºllen.");
      }
      if(currentProduct==="schriftzug"){
        if(!norm(f.script_text)) return showErr("Bitte Name ausf√ºllen.");
        if(!norm(f.script_size)) return showErr("Bitte Gr√∂√üe ausf√ºllen.");
        if(!norm(f.script_color1) || !norm(f.script_color2)) return showErr("Bitte Hauptfarbe und 2. Farbe ausf√ºllen.");
        if(!(Number(f.script_price_cents||0) > 0)) return showErr("Bitte Preis eingeben.");
      }
      if(currentProduct==="other"){
        if(!norm(f.other_name)) return showErr("Bitte Produktname ausf√ºllen.");
        if(!norm(f.other_size)) return showErr("Bitte Gr√∂√üe ausf√ºllen.");
        if(!norm(f.other_color1) || !norm(f.other_color2)) return showErr("Bitte Hauptfarbe und 2. Farbe ausf√ºllen.");
        if(!(Number(f.other_price_cents||0) > 0)) return showErr("Bitte Preis eingeben.");
      }

      return true;
    }

    function itemTitle(it){
      return it.title;
    }

    function colorTextStack(it){
      const c = it.colors || {};
      if(it.product==="bunny"){
        return `
          <div class="colorsStack muted">
            <div><b>Ohren:</b> ${esc(c.ears||"")}</div>
            <div><b>K√∂rper:</b> ${esc(c.body||"")}</div>
            <div><b>Popo:</b> ${esc(c.butt||"")}</div>
          </div>
        `;
      }
      return `
        <div class="colorsStack muted">
          <div><b>Hauptfarbe:</b> ${esc(c.c1||"")}</div>
          <div><b>2. Farbe:</b> ${esc(c.c2||"")}</div>
        </div>
      `;
    }

    function basePriceCents(it){
      if(it.product==="bunny"){
        return PRICES_CENTS.bunny[it.size] || 0;
      }
      if(it.product==="lumi"){
        return PRICES_CENTS.lumi;
      }
      if(it.product==="schriftzug"){
        return Number(it.price_override_cents ?? 0);
      }
      if(it.product==="other"){
        return Number(it.price_override_cents ?? 0);
      }
      return 0;
    }

    function cartTotalCents(){
      return cart.reduce((s,it)=> s + basePriceCents(it) * Number(it.qty||0), 0);
    }

    function updateCartUI(){
      cartList.innerHTML = "";
      cartHint.style.display = cart.length===0 ? "block" : "none";

      for(const it of cart){
        const card = document.createElement("div");
        card.className = "card pad";

        card.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div style="min-width:220px;">
              <div style="font-weight:1000">${esc(itemTitle(it))} <span class="muted">(${esc(prioLabel(it.priority))})</span></div>
              ${colorTextStack(it)}
              <div class="muted" style="margin-top:6px;">üë§ ${esc(it.customer_name)}</div>
              ${it.note ? `<div class="muted" style="margin-top:6px;">üìù ${esc(it.note)}</div>` : ``}
            </div>
            <div class="row" style="gap:8px;">
              <span class="badge">√ó ${esc(it.qty)}</span>
              <button class="iconBtn danger" data-del="${esc(it._cid)}" title="Entfernen">‚úñ</button>
            </div>
          </div>
        `;
        cartList.appendChild(card);
      }

      cartList.querySelectorAll("[data-del]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-del");
          cart = cart.filter(x=>String(x._cid)!==String(id));
          updateCartUI();
          saveOrderBtn.disabled = (cart.length===0);
        });
      });

      cartSum.textContent = "Summe: " + euroFromCents(cartTotalCents());
    }

    addItemBtn.addEventListener("click", ()=>{
      if(!validateForAdd()) return;

      const q = getQty();
      const item = {
        _cid: String(Date.now()) + "-" + Math.random().toString(16).slice(2),
        product: currentProduct,
        title: "",
        size: "",
        qty: q,
        priority,
        customer_name: norm(customer.value),
        note: norm(noteEl.value) || null,
        colors: {},
        price_override_cents: null
      };

      if(currentProduct==="bunny"){
        item.size = f.bunny_size;
        item.title = `Hase ${f.bunny_size}`;
        item.colors = { ears:norm(f.bunny_ears), body:norm(f.bunny_body), butt:norm(f.bunny_butt) };
      }
      if(currentProduct==="lumi"){
        item.size = "‚Äî";
        item.title = "Lumi";
        item.colors = { c1:norm(f.lumi_color1), c2:norm(f.lumi_color2) };
      }
      if(currentProduct==="schriftzug"){
        item.size = norm(f.script_size);
        item.title = norm(f.script_text);
        item.colors = { c1:norm(f.script_color1), c2:norm(f.script_color2) };
        item.price_override_cents = Number(f.script_price_cents||0);
      }
      if(currentProduct==="other"){
        item.size = norm(f.other_size);
        item.title = norm(f.other_name) + ` (${norm(f.other_size)})`;
        item.colors = { c1:norm(f.other_color1), c2:norm(f.other_color2) };
        item.price_override_cents = Number(f.other_price_cents||0);
      }

      cart.push(item);

      qty = null;
      qtyOther.value = "";
      document.querySelectorAll(".qtyBtn").forEach(x=>x.classList.remove("active"));

      updateCartUI();
      saveOrderBtn.disabled = (cart.length===0);
      clearErr();
    });

    // ---------------- Save order to Supabase ----------------
    async function saveOrder(){
      clearErr();
      saveStatus.style.display="none";

      if(cart.length===0){
        showErr("F√ºge zuerst mindestens eine Position hinzu.");
        return;
      }

      saveOrderBtn.disabled = true;
      saveOrderBtn.textContent = "Speichern‚Ä¶";

      const orderPayload = {
        customer_name: norm(customer.value),
        note: norm(noteEl.value) || null,
        archived: false,
        total_override_cents: null
      };

      const { data: orderData, error: orderErr } = await supabase
        .from("orders")
        .insert(orderPayload)
        .select("id")
        .single();

      if(orderErr){
        showErr("Fehler beim Speichern: " + orderErr.message);
        saveOrderBtn.disabled=false;
        saveOrderBtn.textContent="‚úÖ Bestellung speichern";
        return;
      }

      const orderId = orderData.id;

      const itemsPayload = cart.map(it=>({
        order_id: orderId,
        product: it.product,
        title: it.title,
        size: it.size,
        qty: it.qty,
        priority: it.priority,
        colors: it.colors,
        price_override_cents: it.price_override_cents ?? null,
        produced: false
      }));

      const { error: itemsErr } = await supabase
        .from("order_items")
        .insert(itemsPayload);

      if(itemsErr){
        showErr("Fehler beim Speichern (Positionen): " + itemsErr.message);
        await supabase.from("orders").delete().eq("id", orderId);
        saveOrderBtn.disabled=false;
        saveOrderBtn.textContent="‚úÖ Bestellung speichern";
        return;
      }

      cart = [];
      updateCartUI();

      saveStatus.style.display="block";
      saveStatus.textContent="Gespeichert ‚úÖ";
      saveOrderBtn.textContent="‚úÖ Bestellung speichern";
      saveOrderBtn.disabled=true;

      await loadAll();
    }
    saveOrderBtn.addEventListener("click", saveOrder);

    // ---------------- Orders List ----------------
    function formatDateOnly(iso){
      const d = new Date(iso);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}.${mm}.${yy}`;
    }

    function orderTotalCents(order, items){
      // Wenn total_override gesetzt -> das nehmen
      if(order.total_override_cents != null){
        return Number(order.total_override_cents||0);
      }
      // sonst Summe aus Items
      let sum = 0;
      for(const it of items){
        let unit = it.price_override_cents;
        if(unit == null){
          if(it.product==="bunny") unit = PRICES_CENTS.bunny[it.size] || 0;
          else if(it.product==="lumi") unit = PRICES_CENTS.lumi;
          else unit = 0; // other/script sollten override haben, aber falls nicht -> 0
        }
        sum += Number(unit||0) * Number(it.qty||0);
      }
      return sum;
    }

    function renderOrders(target, orders, itemsMap, { archived }){
      target.innerHTML = "";

      if(orders.length===0){
        target.innerHTML = `<div class="muted">Keine ${archived ? "archivierten" : "offenen"} Bestellungen.</div>`;
        return;
      }

      for(const o of orders){
        const items = (itemsMap.get(o.id) || []).slice();

        // Sort Items (prio+title)
        items.sort((a,b)=>{
          const ap = prioRank(a.priority), bp = prioRank(b.priority);
          if(ap!==bp) return ap-bp;
          return String(a.title).localeCompare(String(b.title));
        });

        const allDone = items.length>0 && items.every(x=>x.produced === true);

        const date = formatDateOnly(o.created_at);
        const minPr = Math.min(...items.map(x=>prioRank(x.priority)).concat([2]));
        const prText = minPr===0 ? "Sehr wichtig" : minPr===1 ? "Wichtig" : "Nicht wichtig";

        const totalCents = orderTotalCents(o, items);

        const lines = items.map(it=>{
          const toggleClass = it.produced ? "done" : "notdone";
          const symbol = it.produced ? "‚úì" : "‚úï";

          return `
            <div style="padding:10px 0; border-top:1px dashed #eef2f7;">
              <div class="row" style="justify-content:space-between; gap:10px; align-items:flex-start;">
                <div style="min-width:240px;">
                  <div style="font-weight:900">${esc(it.title)} <span class="muted">(${esc(prioLabel(it.priority))})</span></div>
                  ${it.product==="bunny"
                    ? `<div class="colorsStack muted">
                         <div><b>Ohren:</b> ${esc(it.colors?.ears||"")}</div>
                         <div><b>K√∂rper:</b> ${esc(it.colors?.body||"")}</div>
                         <div><b>Popo:</b> ${esc(it.colors?.butt||"")}</div>
                       </div>`
                    : `<div class="colorsStack muted">
                         <div><b>Hauptfarbe:</b> ${esc(it.colors?.c1||"")}</div>
                         <div><b>2. Farbe:</b> ${esc(it.colors?.c2||"")}</div>
                       </div>`
                  }
                </div>

                <div class="row" style="gap:10px;">
                  <button class="prodToggle ${toggleClass}" data-toggle-produced="${esc(it.id)}" title="Produziert">
                    ${symbol}
                  </button>

                  <span class="badge">√ó ${esc(it.qty)}</span>

                  <button class="iconBtn" title="Preis pro St√ºck √§ndern" data-edit-item="${esc(it.id)}">‚úè</button>
                </div>
              </div>
            </div>
          `;
        }).join("");

        const card = document.createElement("div");
        card.className = "card pad orderCard";

        card.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div>
              <div class="row" style="gap:10px; align-items:center;">
                <div class="orderTitle">${archived ? "Archiv" : "Offen"} ‚Ä¢ ${esc(date)}</div>
                <span class="badge">${esc(prText)}</span>
                ${allDone ? `<span class="badge ok">FERTIG</span>` : ``}
              </div>
              <div class="muted" style="margin-top:6px;">üë§ ${esc(o.customer_name||"")}</div>
              ${o.note ? `<div class="muted" style="margin-top:6px;">üìù ${esc(o.note)}</div>` : ``}
            </div>

            <div class="row" style="gap:8px; align-items:center;">
              <div style="font-weight:1000">${euroFromCents(totalCents)}</div>

              <!-- Gesamtpreis Override NUR √ºber Stift -->
              <button class="iconBtn" title="Gesamtpreis setzen" data-edit-total="${esc(o.id)}">‚úè</button>

              ${
                archived
                  ? `
                    <button class="iconBtn" data-restore="${esc(o.id)}" title="Zur√ºck holen">‚Ü©</button>
                    <button class="iconBtn danger" data-delete="${esc(o.id)}" title="L√∂schen">üóë</button>
                  `
                  : `
                    <button class="iconBtn" data-archive="${esc(o.id)}" title="Ins Archiv">üì¶</button>
                    <button class="iconBtn danger" data-delete="${esc(o.id)}" title="L√∂schen">üóë</button>
                  `
              }
            </div>
          </div>

          <div class="sep"></div>
          ${lines}
        `;

        target.appendChild(card);
      }

      // handlers
      target.querySelectorAll("[data-toggle-produced]").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const id = b.getAttribute("data-toggle-produced");
          // read current from dataset? simplest: refetch value by toggling locally after update
          // we just flip in db using select+update:
          const { data, error } = await supabase.from("order_items").select("produced").eq("id", id).single();
          if(error) return alert(error.message);
          const next = !data.produced;
          const { error: uErr } = await supabase.from("order_items").update({ produced: next }).eq("id", id);
          if(uErr) return alert(uErr.message);
          await loadAll();
        });
      });

      target.querySelectorAll("[data-edit-item]").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const id = b.getAttribute("data-edit-item");
          // current price:
          const { data, error } = await supabase.from("order_items").select("price_override_cents,product,size").eq("id", id).single();
          if(error) return alert(error.message);

          let initial = data.price_override_cents;
          if(initial == null){
            if(data.product==="bunny") initial = PRICES_CENTS.bunny[data.size] || 0;
            else if(data.product==="lumi") initial = PRICES_CENTS.lumi;
            else initial = 0;
          }

          openMoneyModal({
            title: "Preis pro St√ºck",
            initialCents: initial,
            onApply: async (cents)=>{
              const { error: uErr } = await supabase.from("order_items").update({ price_override_cents: cents }).eq("id", id);
              if(uErr) return alert(uErr.message);
              await loadAll();
            }
          });
        });
      });

      target.querySelectorAll("[data-edit-total]").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const orderId = b.getAttribute("data-edit-total");
          const { data: order, error } = await supabase.from("orders").select("total_override_cents").eq("id", orderId).single();
          if(error) return alert(error.message);

          // wenn null -> initial aus berechnetem total
          let initial = order.total_override_cents;
          if(initial == null){
            // calculate from itemsMap:
            const items = (itemsMap.get(orderId) || []);
            initial = orderTotalCents({ total_override_cents:null }, items);
          }

          openMoneyModal({
            title: "Gesamtpreis setzen",
            initialCents: initial || 0,
            onApply: async (cents)=>{
              const { error: uErr } = await supabase.from("orders").update({ total_override_cents: cents }).eq("id", orderId);
              if(uErr) return alert(uErr.message);
              await loadAll();
            }
          });
        });
      });

      target.querySelectorAll("[data-archive]").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const id = b.getAttribute("data-archive");
          await supabase.from("orders").update({ archived:true }).eq("id", id);
          await loadAll();
        });
      });
      target.querySelectorAll("[data-restore]").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const id = b.getAttribute("data-restore");
          await supabase.from("orders").update({ archived:false }).eq("id", id);
          await loadAll();
        });
      });
      target.querySelectorAll("[data-delete]").forEach(b=>{
        b.addEventListener("click", async ()=>{
          const id = b.getAttribute("data-delete");
          const ok = confirm("Wirklich l√∂schen?");
          if(!ok) return;
          await supabase.from("orders").delete().eq("id", id);
          await loadAll();
        });
      });
    }

    async function loadAll(){
      const { data: orders, error: oErr } = await supabase
        .from("orders")
        .select("id,created_at,customer_name,note,archived,total_override_cents")
        .order("created_at", { ascending:false });

      if(oErr){
        openSumEl.textContent = "Fehler: " + oErr.message;
        return;
      }

      const { data: items, error: iErr } = await supabase
        .from("order_items")
        .select("*")
        .order("created_at", { ascending:false });

      if(iErr){
        openSumEl.textContent = "Fehler: " + iErr.message;
        return;
      }

      // map orderId -> items
      const itemsMap = new Map();
      for(const it of (items||[])){
        if(!itemsMap.has(it.order_id)) itemsMap.set(it.order_id, []);
        itemsMap.get(it.order_id).push(it);
      }

      const all = (orders||[]).map(o=>({ ...o, items: itemsMap.get(o.id) || [] }));

      const open = all.filter(x=>!x.archived);
      const archived = all.filter(x=>x.archived);

      if(sortMode==="prio"){
        open.sort((a,b)=>{
          const ap = Math.min(...(a.items||[]).map(x=>prioRank(x.priority)).concat([2]));
          const bp = Math.min(...(b.items||[]).map(x=>prioRank(x.priority)).concat([2]));
          if(ap!==bp) return ap-bp;
          return new Date(b.created_at)-new Date(a.created_at);
        });
      } else {
        open.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
      }

      // sums
      const openTotal = open.reduce((s,o)=> s + orderTotalCents(o, o.items||[]), 0);
      openSumEl.textContent = `Summe offen: ${euroFromCents(openTotal)}`;

      const archTotal = archived.reduce((s,o)=> s + orderTotalCents(o, o.items||[]), 0);
      archivedTotalEl.textContent = `Archiv gesamt: ${euroFromCents(archTotal)}`;

      renderOrders(openOrdersEl, open, itemsMap, { archived:false });
      renderOrders(archiveOrdersEl, archived, itemsMap, { archived:true });
    }

    sortDate.addEventListener("click", ()=>{
      sortMode = "date";
      sortDate.classList.add("btnDark"); sortDate.classList.remove("btnSoft");
      sortPrio.classList.add("btnSoft"); sortPrio.classList.remove("btnDark");
      loadAll();
    });
    sortPrio.addEventListener("click", ()=>{
      sortMode = "prio";
      sortPrio.classList.add("btnDark"); sortPrio.classList.remove("btnSoft");
      sortDate.classList.add("btnSoft"); sortDate.classList.remove("btnDark");
      loadAll();
    });

    // Init
    setProduct("bunny");
    updateCartUI();
    saveOrderBtn.disabled = true;
    await loadAll();
  </script>
</body>
</html>

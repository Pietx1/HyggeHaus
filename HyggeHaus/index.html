<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HyggeHaus ‚Ä¢ Bestellungen</title>

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --dark:#0f172a; --dark2:#111827;
      --danger:#b91c1c; --ok:#047857; --warn:#b45309;
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); }
    .container{ max-width:1100px; margin:0 auto; padding:24px; }
    h1{ margin:0; font-size:34px; letter-spacing:-.02em; }
    .topbar{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; margin-bottom:18px; }
    .hint{ color:var(--muted); font-size:13px; }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); }
    .pad{ padding:18px; }
    .sep{ height:1px; background:var(--border); margin:14px 0; }
    .title2{ font-size:18px; font-weight:900; margin:0 0 8px; }

    /* Mobile Zoom Fix: mind. 16px */
    input, textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius:14px;
      padding:11px 14px;
      font-size:16px;
      outline:none;
      background:#fff;
    }
    textarea{ min-height:90px; resize:vertical; }
    input:focus, textarea:focus{ border-color:#c7d2fe; box-shadow:0 0 0 4px rgba(99,102,241,.12); }

    label{ font-weight:900; font-size:13px; display:block; margin:0 0 6px; }

    .grid{ display:grid; gap:14px; }
    @media(min-width:900px){
      .grid-2{ grid-template-columns:repeat(2,1fr); }
      .grid-3{ grid-template-columns:repeat(3,1fr); }
      .grid-4{ grid-template-columns:repeat(4,1fr); }
    }

    .btn{
      border:0; cursor:pointer;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900; font-size:14px;
      background:var(--dark2); color:#fff;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      user-select:none;
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }
    .btnSmall{ padding:8px 10px; border-radius:12px; font-size:13px; }
    .btnSoft{ background:#fff; border:1px solid var(--border); color:var(--text); font-weight:900; }
    .btnDark{ background:linear-gradient(180deg, #0b1220, #0f172a); }
    .btnDanger{ background:var(--danger); }

    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .muted{ color:var(--muted); font-size:13px; }

    .chips{ display:flex; gap:10px; flex-wrap:wrap; }
    .chip{
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      padding:11px 14px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      min-width:108px;
      text-align:center;
    }
    .chip.active{ background:linear-gradient(180deg, #0b1220, #0f172a); color:#fff; border-color:#0f172a; }

    .prioRow{ display:flex; gap:10px; align-items:stretch; }
    .prioBtn{
      flex:1; border:1px solid var(--border); background:#fff; border-radius:14px;
      font-weight:900; cursor:pointer; padding:10px 12px; text-align:center; user-select:none;
    }
    .prioBtn.small{ flex:.85; } .prioBtn.big{ flex:1.3; }
    .prioBtn.active{ background:var(--dark2); color:#fff; border-color:var(--dark2); }

    /* Menge 3x3 am Handy */
    .qtyGrid{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
    }
    .qtyGrid .chip{ min-width:0; }

    .badge{
      font-size:12px; font-weight:900; padding:6px 10px; border-radius:999px;
      border:1px solid var(--border); background:#fff; white-space:nowrap;
    }
    .badge.ok{ border-color:#bbf7d0; background:#f0fdf4; color:#166534; }
    .badge.neutral{ border-color:#e5e7eb; background:#f9fafb; color:#111827; }

    .iconBtn{
      border:1px solid var(--border);
      background:#fff;
      width:36px; height:36px;
      border-radius:12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
    }
    .iconBtn:hover{ background:#f9fafb; }
    .iconBtn.danger{ border-color:#fecaca; color:#991b1b; }

    /* Produced toggle */
    .prodBtn{
      border:1px solid var(--border);
      background:#fff;
      height:36px;
      padding:0 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .prodBtn.done{
      border-color:#bbf7d0;
      background:#f0fdf4;
      color:#166534;
    }

    /* Color field with arrow inside */
    .pickWrap{ position:relative; }
    .pickInput{ padding-right:44px; }
    .pickArrow{
      position:absolute;
      right:8px;
      top:50%;
      transform:translateY(-50%);
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      line-height:1;
    }

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background:rgba(15,23,42,.45);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:9999;
      padding:14px;
    }
    .modal.open{ display:flex; }
    .sheet{
      width:min(740px, 100%);
      background:#fff;
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .sheetHead{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--border);
      font-weight:1000;
    }
    .sheetBody{ padding:14px; }
    .colorGrid{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
    }
    @media(min-width:700px){
      .colorGrid{ grid-template-columns:repeat(5, 1fr); }
    }
    .cBtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      padding:10px 10px;
      cursor:pointer;
      font-weight:900;
      text-align:center;
      user-select:none;
    }
    .cBtn:hover{ background:#f9fafb; }

    details.archive > summary{
      cursor:pointer;
      user-select:none;
      font-weight:900;
      color:#1f3a8a;
    }

    .error{ color:var(--danger); font-weight:900; }
    .ok{ color:var(--ok); font-weight:900; }

  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <h1>Bestellungen</h1>
      <div class="hint">GitHub Pages ‚Ä¢ Supabase</div>
    </div>

    <!-- NEUE BESTELLUNG -->
    <div class="card">
      <div class="pad">
        <div class="chips">
          <div class="chip" id="btnBunny">üê∞ Hase</div>
          <div class="chip" id="btnLumi">‚ú®ü™≤ Lumi</div>
          <div class="chip" id="btnText">‚úçÔ∏è Schriftzug</div>
          <div class="chip" id="btnOther">‚ûï Weitere Produkt</div>
        </div>

        <div style="height:10px"></div>
        <div class="title2" id="newTitle">Neue Bestellung</div>

        <div class="sep"></div>

        <!-- Kunde IMMER √ºber Priorit√§t -->
        <div class="grid grid-2">
          <div>
            <label for="customer">Kundenname</label>
            <input id="customer" placeholder="z. B. Max Mustermann" />
          </div>
          <div>
            <label for="note">Beschreibung (optional)</label>
            <textarea id="note" placeholder="Hinweis ‚Ä¶"></textarea>
          </div>
        </div>

        <div class="sep"></div>

        <div id="productArea"></div>

        <div class="sep"></div>

        <label>Priorit√§t</label>
        <div class="prioRow">
          <div class="prioBtn small" id="pVery">Sehr wichtig</div>
          <div class="prioBtn big" id="pNorm">Wichtig</div>
          <div class="prioBtn small" id="pLow">Nicht wichtig</div>
        </div>

        <div class="sep"></div>

        <label>Menge</label>
        <div class="qtyGrid" id="qtyGrid">
          <div class="chip qtyBtn" data-q="1">1</div>
          <div class="chip qtyBtn" data-q="2">2</div>
          <div class="chip qtyBtn" data-q="3">3</div>
          <div class="chip qtyBtn" data-q="4">4</div>
          <div class="chip qtyBtn" data-q="5">5</div>
          <div class="chip qtyBtn" data-q="6">6</div>
          <div class="chip qtyBtn" data-q="7">7</div>
          <div class="chip qtyBtn" data-q="8">8</div>
          <div class="chip qtyBtn" data-q="9">9</div>
        </div>

        <div class="grid grid-2" style="align-items:end; margin-top:10px;">
          <div>
            <label for="qtyOther">Andere Menge (optional)</label>
            <input id="qtyOther" inputmode="numeric" placeholder="z. B. 12" />
          </div>
          <div style="display:flex; justify-content:flex-end;">
            <button class="btn btnDark" id="addItemBtn" style="min-width:280px;">+ Position hinzuf√ºgen</button>
          </div>
        </div>

        <div class="sep"></div>

        <div class="row" style="justify-content:space-between; align-items:flex-end;">
          <div class="title2" style="margin:0;">Positionen in dieser Bestellung</div>
          <div class="muted" id="cartSum">Summe: 0,00 ‚Ç¨</div>
        </div>

        <div id="cartList" class="grid" style="margin-top:10px;"></div>
        <div class="muted" id="cartHint">Noch keine Position hinzugef√ºgt.</div>

        <div class="sep"></div>

        <button id="saveOrderBtn" class="btn" disabled>‚úÖ Bestellung speichern</button>
        <div class="error" id="formError" style="display:none; margin-top:10px;"></div>
        <div class="ok" id="saveStatus" style="display:none; margin-top:10px;">Gespeichert ‚úÖ</div>
      </div>
    </div>

    <div style="height:16px"></div>

    <!-- OFFENE BESTELLUNGEN -->
    <div class="card">
      <div class="pad">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div class="title2" style="margin:0;">Offene Bestellungen</div>
            <div class="muted" id="openSum">Summe offen: 0,00 ‚Ç¨</div>
          </div>
          <div class="row" style="gap:10px;">
            <button class="btnSmall btnDark" id="sortDate">Sort: Datum</button>
            <button class="btnSmall btnSoft" id="sortPrio">Sort: Priorit√§t</button>
          </div>
        </div>

        <div class="sep"></div>
        <div id="openOrders" class="grid"></div>

        <div class="sep"></div>

        <details class="archive">
          <summary>Archiv (alte Bestellungen anzeigen)</summary>
          <div style="margin-top:10px;">
            <div class="muted" id="archivedTotal">Archiv gesamt: 0,00 ‚Ç¨</div>
            <div style="height:8px"></div>
            <div id="archiveOrders" class="grid"></div>
          </div>
        </details>
      </div>
    </div>
  </div>

  <!-- Color Modal -->
  <div class="modal" id="colorModal" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHead">
        <div id="colorModalTitle">Farbe w√§hlen</div>
        <button class="btnSmall btnSoft" id="colorModalClose" type="button">Schlie√üen</button>
      </div>
      <div class="sheetBody">
        <div class="colorGrid" id="colorGrid"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ========= Supabase =========
    const SUPABASE_URL = "https://htgrzmlcdolxxzvkppon.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0Z3J6bWxjZG9seHh6dmtwcG9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0MzM2ODIsImV4cCI6MjA4NTAwOTY4Mn0.B0PxMAzmuvsHNd2n_mgNspjlPkaBpQlkrNzGu7p78fY";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ========= Farben (ohne creme) =========
    const COLORS = [
      "wei√ü","schwarz","grau","dunkelgrau","hellgrau",
      "beige","braun","oak",
      "rot","orange","gelb","gr√ºn","blau","lila",
      "pink","rosa","gold","silber"
    ];

    // ========= Standardpreise =========
    const PRICES = {
      bunny: { "20": 12.0, "15": 9.0, "11": 6.0, comboAllThree: 22.50 },
      lumi: 8.50
    };

    // ========= Helpers =========
    const esc = (s)=> String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    const euro = (n)=> (Number(n)||0).toFixed(2).replace(".", ",") + " ‚Ç¨";
    const num = (s)=> Number(String(s??"").replace(",", "."));
    const toCents = (val)=> {
      const n = num(val);
      if(!Number.isFinite(n)) return null;
      return Math.round(n * 100);
    };
    const fromCents = (c)=> (Number(c||0)/100);

    function prioLabel(p){ return p==="very" ? "Sehr wichtig" : p==="normal" ? "Wichtig" : "Nicht wichtig"; }
    function prioRank(p){ return p==="very" ? 0 : p==="normal" ? 1 : 2; }

    // ========= Color modal =========
    const colorModal = document.getElementById("colorModal");
    const colorGrid  = document.getElementById("colorGrid");
    const colorModalTitle = document.getElementById("colorModalTitle");
    const colorModalClose = document.getElementById("colorModalClose");
    let colorResolve = null;

    function openColorModal(title){
      colorModalTitle.textContent = title || "Farbe w√§hlen";
      colorGrid.innerHTML = COLORS.map(c => `<button type="button" class="cBtn" data-c="${esc(c)}">${esc(c)}</button>`).join("");
      colorModal.classList.add("open");
      colorModal.setAttribute("aria-hidden","false");

      return new Promise((resolve)=>{
        colorResolve = resolve;
      });
    }
    function closeColorModal(){
      colorModal.classList.remove("open");
      colorModal.setAttribute("aria-hidden","true");
      if(colorResolve){ colorResolve(null); colorResolve=null; }
    }
    colorModalClose.addEventListener("click", closeColorModal);
    colorModal.addEventListener("click", (e)=>{ if(e.target === colorModal) closeColorModal(); });

    colorGrid.addEventListener("click", (e)=>{
      const btn = e.target.closest("[data-c]");
      if(!btn) return;
      const c = btn.getAttribute("data-c");
      if(colorResolve){ colorResolve(c); colorResolve=null; }
      closeColorModal();
    });

    // ========= UI refs =========
    const btnBunny = document.getElementById("btnBunny");
    const btnLumi  = document.getElementById("btnLumi");
    const btnText  = document.getElementById("btnText");
    const btnOther = document.getElementById("btnOther");
    const newTitle = document.getElementById("newTitle");

    const customer = document.getElementById("customer");
    const noteEl   = document.getElementById("note");

    const pVery = document.getElementById("pVery");
    const pNorm = document.getElementById("pNorm");
    const pLow  = document.getElementById("pLow");

    const qtyOther = document.getElementById("qtyOther");
    const addItemBtn = document.getElementById("addItemBtn");

    const cartList = document.getElementById("cartList");
    const cartHint = document.getElementById("cartHint");
    const cartSum  = document.getElementById("cartSum");

    const saveOrderBtn = document.getElementById("saveOrderBtn");
    const saveStatus = document.getElementById("saveStatus");
    const formError = document.getElementById("formError");

    const openOrdersEl = document.getElementById("openOrders");
    const archiveOrdersEl = document.getElementById("archiveOrders");
    const openSumEl = document.getElementById("openSum");
    const archivedTotalEl = document.getElementById("archivedTotal");

    const sortDate = document.getElementById("sortDate");
    const sortPrio = document.getElementById("sortPrio");

    const productArea = document.getElementById("productArea");

    // ========= State =========
    let currentProduct = "bunny"; // bunny|lumi|schriftzug|other
    let priority = null;
    let qty = null;
    let sortMode = "date";

    // per product fields
    const fields = {
      bunny_size: null, bunny_mode: null, bunny_single:null, bunny_ears:null, bunny_body:null, bunny_butt:null,
      lumi_body:null, lumi_wings:null, lumi_feelers:null,
      text_name:"Happy Birthday", text_color1:null, text_color2:null, text_price:null,
      other_name:"", other_size:"", other_color1:null, other_color2:null, other_price:null
    };

    let cart = [];

    // ========= UI helpers =========
    function setChip(el,on){ el.classList.toggle("active",!!on); }
    function setPrio(el,on){ el.classList.toggle("active",!!on); }
    function err(msg){
      formError.style.display = "block";
      formError.textContent = msg;
    }
    function clearErr(){
      formError.style.display = "none";
      formError.textContent = "";
    }

    function setProduct(p){
      currentProduct = p;
      [btnBunny,btnLumi,btnText,btnOther].forEach(x=>setChip(x,false));
      setChip(btnBunny, p==="bunny");
      setChip(btnLumi,  p==="lumi");
      setChip(btnText,  p==="schriftzug");
      setChip(btnOther, p==="other");

      newTitle.textContent =
        p==="bunny" ? "Neue Bestellung: Hase" :
        p==="lumi" ? "Neue Bestellung: Lumi" :
        p==="schriftzug" ? "Neue Bestellung: Schriftzug" :
        "Neue Bestellung: Weitere Produkt";

      renderProductArea();
      validateSaveEnabled();
      clearErr();
    }

    btnBunny.addEventListener("click", ()=>setProduct("bunny"));
    btnLumi .addEventListener("click", ()=>setProduct("lumi"));
    btnText .addEventListener("click", ()=>setProduct("schriftzug"));
    btnOther.addEventListener("click", ()=>setProduct("other"));

    [pVery,pNorm,pLow].forEach(el=>{
      el.addEventListener("click", ()=>{
        priority = el===pVery ? "very" : el===pNorm ? "normal" : "low";
        [pVery,pNorm,pLow].forEach(x=>setPrio(x,false));
        setPrio(el,true);
      });
    });

    document.querySelectorAll(".qtyBtn").forEach(b=>{
      b.addEventListener("click", ()=>{
        qty = Number(b.getAttribute("data-q"));
        document.querySelectorAll(".qtyBtn").forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
      });
    });

    // ========= product area renderer =========
    function pickField(label, value, onPick){
      const id = "p_" + Math.random().toString(16).slice(2);
      // input readonly, arrow inside
      setTimeout(()=>{
        const arrow = document.getElementById(id+"_a");
        const inp = document.getElementById(id+"_i");
        if(!arrow || !inp) return;
        arrow.addEventListener("click", async ()=>{
          const picked = await onPick();
          if(picked!=null){
            inp.value = picked;
          }
        });
      },0);

      return `
        <div>
          <label>${esc(label)}</label>
          <div class="pickWrap">
            <input id="${id}_i" class="pickInput" value="${esc(value||"")}" readonly />
            <button type="button" class="pickArrow" id="${id}_a">‚ñæ</button>
          </div>
        </div>
      `;
    }

    function renderProductArea(){
      productArea.innerHTML = "";

      if(currentProduct==="bunny"){
        productArea.innerHTML = `
          <div class="grid grid-2">
            <div>
              <label>Gr√∂√üe</label>
              <div class="chips">
                <div class="chip" data-size="11">11 cm</div>
                <div class="chip" data-size="15">15 cm</div>
                <div class="chip" data-size="20">20 cm</div>
              </div>
            </div>
            <div>
              <label>Farbmodus</label>
              <div class="chips">
                <div class="chip" data-mode="single">Einfarbig</div>
                <div class="chip" data-mode="multi">Mehrfarbig</div>
              </div>
            </div>
          </div>

          <div class="sep"></div>

          <div id="bunnyColors"></div>
        `;

        // size buttons
        productArea.querySelectorAll("[data-size]").forEach(b=>{
          b.addEventListener("click", ()=>{
            fields.bunny_size = b.getAttribute("data-size");
            productArea.querySelectorAll("[data-size]").forEach(x=>x.classList.toggle("active", x===b));
          });
        });

        // mode buttons
        productArea.querySelectorAll("[data-mode]").forEach(b=>{
          b.addEventListener("click", ()=>{
            fields.bunny_mode = b.getAttribute("data-mode");
            productArea.querySelectorAll("[data-mode]").forEach(x=>x.classList.toggle("active", x===b));
            renderBunnyColors();
          });
        });

        renderBunnyColors();
      }

      if(currentProduct==="lumi"){
        productArea.innerHTML = `
          <div class="grid grid-3">
            ${pickField("K√∂rper", fields.lumi_body, ()=>openColorModal("Lumi: K√∂rper"))}
            ${pickField("Fl√ºgel", fields.lumi_wings, ()=>openColorModal("Lumi: Fl√ºgel"))}
            ${pickField("F√ºhler", fields.lumi_feelers, ()=>openColorModal("Lumi: F√ºhler"))}
          </div>
        `;
      }

      if(currentProduct==="schriftzug"){
        productArea.innerHTML = `
          <div class="grid grid-2">
            <div>
              <label>Name</label>
              <input id="t_name" value="${esc(fields.text_name||"Happy Birthday")}" placeholder="Happy Birthday" />
            </div>
            <div>
              <label>Preis (‚Ç¨)</label>
              <input id="t_price" inputmode="decimal" placeholder="z. B. 20,00" value="${esc(fields.text_price||"")}" />
            </div>
          </div>
          <div class="sep"></div>
          <div class="grid grid-2">
            ${pickField("Hauptfarbe", fields.text_color1, ()=>openColorModal("Schriftzug: Hauptfarbe"))}
            ${pickField("2. Farbe", fields.text_color2, ()=>openColorModal("Schriftzug: 2. Farbe"))}
          </div>
        `;

        setTimeout(()=>{
          const n = document.getElementById("t_name");
          const p = document.getElementById("t_price");
          n.addEventListener("input", ()=> fields.text_name = n.value || "");
          p.addEventListener("input", ()=> fields.text_price = p.value || "");
        },0);
      }

      if(currentProduct==="other"){
        productArea.innerHTML = `
          <div class="grid grid-2">
            <div>
              <label>Name</label>
              <input id="o_name" value="${esc(fields.other_name||"")}" placeholder="z. B. Schl√ºsselanh√§nger" />
            </div>
            <div>
              <label>Gr√∂√üe</label>
              <input id="o_size" value="${esc(fields.other_size||"")}" placeholder="z. B. 10 cm / XL" />
            </div>
          </div>
          <div class="sep"></div>
          <div class="grid grid-2">
            <div>
              <label>Preis (‚Ç¨)</label>
              <input id="o_price" inputmode="decimal" placeholder="z. B. 12,00" value="${esc(fields.other_price||"")}" />
            </div>
            <div class="muted" style="align-self:end;">&nbsp;</div>
          </div>
          <div class="sep"></div>
          <div class="grid grid-2">
            ${pickField("Hauptfarbe", fields.other_color1, ()=>openColorModal("Weitere: Hauptfarbe"))}
            ${pickField("2. Farbe", fields.other_color2, ()=>openColorModal("Weitere: 2. Farbe"))}
          </div>
        `;

        setTimeout(()=>{
          const n = document.getElementById("o_name");
          const s = document.getElementById("o_size");
          const p = document.getElementById("o_price");
          n.addEventListener("input", ()=> fields.other_name = n.value || "");
          s.addEventListener("input", ()=> fields.other_size = s.value || "");
          p.addEventListener("input", ()=> fields.other_price = p.value || "");
        },0);
      }
    }

    function renderBunnyColors(){
      const host = document.getElementById("bunnyColors");
      if(!host) return;

      if(fields.bunny_mode==="single"){
        host.innerHTML = `
          <div class="grid grid-1">
            ${pickField("Einfarbig", fields.bunny_single, ()=>openColorModal("Hase: Einfarbig"))}
          </div>
        `;
        return;
      }
      if(fields.bunny_mode==="multi"){
        host.innerHTML = `
          <div class="grid grid-3">
            ${pickField("Ohren", fields.bunny_ears, ()=>openColorModal("Hase: Ohren"))}
            ${pickField("K√∂rper", fields.bunny_body, ()=>openColorModal("Hase: K√∂rper"))}
            ${pickField("Popo", fields.bunny_butt, ()=>openColorModal("Hase: Popo"))}
          </div>
        `;
        return;
      }
      host.innerHTML = `<div class="muted">Bitte zuerst Farbmodus w√§hlen.</div>`;
    }

    // ========= Build item =========
    function getQty(){
      const otherQ = Number(String(qtyOther.value||"").replace(",", "."));
      if(Number.isFinite(otherQ) && otherQ>0) return Math.floor(otherQ);
      if(typeof qty==="number" && qty>0) return qty;
      return null;
    }

    function validateItem(){
      if(!(customer.value||"").trim()) return "Kundenname fehlt";
      if(!priority) return "Priorit√§t fehlt";
      const q = getQty();
      if(!q) return "Menge fehlt";

      if(currentProduct==="bunny"){
        if(!fields.bunny_size) return "Gr√∂√üe fehlt";
        if(!fields.bunny_mode) return "Farbmodus fehlt";
        if(fields.bunny_mode==="single" && !fields.bunny_single) return "Einfarbig fehlt";
        if(fields.bunny_mode==="multi" && (!fields.bunny_ears || !fields.bunny_body || !fields.bunny_butt)) return "Ohren/K√∂rper/Popo fehlt";
      }

      if(currentProduct==="lumi"){
        if(!fields.lumi_body || !fields.lumi_wings || !fields.lumi_feelers) return "Lumi Farben fehlen";
      }

      if(currentProduct==="schriftzug"){
        if(!(fields.text_name||"").trim()) return "Name fehlt";
        const pc = toCents(fields.text_price);
        if(pc==null) return "Preis fehlt/ung√ºltig";
        if(!fields.text_color1 || !fields.text_color2) return "Farben fehlen";
      }

      if(currentProduct==="other"){
        if(!(fields.other_name||"").trim()) return "Name fehlt";
        if(!(fields.other_size||"").trim()) return "Gr√∂√üe fehlt";
        const pc = toCents(fields.other_price);
        if(pc==null) return "Preis fehlt/ung√ºltig";
        if(!fields.other_color1 || !fields.other_color2) return "Farben fehlen";
      }

      return null;
    }

    function makeItem(){
      const q = getQty();
      const base = {
        _cid: String(Date.now()) + "-" + Math.random().toString(16).slice(2),
        product_type: currentProduct,
        priority,
        qty: q,
        produced: false,
        note: (noteEl.value||"").trim() || null
      };

      if(currentProduct==="bunny"){
        base.title = "Hase";
        base.size = fields.bunny_size + " cm";
        base.colors = fields.bunny_mode==="single"
          ? { mode:"single", single: fields.bunny_single }
          : { mode:"multi", ears: fields.bunny_ears, body: fields.bunny_body, butt: fields.bunny_butt };
        base.price_cents = null; // Standardpreis
        return base;
      }

      if(currentProduct==="lumi"){
        base.title = "Lumi";
        base.size = null;
        base.colors = { body: fields.lumi_body, wings: fields.lumi_wings, feelers: fields.lumi_feelers };
        base.price_cents = null; // Standardpreis
        return base;
      }

      if(currentProduct==="schriftzug"){
        base.title = "Schriftzug";
        base.size = fields.text_name; // wir nutzen size als ‚ÄúText‚Äù
        base.colors = { main: fields.text_color1, second: fields.text_color2 };
        base.price_cents = toCents(fields.text_price);
        return base;
      }

      // other
      base.title = fields.other_name.trim();
      base.size = fields.other_size.trim();
      base.colors = { main: fields.other_color1, second: fields.other_color2 };
      base.price_cents = toCents(fields.other_price);
      return base;
    }

    function itemDisplayTitle(it){
      if(it.product_type==="bunny") return `Hase ${it.size}`;
      if(it.product_type==="lumi") return "Lumi";
      if(it.product_type==="schriftzug") return `Schriftzug: ${it.size}`;
      return `${it.title} (${it.size||"?"})`;
    }

    function itemPricePerUnit(it){
      if(it.price_cents != null) return fromCents(it.price_cents);

      if(it.product_type==="bunny"){
        const s = String(it.size||"");
        const sizeNum = s.includes("11") ? "11" : s.includes("15") ? "15" : "20";
        return PRICES.bunny[sizeNum] || 0;
      }
      if(it.product_type==="lumi") return PRICES.lumi;
      return 0;
    }

    function cartTotal(items){
      // Bunny combo nur, wenn KEIN bunny-item price_cents override hat
      const bunnies = items.filter(x=>x.product_type==="bunny");
      const bunnyHasOverride = bunnies.some(x=>x.price_cents != null);

      let total = 0;

      // non-bunny
      for(const it of items){
        if(it.product_type!=="bunny"){
          total += itemPricePerUnit(it) * it.qty;
        }
      }

      if(bunnyHasOverride){
        for(const it of bunnies){
          total += itemPricePerUnit(it) * it.qty;
        }
        return total;
      }

      // combo
      const counts = { "20":0,"15":0,"11":0 };
      for(const it of bunnies){
        const s = String(it.size||"");
        const sizeNum = s.includes("11") ? "11" : s.includes("15") ? "15" : "20";
        counts[sizeNum] += it.qty;
      }
      const combos = Math.min(counts["20"], counts["15"], counts["11"]);
      if(combos>0){
        total += combos * PRICES.bunny.comboAllThree;
        counts["20"] -= combos; counts["15"] -= combos; counts["11"] -= combos;
      }
      total += counts["20"] * PRICES.bunny["20"];
      total += counts["15"] * PRICES.bunny["15"];
      total += counts["11"] * PRICES.bunny["11"];
      return total;
    }

    function validateSaveEnabled(){
      saveOrderBtn.disabled = cart.length===0;
    }

    function colorLines(it){
      const c = it.colors || {};
      if(it.product_type==="bunny"){
        if(c.mode==="single"){
          return `<div class="muted">Einfarbig: ${esc(c.single||"")}</div>`;
        }
        return `
          <div class="muted">Ohren: ${esc(c.ears||"")}</div>
          <div class="muted">K√∂rper: ${esc(c.body||"")}</div>
          <div class="muted">Popo: ${esc(c.butt||"")}</div>
        `;
      }
      if(it.product_type==="lumi"){
        return `
          <div class="muted">K√∂rper: ${esc(c.body||"")}</div>
          <div class="muted">Fl√ºgel: ${esc(c.wings||"")}</div>
          <div class="muted">F√ºhler: ${esc(c.feelers||"")}</div>
        `;
      }
      // schriftzug / other: main + second
      return `
        <div class="muted">Hauptfarbe: ${esc(c.main||"")}</div>
        <div class="muted">2. Farbe: ${esc(c.second||"")}</div>
      `;
    }

    function updateCartUI(){
      cartList.innerHTML = "";
      cartHint.style.display = cart.length===0 ? "block" : "none";

      for(const it of cart){
        const card = document.createElement("div");
        card.className = "card pad";
        card.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div style="min-width:240px;">
              <div style="font-weight:1000">${esc(itemDisplayTitle(it))} <span class="muted">(${esc(prioLabel(it.priority))})</span></div>
              ${colorLines(it)}
            </div>
            <div class="row" style="gap:8px;">
              <span class="badge">√ó ${esc(it.qty)}</span>
              <button class="iconBtn danger" data-del="${esc(it._cid)}" title="Entfernen">‚úñ</button>
            </div>
          </div>
        `;
        cartList.appendChild(card);
      }

      cartList.querySelectorAll("[data-del]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-del");
          cart = cart.filter(x=>x._cid !== id);
          updateCartUI();
          validateSaveEnabled();
        });
      });

      cartSum.textContent = "Summe: " + euro(cartTotal(cart));
    }

    addItemBtn.addEventListener("click", ()=>{
      clearErr();
      const msg = validateItem();
      if(msg){ err("Bitte erst ausf√ºllen. " + msg); return; }

      cart.push(makeItem());
      qty = null;
      qtyOther.value = "";
      document.querySelectorAll(".qtyBtn").forEach(x=>x.classList.remove("active"));

      updateCartUI();
      validateSaveEnabled();
    });

    // ========= Save order =========
    async function saveOrder(){
      clearErr();
      saveStatus.style.display="none";
      if(cart.length===0){ err("F√ºge zuerst mindestens eine Position hinzu."); return; }

      saveOrderBtn.disabled = true;
      saveOrderBtn.textContent = "Speichern‚Ä¶";

      const orderPayload = {
        customer_name: (customer.value||"").trim(),
        note: (noteEl.value||"").trim() || null,
        archived: false,
        total_override_cents: null
      };

      const { data: orderData, error: orderErr } = await supabase
        .from("orders")
        .insert(orderPayload)
        .select("id")
        .single();

      if(orderErr){
        err("Fehler beim Speichern (Order): " + orderErr.message);
        saveOrderBtn.disabled = false;
        saveOrderBtn.textContent = "‚úÖ Bestellung speichern";
        return;
      }

      const orderId = orderData.id;

      const itemsPayload = cart.map(it=>({
        order_id: orderId,
        product_type: it.product_type,
        title: it.title,
        size: it.size ?? null,
        colors: it.colors ?? null,
        priority: it.priority,
        qty: it.qty,
        price_cents: it.price_cents ?? null,
        produced: false,
        note: it.note ?? null
      }));

      const { error: itemsErr } = await supabase.from("order_items").insert(itemsPayload);

      if(itemsErr){
        err("Fehler beim Speichern (Positionen): " + itemsErr.message);
        await supabase.from("orders").delete().eq("id", orderId);
        saveOrderBtn.disabled = false;
        saveOrderBtn.textContent = "‚úÖ Bestellung speichern";
        return;
      }

      cart = [];
      updateCartUI();
      validateSaveEnabled();

      saveStatus.style.display="block";
      saveStatus.textContent="Gespeichert ‚úÖ";
      saveOrderBtn.textContent="‚úÖ Bestellung speichern";
      saveOrderBtn.disabled=true;

      await loadAll();
    }

    saveOrderBtn.addEventListener("click", saveOrder);

    // ========= Produced toggle + totals + override =========
    function orderTotal(order){
      // wenn override gesetzt -> genau der Wert
      if(order.total_override_cents != null) return fromCents(order.total_override_cents);

      return cartTotal(order.items.map(x=>({
        product_type: x.product_type,
        title: x.title,
        size: x.size,
        colors: x.colors,
        priority: x.priority,
        qty: x.qty,
        price_cents: x.price_cents
      })));
    }

    function allProduced(items){
      return items.length>0 && items.every(x=>x.produced===true);
    }

    async function toggleProduced(itemId, newVal){
      const { error } = await supabase.from("order_items").update({ produced: newVal }).eq("id", itemId);
      if(error) alert(error.message);
      await loadAll();
    }

    async function editOrderOverride(orderId, currentCents){
      const cur = currentCents==null ? "" : String(fromCents(currentCents)).replace(".", ",");
      const v = prompt("Neuer Gesamtpreis (‚Ç¨) ‚Äî leer = zur√ºck auf automatisch:", cur);
      if(v===null) return;

      const t = String(v).trim();
      let newCents = null;
      if(t!==""){
        const c = toCents(t);
        if(c==null || c<0){ alert("Bitte g√ºltigen Preis eingeben."); return; }
        newCents = c;
      }

      const { error } = await supabase.from("orders").update({ total_override_cents: newCents }).eq("id", orderId);
      if(error) alert(error.message);
      await loadAll();
    }

    async function archiveOrder(orderId){
      await supabase.from("orders").update({ archived:true }).eq("id", orderId);
      await loadAll();
    }
    async function restoreOrder(orderId){
      await supabase.from("orders").update({ archived:false }).eq("id", orderId);
      await loadAll();
    }
    async function deleteOrder(orderId){
      const ok = confirm("Wirklich l√∂schen? Das kann man nicht r√ºckg√§ngig machen.");
      if(!ok) return;
      await supabase.from("orders").delete().eq("id", orderId);
      await loadAll();
    }

    function formatDateOnly(iso){
      const d = new Date(iso);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}.${mm}.${yy}`;
    }

    function renderOrders(target, orders, archived){
      target.innerHTML = "";
      if(orders.length===0){
        target.innerHTML = `<div class="muted">Keine ${archived ? "archivierten" : "offenen"} Bestellungen.</div>`;
        return;
      }

      for(const o of orders){
        const total = orderTotal(o);
        const date = formatDateOnly(o.created_at);

        const minPr = Math.min(...o.items.map(x=>prioRank(x.priority)).concat([2]));
        const prText = minPr===0 ? "Sehr wichtig" : minPr===1 ? "Wichtig" : "Nicht wichtig";

        const fertig = allProduced(o.items);

        const card = document.createElement("div");
        card.className = "card pad";

        const lines = o.items.map(it=>{
          const done = !!it.produced;
          return `
            <div style="padding:10px 0; border-top:1px dashed #eef2f7;">
              <div class="row" style="justify-content:space-between; align-items:flex-start;">
                <div style="min-width:240px;">
                  <div style="font-weight:900">${esc(itemDisplayTitle(it))} <span class="muted">(${esc(prioLabel(it.priority))})</span></div>
                  ${colorLines(it)}
                </div>

                <div class="row" style="gap:10px;">
                  <button class="prodBtn ${done?'done':''}" data-prod="${it.id}" data-val="${done ? "0" : "1"}" title="Produziert">
                    ${done ? "‚úÖ" : "‚úñ"}
                  </button>
                  <span class="badge">√ó ${esc(it.qty)}</span>
                </div>
              </div>
            </div>
          `;
        }).join("");

        card.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div>
              <div class="row" style="gap:10px; align-items:center;">
                <div style="font-weight:1000">${archived ? "Archiv" : "Offen"} ‚Ä¢ ${esc(date)}</div>
                <span class="badge">${esc(prText)}</span>
                ${fertig ? `<span class="badge ok">FERTIG</span>` : ``}
              </div>
              <div class="muted" style="margin-top:6px;">üë§ ${esc(o.customer_name)}</div>
              ${o.note ? `<div class="muted" style="margin-top:4px;">üìù ${esc(o.note)}</div>` : ``}
            </div>

            <div class="row" style="gap:8px; align-items:center;">
              <div style="font-weight:1000">${euro(total)}</div>
              <!-- Stift: Override nur hier, NICHT als extra Button -->
              <button class="iconBtn" title="Gesamtpreis √ºberschreiben" data-edit-total="${o.id}" data-cur="${o.total_override_cents ?? ""}">‚úè</button>

              ${
                archived
                  ? `
                    <button class="iconBtn" title="Zur√ºck holen" data-restore="${o.id}">‚Ü©</button>
                    <button class="iconBtn danger" title="L√∂schen" data-delete="${o.id}">üóë</button>
                  `
                  : `
                    <button class="iconBtn" title="Ins Archiv" data-archive="${o.id}">üì¶</button>
                    <button class="iconBtn danger" title="L√∂schen" data-delete="${o.id}">üóë</button>
                  `
              }
            </div>
          </div>

          <div class="sep"></div>
          ${lines}
        `;

        target.appendChild(card);
      }

      // handlers
      target.querySelectorAll("[data-prod]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-prod");
          const val = b.getAttribute("data-val")==="1";
          toggleProduced(id, val);
        });
      });
      target.querySelectorAll("[data-edit-total]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-edit-total");
          const cur = b.getAttribute("data-cur");
          editOrderOverride(id, cur==="" ? null : Number(cur));
        });
      });
      target.querySelectorAll("[data-archive]").forEach(b=> b.addEventListener("click", ()=>archiveOrder(b.getAttribute("data-archive"))) );
      target.querySelectorAll("[data-restore]").forEach(b=> b.addEventListener("click", ()=>restoreOrder(b.getAttribute("data-restore"))) );
      target.querySelectorAll("[data-delete]").forEach(b=> b.addEventListener("click", ()=>deleteOrder(b.getAttribute("data-delete"))) );
    }

    async function loadAll(){
      const { data: orders, error: oErr } = await supabase
        .from("orders")
        .select("id,created_at,customer_name,note,archived,total_override_cents")
        .order("created_at", { ascending:false });

      if(oErr){
        openOrdersEl.innerHTML = `<div class="error">Fehler: ${esc(oErr.message)}</div>`;
        return;
      }

      const { data: items, error: iErr } = await supabase
        .from("order_items")
        .select("*")
        .order("created_at", { ascending:false });

      if(iErr){
        openOrdersEl.innerHTML = `<div class="error">Fehler: ${esc(iErr.message)}</div>`;
        return;
      }

      const map = new Map();
      for(const o of (orders||[])) map.set(o.id, { ...o, items: [] });
      for(const it of (items||[])){
        const o = map.get(it.order_id);
        if(o) o.items.push({ ...it, colors: it.colors || {} });
      }

      const all = Array.from(map.values());
      let open = all.filter(x=>!x.archived);
      const archived = all.filter(x=>x.archived);

      if(sortMode==="prio"){
        open.sort((a,b)=>{
          const ap = Math.min(...a.items.map(x=>prioRank(x.priority)).concat([2]));
          const bp = Math.min(...b.items.map(x=>prioRank(x.priority)).concat([2]));
          if(ap!==bp) return ap-bp;
          return new Date(b.created_at)-new Date(a.created_at);
        });
      }else{
        open.sort((a,b)=> new Date(b.created_at)-new Date(a.created_at));
      }

      const openTotal = open.reduce((s,o)=> s + orderTotal(o), 0);
      openSumEl.textContent = "Summe offen: " + euro(openTotal);

      const archTotal = archived.reduce((s,o)=> s + orderTotal(o), 0);
      archivedTotalEl.textContent = "Archiv gesamt: " + euro(archTotal);

      renderOrders(openOrdersEl, open, false);
      renderOrders(archiveOrdersEl, archived, true);
    }

    sortDate.addEventListener("click", ()=>{
      sortMode="date";
      sortDate.classList.add("btnDark"); sortDate.classList.remove("btnSoft");
      sortPrio.classList.add("btnSoft"); sortPrio.classList.remove("btnDark");
      loadAll();
    });
    sortPrio.addEventListener("click", ()=>{
      sortMode="prio";
      sortPrio.classList.add("btnDark"); sortPrio.classList.remove("btnSoft");
      sortDate.classList.add("btnSoft"); sortDate.classList.remove("btnDark");
      loadAll();
    });

    // init
    setProduct("bunny");
    validateSaveEnabled();
    updateCartUI();
    await loadAll();
  </script>
</body>
</html>
